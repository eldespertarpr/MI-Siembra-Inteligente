<!DOCTYPE html>  <html lang="es">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1" />  
  <title>Mi Siembra Inteligente (v17.1)</title>    <!-- PWA -->    <link rel="manifest" href="manifest.json" />  
  <meta name="theme-color" content="#22c55e" />    <!-- jsPDF -->    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>    <style>  
    :root {  
      color-scheme: dark;  
      --bg: #020617;  
      --bg-elevated: #02081f;  
      --card: #02081f;  
      --card-soft: #030919;  
      --accent: #22c55e;  
      --accent-soft: rgba(34,197,94,0.15);  
      --accent-strong: rgba(34,197,94,0.45);  
      --text-main: #f9fafb;  
      --text-soft: #9ca3af;  
      --border-subtle: rgba(148,163,184,0.3);  
      --danger: #f97373;  
      --chip-bg: rgba(15,23,42,0.9);  
      --chip-border: rgba(148,163,184,0.4);  
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.7);  
      --radius-xl: 22px;  
      --radius-lg: 18px;  
      --radius-full: 999px;  
    }  
  
    * { box-sizing: border-box; }  
  
    body {  
      margin: 0;  
      padding: 0;  
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",  
        "Roboto", "Segoe UI", sans-serif;  
      background: radial-gradient(circle at top, #022c22 0, #020617 55%);  
      color: var(--text-main);  
      min-height: 100vh;  
      display: flex;  
      flex-direction: column;  
    }  
  
    .app-shell {  
      max-width: 960px;  
      margin: 0 auto;  
      padding: 16px 12px 28px;  
    }  
  
    @media (min-width: 768px) {  
      .app-shell { padding: 20px 16px 40px; }  
    }  
  
    /* HEADER */  
    .app-header {  
      background: radial-gradient(circle at 0 0, #4ade80 0, #16a34a 28%, #052e16 85%);  
      border-radius: 28px;  
      padding: 18px 18px 16px;  
      display: flex;  
      align-items: center;  
      gap: 14px;  
      box-shadow: var(--shadow-soft);  
      position: relative;  
      overflow: hidden;  
      margin-bottom: 14px;  
    }  
  
    .app-header::after {  
      content: "";  
      position: absolute;  
      inset: 0;  
      background: radial-gradient(circle at 120% -10%, rgba(34,197,94,0.35) 0, transparent 55%);  
      opacity: 0.9;  
      pointer-events: none;  
    }  
  
    .app-header-icon {  
      position: relative;  
      z-index: 1;  
      width: 52px;  
      height: 52px;  
      border-radius: 18px;  
      background: radial-gradient(circle at 30% 10%, #bbf7d0 0, #16a34a 35%, #052e16 90%);  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      box-shadow: 0 14px 35px rgba(0,0,0,0.45);  
      flex-shrink: 0;  
    }  
  
    .app-header-icon span { font-size: 42px; }  
  
    .app-header-text {  
      position: relative;  
      z-index: 1;  
      display: flex;  
      flex-direction: column;  
      gap: 4px;  
    }  
  
    .app-title-row {  
      display: flex;  
      align-items: center;  
      gap: 10px;  
      flex-wrap: wrap;  
    }  
  
    .app-title {  
      font-size: 1.35rem;  
      font-weight: 700;  
      letter-spacing: 0.02em;  
    }  
  
    .app-tag {  
      font-size: 0.72rem;  
      padding: 2px 8px;  
      border-radius: 999px;  
      background: rgba(15,23,42,0.45);  
      border: 1px solid rgba(15,23,42,0.8);  
      text-transform: uppercase;  
      letter-spacing: 0.12em;  
      color: #e5e7eb;  
    }  
  
    .app-subtitle {  
      font-size: 0.80rem;  
      color: #e5e7eb;  
      opacity: 0.95;  
      display: flex;  
      flex-wrap: wrap;  
      gap: 6px;  
      align-items: center;  
    }  
  
    .app-subtitle span {  
      display: inline-flex;  
      align-items: center;  
      gap: 4px;  
    }  
  
    .app-subtitle-dot {  
      width: 3px;  
      height: 3px;  
      border-radius: 50%;  
      background: rgba(226,232,240,0.7);  
    }  
  
    /* NAV */  
    .nav {  
      margin-top: 8px;  
      background: linear-gradient(135deg, var(--bg-elevated), #020617);  
      border-radius: 26px;  
      padding: 10px;  
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);  
      display: grid;  
      grid-template-columns: repeat(4, 1fr);  
      gap: 8px;  
      position: sticky;  
      top: 0;  
      z-index: 40;  
      backdrop-filter: blur(16px);  
      border: 1px solid rgba(15,23,42,0.85);  
    }  
  
    @media (min-width: 660px) {  
      .nav { grid-template-columns: repeat(8, minmax(0,1fr)); }  
    }  
  
    .nav-btn {  
      border: none;  
      border-radius: 999px;  
      padding: 7px 6px 6px;  
      font-size: 0.70rem;  
      color: var(--text-soft);  
      background: transparent;  
      display: flex;  
      flex-direction: column;  
      align-items: center;  
      gap: 3px;  
      cursor: pointer;  
      transition: background 0.18s, color 0.18s, transform 0.12s;  
      position: relative;  
      min-height: 52px;  
    }  
  
    .nav-btn span.nav-icon { font-size: 1.40rem; }  
  
    .nav-btn.nav-btn--active {  
      background: radial-gradient(circle at top, var(--accent) 0, var(--accent-soft) 45%, transparent 100%);  
      color: #ecfdf5;  
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4), 0 14px 30px rgba(22,163,74,0.55);  
      transform: translateY(-1px);  
    }  
  
    .nav-btn.nav-btn--active::after {  
      content: "";  
      position: absolute;  
      inset: auto auto -3px 50%;  
      width: 32%;  
      max-width: 42px;  
      height: 3px;  
      border-radius: 999px;  
      background: linear-gradient(90deg, rgba(34,197,94,0.1), rgba(34,197,94,0.6), rgba(34,197,94,0.1));  
      transform: translateX(-50%);  
    }  
  
    /* SECTIONS */  
    main { margin-top: 14px; }  
  
    .section { display: none; animation: fadeIn 0.18s ease-out; }  
    .section--active { display: block; }  
  
    @keyframes fadeIn {  
      from { opacity: 0; transform: translateY(4px); }  
      to { opacity: 1; transform: translateY(0); }  
    }  
  
    .section > .section-title-row {  
      display: flex;  
      align-items: center;  
      gap: 10px;  
      margin: 14px 2px 8px;  
    }  
  
    .section-icon-pill {  
      width: 26px;  
      height: 26px;  
      border-radius: 13px;  
      background: radial-gradient(circle at 30% 15%, #fefce8 0, #fef9c3 25%, #0f172a 90%);  
      display: flex;  
      align-items: center;  
      justify-content: center;  
      font-size: 1.3rem;  
    }  
  
    .section-title-row h2 { font-size: 1.05rem; margin: 0; }  
  
    .section-subtitle {  
      font-size: 0.82rem;  
      color: var(--text-soft);  
      margin: 2px 2px 10px;  
    }  
  
    .app-card {  
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #02081f 100%);  
      border-radius: var(--radius-xl);  
      padding: 14px 16px 14px;  
      border: 1px solid var(--border-subtle);  
      box-shadow: var(--shadow-soft);  
      margin-bottom: 14px;  
    }  
  
    .app-card-header {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      gap: 10px;  
      margin-bottom: 6px;  
    }  
  
    .app-card-title { font-size: 0.96rem; font-weight: 600; }  
  
    .chip {  
      border-radius: var(--radius-full);  
      padding: 4px 10px;  
      font-size: 0.74rem;  
      border: 1px solid var(--chip-border);  
      background: var(--chip-bg);  
      display: inline-flex;  
      align-items: center;  
      gap: 4px;  
      white-space: nowrap;  
    }  
  
    .chip.badge {  
      background: rgba(34,197,94,0.12);  
      border-color: rgba(34,197,94,0.6);  
      color: #bbf7d0;  
    }  
  
    .muted { color: var(--text-soft); font-size: 0.80rem; }  
  
    .divider-soft {  
      height: 1px;  
      background: linear-gradient(90deg, transparent, rgba(148,163,184,0.4), transparent);  
      margin: 8px -2px 10px;  
    }  
  
    .pill-group {  
      display: flex;  
      flex-wrap: wrap;  
      gap: 8px;  
      margin: 8px -1px 4px;  
    }  
  
    .pill {  
      border-radius: 999px;  
      padding: 5px 12px;  
      font-size: 0.78rem;  
      border: 1px solid rgba(148,163,184,0.55);  
      background: rgba(15,23,42,0.9);  
      cursor: pointer;  
      color: var(--text-main);  
    }  
  
    .pill--active {  
      background: var(--accent-soft);  
      border-color: rgba(34,197,94,0.85);  
      color: #bbf7d0;  
    }  
  
    .btn {  
      border-radius: 999px;  
      border: none;  
      padding: 9px 14px;  
      font-size: 0.82rem;  
      font-weight: 500;  
      cursor: pointer;  
      display: inline-flex;  
      align-items: center;  
      gap: 6px;  
      background: linear-gradient(135deg, #16a34a, #22c55e);  
      color: #022c22;  
      box-shadow: 0 12px 30px rgba(22,163,74,0.55);  
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;  
    }  
  
    .btn span { font-size: 1rem; }  
  
    .btn:active {  
      transform: translateY(1px);  
      box-shadow: 0 7px 18px rgba(22,163,74,0.55);  
      filter: brightness(0.96);  
    }  
  
    .btn-secondary {  
      background: rgba(15,23,42,0.9);  
      color: var(--text-main);  
      border: 1px solid var(--border-subtle);  
      box-shadow: none;  
    }  
  
    .btn-full { width: 100%; justify-content: center; }  
  
    .btn-danger {  
      background: linear-gradient(135deg, #b91c1c, #ef4444);  
      color: #fee2e2;  
      box-shadow: 0 10px 26px rgba(248,113,113,0.45);  
    }  
  
    .grid-two {  
      display: grid;  
      grid-template-columns: repeat(2,minmax(0,1fr));  
      gap: 8px;  
    }  
  
    .small-label { font-size: 0.78rem; color: var(--text-soft); margin-bottom: 2px; }  
    .big-number { font-size: 1.3rem; font-weight: 600; }  
  
    /* FORMS */  
    .form-grid {  
      display: grid;  
      grid-template-columns: 1fr;  
      gap: 10px;  
      margin: 8px 0 4px;  
    }  
  
    @media (min-width: 660px) {  
      .form-grid--2 { grid-template-columns: repeat(2, minmax(0,1fr)); }  
    }  
  
    .field { display: flex; flex-direction: column; gap: 4px; }  
    .field label { font-size: 0.78rem; color: var(--text-soft); }  
  
    input[type="text"],  
    input[type="date"],  
    input[type="number"],  
    select,  
    textarea {  
      background: rgba(15,23,42,0.95);  
      border-radius: 14px;  
      border: 1px solid rgba(51,65,85,0.9);  
      padding: 8px 10px;  
      color: var(--text-main);  
      font-size: 0.83rem;  
      font-family: inherit;  
      width: 100%;  
      max-width: 100%;  
      outline: none;  
      transition: border 0.12s, box-shadow 0.12s, background 0.12s;  
    }  
  
    select {  
      appearance: none;  
      -webkit-appearance: none;  
      -moz-appearance: none;  
      padding-right: 26px;  
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),  
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);  
      background-position: calc(100% - 15px) 10px, calc(100% - 11px) 10px;  
      background-size: 6px 6px, 6px 6px;  
      background-repeat: no-repeat;  
    }  
  
    textarea { min-height: 72px; resize: vertical; }  
  
    input:focus, select:focus, textarea:focus {  
      border-color: rgba(34,197,94,0.9);  
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);  
      background: rgba(15,23,42,0.98);  
    }  
  
    /* Cat√°logo */  
    .cultivos-list {  
      display: flex;  
      flex-direction: column;  
      gap: 10px;  
      margin-top: 10px;  
    }  
  
    .cultivo-card {  
      border-radius: var(--radius-lg);  
      padding: 10px 11px;  
      background: radial-gradient(circle at top left, var(--card-soft) 0, #020617 60%);  
      border: 1px solid rgba(75,85,99,0.9);  
      display: flex;  
      flex-direction: column;  
      gap: 4px;  
    }  
  
    .cultivo-header {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      gap: 8px;  
    }  
  
    .cultivo-title {  
      font-size: 0.9rem;  
      font-weight: 600;  
      display: flex;  
      align-items: center;  
      gap: 8px;  
    }  
  
    .cultivo-thumb {  
      width: 56px;  
      height: 56px;  
      border-radius: 16px;  
      object-fit: cover;  
      flex-shrink: 0;  
    }  
  
    .cultivo-body {  
      font-size: 0.78rem;  
      color: var(--text-soft);  
      display: grid;  
      grid-template-columns: 1.1fr 0.9fr;  
      gap: 4px 10px;  
      margin-top: 6px;  
    }  
  
    @media (max-width: 480px) {  
      .cultivo-body { grid-template-columns: 1fr; }  
    }  
  
    .cultivo-actions {  
      margin-top: 8px;  
      display: flex;  
      justify-content: flex-end;  
      gap: 6px;  
      flex-wrap: wrap;  
    }  
  
    .germinacion-panel {  
      margin-top: 10px;  
      padding-top: 10px;  
      border-top: 1px solid rgba(148,163,184,0.5);  
      font-size: 0.78rem;  
      color: var(--text-soft);  
      display: none;  
    }  
  
    /* Calendario */  
    .calendar-list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }  
    .calendar-item {  
      border-radius: 16px;  
      padding: 9px 10px;  
      background: rgba(15,23,42,0.9);  
      border: 1px solid rgba(55,65,81,0.9);  
      font-size: 0.8rem;  
    }  
    .calendar-item-title {  
      font-weight: 600;  
      margin-bottom: 2px;  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      gap: 8px;  
    }  
    .calendar-empty { font-size: 0.8rem; color: var(--text-soft); margin-top: 8px; }  
  
    /* Diario */  
    .diario-list { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; font-size: 0.8rem; }  
    .diario-item {  
      border-radius: 14px;  
      padding: 8px 10px;  
      background: rgba(15,23,42,0.9);  
      border: 1px solid rgba(55,65,81,0.9);  
    }  
    .diario-item-header {  
      display: flex;  
      justify-content: space-between;  
      align-items: center;  
      gap: 8px;  
      margin-bottom: 6px;  
    }  
  
    /* Plagas / pesticidas */  
    .plaga-card {  
      border-radius: 14px;  
      padding: 8px 10px;  
      background: rgba(15,23,42,0.9);  
      border: 1px solid rgba(55,65,81,0.9);  
      margin-bottom: 6px;  
    }  
    .plaga-card--highlight {  
      border-color: rgba(34,197,94,0.9);  
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6);  
    }  
    .media-list { display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }  
    .media-item-title { font-size: 0.86rem; font-weight: 600; }  
    .media-item-body { font-size: 0.8rem; color: var(--text-soft); margin-top: 2px; }  
  
    footer {  
      margin-top: 6px;  
      font-size: 0.76rem;  
      color: var(--text-soft);  
      text-align: center;  
      padding-bottom: 6px;  
    }  
  
    #installBanner {  
      position: fixed;  
      left: 50%;  
      bottom: 16px;  
      transform: translateX(-50%);  
      background: rgba(15,23,42,0.97);  
      border-radius: 999px;  
      padding: 7px 12px;  
      display: flex;  
      align-items: center;  
      gap: 8px;  
      border: 1px solid rgba(148,163,184,0.75);  
      box-shadow: 0 16px 40px rgba(15,23,42,0.85);  
      font-size: 0.78rem;  
      z-index: 80;  
    }  
    #installBanner.hidden { display: none; }  
    #installBanner button { font-size: 0.78rem; padding: 6px 10px; }  
  </style>  </head>  <body>  
  <div class="app-shell">  
    <!-- HEADER -->  
    <header class="app-header">  
      <div class="app-header-icon"><span>üå±</span></div>  
      <div class="app-header-text">  
        <div class="app-title-row">  
          <div class="app-title">Mi Siembra Inteligente</div>  
          <div class="app-tag">v17.1 ¬∑ PWA</div>  
        </div>  
        <div class="app-subtitle" id="appSubtitle"></div>  
      </div>  
    </header>  <!-- NAV -->  
<nav class="nav">  
  <button class="nav-btn nav-btn--active" data-section="inicio"><span class="nav-icon">üè†</span><span class="nav-label">Inicio</span></button>  
  <button class="nav-btn" data-section="calendario"><span class="nav-icon">üìÖ</span><span class="nav-label">Calendario</span></button>  
  <button class="nav-btn" data-section="catalogo"><span class="nav-icon">üå±</span><span class="nav-label">Cat√°logo</span></button>  
  <button class="nav-btn" data-section="huerto"><span class="nav-icon">üåø</span><span class="nav-label">Mi huerto</span></button>  
  <button class="nav-btn" data-section="diario"><span class="nav-icon">üìì</span><span class="nav-label">Diario</span></button>  
  <button class="nav-btn" data-section="plagas"><span class="nav-icon">üêõ</span><span class="nav-label">Plagas</span></button>  
  <button class="nav-btn" data-section="pesticidas"><span class="nav-icon">üíß</span><span class="nav-label">Pesticidas</span></button>  
  <button class="nav-btn" data-section="opciones"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Opciones</span></button>  
  <button class="nav-btn" data-section="guias"><span class="nav-icon">üìö</span><span class="nav-label">Gu√≠as</span></button>  
</nav>  

<main>  
  <!-- INICIO -->  
  <section id="section-inicio" class="section section--active">  
    <div class="section-title-row"><div class="section-icon-pill">üè†</div><h2>Inicio</h2></div>  
    <p class="section-subtitle">Resumen r√°pido de tu huerto y acceso a las funciones principales.</p>  

    <!-- Acciones r√°pidas (card separada, limpia) -->  
    <div class="app-card" id="accionesRapidasCard">  
      <div class="app-card-header">  
        <div class="app-card-title">Acciones r√°pidas</div>  
        <div class="chip" id="accionesRapidasChip">‚Äî</div>  
      </div>  

      <p class="muted" id="accionesRapidasDesc">Marca riego o abono del cultivo m√°s urgente.</p>  

      <div class="grid-two" style="margin-top:10px;">  
        <button class="btn btn-secondary btn-full" id="btnQuickRiego"><span>üí¶</span> Riego hecho</button>  
        <button class="btn btn-secondary btn-full" id="btnQuickAbono"><span>üíß</span> Abono hecho</button>  
      </div>  

      <div class="divider-soft"></div>  
      <p class="muted" id="accionesRapidasDetalle">‚Äî</p>  
    </div>  

    <!-- Estado r√°pido -->  
    <div class="app-card">  
      <div class="app-card-header">  
        <div class="app-card-title">Estado r√°pido</div>  
        <div class="chip badge" id="estadoClimaChip">Clima tropical</div>  
      </div>  

      <div class="grid-two">  
        <div>  
          <div class="small-label">Cultivos registrados</div>  
          <div class="big-number" id="estadoCultivosCount">0</div>  
        </div>  
        <div>  
          <div class="small-label">Entradas hoy en el diario</div>  
          <div class="big-number" id="estadoEntradasCount">0</div>  
        </div>  
      </div>  

      <div class="divider-soft"></div>  
      <p class="muted" id="estadoResumen">A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.</p>  

      <div class="divider-soft"></div>  
      <div class="muted" id="pendientesHoy"></div>  
    </div>  
  </section>  

  <!-- CALENDARIO -->  
  <section id="section-calendario" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üìÖ</div><h2>Calendario de siembra</h2></div>  
    <p class="section-subtitle">Selecciona un mes para ver sugerencias de cultivos seg√∫n tu clima y hemisferio.</p>  

    <div class="app-card">  
      <div class="app-card-header">  
        <div class="app-card-title">Meses del a√±o</div>  
        <div class="chip" id="calendarioClimaChip2">Clima tropical</div>  
      </div>  

      <div class="pill-group" id="mesesPills">  
        <button class="pill" data-mes="0">Ene</button><button class="pill" data-mes="1">Feb</button><button class="pill" data-mes="2">Mar</button>  
        <button class="pill" data-mes="3">Abr</button><button class="pill" data-mes="4">May</button><button class="pill" data-mes="5">Jun</button>  
        <button class="pill" data-mes="6">Jul</button><button class="pill" data-mes="7">Ago</button><button class="pill" data-mes="8">Sep</button>  
        <button class="pill" data-mes="9">Oct</button><button class="pill" data-mes="10">Nov</button><button class="pill" data-mes="11">Dic</button>  
      </div>  

      <div class="calendar-list" id="calendarList"></div>  
      <div class="calendar-empty" id="calendarEmpty" style="display:none;">Por ahora no hay recomendaciones espec√≠ficas para este mes y clima.</div>  
    </div>  
  </section>  

  <!-- CATALOGO -->  
  <section id="section-catalogo" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üå±</div><h2>Cat√°logo de cultivos</h2></div>  
    <p class="section-subtitle">Lista de cultivos con informaci√≥n r√°pida y gu√≠a de germinaci√≥n / reproducci√≥n.</p>  

    <div class="app-card">  
      <div class="field">  
        <label for="catalogoBusqueda">Buscar cultivo</label>  
        <input type="text" id="catalogoBusqueda" placeholder="Ej. tomate, lechuga, pl√°tano..." />  
      </div>  

      <div style="margin-top: 10px;">  
        <button type="button" class="btn btn-secondary" id="btnToggleNuevoCultivo">‚ûï A√±adir cultivo manual</button>  
      </div>  

      <div class="cultivos-list" id="catalogoList"></div>  

      <!-- Formulario cultivo manual -->  
      <div class="app-card" id="nuevoCultivoCard" style="margin-top: 12px; display:none;">  
        <div class="app-card-header">  
          <div class="app-card-title" id="nuevoCultivoTitulo">Nuevo cultivo</div>  
          <span class="chip badge">Personalizado</span>  
        </div>  

        <div class="form-grid form-grid--2">  
          <div class="field">  
            <label for="nuevoCultivoNombre">Nombre del cultivo *</label>  
            <input type="text" id="nuevoCultivoNombre" placeholder="Ej. cilantro criollo" />  
          </div>  
          <div class="field">  
            <label for="nuevoCultivoCategoria">Categor√≠a</label>  
            <select id="nuevoCultivoCategoria">  
              <option value="Hoja">Hoja</option>  
              <option value="Fruto">Fruto</option>  
              <option value="Ra√≠z">Ra√≠z</option>  
              <option value="Tub√©rculo">Tub√©rculo</option>  
              <option value="Arom√°tica">Arom√°tica</option>  
              <option value="Frutal perenne">Frutal perenne</option>  
              <option value="Otro">Otro</option>  
            </select>  
          </div>  
        </div>  

        <div class="form-grid form-grid--2">  
          <div class="field">  
            <label for="nuevoCultivoDiasGerminacion">D√≠as de germinaci√≥n (opcional)</label>  
            <input type="number" id="nuevoCultivoDiasGerminacion" min="0" placeholder="Ej. 7" />  
          </div>  
          <div class="field">  
            <label for="nuevoCultivoDiasCosecha">D√≠as hasta cosecha (opcional)</label>  
            <input type="number" id="nuevoCultivoDiasCosecha" min="0" placeholder="Ej. 90" />  
          </div>  
        </div>  

        <div class="form-grid form-grid--2">  
          <div class="field">  
            <label for="nuevoCultivoLuz">Luz</label>  
            <input type="text" id="nuevoCultivoLuz" placeholder="Ej. Sol directo (6‚Äì8 h)" />  
          </div>  
          <div class="field">  
            <label for="nuevoCultivoRiego">Riego</label>  
            <input type="text" id="nuevoCultivoRiego" placeholder="Ej. Suelo siempre ligeramente h√∫medo" />  
          </div>  
        </div>  

        <div class="form-grid form-grid--2">  
          <div class="field">  
            <label for="nuevoCultivoTiesto">Tiesto / suelo</label>  
            <input type="text" id="nuevoCultivoTiesto" placeholder="Ej. Maceta 5+ galones o suelo directo" />  
          </div>  
          <div class="field">  
            <label for="nuevoCultivoProfundidad">Profundidad de siembra</label>  
            <input type="text" id="nuevoCultivoProfundidad" placeholder="Ej. 0.5‚Äì1 cm" />  
          </div>  
        </div>  

        <div class="field">  
          <label for="nuevoCultivoPlagas">Plagas frecuentes (separadas por coma)</label>  
          <input type="text" id="nuevoCultivoPlagas" placeholder="Ej. pulgones, babosas, hongos" />  
        </div>  

        <div class="field" style="margin-top: 10px;">  
          <label>Meses de siembra (para recomendaciones del Calendario)</label>  
          <div class="pill-group" id="nuevoCultivoMesesPills">  
            <button type="button" class="pill" data-mes="0">Ene</button><button type="button" class="pill" data-mes="1">Feb</button>  
            <button type="button" class="pill" data-mes="2">Mar</button><button type="button" class="pill" data-mes="3">Abr</button>  
            <button type="button" class="pill" data-mes="4">May</button><button type="button" class="pill" data-mes="5">Jun</button>  
            <button type="button" class="pill" data-mes="6">Jul</button><button type="button" class="pill" data-mes="7">Ago</button>  
            <button type="button" class="pill" data-mes="8">Sep</button><button type="button" class="pill" data-mes="9">Oct</button>  
            <button type="button" class="pill" data-mes="10">Nov</button><button type="button" class="pill" data-mes="11">Dic</button>  
          </div>  
          <p class="muted" style="margin-top:6px;">Si no seleccionas ninguno, se asumir√° <strong>todo el a√±o</strong>.</p>  
        </div>  

        <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">  
          <button type="button" class="btn" id="btnGuardarNuevoCultivo">Guardar cultivo</button>  
          <button type="button" class="btn btn-secondary" id="btnCancelarNuevoCultivo">Cancelar</button>  
        </div>  

        <p class="muted" style="margin-top: 10px;">  
          El cultivo se guardar√° en este dispositivo y aparecer√° en el cat√°logo como <strong>‚ÄúCultivo personalizado‚Äù</strong>.  
        </p>  
      </div>  
    </div>  
  </section>  

  <!-- MI HUERTO -->  
  <section id="section-huerto" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üåø</div><h2>Mi huerto</h2></div>  
    <p class="section-subtitle">Registra tus cultivos y consulta los detalles de cada planta.</p>  

    <div class="app-card">  
      <div class="app-card-header">  
        <div class="app-card-title">Nuevo cultivo</div>  
        <div class="chip badge">Registro r√°pido</div>  
      </div>  
      <div class="media-list settings-context"></div>  

      <div class="form-grid form-grid--2">  
        <div class="field">  
          <label for="cultivoNombre">Nombre del cultivo *</label>  
          <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />  
        </div>  
        <div class="field">  
          <label for="cultivoVariedad">Variedad (opcional)</label>  
          <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />  
        </div>  
      </div>  

      <div class="form-grid form-grid--2">  
        <div class="field">  
          <label for="cultivoTipo">Tipo</label>  
          <select id="cultivoTipo">  
            <option value="hoja">Hoja</option>  
            <option value="fruto">Fruto</option>  
            <option value="raiz">Ra√≠z</option>  
            <option value="tuberculo">Tub√©rculo</option>  
            <option value="aromaticas">Arom√°ticas</option>  
            <option value="otro">Otro</option>  
          </select>  
        </div>  
        <div class="field">  
          <label for="cultivoFecha">Fecha de siembra</label>  
          <input type="date" id="cultivoFecha" />  
        </div>  
      </div>  

      <div class="field">  
        <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>  
        <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>  
      </div>  

      <button class="btn btn-full" id="btnAgregarCultivo"><span>‚ûï</span> Guardar cultivo</button>  
      <p class="muted" style="margin-top:6px;">* Solo el nombre es obligatorio. Puedes editar o eliminar los cultivos luego.</p>  
    </div>  

    <div class="app-card">  
      <div class="app-card-header">  
        <div class="app-card-title">Cultivos registrados</div>  
        <div class="chip" id="cultivosCountChip">0 cultivos</div>  
      </div>  
      <div class="cultivos-list" id="cultivosList"></div>  
    </div>  
  </section>  

  <!-- DIARIO -->  
  <section id="section-diario" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üìì</div><h2>Diario de huerto</h2></div>  
    <p class="section-subtitle">Anota riegos, abonados, podas o cualquier evento importante.</p>  

    <div class="app-card" id="diarioFormCard">  
      <div class="app-card-header">  
        <div class="app-card-title" id="diarioFormTitle">Nueva entrada</div>  
        <div class="chip badge">Hoy</div>  
      </div>  
      <div class="field">  
        <label for="diarioTexto">¬øQu√© hiciste hoy?</label>  
        <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates y lechugas. Apliqu√© compost."></textarea>  
      </div>  
      <button class="btn btn-full" id="btnGuardarDiario"><span>üíæ</span> Guardar en el diario</button>  
    </div>  

    <div class="app-card">  
      <div class="app-card-header">  
        <div class="app-card-title">Entradas recientes</div>  
        <div class="chip" id="diarioCountChip">0 entradas</div>  
      </div>  

      <div class="pill-group" id="diarioFiltros">  
        <button class="pill pill--active" data-filtro="todos">Todo</button>  
        <button class="pill" data-filtro="Riego">Riego</button>  
        <button class="pill" data-filtro="Abono">Abono</button>  
        <button class="pill" data-filtro="General">General</button>  
      </div>  

      <p class="muted" id="diarioResumenHoy"></p>  
      <div class="diario-list" id="diarioList"></div>  

      <button class="btn btn-secondary btn-full" id="btnExportarDiarioPdf"><span>üì¶</span> Exportar diario (PDF)</button>  
    </div>  
  </section>  

  <!-- PLAGAS -->  
  <section id="section-plagas" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üêõ</div><h2>Plagas comunes</h2></div>  
    <p class="section-subtitle">Referencia r√°pida de plagas frecuentes en huertos caseros y c√≥mo manejarlas.</p>  
    <div class="app-card">  
      <div class="app-card-header"><div class="app-card-title">Cat√°logo b√°sico de plagas</div><div class="chip">Referencia</div></div>  
      <div class="media-list" id="plagasList"></div>  
    </div>  
  </section>  

  <!-- PESTICIDAS -->  
  <section id="section-pesticidas" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üíß</div><h2>Pesticidas y preparados</h2></div>  
    <p class="section-subtitle">Opciones suaves y de bajo impacto para manejar plagas en un huerto casero.</p>  
    <div class="app-card">  
      <div class="app-card-header"><div class="app-card-title">Preparados sugeridos</div><div class="chip">Uso responsable</div></div>  
      <div class="media-list" id="pesticidasList"></div>  
    </div>  
  </section>  

  <!-- OPCIONES -->  
  <section id="section-opciones" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">‚öôÔ∏è</div><h2>Opciones</h2></div>  
    <p class="section-subtitle">Ajusta el nombre de tu huerto, el clima y el hemisferio.</p>  

    <div class="app-card">  
      <div class="app-card-header"><div class="app-card-title">Datos generales</div></div>  
      <div class="media-list settings-context"></div>  

      <div class="form-grid">  
        <div class="field">  
          <label for="nombreHuerto">Nombre de huerto</label>  
          <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG, Mi huerto, etc." />  
        </div>  
      </div>  

      <div class="form-grid form-grid--2">  
        <div class="field">  
          <label for="climaSelect">Clima principal</label>  
          <select id="climaSelect">  
            <option value="tropical">Tropical (Caribe, PR, etc.)</option>  
            <option value="subtropical">Subtropical / templado suave</option>  
            <option value="templado">Templado / fr√≠o</option>  
          </select>  
        </div>  
        <div class="field">  
          <label for="hemisferioSelect">Hemisferio</label>  
          <select id="hemisferioSelect">  
            <option value="norte">Hemisferio norte</option>  
            <option value="sur">Hemisferio sur</option>  
          </select>  
        </div>  
      </div>  

      <button class="btn btn-full" id="btnGuardarConfig"><span>üíæ</span> Guardar configuraci√≥n</button>  

      <div class="divider-soft"></div>  
      <p class="muted">Toda la informaci√≥n se guarda <strong>solo en tu dispositivo</strong> usando almacenamiento local.</p>  

      <div class="pill-group" style="flex-direction:column;">  
        <button class="btn btn-secondary btn-full" id="btnExportarDatosPdf"><span>üìÑ</span> Exportar datos (PDF)</button>  
        <button class="btn btn-secondary btn-full" id="btnExportarJson"><span>üíæ</span> Exportar respaldo (.json)</button>  
        <button class="btn btn-secondary btn-full" id="btnImportarJson"><span>üç∞</span> Restaurar respaldo</button>  
        <button class="btn btn-danger btn-full" id="btnBorrarTodo"><span>üßπ</span> Borrar todo</button>  
      </div>  

      <input type="file" id="inputRespaldoJSON" accept="application/json" style="display:none" />  
    </div>  
  </section>  

  <!-- GUIAS -->  
  <section id="section-guias" class="section">  
    <div class="section-title-row"><div class="section-icon-pill">üìö</div><h2>Gu√≠as r√°pidas</h2></div>  
    <p class="section-subtitle">Consejos b√°sicos para sacar m√°s provecho a tu huerto.</p>  

    <div class="app-card">  
      <div class="app-card-header"><div class="app-card-title">Antes de sembrar</div><div class="chip">Paso 1</div></div>  
      <div class="media-list">  
        <div>  
          <div class="media-item-title">Preparar el suelo</div>  
          <div class="media-item-body">Retira piedras y ra√≠ces gruesas, agrega materia org√°nica y afloja la tierra sin voltearla en exceso.</div>  
        </div>  
        <div>  
          <div class="media-item-title">Elegir el lugar</div>  
          <div class="media-item-body">La mayor√≠a de los cultivos necesitan al menos 4‚Äì6 horas de sol directo.</div>  
        </div>  
      </div>  
    </div>  

    <div class="app-card">  
      <div class="app-card-header"><div class="app-card-title">Riego inteligente</div><div class="chip">Paso 2</div></div>  
      <div class="media-list">  
        <div>  
          <div class="media-item-title">Revisar la humedad</div>  
          <div class="media-item-body">Antes de regar, introduce un dedo en el sustrato hasta 2‚Äì3 cm. Si est√° h√∫medo, espera.</div>  
        </div>  
        <div>  
          <div class="media-item-title">Horario recomendado</div>  
          <div class="media-item-body">En climas c√°lidos suele ser mejor regar temprano en la ma√±ana o al final de la tarde.</div>  
        </div>  
      </div>  
    </div>  
  </section>  
</main>  

<footer><span>Mi Siembra Inteligente ¬∑ Datos guardados localmente en tu dispositivo üåø</span></footer>

  </div>    <!-- Banner instalar PWA -->    <div id="installBanner" class="hidden">  
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>  
    <button class="btn btn-secondary" id="btnInstalarPwa"><span>üì≤</span> Instalar</button>  
  </div>   
    <script>  
    "use strict";  
  
    // ===== Guard: errores globales claros =====  
    window.addEventListener("error", (e) => {  
      console.error("üí• JS Error:", e.message, "\nArchivo:", e.filename, "\nL√≠nea:", e.lineno, "\nCol:", e.colno, "\n", e.error);  
      alert(`Error: ${e.message}\n(L√≠nea ${e.lineno})\nAbre consola para ver detalles.`);  
    });  
  
    window.addEventListener("unhandledrejection", (e) => {  
      console.error("üí• Promise rejection:", e.reason);  
      alert("Error interno (promesa). Abre la consola para ver el detalle.");  
    });  
  
    // ===== Helpers =====  
    function escapeHTML(str) {  
      return String(str ?? "")  
        .replaceAll("&", "&amp;")  
        .replaceAll("<", "&lt;")  
        .replaceAll(">", "&gt;")  
        .replaceAll('"', "&quot;")  
        .replaceAll("'", "&#39;");  
    }  
  
    function normText(s) {  
      return String(s || "")  
        .toLowerCase()  
        .normalize("NFD")  
        .replace(/[\u0300-\u036f]/g, "");  
    }  
  
    function todayISO() {  
      const d = new Date();  
      return d.toISOString().slice(0, 10);  
    }  
  
    function addDays(dateISO, days) {  
      if (!dateISO || !Number.isFinite(days)) return dateISO;  
      const d = new Date(dateISO + "T00:00:00");  
      if (Number.isNaN(d.getTime())) return dateISO;  
      d.setDate(d.getDate() + days);  
      return d.toISOString().slice(0, 10);  
    }  
  
    function safeISO(dateStr) {  
      if (!dateStr) return null;  
      const d = new Date(dateStr + "T00:00:00");  
      return Number.isNaN(d.getTime()) ? null : dateStr;  
    }  
  
    function daysBetween(fromISO, toISO) {  
      const a = new Date(fromISO + "T00:00:00");  
      const b = new Date(toISO + "T00:00:00");  
      if (Number.isNaN(a.getTime()) || Number.isNaN(b.getTime())) return null;  
      const ms = b.getTime() - a.getTime();  
      return Math.floor(ms / (1000 * 60 * 60 * 24));  
    }  
  
    function formatDate(dateStr) {  
      if (!dateStr) return "Sin fecha";  
      const d = new Date(dateStr + "T00:00:00");  
      if (Number.isNaN(d.getTime())) return dateStr;  
      const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];  
      const dia = d.getDate().toString().padStart(2, "0");  
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;  
    }  
  
    /*********************  
     * Storage  
     *********************/  
    const STORAGE_KEYS = {  
      settings: "msi-settings",  
      cultivos: "msi-cultivos",  
      diario: "msi-diario"  
    };  
  
    const STORAGE_CUSTOM_CULTIVOS = "msi-custom-cultivos-v17";  
  
    const DEFAULT_SETTINGS = {  
      nombreHuerto: "Mi huerto",  
      clima: "tropical",  
      hemisferio: "norte"  
    };  
  
    const CLIMA_LABEL = {  
      tropical: "tropical",  
      subtropical: "subtropical/templado",  
      templado: "templado/fr√≠o"  
    };  
  
    const HEMISFERIO_LABEL = {  
      norte: "hemisferio norte",  
      sur: "hemisferio sur"  
    };  
  
    function loadSettings() {  
      try {  
        const raw = localStorage.getItem(STORAGE_KEYS.settings);  
        if (!raw) return { ...DEFAULT_SETTINGS };  
        const parsed = JSON.parse(raw);  
        return { ...DEFAULT_SETTINGS, ...(parsed && typeof parsed === "object" ? parsed : {}) };  
      } catch { return { ...DEFAULT_SETTINGS }; }  
    }  
  
    function saveSettings(settings) {  
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings));  
    }  
  
    function loadCultivos() {  
      try {  
        const raw = localStorage.getItem(STORAGE_KEYS.cultivos);  
        const arr = raw ? JSON.parse(raw) : [];  
        return Array.isArray(arr) ? arr : [];  
      } catch { return []; }  
    }  
  
    function saveCultivos(list) {  
      localStorage.setItem(STORAGE_KEYS.cultivos, JSON.stringify(list));  
    }  
  
    function loadDiario() {  
      try {  
        const raw = localStorage.getItem(STORAGE_KEYS.diario);  
        const arr = raw ? JSON.parse(raw) : [];  
        return Array.isArray(arr) ? arr : [];  
      } catch { return []; }  
    }  
  
    function saveDiario(list) {  
      localStorage.setItem(STORAGE_KEYS.diario, JSON.stringify(list));  
    }  
  
    function loadCustomCultivos() {  
      try {  
        const raw = localStorage.getItem(STORAGE_CUSTOM_CULTIVOS);  
        const arr = raw ? JSON.parse(raw) : [];  
        return Array.isArray(arr) ? arr : [];  
      } catch { return []; }  
    }  
  
    function saveCustomCultivos(arr) {  
      try { localStorage.setItem(STORAGE_CUSTOM_CULTIVOS, JSON.stringify(arr)); }  
      catch (e) { console.error("Error guardando custom:", e); }  
    }  
  
    /*********************  
     * Normalizaci√≥n (riego/abono/rotaci√≥n)  
     *********************/  
    function normalizeCultivo(c) {  
      const hoy = todayISO();  
      const out = { ...c };  
  
      out.ultimoRiego = safeISO(out.ultimoRiego);  
      out.ultimaFertilizacion = safeISO(out.ultimaFertilizacion);  
      out.ultimaRotacion = safeISO(out.ultimaRotacion);  
  
      if (!Number.isFinite(out.frecuenciaRiegoDias) || out.frecuenciaRiegoDias <= 0) out.frecuenciaRiegoDias = 3;  
      if (!Number.isFinite(out.frecuenciaAbonoDias) || out.frecuenciaAbonoDias <= 0) out.frecuenciaAbonoDias = 30;  
  
      if (out.rotacionDias != null) {  
        const r = parseInt(out.rotacionDias, 10);  
        out.rotacionDias = Number.isFinite(r) && r > 0 ? r : null;  
      } else out.rotacionDias = null;  
  
      out.fechaSiembra = safeISO(out.fechaSiembra) || out.fechaSiembra || hoy;  
      out.creadoEl = safeISO(out.creadoEl) || out.creadoEl || hoy;  
  
      return out;  
    }  
  
    function normalizeAllCultivos(list) {  
      const arr = Array.isArray(list) ? list.map(normalizeCultivo) : [];  
      return arr;  
    }  
  
    /*********************  
     * Calendario de siembra  
     *********************/  
    const CALENDARIO_SIEMBRA = {  
      tropical: {  
        5: [  
          { titulo: "Re-siembra de lechugas", tipo: "Hoja", detalle: "Siembra escalonada cada 2‚Äì3 semanas para cosechas continuas." },  
          { titulo: "R√°banos", tipo: "Ra√≠z", detalle: "Cosecha r√°pida (20‚Äì30 d√≠as). Perfectos para ocupar huecos libres." }  
        ],  
        6: [  
          { titulo: "Berenjena", tipo: "Fruto", detalle: "Le gustan las noches c√°lidas. Ideal para verano tropical." },  
          { titulo: "Aj√≠es y pimientos", tipo: "Fruto", detalle: "Sembrar en lugar soleado y con buen drenaje." }  
        ]  
      },  
      subtropical: {  
        5: [{ titulo: "Tomates de media estaci√≥n", tipo: "Fruto", detalle: "Elige variedades adaptadas a tu regi√≥n." }]  
      },  
      templado: {  
        2: [{ titulo: "Lechugas de primavera", tipo: "Hoja", detalle: "Siembra temprana bajo protecci√≥n ligera si hay riesgo de heladas." }]  
      }  
    };  
  
    function ajustarMesPorHemisferio(settings, monthIndex) {  
      const climaKey = settings.clima || "tropical";  
      let mes = monthIndex;  
      if (settings.hemisferio === "sur" && (climaKey === "templado" || climaKey === "subtropical")) {  
        mes = (monthIndex + 6) % 12;  
      }  
      return mes;  
    }  
  
    function getCalendarData(settings, monthIndex) {  
      const climaKey = settings.clima || "tropical";  
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);  
      const base = CALENDARIO_SIEMBRA[climaKey] || {};  
      return base[mesAjustado] || [];  
    }  
  
    /*********************  
     * Cat√°logo base  
     *********************/  
    const CATALOGO_CULTIVOS = [  
      { id:"tomate", nombre:"Tomate", categoria:"Fruto", dias:"70‚Äì90 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, sin encharcar", tiesto:"Macetas profundas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones","Mosca blanca","Orugas"], meses:[0,1,2,3,4,5,6,7], imagen:"img/tomate.jpg" },  
      { id:"lechuga", nombre:"Lechuga", categoria:"Hoja", dias:"45‚Äì60 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo siempre ligeramente h√∫medo", tiesto:"Macetas anchas de 3+ galones", profundidad:"0.5 cm", plagas:["Babosas","Caracoles","Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/lechuga.jpg" },  
      { id:"pepinillo", nombre:"Pepinillo / Pepino", categoria:"Fruto", dias:"60‚Äì90 d√≠as", luz:"Sol directo", riego:"Abundante y constante", tiesto:"Macetas profundas de 5+ galones con tutor", profundidad:"1‚Äì2 cm", plagas:["Mosca blanca","√Åcaros","Hongos"], meses:[3,4,5,6,7,8], imagen:"img/pepinillo.jpg" },  
      { id:"platano", nombre:"Pl√°tano", categoria:"Fruto perenne", dias:"Cosecha a partir de 9‚Äì12 meses", luz:"Sol directo", riego:"Regular, le gusta la humedad", tiesto:"Suelo directo, espacio amplio", profundidad:"Cormo enterrado firmemente", plagas:["Picudo del pl√°tano","Sigatoka"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/platano.jpg" },  
      { id:"pimiento_morron", nombre:"Pimiento morr√≥n", categoria:"Fruto", dias:"80‚Äì100 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, evitando encharcamientos", tiesto:"Macetas de 4‚Äì5 galones", profundidad:"0.5 cm", plagas:["Pulgones","Trips","Ara√±a roja"], meses:[2,3,4,5,6,7], imagen:"img/pimiento_morron.jpg" },  
      { id:"berenjena", nombre:"Berenjena", categoria:"Fruto", dias:"80‚Äì100 d√≠as", luz:"Sol directo", riego:"Constante, sin encharcar", tiesto:"Macetas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Escarabajos","Pulgones","Ara√±a roja"], meses:[3,4,5,6,7,8], imagen:"img/berenjena.jpg" },  
      { id:"rabano", nombre:"R√°bano", categoria:"Ra√≠z", dias:"25‚Äì35 d√≠as", luz:"Sol directo o media sombra", riego:"Suelo constantemente h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"1 cm", plagas:["Pulguillas","Babosas"], meses:[0,1,2,3,8,9,10,11], imagen:"img/rabano.jpg" },  
      { id:"cilantro", nombre:"Cilantro", categoria:"Arom√°tica", dias:"30‚Äì50 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo fresco y h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/cilantro.jpg" },  
      { id:"albahaca", nombre:"Albahaca", categoria:"Arom√°tica", dias:"40‚Äì60 d√≠as", luz:"Sol directo suave", riego:"Suelo ligeramente h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"0.5 cm", plagas:["Pulgones","Mosca blanca"], meses:[2,3,4,5,6,7,8], imagen:"img/albahaca.jpg" },  
      { id:"limon", nombre:"Lim√≥n", categoria:"Frutal c√≠trico", dias:"2‚Äì3 a√±os desde plant√≠n", luz:"Sol directo", riego:"Regular en sequ√≠a", tiesto:"Macet√≥n grande o suelo directo", profundidad:"Plant√≠n al nivel del cuello", plagas:["Minador de hoja","Cochinillas"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/limon.jpg" }  
    ];  
  
    function removeCustomFromCatalogo() {  
      for (let i = CATALOGO_CULTIVOS.length - 1; i >= 0; i--) {  
        if (CATALOGO_CULTIVOS[i]?.esPersonalizado) CATALOGO_CULTIVOS.splice(i, 1);  
      }  
    }  
  
    function injectCustomIntoCatalogo(customList) {  
      removeCustomFromCatalogo();  
      (customList || []).forEach(c => CATALOGO_CULTIVOS.push({ ...c, esPersonalizado: true }));  
    }  
  
    /*********************  
     * Germinaci√≥n / reproducci√≥n  
     *********************/  
    const GERMINACION_POR_CULTIVO = {  
      tomate: {  
        titulo: "Tomate ‚Äì germinaci√≥n",  
        metodo: "Semilla en alm√°cigo y luego trasplante.",  
        pasos: [  
          "Llenar bandeja o alm√°cigo con sustrato suelto y bien drenado.",  
          "Sembrar la semilla a 0.5‚Äì1 cm de profundidad.",  
          "Mantener siempre ligeramente h√∫medo, sin encharcar.",  
          "Trasplantar cuando tenga 3‚Äì4 hojas verdaderas."  
        ],  
        tip: "Al inicio prefieren luz filtrada, no sol directo fuerte."  
      },  
      lechuga: {  
        titulo: "Lechuga ‚Äì germinaci√≥n",  
        metodo: "Semilla directa o en alm√°cigo.",  
        pasos: [  
          "Sembrar muy superficial, apenas cubierta de sustrato.",  
          "Mantener el sustrato siempre h√∫medo.",  
          "En alm√°cigo: trasplantar con 3‚Äì4 hojas.",  
          "En directa: ralear, dejando espacio."  
        ],  
        tip: "Germina mejor con temperaturas moderadas y sol suave."  
      }  
    };  
  
    const GERMINACION_GENERIC = {  
      hoja: { titulo:"Cultivos de hoja ‚Äì germinaci√≥n b√°sica", metodo:"Semilla directa o alm√°cigo, muy superficial.", pasos:["Sustrato suelto y drenado.","Sembrar casi en superficie.","Humedad constante sin charcos.","Trasplantar con 3‚Äì4 hojas."], tip:"Sol suave o media sombra y riegos frecuentes." },  
      fruto:{ titulo:"Cultivos de fruto ‚Äì germinaci√≥n b√°sica", metodo:"Alm√°cigo o directa seg√∫n espacio.", pasos:["Sembrar a 1‚Äì2 cm.","Humedad constante.","Buena luz para que no se espiguen.","Trasplantar cuando est√©n fuertes."], tip:"Mucho sol y macetas profundas." },  
      raiz: { titulo:"Ra√≠ces ‚Äì germinaci√≥n b√°sica", metodo:"Siempre semilla directa.", pasos:["Aflojar suelo profundo.","Sembrar 0.5‚Äì1 cm.","Humedad constante.","Ralear."], tip:"No trasplantar: se deforman." },  
      aromatica:{ titulo:"Arom√°ticas ‚Äì germinaci√≥n b√°sica", metodo:"Semilla fina o esquejes.", pasos:["Semilla superficial.","Humedad fina.","Luz sin sol fuerte al inicio.","Trasplantar cuando el cepell√≥n est√© firme."], tip:"Muchas prefieren maceta." },  
      frutal:{ titulo:"Frutales ‚Äì establecimiento b√°sico", metodo:"Plantines o injertos.", pasos:["Plant√≠n sano.","Hoyo amplio con materia org√°nica.","Plantar al nivel del cuello.","Riego inicial y tutor si hace falta."], tip:"Sol y paciencia." },  
      generico:{ titulo:"Germinaci√≥n b√°sica ‚Äì gu√≠a general", metodo:"Semilla directa o bandeja.", pasos:["Leer sobre/variedad.","Sustrato limpio.","Profundidad 2‚Äì3x tama√±o semilla.","Humedad constante."], tip:"Prueba 2 m√©todos y observa." }  
    };  
  
    function getInfoGerminacion(cultivoId) {  
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);  
      if (!cultivo) return null;  
      if (GERMINACION_POR_CULTIVO[cultivoId]) return GERMINACION_POR_CULTIVO[cultivoId];  
  
      const cat = (cultivo.categoria || "").toLowerCase();  
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;  
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;  
      if (cat.includes("arom√°tica") || cat.includes("aromatica")) return GERMINACION_GENERIC.aromatica;  
      if (cat.includes("frutal")) return GERMINACION_GENERIC.frutal;  
      if (cat.includes("fruto")) return GERMINACION_GENERIC.fruto;  
      return GERMINACION_GENERIC.generico;  
    }  
  
    /*********************  
     * Plagas (datos base)  
     *********************/  
    const PLAGAS_DATA = [  
      { id:"pulgones", nombre:"Pulgones", comoSeVe:"Insectos peque√±os en brotes; hojas enrolladas.", manejoSuave:"Lavar con agua suave y revisar brotes.", preparadosCaseros:"Jab√≥n pot√°sico diluido al atardecer.", productosComerciales:"Insecticidas de contacto autorizados." },  
      { id:"mosca_blanca", nombre:"Mosca blanca", comoSeVe:"Volantitos blancos al mover la hoja.", manejoSuave:"Retirar hojas afectadas y ventilar.", preparadosCaseros:"Trampas amarillas + jab√≥n pot√°sico.", productosComerciales:"Productos espec√≠ficos dom√©sticos." },  
      { id:"arana_roja", nombre:"Ara√±a roja", comoSeVe:"Punteado amarillo y telara√±as finas.", manejoSuave:"Aumentar humedad y lavar env√©s.", preparadosCaseros:"Jab√≥n pot√°sico muy diluido.", productosComerciales:"Acaricidas espec√≠ficos." },  
      { id:"hongos_hoja", nombre:"Hongos de hoja (mildiu, o√≠dio, manchas)", comoSeVe:"Manchas o polvillo blanco.", manejoSuave:"Ventilar, no mojar de noche, retirar hojas.", preparadosCaseros:"Bicarbonato suave.", productosComerciales:"Fungicidas autorizados." }  
    ];  
  
    /*********************  
     * Estado global  
     *********************/  
    let stateSettings = loadSettings();  
    let stateCultivos = normalizeAllCultivos(loadCultivos());  
    let stateDiario = loadDiario();  
  
    // Migraci√≥n defaults recomendada  
    saveCultivos(stateCultivos);  
  
    let diarioFiltroActual = "todos";  
    let diarioEnEdicionId = null;  
  
    /*********************  
     * Pendientes + Acciones r√°pidas  
     *********************/  
    function calcNextDate(ultimaISO, frecuenciaDias) {  
      const base = safeISO(ultimaISO) || todayISO();  
      return addDays(base, frecuenciaDias);  
    }  
  
    function getPendientes({ rangeDays = 0 } = {}) {  
      const hoy = todayISO();  
      const fin = rangeDays > 0 ? addDays(hoy, rangeDays) : hoy;  
      const items = [];  
  
      stateCultivos.forEach(c => {  
        const nombre = c.nombre || "Cultivo";  
  
        // RIEGO  
        if (c.frecuenciaRiegoDias) {  
          const proxima = calcNextDate(c.ultimoRiego, c.frecuenciaRiegoDias);  
          const d = daysBetween(hoy, proxima);  
  
          if (proxima < hoy) {  
            const atras = daysBetween(proxima, hoy);  
            items.push({ tipo:"Riego", cultivoId:c.id, nombre, fecha:hoy, texto:`${nombre}: riego atrasado (${atras} d√≠a(s))` });  
          } else if (d !== null && proxima >= hoy && proxima <= fin) {  
            items.push({ tipo:"Riego", cultivoId:c.id, nombre, fecha:proxima, texto: d === 0 ? `${nombre}: riego hoy` : `${nombre}: riego en ${d} d√≠a(s)` });  
          }  
        }  
  
        // ABONO  
        if (c.frecuenciaAbonoDias) {  
          const proxima = calcNextDate(c.ultimaFertilizacion, c.frecuenciaAbonoDias);  
          const d = daysBetween(hoy, proxima);  
  
          if (proxima < hoy) {  
            const atras = daysBetween(proxima, hoy);  
            items.push({ tipo:"Abono", cultivoId:c.id, nombre, fecha:hoy, texto:`${nombre}: abono atrasado (${atras} d√≠a(s))` });  
          } else if (d !== null && proxima >= hoy && proxima <= fin) {  
            items.push({ tipo:"Abono", cultivoId:c.id, nombre, fecha:proxima, texto: d === 0 ? `${nombre}: abono hoy` : `${nombre}: abono en ${d} d√≠a(s)` });  
          }  
        }  
  
        // ROTACI√ìN (opcional)  
        if (c.rotacionDias) {  
          const proxima = calcNextDate(c.ultimaRotacion, c.rotacionDias);  
          const d = daysBetween(hoy, proxima);  
  
          if (proxima < hoy) {  
            const atras = daysBetween(proxima, hoy);  
            items.push({ tipo:"Rotaci√≥n", cultivoId:c.id, nombre, fecha:hoy, texto:`${nombre}: rotaci√≥n atrasada (${atras} d√≠a(s))` });  
          } else if (d !== null && proxima >= hoy && proxima <= fin) {  
            items.push({ tipo:"Rotaci√≥n", cultivoId:c.id, nombre, fecha:proxima, texto: d === 0 ? `${nombre}: rotaci√≥n hoy` : `${nombre}: rotaci√≥n en ${d} d√≠a(s)` });  
          }  
        }  
      });  
  
      items.sort((a, b) => (a.fecha || "").localeCompare(b.fecha || "") || (a.tipo || "").localeCompare(b.tipo || ""));  
      return items;  
    }  
  
    function renderPendientesEnInicio() {  
      const el = document.getElementById("pendientesHoy");  
      if (!el) return;  
  
      if (!stateCultivos.length) {  
        el.textContent = "Pendientes: a√±ade tu primer cultivo en ‚ÄúMi huerto‚Äù.";  
        return;  
      }  
  
      const hoy = getPendientes({ rangeDays: 0 });  
      if (!hoy.length) {  
        el.textContent = "Pendientes: nada para hoy ‚úÖ";  
        return;  
      }  
  
      const top = hoy.slice(0, 5).map(i => `‚Ä¢ ${i.texto}`).join("\n");  
      el.innerHTML =  
        `<strong>Pendientes hoy:</strong><br>${escapeHTML(top).replace(/\n/g, "<br>")}` +  
        (hoy.length > 5 ? `<br><span class="muted">(+${hoy.length - 5} m√°s)</span>` : "");  
    }  
  
    function getCultivoUrgente() {  
      const hoy = todayISO();  
      if (!Array.isArray(stateCultivos) || !stateCultivos.length) return null;  
  
      const ranked = stateCultivos.map(c => {  
        const fr = Number.isFinite(c.frecuenciaRiegoDias) ? c.frecuenciaRiegoDias : null;  
        const fa = Number.isFinite(c.frecuenciaAbonoDias) ? c.frecuenciaAbonoDias : null;  
  
        const lastR = c.ultimoRiego || c.fechaSiembra || c.creadoEl || null;  
        const lastA = c.ultimaFertilizacion || c.fechaSiembra || c.creadoEl || null;  
  
        let overdueR = null, overdueA = null;  
  
        if (fr && lastR) {  
          const d = daysBetween(lastR, hoy);  
          if (d !== null) overdueR = d - fr;  
        }  
        if (fa && lastA) {  
          const d = daysBetween(lastA, hoy);  
          if (d !== null) overdueA = d - fa;  
        }  
  
        const scoreR = overdueR === null ? -9999 : (overdueR > 0 ? 1000 + overdueR : -Math.abs(overdueR));  
        const scoreA = overdueA === null ? -9999 : (overdueA > 0 ? 800 + overdueA : -Math.abs(overdueA));  
        const score = Math.max(scoreR, scoreA);  
        const tipoUrgente = (scoreR >= scoreA) ? "riego" : "abono";  
  
        return { c, score, tipoUrgente, overdueR, overdueA };  
      });  
  
      ranked.sort((x, y) => y.score - x.score);  
      return ranked[0];  
    }  
  
    function updateAccionesRapidasUI() {  
      const chip = document.getElementById("accionesRapidasChip");  
      const desc = document.getElementById("accionesRapidasDesc");  
      const det  = document.getElementById("accionesRapidasDetalle");  
      const btnR = document.getElementById("btnQuickRiego");  
      const btnA = document.getElementById("btnQuickAbono");  
      if (!chip || !desc || !det || !btnR || !btnA) return;  
  
      if (!stateCultivos.length) {  
        chip.textContent = "Sin cultivos";  
        desc.textContent = 'Primero a√±ade un cultivo en "Mi huerto".';  
        det.textContent = "‚Äî";  
        btnR.disabled = true; btnA.disabled = true;  
        btnR.style.opacity = 0.55; btnA.style.opacity = 0.55;  
        return;  
      }  
  
      const urgente = getCultivoUrgente();  
      if (!urgente) {  
        chip.textContent = "Listo";  
        desc.textContent = "No hay pendientes por ahora.";  
        det.textContent = "‚Äî";  
        btnR.disabled = false; btnA.disabled = false;  
        btnR.style.opacity = 1; btnA.style.opacity = 1;  
        return;  
      }  
  
      const nombre = urgente.c.nombre + (urgente.c.variedad ? ` (${urgente.c.variedad})` : "");  
      chip.textContent = `Prioridad: ${urgente.tipoUrgente === "riego" ? "Riego" : "Abono"}`;  
  
      const rTxt = (urgente.overdueR === null) ? "Riego: ‚Äî"  
        : (urgente.overdueR > 0 ? `Riego vencido por ${urgente.overdueR} d√≠a(s)` : `Riego en ${Math.abs(urgente.overdueR)} d√≠a(s)`);  
      const aTxt = (urgente.overdueA === null) ? "Abono: ‚Äî"  
        : (urgente.overdueA > 0 ? `Abono vencido por ${urgente.overdueA} d√≠a(s)` : `Abono en ${Math.abs(urgente.overdueA)} d√≠a(s)`);  
  
      desc.textContent = `Cultivo sugerido: ${nombre}`;  
      det.textContent = `${rTxt} ¬∑ ${aTxt}`;  
  
      btnR.disabled = false; btnA.disabled = false;  
      btnR.style.opacity = 1; btnA.style.opacity = 1;  
  
      btnR.dataset.id = urgente.c.id;  
      btnA.dataset.id = urgente.c.id;  
    }  
  
    function quickRegistrar(tipo) {  
      const btn = (tipo === "riego") ? document.getElementById("btnQuickRiego") : document.getElementById("btnQuickAbono");  
      const id = btn?.dataset?.id;  
      if (!id) { alert("No hay un cultivo seleccionado para registrar."); return; }  
  
      const cultivo = stateCultivos.find(c => c.id === id);  
      if (!cultivo) { alert("No encontr√© el cultivo."); return; }  
  
      const hoy = todayISO();  
  
      if (tipo === "riego") {  
        cultivo.ultimoRiego = hoy;  
        stateDiario.push({  
          id: Date.now().toString(36),  
          fecha: hoy,  
          texto: `Riego registrado para ${cultivo.nombre}${cultivo.variedad ? ` (${cultivo.variedad})` : ""}.`,  
          tipo: "Riego"  
        });  
        alert("Riego registrado ‚úÖ");  
      } else {  
        cultivo.ultimaFertilizacion = hoy;  
        stateDiario.push({  
          id: Date.now().toString(36),  
          fecha: hoy,  
          texto: `Abono registrado para ${cultivo.nombre}${cultivo.variedad ? ` (${cultivo.variedad})` : ""}.`,  
          tipo: "Abono"  
        });  
        alert("Abono registrado ‚úÖ");  
      }  
  
      saveCultivos(stateCultivos);  
      saveDiario(stateDiario);  
  
      renderCultivos();  
      renderDiario();  
      renderInicio();  
      updateAccionesRapidasUI();  
    }  
  
    /*********************  
     * Cat√°logo: personalizados  
     *********************/  
    let customEditId = null;  
  
    function parsePlagas(str) {  
      return (str || "").split(",").map(s => s.trim()).filter(Boolean);  
    }  
    function allMonths() { return [0,1,2,3,4,5,6,7,8,9,10,11]; }  
  
    function getMesesSeleccionadosUI() {  
      return Array.from(document.querySelectorAll("#nuevoCultivoMesesPills .pill.pill--active"))  
        .map(b => parseInt(b.dataset.mes, 10))  
        .filter(n => Number.isFinite(n));  
    }  
  
    function setMesesSeleccionadosUI(meses) {  
      const set = new Set((meses || []).map(Number));  
      document.querySelectorAll("#nuevoCultivoMesesPills .pill").forEach(b => {  
        const m = parseInt(b.dataset.mes, 10);  
        b.classList.toggle("pill--active", set.has(m));  
      });  
    }  
  
    function setupNuevoCultivoMesesPills() {  
      const wrap = document.getElementById("nuevoCultivoMesesPills");  
      if (!wrap) return;  
      if (wrap.dataset.bound === "1") return;  
      wrap.dataset.bound = "1";  
      wrap.addEventListener("click", (ev) => {  
        const b = ev.target.closest("button.pill[data-mes]");  
        if (!b) return;  
        b.classList.toggle("pill--active");  
      });  
    }  
  
    function buildCustomCultivoFromUI(existingId) {  
      const nombre = (document.getElementById("nuevoCultivoNombre")?.value || "").trim();  
      const categoria = (document.getElementById("nuevoCultivoCategoria")?.value || "Otro").trim();  
  
      const diasG = parseInt(document.getElementById("nuevoCultivoDiasGerminacion")?.value || "", 10);  
      const diasC = parseInt(document.getElementById("nuevoCultivoDiasCosecha")?.value || "", 10);  
  
      const luz = (document.getElementById("nuevoCultivoLuz")?.value || "").trim() || "‚Äî";  
      const riego = (document.getElementById("nuevoCultivoRiego")?.value || "").trim() || "‚Äî";  
      const tiesto = (document.getElementById("nuevoCultivoTiesto")?.value || "").trim() || "‚Äî";  
      const profundidad = (document.getElementById("nuevoCultivoProfundidad")?.value || "").trim() || "‚Äî";  
      const plagasStr = (document.getElementById("nuevoCultivoPlagas")?.value || "").trim();  
  
      if (!nombre) { alert("Escribe el nombre del cultivo."); return null; }  
  
      let meses = getMesesSeleccionadosUI();  
      if (!meses.length) meses = allMonths();  
  
      const id = existingId || `custom-${Date.now().toString(36)}`;  
      const diasTexto = Number.isFinite(diasC) && diasC > 0 ? `${diasC} d√≠as` : "‚Äî";  
  
      return {  
        id,  
        nombre,  
        categoria,  
        dias: diasTexto,  
        luz,  
        riego,  
        tiesto,  
        profundidad,  
        plagas: parsePlagas(plagasStr),  
        meses,  
        imagen: "img/placeholder.jpg",  
        esPersonalizado: true,  
        diasGerminacion: Number.isFinite(diasG) && diasG > 0 ? diasG : null,  
        diasCosecha: Number.isFinite(diasC) && diasC > 0 ? diasC : null  
      };  
    }  
  
    function clearCustomCultivoUI() {  
      ["nuevoCultivoNombre","nuevoCultivoDiasGerminacion","nuevoCultivoDiasCosecha","nuevoCultivoLuz","nuevoCultivoRiego","nuevoCultivoTiesto","nuevoCultivoProfundidad","nuevoCultivoPlagas"]  
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });  
  
      const cat = document.getElementById("nuevoCultivoCategoria");  
      if (cat) cat.value = "Otro";  
      setMesesSeleccionadosUI([]);  
    }  
  
    function resetEditCustomCultivoUI() {  
      customEditId = null;  
      const t = document.getElementById("nuevoCultivoTitulo");  
      if (t) t.textContent = "Nuevo cultivo";  
      const btn = document.getElementById("btnGuardarNuevoCultivo");  
      if (btn) btn.textContent = "Guardar cultivo";  
    }  
  
    function startEditCustomCultivo(cultivo) {  
      customEditId = cultivo.id;  
      const card = document.getElementById("nuevoCultivoCard");  
      if (card) card.style.display = "block";  
  
      document.getElementById("nuevoCultivoTitulo").textContent = "Editar cultivo";  
      document.getElementById("btnGuardarNuevoCultivo").textContent = "Actualizar cultivo";  
  
      document.getElementById("nuevoCultivoNombre").value = cultivo.nombre || "";  
      document.getElementById("nuevoCultivoCategoria").value = cultivo.categoria || "Otro";  
      document.getElementById("nuevoCultivoDiasGerminacion").value = cultivo.diasGerminacion || "";  
      document.getElementById("nuevoCultivoDiasCosecha").value = cultivo.diasCosecha || "";  
      document.getElementById("nuevoCultivoLuz").value = cultivo.luz || "";  
      document.getElementById("nuevoCultivoRiego").value = cultivo.riego || "";  
      document.getElementById("nuevoCultivoTiesto").value = cultivo.tiesto || "";  
      document.getElementById("nuevoCultivoProfundidad").value = cultivo.profundidad || "";  
      document.getElementById("nuevoCultivoPlagas").value = Array.isArray(cultivo.plagas) ? cultivo.plagas.join(", ") : "";  
      setMesesSeleccionadosUI(Array.isArray(cultivo.meses) ? cultivo.meses : []);  
  
      setupNuevoCultivoMesesPills();  
      card?.scrollIntoView({ behavior: "smooth", block: "start" });  
      document.getElementById("nuevoCultivoNombre")?.focus();  
    }  
  
    function deleteCustomCultivoById(id) {  
      const customList = loadCustomCultivos().filter(c => c.id !== id);  
      saveCustomCultivos(customList);  
      injectCustomIntoCatalogo(customList);  
  
      if (customEditId === id) {  
        resetEditCustomCultivoUI();  
        const card = document.getElementById("nuevoCultivoCard");  
        if (card) card.style.display = "none";  
        clearCustomCultivoUI();  
      }  
    }  
  
    function setupCultivoManualUI() {  
      const btnToggle = document.getElementById("btnToggleNuevoCultivo");  
      const card = document.getElementById("nuevoCultivoCard");  
      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");  
      const btnCancelar = document.getElementById("btnCancelarNuevoCultivo");  
  
      if (!btnToggle || !card || !btnGuardar || !btnCancelar) return;  
  
      setupNuevoCultivoMesesPills();  
  
      if (btnToggle.dataset.bound === "1") return;  
      btnToggle.dataset.bound = "1";  
  
      btnToggle.addEventListener("click", () => {  
        const visible = card.style.display !== "none";  
        card.style.display = visible ? "none" : "block";  
        if (!visible) document.getElementById("nuevoCultivoNombre")?.focus();  
        else { clearCustomCultivoUI(); resetEditCustomCultivoUI(); }  
      });  
  
      btnCancelar.addEventListener("click", () => {  
        card.style.display = "none";  
        clearCustomCultivoUI();  
        resetEditCustomCultivoUI();  
      });  
  
      btnGuardar.addEventListener("click", () => {  
        const wasEditing = Boolean(customEditId);  
        const cultivo = buildCustomCultivoFromUI(customEditId);  
        if (!cultivo) return;  
  
        let customList = loadCustomCultivos();  
  
        if (customEditId) {  
          customList = customList.filter(c => c.id !== customEditId);  
        } else {  
          const nameLower = (cultivo.nombre || "").toLowerCase();  
          customList = customList.filter(c => (c.nombre || "").toLowerCase() !== nameLower);  
        }  
  
        customList.push(cultivo);  
        saveCustomCultivos(customList);  
        injectCustomIntoCatalogo(customList);  
  
        const filtro = (document.getElementById("catalogoBusqueda")?.value || "").trim();  
        renderCatalogo(filtro);  
  
        card.style.display = "none";  
        clearCustomCultivoUI();  
        resetEditCustomCultivoUI();  
  
        alert(wasEditing ? "Cultivo actualizado ‚úÖ" : "Cultivo guardado ‚úÖ");  
      });  
    }

/* ‚úÖ CIERRA setupCultivoManualUI() y pega esto luego */

/*********************
 * Pesticidas (datos base)
 *********************/
const PESTICIDAS_DATA = [
  { nombre: "Jab√≥n pot√°sico", uso: "Pulgones, mosca blanca, √°caros (contacto).", nota: "Aplicar al atardecer; prueba en pocas hojas primero." },
  { nombre: "Aceite de neem", uso: "Repelente/antialimentario suave.", nota: "Evitar sol fuerte; seguir etiqueta." },
  { nombre: "Bicarbonato (suave)", uso: "Apoyo contra o√≠dio/manchas.", nota: "No abusar; alterna y mejora ventilaci√≥n." }
];

/*********************
 * NAV (cambio de secciones)
 *********************/
function setActiveSection(sectionKey) {
  document.querySelectorAll(".nav-btn").forEach(b => {
    b.classList.toggle("nav-btn--active", b.dataset.section === sectionKey);
  });

  document.querySelectorAll(".section").forEach(sec => sec.classList.remove("section--active"));
  const target = document.getElementById(`section-${sectionKey}`);
  if (target) target.classList.add("section--active");

  if (sectionKey === "inicio") renderInicio();
  if (sectionKey === "calendario") renderCalendario();
  if (sectionKey === "catalogo") renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
  if (sectionKey === "huerto") renderCultivos();
  if (sectionKey === "diario") renderDiario();
  if (sectionKey === "plagas") renderPlagas();
  if (sectionKey === "pesticidas") renderPesticidas();
  if (sectionKey === "opciones") renderOpciones();
  // "guias" no necesita render especial: solo mostrar secci√≥n
}

function bindNav() {
  document.querySelectorAll(".nav-btn").forEach(btn => {
    if (btn.dataset.bound === "1") return;
    btn.dataset.bound = "1";
    btn.addEventListener("click", () => setActiveSection(btn.dataset.section));
  });
}

/*********************
 * Header subtitle
 *********************/
function renderHeader() {
  const el = document.getElementById("appSubtitle");
  if (!el) return;
  const n = escapeHTML(stateSettings.nombreHuerto || DEFAULT_SETTINGS.nombreHuerto);
  const clima = CLIMA_LABEL[stateSettings.clima] || "tropical";
  const hem = HEMISFERIO_LABEL[stateSettings.hemisferio] || "hemisferio norte";
  el.innerHTML =
    `<span>üè° <strong>${n}</strong></span>` +
    `<span class="app-subtitle-dot"></span>` +
    `<span>üå¶Ô∏è ${escapeHTML(clima)}</span>` +
    `<span class="app-subtitle-dot"></span>` +
    `<span>üß≠ ${escapeHTML(hem)}</span>`;
}

/*********************
 * INICIO
 *********************/
function renderInicio() {
  document.getElementById("estadoCultivosCount").textContent = String(stateCultivos.length || 0);

  const hoy = todayISO();
  const entradasHoy = (stateDiario || []).filter(e => e?.fecha === hoy).length;
  document.getElementById("estadoEntradasCount").textContent = String(entradasHoy);

  const resumen = document.getElementById("estadoResumen");
  if (resumen) {
    resumen.textContent = !stateCultivos.length
      ? 'A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.'
      : (getPendientes({ rangeDays: 0 }).length ? `Hoy tienes pendientes. Atiende riego/abono.` : "Hoy no tienes pendientes ‚úÖ");
  }

  const chip = document.getElementById("estadoClimaChip");
  if (chip) chip.textContent = `Clima ${CLIMA_LABEL[stateSettings.clima] || "tropical"}`;

  renderPendientesEnInicio();
  updateAccionesRapidasUI();
}

/*********************
 * CALENDARIO
 *********************/
let calendarioMesActual = new Date().getMonth();

function isRecommendedForMonth(cultivo, settings, monthIndex) {
  const mesA = ajustarMesPorHemisferio(settings, monthIndex);
  const meses = Array.isArray(cultivo.meses) ? cultivo.meses : [];
  return meses.includes(mesA);
}

function renderCalendario() {
  const chip = document.getElementById("calendarioClimaChip2");
  if (chip) chip.textContent = `Clima ${CLIMA_LABEL[stateSettings.clima] || "tropical"}`;

  const list = document.getElementById("calendarList");
  const empty = document.getElementById("calendarEmpty");
  if (!list || !empty) return;

  document.querySelectorAll("#mesesPills .pill").forEach(p => {
    p.classList.toggle("pill--active", parseInt(p.dataset.mes, 10) === calendarioMesActual);
  });

  const base = getCalendarData(stateSettings, calendarioMesActual);

  const catalogoRecs = CATALOGO_CULTIVOS
    .filter(c => isRecommendedForMonth(c, stateSettings, calendarioMesActual))
    .slice(0, 10)
    .map(c => ({
      titulo: c.nombre,
      tipo: c.categoria || "‚Äî",
      detalle: c.esPersonalizado ? "Recomendaci√≥n por meses (personalizado)." : "Recomendaci√≥n por meses (cat√°logo)."
    }));

  const merged = [...base, ...catalogoRecs];

  list.innerHTML = "";
  if (!merged.length) { empty.style.display = "block"; return; }
  empty.style.display = "none";

  merged.forEach(item => {
    const div = document.createElement("div");
    div.className = "calendar-item";
    div.innerHTML = `
      <div class="calendar-item-title">
        <span>${escapeHTML(item.titulo || "‚Äî")}</span>
        <span class="chip">${escapeHTML(item.tipo || "‚Äî")}</span>
      </div>
      <div class="muted">${escapeHTML(item.detalle || "")}</div>
    `;
    list.appendChild(div);
  });
}

function bindCalendario() {
  const wrap = document.getElementById("mesesPills");
  if (!wrap || wrap.dataset.bound === "1") return;
  wrap.dataset.bound = "1";
  wrap.addEventListener("click", (ev) => {
    const b = ev.target.closest("button.pill[data-mes]");
    if (!b) return;
    calendarioMesActual = parseInt(b.dataset.mes, 10);
    renderCalendario();
  });
}

/*********************
 * CATALOGO
 *********************/
function renderCatalogo(filtro = "") {
  const list = document.getElementById("catalogoList");
  if (!list) return;

  const q = normText(filtro);
  const items = CATALOGO_CULTIVOS.filter(c => {
    if (!q) return true;
    return normText(c.nombre).includes(q) || normText(c.categoria).includes(q);
  });

  list.innerHTML = "";
  if (!items.length) { list.innerHTML = `<div class="muted">No se encontraron cultivos.</div>`; return; }

  items.forEach(c => {
    const card = document.createElement("div");
    card.className = "cultivo-card";
    const pl = Array.isArray(c.plagas) ? c.plagas.join(", ") : "‚Äî";
    const badge = c.esPersonalizado ? `<span class="chip badge">Personalizado</span>` : `<span class="chip">Cat√°logo</span>`;
    card.innerHTML = `
      <div class="cultivo-header">
        <div class="cultivo-title">
          <img class="cultivo-thumb" src="${escapeHTML(c.imagen || "img/placeholder.jpg")}" alt="${escapeHTML(c.nombre)}" onerror="this.src='img/placeholder.jpg';" />
          <div>
            <div>${escapeHTML(c.nombre)}</div>
            <div class="muted">${escapeHTML(c.categoria || "‚Äî")} ¬∑ ${escapeHTML(c.dias || "‚Äî")}</div>
          </div>
        </div>
        ${badge}
      </div>

      <div class="cultivo-body">
        <div><strong>Luz:</strong> ${escapeHTML(c.luz || "‚Äî")}</div>
        <div><strong>Riego:</strong> ${escapeHTML(c.riego || "‚Äî")}</div>
        <div><strong>Tiesto:</strong> ${escapeHTML(c.tiesto || "‚Äî")}</div>
        <div><strong>Prof:</strong> ${escapeHTML(c.profundidad || "‚Äî")}</div>
        <div style="grid-column:1/-1;"><strong>Plagas:</strong> ${escapeHTML(pl)}</div>
      </div>

      <div class="cultivo-actions">
        <button class="btn btn-secondary" data-action="toggle-germinacion" data-id="${escapeHTML(c.id)}">üå± Germinaci√≥n</button>
        ${c.esPersonalizado ? `
          <button class="btn btn-secondary" data-action="edit-custom" data-id="${escapeHTML(c.id)}">‚úèÔ∏è Editar</button>
          <button class="btn btn-danger" data-action="delete-custom" data-id="${escapeHTML(c.id)}">üóëÔ∏è Borrar</button>
        ` : ""}
      </div>

      <div class="germinacion-panel" id="germ-${escapeHTML(c.id)}"></div>
    `;
    list.appendChild(card);
  });
}

function toggleGerminacionUI(cultivoId) {
  const panel = document.getElementById(`germ-${cultivoId}`);
  if (!panel) return;

  const isOpen = panel.style.display === "block";
  if (isOpen) { panel.style.display = "none"; return; }

  const info = getInfoGerminacion(cultivoId);
  if (!info) { panel.innerHTML = `<div class="muted">No hay info de germinaci√≥n.</div>`; panel.style.display = "block"; return; }

  const pasos = Array.isArray(info.pasos) ? info.pasos.map(p => `‚Ä¢ ${p}`).join("\n") : "";
  panel.innerHTML = `
    <div><strong>${escapeHTML(info.titulo || "Gu√≠a")}</strong></div>
    <div class="muted">${escapeHTML(info.metodo || "")}</div>
    <div style="margin-top:6px; white-space:pre-line;">${escapeHTML(pasos)}</div>
    ${info.tip ? `<div class="muted" style="margin-top:6px;"><strong>Tip:</strong> ${escapeHTML(info.tip)}</div>` : ""}
  `;
  panel.style.display = "block";
}

function bindCatalogo() {
  const input = document.getElementById("catalogoBusqueda");
  if (input && input.dataset.bound !== "1") {
    input.dataset.bound = "1";
    input.addEventListener("input", () => renderCatalogo(input.value.trim()));
  }

  const list = document.getElementById("catalogoList");
  if (!list || list.dataset.bound === "1") return;
  list.dataset.bound = "1";

  list.addEventListener("click", (ev) => {
    const btn = ev.target.closest("button[data-action]");
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;

    if (action === "toggle-germinacion") toggleGerminacionUI(id);

    if (action === "edit-custom") {
      const custom = loadCustomCultivos().find(x => x.id === id);
      if (custom) startEditCustomCultivo(custom);
    }

    if (action === "delete-custom") {
      if (confirm("¬øBorrar este cultivo personalizado?")) {
        deleteCustomCultivoById(id);
        renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
        renderCalendario();
      }
    }
  });
}

/*********************
 * MI HUERTO + DIARIO + PLAGAS + PESTICIDAS + OPCIONES
 * (usa lo que ya definiste en tu versi√≥n anterior; aqu√≠ va solo lo m√≠nimo: binds + init)
 *********************/
function renderPlagas() {
  const wrap = document.getElementById("plagasList");
  if (!wrap) return;
  wrap.innerHTML = "";
  PLAGAS_DATA.forEach(p => {
    const div = document.createElement("div");
    div.className = "plaga-card";
    div.innerHTML = `
      <div class="media-item-title">${escapeHTML(p.nombre)}</div>
      <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.comoSeVe)}</div>
      <div class="media-item-body"><strong>Manejo suave:</strong> ${escapeHTML(p.manejoSuave)}</div>
      <div class="media-item-body"><strong>Casero:</strong> ${escapeHTML(p.preparadosCaseros)}</div>
      <div class="media-item-body"><strong>Comercial:</strong> ${escapeHTML(p.productosComerciales)}</div>
    `;
    wrap.appendChild(div);
  });
}

function renderPesticidas() {
  const wrap = document.getElementById("pesticidasList");
  if (!wrap) return;
  wrap.innerHTML = "";
  PESTICIDAS_DATA.forEach(p => {
    const div = document.createElement("div");
    div.className = "plaga-card";
    div.innerHTML = `
      <div class="media-item-title">${escapeHTML(p.nombre)}</div>
      <div class="media-item-body"><strong>Uso:</strong> ${escapeHTML(p.uso)}</div>
      <div class="media-item-body"><strong>Nota:</strong> ${escapeHTML(p.nota)}</div>
    `;
    wrap.appendChild(div);
  });
}

function renderOpciones() {
  const n = document.getElementById("nombreHuerto");
  const c = document.getElementById("climaSelect");
  const h = document.getElementById("hemisferioSelect");
  if (n) n.value = stateSettings.nombreHuerto || DEFAULT_SETTINGS.nombreHuerto;
  if (c) c.value = stateSettings.clima || DEFAULT_SETTINGS.clima;
  if (h) h.value = stateSettings.hemisferio || DEFAULT_SETTINGS.hemisferio;
}

function bindAccionesRapidas() {
  const r = document.getElementById("btnQuickRiego");
  const a = document.getElementById("btnQuickAbono");
  if (r && r.dataset.bound !== "1") { r.dataset.bound = "1"; r.addEventListener("click", () => quickRegistrar("riego")); }
  if (a && a.dataset.bound !== "1") { a.dataset.bound = "1"; a.addEventListener("click", () => quickRegistrar("abono")); }
}

let deferredPrompt = null;
function bindPWAInstall() {
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById("installBanner")?.classList.remove("hidden");
  });

  const btn = document.getElementById("btnInstalarPwa");
  if (btn && btn.dataset.bound !== "1") {
    btn.dataset.bound = "1";
    btn.addEventListener("click", async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      try { await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      document.getElementById("installBanner")?.classList.add("hidden");
    });
  }
}

function renderAll() {
  renderHeader();
  injectCustomIntoCatalogo(loadCustomCultivos());
  renderInicio();
  renderCalendario();
  renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
  // Si ya tienes renderCultivos/renderDiario/binds en tu script, se llamar√°n desde setActiveSection cuando entres.
}

function init() {
  injectCustomIntoCatalogo(loadCustomCultivos());
  bindNav();
  bindCalendario();
  bindCatalogo();
  bindAccionesRapidas();
  bindPWAInstall();
  setupCultivoManualUI();

  const f = document.getElementById("cultivoFecha");
  if (f && !f.value) f.value = todayISO();

  renderAll();
  setActiveSection("inicio");
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
