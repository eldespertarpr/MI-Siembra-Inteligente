<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v17)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #02081f;
      --card: #02081f;
      --card-soft: #030919;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.15);
      --accent-strong: rgba(34,197,94,0.45);
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148,163,184,0.3);
      --danger: #f97373;
      --chip-bg: rgba(15,23,42,0.9);
      --chip-border: rgba(148,163,184,0.4);
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.7);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-full: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #022c22 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 28px;
    }

    @media (min-width: 768px) {
      .app-shell { padding: 20px 16px 40px; }
    }

    /* HEADER */
    .app-header {
      background: radial-gradient(circle at 0 0, #4ade80 0, #16a34a 28%, #052e16 85%);
      border-radius: 28px;
      padding: 18px 18px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 120% -10%, rgba(34,197,94,0.35) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .app-header-icon {
      position: relative;
      z-index: 1;
      width: 52px;
      height: 52px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 10%, #bbf7d0 0, #16a34a 35%, #052e16 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 14px 35px rgba(0,0,0,0.45);
      flex-shrink: 0;
    }

    .app-header-icon span { font-size: 42px; }

    .app-header-text {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-tag {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.45);
      border: 1px solid rgba(15,23,42,0.8);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .app-subtitle {
      font-size: 0.80rem;
      color: #e5e7eb;
      opacity: 0.95;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .app-subtitle span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .app-subtitle-dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: rgba(226,232,240,0.7);
    }

    /* NAV */
    .nav {
      margin-top: 8px;
      background: linear-gradient(135deg, var(--bg-elevated), #020617);
      border-radius: 26px;
      padding: 10px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(15,23,42,0.85);
    }

    @media (min-width: 660px) {
      .nav { grid-template-columns: repeat(8, minmax(0,1fr)); }
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 6px 6px;
      font-size: 0.70rem;
      color: var(--text-soft);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, transform 0.12s;
      position: relative;
      min-height: 52px;
    }

    .nav-btn span.nav-icon { font-size: 1.40rem; }

    .nav-btn.nav-btn--active {
      background: radial-gradient(circle at top, var(--accent) 0, var(--accent-soft) 45%, transparent 100%);
      color: #ecfdf5;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4), 0 14px 30px rgba(22,163,74,0.55);
      transform: translateY(-1px);
    }

    .nav-btn.nav-btn--active::after {
      content: "";
      position: absolute;
      inset: auto auto -3px 50%;
      width: 32%;
      max-width: 42px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,0.1), rgba(34,197,94,0.6), rgba(34,197,94,0.1));
      transform: translateX(-50%);
    }

    /* SECTIONS */
    main { margin-top: 14px; }

    .section { display: none; animation: fadeIn 0.18s ease-out; }
    .section--active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section > .section-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 2px 8px;
    }

    .section-icon-pill {
      width: 26px;
      height: 26px;
      border-radius: 13px;
      background: radial-gradient(circle at 30% 15%, #fefce8 0, #fef9c3 25%, #0f172a 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .section-title-row h2 { font-size: 1.05rem; margin: 0; }

    .section-subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin: 2px 2px 10px;
    }

    .app-card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #02081f 100%);
      border-radius: var(--radius-xl);
      padding: 14px 16px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }

    .app-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .app-card-title { font-size: 0.96rem; font-weight: 600; }

    .chip{
  border-radius: var(--radius-full);
  padding: 4px 10px;
  font-size: 0.74rem;
  border: 1px solid var(--chip-border);
  background: var(--chip-bg);
  display: inline-flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}

.chip--muted{
  background: rgba(148,163,184,0.14);
  border-color: rgba(148,163,184,0.35);
  color: #e5e7eb;
  opacity: .9;
}

.chip.badge{
  background: rgba(34,197,94,0.12);
  border-color: rgba(34,197,94,0.6);
  color: #bbf7d0;
}

    .muted { color: var(--text-soft); font-size: 0.80rem; }

    .divider-soft {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,184,0.4), transparent);
      margin: 8px -2px 10px;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px -1px 4px;
    }

    .pill {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
      color: var(--text-main);
    }

    .pill--active {
      background: var(--accent-soft);
      border-color: rgba(34,197,94,0.85);
      color: #bbf7d0;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(22,163,74,0.55);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
    }

    .btn span { font-size: 1rem; }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 7px 18px rgba(22,163,74,0.55);
      filter: brightness(0.96);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
      box-shadow: none;
    }

    .btn-full { width: 100%; justify-content: center; }

    .btn-danger {
      background: linear-gradient(135deg, #b91c1c, #ef4444);
      color: #fee2e2;
      box-shadow: 0 10px 26px rgba(248,113,113,0.45);
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .small-label { font-size: 0.78rem; color: var(--text-soft); margin-bottom: 2px; }
    .big-number { font-size: 1.3rem; font-weight: 600; }

    /* FORMS */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 8px 0 4px;
    }

    @media (min-width: 660px) {
      .form-grid--2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .field { display: flex; flex-direction: column; gap: 4px; }
    .field label { font-size: 0.78rem; color: var(--text-soft); }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      background: rgba(15,23,42,0.95);
      border-radius: 14px;
      border: 1px solid rgba(51,65,85,0.9);
      padding: 8px 10px;
      color: var(--text-main);
      font-size: 0.83rem;
      font-family: inherit;
      width: 100%;
      max-width: 100%;
      outline: none;
      transition: border 0.12s, box-shadow 0.12s, background 0.12s;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 10px, calc(100% - 11px) 10px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    textarea { min-height: 72px; resize: vertical; }

    input:focus, select:focus, textarea:focus {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
      background: rgba(15,23,42,0.98);
    }

    /* Cat√°logo */
.cultivos-list{
  display:flex;
  flex-direction:column;
  gap:10px;
  margin-top:10px;
}

.cultivo-card{
  border-radius:var(--radius-lg);
  padding:10px 11px;
  background: radial-gradient(circle at top left, var(--card-soft) 0, #020617 60%);
  border:1px solid rgba(75,85,99,0.9);
  display:flex;
  flex-direction:column;
  gap:6px;
}

.cultivo-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
}

.cultivo-title{
  font-size:0.9rem;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:10px;
  flex:1;
  min-width:0;
}

.cultivo-title span{
  word-break:break-word;
}

/* Imagen cat√°logo ‚Äì estable y pro */
.cultivo-thumb{
  width:64px;
  height:64px;
  aspect-ratio: 1 / 1;
  border-radius:18px;
  object-fit:cover;
  flex-shrink:0;

  background:
    radial-gradient(circle at 30% 30%,
      rgba(34,197,94,0.35),
      rgba(15,23,42,0.9));

  border:1px solid rgba(148,163,184,0.25);
}

.cultivo-body{
  font-size:0.78rem;
  color:var(--text-soft);
  display:grid;
  grid-template-columns: 1.1fr 0.9fr;
  gap:4px 10px;
  margin-top:4px;
}

@media (max-width:480px){
  .cultivo-body{ grid-template-columns:1fr; }
}

.cultivo-actions{
  margin-top:8px;
  display:flex;
  justify-content:flex-end;
  gap:6px;
  flex-wrap:wrap;
}

.germinacion-panel{
  margin-top:10px;
  padding-top:10px;
  border-top:1px solid rgba(148,163,184,0.5);
  font-size:0.78rem;
  color:var(--text-soft);
  display:none;
}

    /* Calendario */
    .calendar-list { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
    .calendar-item {
      border-radius: 16px;
      padding: 9px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 0.8rem;
    }
    .calendar-item-title {
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .calendar-empty { font-size: 0.8rem; color: var(--text-soft); margin-top: 8px; }

    /* Diario */
    .diario-list { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; font-size: 0.8rem; }
    .diario-item {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .diario-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    /* Plagas / pesticidas */
    .plaga-card {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 6px;
    }
    .plaga-card--highlight {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6);
    }
    .media-list { display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }
    .media-item-title { font-size: 0.86rem; font-weight: 600; }
    .media-item-body { font-size: 0.8rem; color: var(--text-soft); margin-top: 2px; }

    footer {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--text-soft);
      text-align: center;
      padding-bottom: 6px;
    }

    #installBanner {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.97);
      border-radius: 999px;
      padding: 7px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(148,163,184,0.75);
      box-shadow: 0 16px 40px rgba(15,23,42,0.85);
      font-size: 0.78rem;
      z-index: 80;
    }
    #installBanner.hidden { display: none; }
    #installBanner button { font-size: 0.78rem; padding: 6px 10px; }
    .catalogo-categoria-title{
  margin: 12px 2px 6px;
  font-size: 0.86rem;
  font-weight: 700;
  letter-spacing: .02em;
  color: #e5e7eb;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.catalogo-categoria-title .chip{
  font-weight: 600;
  .catalogo-topbar{
  display:flex;
  gap:10px;
  align-items:center;
}
.catalogo-topbar input{ flex:1; }

.sheet-backdrop{
  position:fixed; inset:0;
  background: rgba(0,0,0,.55);
  z-index: 999;
}
.sheet{
  position:fixed;
  left:12px; right:12px; bottom:12px;
  border-radius: 18px;
  padding: 12px;
  z-index: 1000;
  background: var(--card, #111827);
  border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 20px 60px rgba(0,0,0,.5);
}
.sheet-header{
  display:flex; justify-content:space-between; align-items:center;
  gap:10px; margin-bottom:10px;
}
.sheet-title{ font-weight:700; }
.sheet-list{
  display:flex; flex-wrap:wrap; gap:10px;
}
.sheet-chip{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding: 10px 12px;
  border-radius: 999px;
  cursor: pointer;
  user-select:none;
}
.sheet-chip.active{
  border-color: rgba(34,197,94,.45);
  background: rgba(34,197,94,.15);
}
}
  </style>
</head>

<body>

  <!-- Sheet Categor√≠as -->
  <div id="catSheetBackdrop" class="sheet-backdrop" hidden></div>

  <div id="catSheet" class="sheet" hidden</div>
    <div class="sheet-header">
      <div class="sheet-title">Categor√≠as></div>
      <button type="button" class="btn btn-secondary" id="btnCerrarCatSheet">Cerrar</button>
    </div>

    <div id="catSheetList" class="sheet-list"></div>
  </div>
  <!-- /Sheet Categor√≠as -->

  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon"><span>üå±</span></div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v17 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle"></div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio"><span class="nav-icon">üè†</span><span class="nav-label">Inicio</span></button>
      <button class="nav-btn" data-section="calendario"><span class="nav-icon">üìÖ</span><span class="nav-label">Calendario</span></button>
      <button class="nav-btn" data-section="catalogo"><span class="nav-icon">üå±</span><span class="nav-label">Cat√°logo</span></button>
      <button class="nav-btn" data-section="huerto"><span class="nav-icon">üåø</span><span class="nav-label">Mi huerto</span></button>
      <button class="nav-btn" data-section="diario"><span class="nav-icon">üìì</span><span class="nav-label">Diario</span></button>
      <button class="nav-btn" data-section="plagas"><span class="nav-icon">üêõ</span><span class="nav-label">Plagas</span></button>
      <button class="nav-btn" data-section="pesticidas"><span class="nav-icon">üíß</span><span class="nav-label">Pesticidas</span></button>
      <button class="nav-btn" data-section="opciones"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Opciones</span></button>
      <button class="nav-btn" data-section="guias"><span class="nav-icon">üìö</span><span class="nav-label">Gu√≠as</span></button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row"><div class="section-icon-pill">üè†</div><h2>Inicio</h2></div>
        <p class="section-subtitle">Resumen r√°pido de tu huerto y acceso a las funciones principales.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div class="chip badge" id="estadoClimaChip">Clima tropical</div>
          </div>
          <div class="grid-two">
            <div><div class="small-label">Cultivos registrados</div><div class="big-number" id="estadoCultivosCount">0</div></div>
            <div><div class="small-label">Entradas hoy en el diario</div><div class="big-number" id="estadoEntradasCount">0</div></div>
          </div>
          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.</p>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìÖ</div><h2>Calendario de siembra</h2></div>
        <p class="section-subtitle">Selecciona un mes para ver sugerencias de cultivos seg√∫n tu clima y hemisferio.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses del a√±o</div>
            <div class="chip" id="calendarioClimaChip2">Clima tropical</div>
          </div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button><button class="pill" data-mes="1">Feb</button><button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button><button class="pill" data-mes="4">May</button><button class="pill" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button><button class="pill" data-mes="7">Ago</button><button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button><button class="pill" data-mes="10">Nov</button><button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">Por ahora no hay recomendaciones espec√≠ficas para este mes y clima.</div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üå±</div><h2>Cat√°logo de cultivos</h2></div>
        <p class="section-subtitle">Lista de cultivos con informaci√≥n r√°pida y gu√≠a de germinaci√≥n / reproducci√≥n.</p>

        <div class="app-card">
          <div class="catalogo-search-row">
  <div class="field">
    <label for="catalogoBusqueda">Buscar</label>
    <input type="text" id="catalogoBusqueda">
  </div>

  <button type="button" class="btn btn-secondary btn-categorias">
    üå± Categor√≠as
  </button>
</div>

          <div style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary" id="btnToggleNuevoCultivo">‚ûï A√±adir cultivo manual</button>
          </div>

          <div class="cultivos-list" id="catalogoList"></div>

          <!-- Formulario cultivo manual -->
          <div class="app-card" id="nuevoCultivoCard" style="margin-top: 12px; display:none;">
            <div class="app-card-header">
              <div class="app-card-title" id="nuevoCultivoTitulo">Nuevo cultivo</div>
              <span class="chip badge">Personalizado</span>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoNombre">Nombre del cultivo *</label>
                <input type="text" id="nuevoCultivoNombre" placeholder="Ej. cilantro criollo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoCategoria">Categor√≠a</label>
                <select id="nuevoCultivoCategoria">
                  <option value="Hoja">Hoja</option>
                  <option value="Fruto">Fruto</option>
                  <option value="Ra√≠z">Ra√≠z</option>
                  <option value="Tub√©rculo">Tub√©rculo</option>
                  <option value="Arom√°tica">Arom√°tica</option>
                  <option value="Frutal perenne">Frutal perenne</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoDiasGerminacion">D√≠as de germinaci√≥n (opcional)</label>
                <input type="number" id="nuevoCultivoDiasGerminacion" min="0" placeholder="Ej. 7" />
              </div>
              <div class="field">
                <label for="nuevoCultivoDiasCosecha">D√≠as hasta cosecha (opcional)</label>
                <input type="number" id="nuevoCultivoDiasCosecha" min="0" placeholder="Ej. 90" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoLuz">Luz</label>
                <input type="text" id="nuevoCultivoLuz" placeholder="Ej. Sol directo (6‚Äì8 h)" />
              </div>
              <div class="field">
                <label for="nuevoCultivoRiego">Riego</label>
                <input type="text" id="nuevoCultivoRiego" placeholder="Ej. Suelo siempre ligeramente h√∫medo" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoTiesto">Tiesto / suelo</label>
                <input type="text" id="nuevoCultivoTiesto" placeholder="Ej. Maceta 5+ galones o suelo directo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoProfundidad">Profundidad de siembra</label>
                <input type="text" id="nuevoCultivoProfundidad" placeholder="Ej. 0.5‚Äì1 cm" />
              </div>
            </div>

            <div class="field">
              <label for="nuevoCultivoPlagas">Plagas frecuentes (separadas por coma)</label>
              <input type="text" id="nuevoCultivoPlagas" placeholder="Ej. pulgones, babosas, hongos" />
            </div>

            <div class="field" style="margin-top: 10px;">
              <label>Meses de siembra (para recomendaciones del Calendario)</label>
              <div class="pill-group" id="nuevoCultivoMesesPills">
                <button type="button" class="pill" data-mes="0">Ene</button><button type="button" class="pill" data-mes="1">Feb</button>
                <button type="button" class="pill" data-mes="2">Mar</button><button type="button" class="pill" data-mes="3">Abr</button>
                <button type="button" class="pill" data-mes="4">May</button><button type="button" class="pill" data-mes="5">Jun</button>
                <button type="button" class="pill" data-mes="6">Jul</button><button type="button" class="pill" data-mes="7">Ago</button>
                <button type="button" class="pill" data-mes="8">Sep</button><button type="button" class="pill" data-mes="9">Oct</button>
                <button type="button" class="pill" data-mes="10">Nov</button><button type="button" class="pill" data-mes="11">Dic</button>
              </div>
              <p class="muted" style="margin-top:6px;">Si no seleccionas ninguno, se asumir√° <strong>todo el a√±o</strong>.</p>
            </div>

            <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btnGuardarNuevoCultivo">Guardar cultivo</button>
              <button type="button" class="btn btn-secondary" id="btnCancelarNuevoCultivo">Cancelar</button>
            </div>

            <p class="muted" style="margin-top: 10px;">
              El cultivo se guardar√° en este dispositivo y aparecer√° en el cat√°logo como <strong>‚ÄúCultivo personalizado‚Äù</strong>.
            </p>
          </div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üåø</div><h2>Mi huerto</h2></div>
        <p class="section-subtitle">Registra tus cultivos y consulta los detalles de cada planta.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>
          <div class="media-list settings-context"></div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>
            <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo"><span>‚ûï</span> Guardar cultivo</button>
          <p class="muted" style="margin-top:6px;">* Solo el nombre es obligatorio. Puedes editar o eliminar los cultivos luego.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>
          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìì</div><h2>Diario de huerto</h2></div>
        <p class="section-subtitle">Anota riegos, abonados, podas o cualquier evento importante.</p>

        <div class="app-card" id="diarioFormCard">
          <div class="app-card-header">
            <div class="app-card-title" id="diarioFormTitle">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>
          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste hoy?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates y lechugas. Apliqu√© compost."></textarea>
          </div>
          <button class="btn btn-full" id="btnGuardarDiario"><span>üíæ</span> Guardar en el diario</button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas recientes</div>
            <div class="chip" id="diarioCountChip">0 entradas</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>
          <div class="diario-list" id="diarioList"></div>

          <button class="btn btn-secondary btn-full" id="btnExportarDiarioPdf"><span>üì¶</span> Exportar diario (PDF)</button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üêõ</div><h2>Plagas comunes</h2></div>
        <p class="section-subtitle">Referencia r√°pida de plagas frecuentes en huertos caseros y c√≥mo manejarlas.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Cat√°logo b√°sico de plagas</div><div class="chip">Referencia</div></div>
          <div class="media-list" id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üíß</div><h2>Pesticidas y preparados</h2></div>
        <p class="section-subtitle">Opciones suaves y de bajo impacto para manejar plagas en un huerto casero.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Preparados sugeridos</div><div class="chip">Uso responsable</div></div>
          <div class="media-list" id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row"><div class="section-icon-pill">‚öôÔ∏è</div><h2>Opciones</h2></div>
        <p class="section-subtitle">Ajusta el nombre de tu huerto, el clima y el hemisferio.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Datos generales</div></div>
          <div class="media-list settings-context"></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG, Mi huerto, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima principal</label>
              <select id="climaSelect">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <button class="btn btn-full" id="btnGuardarConfig"><span>üíæ</span> Guardar configuraci√≥n</button>

          <div class="divider-soft"></div>
          <p class="muted">Toda la informaci√≥n se guarda <strong>solo en tu dispositivo</strong> usando almacenamiento local.</p>

          <div class="pill-group" style="flex-direction:column;">
            <button class="btn btn-secondary btn-full" id="btnExportarDatosPdf"><span>üìÑ</span> Exportar datos (PDF)</button>
            <button class="btn btn-secondary btn-full" id="btnExportarJson"><span>üíæ</span> Exportar respaldo (.json)</button>
            <button class="btn btn-secondary btn-full" id="btnImportarJson"><span>üç∞</span> Restaurar respaldo</button>
            <button class="btn btn-danger btn-full" id="btnBorrarTodo"><span>üßπ</span> Borrar todo</button>
          </div>

          <input type="file" id="inputRespaldoJSON" accept="application/json" style="display:none" />
        </div>
      </section>

      <!-- GUIAS -->
      <section id="section-guias" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìö</div><h2>Gu√≠as r√°pidas</h2></div>
        <p class="section-subtitle">Consejos b√°sicos para sacar m√°s provecho a tu huerto.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Antes de sembrar</div><div class="chip">Paso 1</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Preparar el suelo</div>
              <div class="media-item-body">Retira piedras y ra√≠ces gruesas, agrega materia org√°nica y afloja la tierra sin voltearla en exceso.</div>
            </div>
            <div>
              <div class="media-item-title">Elegir el lugar</div>
              <div class="media-item-body">La mayor√≠a de los cultivos necesitan al menos 4‚Äì6 horas de sol directo.</div>
            </div>
          </div>
        </div>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Riego inteligente</div><div class="chip">Paso 2</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Revisar la humedad</div>
              <div class="media-item-body">Antes de regar, introduce un dedo en el sustrato hasta 2‚Äì3 cm. Si est√° h√∫medo, espera.</div>
            </div>
            <div>
              <div class="media-item-title">Horario recomendado</div>
              <div class="media-item-body">En climas c√°lidos suele ser mejor regar temprano en la ma√±ana o al final de la tarde.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer><span>Mi Siembra Inteligente ¬∑ Datos guardados localmente en tu dispositivo üåø</span></footer>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>
    <button class="btn btn-secondary" id="btnInstalarPwa"><span>üì≤</span> Instalar</button>
  </div>

  <script>
    "use strict";

    /*********************
     * Helpers (seguridad b√°sica de HTML)
     *********************/
    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
function chipSinDatos(){
  return `<span class="chip chip--muted">Sin datos</span>`;
}

function getCategoriaIcon(categoria){
  const c = String(categoria || "").toLowerCase();
  if (c.includes("hoja")) return "ü•¨";
  if (c.includes("ra√≠z") || c.includes("raiz")) return "ü•ï";
  if (c.includes("tub√©r") || c.includes("tuber")) return "ü•î";
  if (c.includes("arom")) return "üåø";
  if (c.includes("frutal") || c.includes("c√≠trico") || c.includes("citric")) return "üå≥";
  if (c.includes("fruto")) return "üçÖ";
  if (c.includes("bulbo")) return "üßÖ";
  if (c.includes("grano")) return "üåΩ";
  if (c.includes("legumin")) return "ü´ò";
  return "üå±";
}

function catSortKey(c){
  const cat = String(c?.categoria || "zzzz").toLowerCase();
  const nom = String(c?.nombre || "").toLowerCase();
  return `${cat}||${nom}`;
}
    /*********************
     * Storage
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario"
    };

    const DEFAULT_SETTINGS = {
      nombreHuerto: "Mi huerto",
      clima: "tropical",
      hemisferio: "norte"
    };

    const CLIMA_LABEL = {
      tropical: "tropical",
      subtropical: "subtropical/templado",
      templado: "templado/fr√≠o"
    };

    const HEMISFERIO_LABEL = {
      norte: "hemisferio norte",
      sur: "hemisferio sur"
    };

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.settings);
        if (!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...(parsed && typeof parsed === "object" ? parsed : {}) };
      } catch { return { ...DEFAULT_SETTINGS }; }
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings));
    }

    function loadCultivos() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.cultivos);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function saveCultivos(list) {
      localStorage.setItem(STORAGE_KEYS.cultivos, JSON.stringify(list));
    }

    function loadDiario() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.diario);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function saveDiario(list) {
      localStorage.setItem(STORAGE_KEYS.diario, JSON.stringify(list));
    }

    function todayISO() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "Sin fecha";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      const dia = d.getDate().toString().padStart(2, "0");
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }

    /*********************
     * Calendario de siembra
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        5: [
          { titulo: "Re-siembra de lechugas", tipo: "Hoja", detalle: "Siembra escalonada cada 2‚Äì3 semanas para cosechas continuas." },
          { titulo: "R√°banos", tipo: "Ra√≠z", detalle: "Cosecha r√°pida (20‚Äì30 d√≠as). Perfectos para ocupar huecos libres." }
        ],
        6: [
          { titulo: "Berenjena", tipo: "Fruto", detalle: "Le gustan las noches c√°lidas. Ideal para verano tropical." },
          { titulo: "Aj√≠es y pimientos", tipo: "Fruto", detalle: "Sembrar en lugar soleado y con buen drenaje." }
        ]
      },
      subtropical: {
        5: [{ titulo: "Tomates de media estaci√≥n", tipo: "Fruto", detalle: "Elige variedades adaptadas a tu regi√≥n." }]
      },
      templado: {
        2: [{ titulo: "Lechugas de primavera", tipo: "Hoja", detalle: "Siembra temprana bajo protecci√≥n ligera si hay riesgo de heladas." }]
      }
    };

    function ajustarMesPorHemisferio(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      let mes = monthIndex;
      // Ajuste SOLO para climas con estaciones marcadas
      if (settings.hemisferio === "sur" && (climaKey === "templado" || climaKey === "subtropical")) {
        mes = (monthIndex + 6) % 12;
      }
      return mes;
    }

    function getCalendarData(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);
      const base = CALENDARIO_SIEMBRA[climaKey] || {};
      return base[mesAjustado] || [];
    }

    /*********************
     * Cat√°logo base
     *********************/
    const CATALOGO_CULTIVOS = [
      { id:"tomate", nombre:"Tomate", categoria:"Fruto", dias:"70‚Äì90 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, sin encharcar", tiesto:"Macetas profundas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones","Mosca blanca","Orugas"], meses:[0,1,2,3,4,5,6,7], imagen:"img/tomate.jpg" },
      { id:"lechuga", nombre:"Lechuga", categoria:"Hoja", dias:"45‚Äì60 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo siempre ligeramente h√∫medo", tiesto:"Macetas anchas de 3+ galones", profundidad:"0.5 cm", plagas:["Babosas","Caracoles","Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/lechuga.jpg" },
      { id:"pepinillo", nombre:"Pepinillo / Pepino", categoria:"Fruto", dias:"60‚Äì90 d√≠as", luz:"Sol directo", riego:"Abundante y constante", tiesto:"Macetas profundas de 5+ galones con tutor", profundidad:"1‚Äì2 cm", plagas:["Mosca blanca","√Åcaros","Hongos"], meses:[3,4,5,6,7,8], imagen:"img/pepinillo.jpg" },
      { id:"platano", nombre:"Pl√°tano", categoria:"Fruto perenne", dias:"Cosecha a partir de 9‚Äì12 meses", luz:"Sol directo", riego:"Regular, le gusta la humedad", tiesto:"Suelo directo, espacio amplio", profundidad:"Cormo enterrado firmemente", plagas:["Picudo del pl√°tano","Sigatoka"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/platano.jpg" },
      { id:"pimiento_morron", nombre:"Pimiento morr√≥n", categoria:"Fruto", dias:"80‚Äì100 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, evitando encharcamientos", tiesto:"Macetas de 4‚Äì5 galones", profundidad:"0.5 cm", plagas:["Pulgones","Trips","Ara√±a roja"], meses:[2,3,4,5,6,7], imagen:"img/pimiento_morron.jpg" },
      { id:"berenjena", nombre:"Berenjena", categoria:"Fruto", dias:"80‚Äì100 d√≠as", luz:"Sol directo", riego:"Constante, sin encharcar", tiesto:"Macetas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Escarabajos","Pulgones","Ara√±a roja"], meses:[3,4,5,6,7,8], imagen:"img/berenjena.jpg" },
      { id:"cebolla", nombre:"Cebolla", categoria:"Bulbo", dias:"100‚Äì150 d√≠as", luz:"Sol directo", riego:"Moderado, reducir antes de cosechar", tiesto:"Macetas profundas o suelo directo", profundidad:"1‚Äì2 cm", plagas:["Trips","Mosca de la cebolla"], meses:[0,1,2,6,7,8,9,10], imagen:"img/cebolla.jpg" },
      { id:"zanahoria", nombre:"Zanahoria", categoria:"Ra√≠z", dias:"70‚Äì100 d√≠as", luz:"Sol directo", riego:"Suelo siempre ligeramente h√∫medo", tiesto:"Macetas profundas (30+ cm)", profundidad:"0.5‚Äì1 cm", plagas:["Mosca de la zanahoria","Hongos"], meses:[0,1,2,3,8,9,10,11], imagen:"img/zanahoria.jpg" },
      { id:"rabano", nombre:"R√°bano", categoria:"Ra√≠z", dias:"25‚Äì35 d√≠as", luz:"Sol directo o media sombra", riego:"Suelo constantemente h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"1 cm", plagas:["Pulguillas","Babosas"], meses:[0,1,2,3,8,9,10,11], imagen:"img/rabano.jpg" },
      { id:"papa", nombre:"Papa", categoria:"Tub√©rculo", dias:"90‚Äì120 d√≠as", luz:"Sol directo", riego:"Regular, sin encharcar", tiesto:"Sacos o macetas profundas de 10+ galones", profundidad:"Tub√©rculo cubierto con 5‚Äì10 cm de sustrato", plagas:["Escarabajo de la papa","Hongos"], meses:[0,1,2,7,8,9], imagen:"img/papa.jpg" },
      { id:"gandules", nombre:"Gandules", categoria:"Leguminosa perenne", dias:"4‚Äì6 meses para la primera cosecha", luz:"Sol directo", riego:"Moderado, resistente a sequ√≠a", tiesto:"Suelo directo o macetas muy grandes", profundidad:"2‚Äì3 cm", plagas:["Gusanos de vaina","Pulgones"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/gandules.jpg" },
      { id:"calabaza", nombre:"Calabaza", categoria:"Fruto rastrero", dias:"90‚Äì130 d√≠as", luz:"Sol directo", riego:"Regular, le gusta suelo f√©rtil", tiesto:"Suelo directo o macetas muy grandes", profundidad:"2‚Äì3 cm", plagas:["Barrenador de tallo","Mosca blanca"], meses:[2,3,4,5,6,7], imagen:"img/calabaza.jpg" },
      { id:"calabacin_zucchini", nombre:"Calabac√≠n / Zucchini", categoria:"Fruto", dias:"45‚Äì60 d√≠as", luz:"Sol directo", riego:"Regular, sin encharcar", tiesto:"Macetas de 8+ galones", profundidad:"2‚Äì3 cm", plagas:["O√≠dio","Pulgones"], meses:[2,3,4,5,6,7], imagen:"img/calabacin_zucchini.jpg" },
      { id:"maiz", nombre:"Ma√≠z", categoria:"Grano", dias:"80‚Äì100 d√≠as", luz:"Sol directo", riego:"Regular, m√°s constante en floraci√≥n", tiesto:"Parterres o contenedores grandes", profundidad:"2‚Äì3 cm", plagas:["Gusanos del ma√≠z","Pulgones"], meses:[2,3,4,5,6,7], imagen:"img/maiz.jpg" },
      { id:"habichuelas", nombre:"Habichuelas", categoria:"Leguminosa", dias:"60‚Äì80 d√≠as", luz:"Sol directo", riego:"Regular, sin encharcar", tiesto:"Macetas de 5+ galones con tutor", profundidad:"2‚Äì3 cm", plagas:["Pulgones","Trips"], meses:[2,3,4,5,6,7], imagen:"img/habichuelas.jpg" },
      { id:"cilantro", nombre:"Cilantro", categoria:"Arom√°tica", dias:"30‚Äì50 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo fresco y h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/cilantro.jpg" },
      { id:"albahaca", nombre:"Albahaca", categoria:"Arom√°tica", dias:"40‚Äì60 d√≠as", luz:"Sol directo suave", riego:"Suelo ligeramente h√∫medo", tiesto:"Macetas de 3+ galones", profundidad:"0.5 cm", plagas:["Pulgones","Mosca blanca"], meses:[2,3,4,5,6,7,8], imagen:"img/albahaca.jpg" },
      { id:"mango", nombre:"Mango", categoria:"Frutal perenne", dias:"Varios a√±os hasta producir", luz:"Sol directo fuerte", riego:"Poco una vez establecido", tiesto:"Suelo directo; macet√≥n solo en variedades enanas", profundidad:"Plant√≠n al nivel del cuello", plagas:["Mosca de la fruta","Hongos"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/mango.jpg" },
      { id:"limon", nombre:"Lim√≥n", categoria:"Frutal c√≠trico", dias:"2‚Äì3 a√±os desde plant√≠n", luz:"Sol directo", riego:"Regular en sequ√≠a", tiesto:"Macet√≥n grande o suelo directo", profundidad:"Plant√≠n al nivel del cuello", plagas:["Minador de hoja","Cochinillas"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/limon.jpg" },
      { id:"chayote", nombre:"Chayote", categoria:"Fruto trepador", dias:"120‚Äì180 d√≠as (primera cosecha)", luz:"Sol directo o media sombra luminosa", riego:"Regular, suelos h√∫medos pero bien drenados", tiesto:"Mejor en suelo directo con enredadera", profundidad:"Fruto enterrado lateral, apenas cubierto", plagas:["Babosas","Caracoles","Hongos"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/chayote.jpg" },
      { id:"pina", nombre:"Pi√±a", categoria:"Frutal perenne", dias:"15‚Äì18 meses hasta la primera cosecha", luz:"Sol directo fuerte", riego:"Moderado, evitando encharcamientos", tiesto:"Macetones profundos o suelo directo", profundidad:"Corona plantada superficialmente", plagas:["Cochinillas","Hongos","Mosca de la fruta"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/pina.jpg" }
    ];

    /*********************
     * Germinaci√≥n / reproducci√≥n
     *********************/
    const GERMINACION_POR_CULTIVO = {
      tomate: {
        titulo: "Tomate ‚Äì germinaci√≥n",
        metodo: "Semilla en alm√°cigo y luego trasplante.",
        pasos: [
          "Llenar bandeja o alm√°cigo con sustrato suelto y bien drenado.",
          "Sembrar la semilla a 0.5‚Äì1 cm de profundidad.",
          "Mantener siempre ligeramente h√∫medo, sin encharcar.",
          "Trasplantar cuando tenga 3‚Äì4 hojas verdaderas."
        ],
        tip: "Las pl√°ntulas al inicio prefieren luz filtrada, no sol directo fuerte."
      },
      lechuga: {
        titulo: "Lechuga ‚Äì germinaci√≥n",
        metodo: "Semilla directa o en alm√°cigo.",
        pasos: [
          "Sembrar muy superficial, apenas cubierta de sustrato.",
          "Mantener el sustrato siempre h√∫medo.",
          "Siembra en alm√°cigo: trasplantar con 3‚Äì4 hojas.",
          "Siembra directa: ralear, dejando espacio entre plantas."
        ],
        tip: "Germina mejor con temperaturas moderadas y sol suave."
      },
      calabacin_zucchini: {
        titulo: "Calabac√≠n / Zucchini ‚Äì germinaci√≥n",
        metodo: "Semilla directa en el sitio definitivo o tiesto grande.",
        pasos: [
          "Hacer hoyos de 2‚Äì3 cm de profundidad.",
          "Sembrar 2‚Äì3 semillas por hoyo y luego dejar la planta m√°s fuerte.",
          "Mantener el suelo h√∫medo pero sin charcos.",
          "Dejar buen espacio entre plantas, se abren bastante."
        ],
        tip: "Evita mojar hojas todo el tiempo para no favorecer el o√≠dio."
      },
      platano: {
        titulo: "Pl√°tano ‚Äì reproducci√≥n",
        metodo: "Hijuelos / cormos, no semilla.",
        pasos: [
          "Elegir hijuelos sanos, sin pudriciones.",
          "Cortar el hijo y dejarlo orear unas horas.",
          "Plantar enterrando bien el cormo en suelo con buen drenaje.",
          "Regar para asentar la tierra y luego mantener humedad moderada."
        ],
        tip: "No lo pongas donde se empoce el agua."
      },
      papa: {
        titulo: "Papa ‚Äì siembra",
        metodo: "Trozos de tub√©rculo con al menos 1‚Äì2 ojos.",
        pasos: [
          "Cortar la papa en trozos con ojos y dejarlos secar 1 d√≠a.",
          "Sembrar a 10 cm de profundidad.",
          "Cuando crece, ir aporcando (echando tierra al tallo).",
          "Mantener riego regular sin encharcar."
        ],
        tip: "Rota el lugar de siembra para evitar plagas y enfermedades."
      },
      chayote: {
        titulo: "Chayote ‚Äì germinaci√≥n",
        metodo: "El fruto entero se usa como semilla.",
        pasos: [
          "Elegir un chayote sano, sin golpes ni pudrici√≥n.",
          "Dejarlo brotar en un lugar ventilado y sombreado.",
          "Cuando el brote tenga buen tama√±o, plantar el fruto de lado en suelo suelto.",
          "Cubrir parcialmente con tierra y mantener el sustrato h√∫medo, sin encharcar."
        ],
        tip: "Dale una estructura para trepar; es muy vigoroso."
      }
    };

    const GERMINACION_GENERIC = {
      hoja: { titulo:"Cultivos de hoja ‚Äì germinaci√≥n b√°sica", metodo:"Semilla directa o en alm√°cigo, muy superficial.", pasos:["Usar sustrato suelto y bien drenado.","Sembrar la semilla casi en superficie, apenas cubierta.","Mantener siempre ligeramente h√∫medo, sin charcos.","Trasplantar (si es alm√°cigo) cuando tenga 3‚Äì4 hojas verdaderas."], tip:"Prefieren sol suave o media sombra y riegos frecuentes." },
      fruto:{ titulo:"Cultivos de fruto ‚Äì germinaci√≥n b√°sica", metodo:"Semilla en alm√°cigo o directa seg√∫n el espacio.", pasos:["Sembrar a 1‚Äì2 cm de profundidad seg√∫n tama√±o de semilla.","Mantener el sustrato h√∫medo, no encharcado.","Dar buena luz desde peque√±os para que no se espiguen.","Trasplantar a tiesto grande o suelo cuando est√©n fuertes."], tip:"Necesitan mucho sol y macetas profundas o suelo suelto." },
      raiz: { titulo:"Ra√≠ces ‚Äì germinaci√≥n b√°sica", metodo:"Siempre semilla directa en el sitio definitivo.", pasos:["Aflojar bien el suelo a buena profundidad.","Sembrar muy superficial (0.5‚Äì1 cm).","Mantener humedad constante hasta que germinen.","Ralear dejando espacio entre plantas."], tip:"No trasplantar: se deforman las ra√≠ces." },
      tuberculo:{ titulo:"Tub√©rculos ‚Äì siembra b√°sica", metodo:"Trozos de tub√©rculo o estacas seg√∫n el cultivo.", pasos:["Elegir material sano, sin pudriciones.","Dejar orear si hace falta (como en papa).","Enterrar a buena profundidad en suelo suelto.","Mantener riego regular sin encharcar."], tip:"Les va bien un suelo profundo y con materia org√°nica." },
      aromatica:{ titulo:"Arom√°ticas ‚Äì germinaci√≥n b√°sica", metodo:"Semilla fina o esquejes, seg√∫n especie.", pasos:["Semilla: sembrar muy superficial y mantener humedad fina.","Esquejes: enterrar la parte baja en sustrato h√∫medo.","Colocar en lugar luminoso, sin sol muy fuerte al inicio.","Trasplantar cuando el cepell√≥n est√© firme."], tip:"Muchas arom√°ticas prefieren maceta." },
      frutal:{ titulo:"Frutales ‚Äì establecimiento b√°sico", metodo:"Plantines o injertos, m√°s que semilla.", pasos:["Comprar plant√≠n sano o injertado si es posible.","Hacer hoyo amplio, mejorar el suelo con materia org√°nica.","Plantar al nivel del cuello de la planta.","Regar bien al inicio y tutorar si hace falta."], tip:"Necesitan sitio fijo, sol y paciencia." },
      generico:{ titulo:"Germinaci√≥n b√°sica ‚Äì gu√≠a general", metodo:"Semilla directa o en bandeja seg√∫n tama√±o de planta.", pasos:["Leer siempre las indicaciones del sobre de semilla.","Usar sustrato suelto y limpio.","Respetar profundidad aproximada de 2‚Äì3 veces el tama√±o de la semilla.","Mantener humedad constante hasta que germinen."], tip:"Si dudas, prueba en alm√°cigo y directo y observa." }
    };

    function getInfoGerminacion(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      if (!cultivo) return null;
      if (GERMINACION_POR_CULTIVO[cultivoId]) return GERMINACION_POR_CULTIVO[cultivoId];

      const cat = (cultivo.categoria || "").toLowerCase();
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;
      if (cat.includes("tub√©rc") || cat.includes("tuberc")) return GERMINACION_GENERIC.tuberculo;
      if (cat.includes("arom√°tica") || cat.includes("aromatica")) return GERMINACION_GENERIC.aromatica;
      if (cat.includes("frutal")) return GERMINACION_GENERIC.frutal;
      if (cat.includes("fruto")) return GERMINACION_GENERIC.fruto;
      return GERMINACION_GENERIC.generico;
    }

    /*********************
     * Plagas (datos base)
     *********************/
    const PLAGAS_DATA = [
      { id:"pulgones", nombre:"Pulgones", comoSeVe:"Peque√±os insectos verdes, negros o amarillos pegados en brotes tiernos. Hojas enrolladas o deformadas.", manejoSuave:"Lavar con agua a presi√≥n suave y revisar con frecuencia brotes tiernos.", preparadosCaseros:"Jab√≥n pot√°sico o agua con jab√≥n neutro (bien diluido) al atardecer.", productosComerciales:"Insecticidas de contacto para pulgones autorizados para huerto casero." },
      { id:"mosca_blanca", nombre:"Mosca blanca", comoSeVe:"Al mover la hoja salen volantitos blancos. En el env√©s se ven peque√±os puntos blancos fijos.", manejoSuave:"Retirar hojas muy afectadas y mejorar ventilaci√≥n entre plantas.", preparadosCaseros:"Trampas amarillas adhesivas y jab√≥n pot√°sico suave.", productosComerciales:"Productos espec√≠ficos para mosca blanca de uso dom√©stico." },
      { id:"orugas", nombre:"Orugas", comoSeVe:"Hojas con mordidas grandes. Orugas visibles en env√©s o entre hojas.", manejoSuave:"Recolecci√≥n manual con guantes, muy efectiva en huertos peque√±os.", preparadosCaseros:"Infusi√≥n de ajo y aj√≠ como repelente, junto con retiro manual.", productosComerciales:"Bacillus thuringiensis (BT) para orugas j√≥venes." },
      { id:"caracoles_babosas", nombre:"Caracoles y babosas", comoSeVe:"Mordidas irregulares en hojas y rastros de baba plateada.", manejoSuave:"Mantener el √°rea limpia y recogerlos a mano al atardecer.", preparadosCaseros:"Refugios-trampa y barreras de c√°scara de huevo triturada.", productosComerciales:"Cebos para babosas/caracoles aptos para huerto casero." },
      { id:"arana_roja", nombre:"Ara√±a roja", comoSeVe:"Puntos amarillos finos en hojas y, en ataques fuertes, telara√±as finas.", manejoSuave:"Aumentar humedad ambiental y duchas de agua en el env√©s.", preparadosCaseros:"Jab√≥n pot√°sico muy diluido o infusi√≥n de ajo.", productosComerciales:"Acaricidas espec√≠ficos para ara√±a roja." },
      { id:"trips", nombre:"Trips", comoSeVe:"Manchas plateadas o rayas en hojas y p√©talos. Insectos alargados y r√°pidos.", manejoSuave:"Eliminar flores y hojas muy da√±adas y mejorar ventilaci√≥n.", preparadosCaseros:"Trampas azules/amarillas adhesivas y jab√≥n pot√°sico.", productosComerciales:"Insecticidas para trips de uso dom√©stico." },
      { id:"cochinillas", nombre:"Cochinillas", comoSeVe:"Bultitos algodonosos o duros en tallos y hojas; melaza pegajosa.", manejoSuave:"Retirar a mano o con hisopo y alcohol. Podar partes muy infestadas.", preparadosCaseros:"Jab√≥n pot√°sico y aceites vegetales suaves.", productosComerciales:"Aceites hort√≠colas o productos para cochinilla." },
      { id:"hongos_hoja", nombre:"Hongos de hoja (mildiu, o√≠dio, manchas)", comoSeVe:"Manchas amarillas o caf√©s, a veces polvillo blanco en hojas.", manejoSuave:"Mejorar ventilaci√≥n, evitar mojar follaje de noche y retirar hojas enfermas.", preparadosCaseros:"Bicarbonato suave o infusiones de cola de caballo.", productosComerciales:"Fungicidas autorizados para huerto casero." }
    ];

    /*********************
     * Estado global
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";
    let diarioEnEdicionId = null;

    /*********************
     * Cultivos personalizados (Cat√°logo)
     *********************/
    const STORAGE_CUSTOM_CULTIVOS = "msi-custom-cultivos-v17";
    let customEditId = null;

    function loadCustomCultivos() {
      try {
        const raw = localStorage.getItem(STORAGE_CUSTOM_CULTIVOS);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }

    function saveCustomCultivos(arr) {
      try { localStorage.setItem(STORAGE_CUSTOM_CULTIVOS, JSON.stringify(arr)); }
      catch (e) { console.error("Error guardando custom:", e); }
    }

    function parsePlagas(str) {
      return (str || "").split(",").map(s => s.trim()).filter(Boolean);
    }

    function allMonths() { return [0,1,2,3,4,5,6,7,8,9,10,11]; }

    function getMesesSeleccionadosUI() {
      return Array.from(document.querySelectorAll("#nuevoCultivoMesesPills .pill.pill--active"))
        .map(b => parseInt(b.dataset.mes, 10))
        .filter(n => Number.isFinite(n));
    }

    function setMesesSeleccionadosUI(meses) {
      const set = new Set((meses || []).map(Number));
      document.querySelectorAll("#nuevoCultivoMesesPills .pill").forEach(b => {
        const m = parseInt(b.dataset.mes, 10);
        b.classList.toggle("pill--active", set.has(m));
      });
    }

    function setupNuevoCultivoMesesPills() {
      const wrap = document.getElementById("nuevoCultivoMesesPills");
      if (!wrap) return;
      if (wrap.dataset.bound === "1") return;
      wrap.dataset.bound = "1";

      wrap.addEventListener("click", (ev) => {
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        b.classList.toggle("pill--active");
      });
    }

    function removeCustomFromCatalogo() {
      for (let i = CATALOGO_CULTIVOS.length - 1; i >= 0; i--) {
        if (CATALOGO_CULTIVOS[i]?.esPersonalizado) CATALOGO_CULTIVOS.splice(i, 1);
      }
    }

    function injectCustomIntoCatalogo(customList) {
      removeCustomFromCatalogo();
      customList.forEach(c => CATALOGO_CULTIVOS.push({ ...c, esPersonalizado: true }));
    }
// Helper: valida si un valor tiene contenido real
function isFilled(v){
  if (v === null || v === undefined) return false;
  const s = String(v).trim();
  return s !== "" && s !== "‚Äî" && s.toLowerCase() !== "null";
}
    function buildCustomCultivoFromUI(existingId) {
      const nombre = (document.getElementById("nuevoCultivoNombre")?.value || "").trim();
      const categoria = (document.getElementById("nuevoCultivoCategoria")?.value || "Otro").trim();

      const diasG = parseInt(document.getElementById("nuevoCultivoDiasGerminacion")?.value || "", 10);
      const diasC = parseInt(document.getElementById("nuevoCultivoDiasCosecha")?.value || "", 10);

      const luz = (document.getElementById("nuevoCultivoLuz")?.value || "").trim() || null;
const riego = (document.getElementById("nuevoCultivoRiego")?.value || "").trim() || null;
const tiesto = (document.getElementById("nuevoCultivoTiesto")?.value || "").trim() || null;
const profundidad = (document.getElementById("nuevoCultivoProfundidad")?.value || "").trim() || null;
      const plagasStr = (document.getElementById("nuevoCultivoPlagas")?.value || "").trim();

      if (!nombre) { alert("Escribe el nombre del cultivo."); return null; }

      let meses = getMesesSeleccionadosUI();
      if (!meses.length) meses = allMonths();

      const id = existingId || `custom-${Date.now().toString(36)}`;
      const diasTexto = Number.isFinite(diasC) && diasC > 0 ? `${diasC} d√≠as` : null;
      return {
        id,
        nombre,
        categoria,
dias: diasTexto,
        luz,
        riego,
        tiesto,
        profundidad,
        plagas: parsePlagas(plagasStr),
        meses,
        imagen: "img/placeholder.jpg",
        esPersonalizado: true,
        diasGerminacion: Number.isFinite(diasG) && diasG > 0 ? diasG : null,
        diasCosecha: Number.isFinite(diasC) && diasC > 0 ? diasC : null
      };
    }

    function clearCustomCultivoUI() {
      ["nuevoCultivoNombre","nuevoCultivoDiasGerminacion","nuevoCultivoDiasCosecha","nuevoCultivoLuz","nuevoCultivoRiego","nuevoCultivoTiesto","nuevoCultivoProfundidad","nuevoCultivoPlagas"]
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });

      const cat = document.getElementById("nuevoCultivoCategoria");
      if (cat) cat.value = "Otro";
      setMesesSeleccionadosUI([]);
    }

    function resetEditCustomCultivoUI() {
      customEditId = null;
      const t = document.getElementById("nuevoCultivoTitulo");
      if (t) t.textContent = "Nuevo cultivo";
      const btn = document.getElementById("btnGuardarNuevoCultivo");
      if (btn) btn.textContent = "Guardar cultivo";
    }

    function startEditCustomCultivo(cultivo) {
      customEditId = cultivo.id;

      const card = document.getElementById("nuevoCultivoCard");
      if (card) card.style.display = "block";

      const t = document.getElementById("nuevoCultivoTitulo");
      if (t) t.textContent = "Editar cultivo";

      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");
      if (btnGuardar) btnGuardar.textContent = "Actualizar cultivo";

      document.getElementById("nuevoCultivoNombre").value = cultivo.nombre || "";
      document.getElementById("nuevoCultivoCategoria").value = cultivo.categoria || "Otro";
      document.getElementById("nuevoCultivoDiasGerminacion").value = cultivo.diasGerminacion || "";
      document.getElementById("nuevoCultivoDiasCosecha").value = cultivo.diasCosecha || "";
      document.getElementById("nuevoCultivoLuz").value = cultivo.luz || "";
      document.getElementById("nuevoCultivoRiego").value = cultivo.riego || "";
      document.getElementById("nuevoCultivoTiesto").value = cultivo.tiesto || "";
      document.getElementById("nuevoCultivoProfundidad").value = cultivo.profundidad || "";
      document.getElementById("nuevoCultivoPlagas").value = Array.isArray(cultivo.plagas) ? cultivo.plagas.join(", ") : "";

      setMesesSeleccionadosUI(Array.isArray(cultivo.meses) ? cultivo.meses : []);
      setupNuevoCultivoMesesPills();

      card?.scrollIntoView({ behavior: "smooth", block: "start" });
      document.getElementById("nuevoCultivoNombre")?.focus();
    }

    function deleteCustomCultivoById(id) {
      const customList = loadCustomCultivos().filter(c => c.id !== id);
      saveCustomCultivos(customList);
      injectCustomIntoCatalogo(customList);

      if (customEditId === id) {
        resetEditCustomCultivoUI();
        document.getElementById("nuevoCultivoCard").style.display = "none";
        clearCustomCultivoUI();
      }
    }

    function setupCultivoManualUI() {
      const btnToggle = document.getElementById("btnToggleNuevoCultivo");
      const card = document.getElementById("nuevoCultivoCard");
      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");
      const btnCancelar = document.getElementById("btnCancelarNuevoCultivo");

      if (!btnToggle || !card || !btnGuardar || !btnCancelar) return;

      setupNuevoCultivoMesesPills();

      // Evitar duplicar listeners si llamas dos veces
      if (btnToggle.dataset.bound === "1") return;
      btnToggle.dataset.bound = "1";

      btnToggle.addEventListener("click", () => {
        const visible = card.style.display !== "none";
        card.style.display = visible ? "none" : "block";
        if (!visible) document.getElementById("nuevoCultivoNombre")?.focus();
        else { clearCustomCultivoUI(); resetEditCustomCultivoUI(); }
      });

      btnCancelar.addEventListener("click", () => {
        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
      });

      btnGuardar.addEventListener("click", () => {
        const wasEditing = Boolean(customEditId);
        const cultivo = buildCustomCultivoFromUI(customEditId);
        if (!cultivo) return;

        let customList = loadCustomCultivos();

        if (customEditId) {
          customList = customList.filter(c => c.id !== customEditId);
        } else {
          const nameLower = (cultivo.nombre || "").toLowerCase();
          customList = customList.filter(c => (c.nombre || "").toLowerCase() !== nameLower);
        }

        customList.push(cultivo);
        saveCustomCultivos(customList);
        injectCustomIntoCatalogo(customList);

        const filtro = (document.getElementById("catalogoBusqueda")?.value || "").trim();
        renderCatalogo(filtro);

        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();

        alert(wasEditing ? "Cultivo actualizado ‚úÖ" : "Cultivo guardado ‚úÖ");
      });
    }

    function initCustomCultivos() {
      const customList = loadCustomCultivos();
      injectCustomIntoCatalogo(customList);
      setupCultivoManualUI();
    }

    /*********************
     * Render UI
     *********************/
    function updateHeader() {
      const subtitleEl = document.getElementById("appSubtitle");
      if (!subtitleEl) return;

      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${escapeHTML(nombre)}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${escapeHTML(clima)}</span>
        <span class="app-subtitle-dot"></span>
        <span>${escapeHTML(hemis)}</span>
      `;
    }

    function updateSettingsContexts() {
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      document.querySelectorAll(".settings-context").forEach(el => {
        el.innerHTML = `
          <span class="chip"><span>üåø</span> Huerto: ${escapeHTML(nombre)}</span>
          <span class="chip"><span>‚òÅÔ∏è</span> Clima: ${escapeHTML(clima)}</span>
          <span class="chip"><span>üß≠</span> ${escapeHTML(hemis)}</span>
        `;
      });

      const climaText = `Clima ${clima}`;
      const estadoClimaChip = document.getElementById("estadoClimaChip");
      if (estadoClimaChip) estadoClimaChip.textContent = climaText;
      const calChip2 = document.getElementById("calendarioClimaChip2");
      if (calChip2) calChip2.textContent = climaText;
    }

    function renderInicio() {
      const cultivosCount = stateCultivos.length;
      const hoyISO = todayISO();
      const entradasHoy = stateDiario.filter(e => e.fecha === hoyISO).length;

      const cultivosEl = document.getElementById("estadoCultivosCount");
      const entradasEl = document.getElementById("estadoEntradasCount");
      if (cultivosEl) cultivosEl.textContent = String(cultivosCount);
      if (entradasEl) entradasEl.textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      if (!resumen) return;

      const nombre = stateSettings.nombreHuerto || "tu huerto";
      let texto;

      if (!cultivosCount && !entradasHoy) {
        texto = 'Todav√≠a no has registrado cultivos ni entradas en el diario. Empieza a√±adiendo tu primer cultivo en "Mi huerto".';
      } else if (cultivosCount && !entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) registrado(s) en ${nombre}. A√∫n no has escrito nada en el diario hoy.`;
      } else if (cultivosCount && entradasHoy) {
        texto = `Llevas ${cultivosCount} cultivo(s) activo(s) y ya registraste ${entradasHoy} nota(s) en el diario hoy. ¬°Buen trabajo!`;
      } else {
        texto = 'Tienes anotaciones en el diario pero a√∫n no has a√±adido cultivos. Usa "Mi huerto" para registrar lo que est√°s sembrando.';
      }

      resumen.textContent = texto;
    }

    function renderCalendario(monthIndex) {
  const listEl = document.getElementById("calendarList");
  const emptyEl = document.getElementById("calendarEmpty");
  if (!listEl || !emptyEl) return;

  listEl.innerHTML = "";

  const data = getCalendarData(stateSettings, monthIndex);

  // Aviso si el mes se ajusta por hemisferio (solo en subtropical/templado)
  const MESES_ABR = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  const mesAjustado = ajustarMesPorHemisferio(stateSettings, monthIndex);

  if (mesAjustado !== monthIndex) {
    const info = document.createElement("p");
    info.className = "muted";
    info.textContent = `Hemisferio sur: ${MESES_ABR[monthIndex]} se interpreta como ${MESES_ABR[mesAjustado]} (+6m).`;
    listEl.appendChild(info);
  }

  if (data.length) {
    emptyEl.style.display = "none";
    data.forEach(item => {
      const div = document.createElement("div");
      div.className = "calendar-item";
      div.innerHTML = `
        <div class="calendar-item-title">
          <span>${escapeHTML(item.titulo)}</span>
          <span class="chip">${escapeHTML(item.tipo)}</span>
        </div>
        <div>${escapeHTML(item.detalle)}</div>
      `;
      listEl.appendChild(div);
    });
  } else {
    emptyEl.style.display = "block";
  }

  // Recomendaciones desde el cat√°logo (mes ajustado)
  const mesCatalogo = ajustarMesPorHemisferio(stateSettings, monthIndex);
  const sugeridos = CATALOGO_CULTIVOS.filter(c => Array.isArray(c.meses) && c.meses.includes(mesCatalogo));

  if (sugeridos.length) {
    emptyEl.style.display = "none";

    const separador = document.createElement("div");
    separador.className = "divider-soft";
    listEl.appendChild(separador);

    const tituloExtra = document.createElement("p");
    tituloExtra.className = "muted";
    tituloExtra.textContent = "Desde el cat√°logo: cultivos recomendados para este mes.";
    listEl.appendChild(tituloExtra);

    sugeridos.forEach(c => {
      const div = document.createElement("div");
      div.className = "calendar-item";
      div.innerHTML = `
        <div class="calendar-item-title">
          <span>${escapeHTML(c.nombre)}</span>
          <span class="chip">${escapeHTML(c.categoria)}</span>
        </div>
        <div>
  ${isFilled(c.dias) ? `D√≠as a cosecha: ${escapeHTML(c.dias)}.` : ``}
  ${isFilled(c.luz) ? ` Luz: ${escapeHTML(c.luz)}.` : ``}
</div>
        <div style="margin-top:6px;">
          <button class="btn btn-secondary btn-full" data-action="ver-catalogo" data-id="${escapeHTML(c.id)}">
            üîç Ver en cat√°logo
          </button>
        </div>
      `;
      listEl.appendChild(div);
    });
  }
}
    function irACultivoEnCatalogo(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      const textoBusqueda = cultivo ? cultivo.nombre : "";

      const navBtn = document.querySelector('.nav-btn[data-section="catalogo"]');
      if (navBtn) navBtn.click();
function getCategoriasUnicas(){
  const set = new Set(["Todas"]);
  (CATALOGO_CULTIVOS || []).forEach(c => set.add((c.categoria || "Otro").trim() || "Otro"));
  return Array.from(set);
}

function openCatSheet(){
  const back = document.getElementById("catSheetBackdrop");
  const sheet = document.getElementById("catSheet");
  const list = document.getElementById("catSheetList");
  if (!back || !sheet || !list) return;

  list.innerHTML = "";
  getCategoriasUnicas().forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "sheet-chip" + (cat === categoriaActiva ? " active" : "");
    chip.textContent = cat;
    chip.onclick = () => {
      categoriaActiva = cat;
      const btn = document.getElementById("btnCategorias");
if (btn) btn.textContent = cat === "Todas" ? "Categor√≠as" : cat;
      closeCatSheet();

      const input = document.getElementById("catalogoBusqueda");
      renderCatalogo(input ? input.value : "");
    };
    list.appendChild(chip);
  });

  back.hidden = false;
  sheet.hidden = false;
}

function closeCatSheet(){
  const back = document.getElementById("catSheetBackdrop");
  const sheet = document.getElementById("catSheet");
  if (back) back.hidden = true;
  if (sheet) sheet.hidden = true;
}
      const input = document.getElementById("catalogoBusqueda");
      if (input) input.value = textoBusqueda;

      renderCatalogo(textoBusqueda);

      const section = document.getElementById("section-catalogo");
      section?.scrollIntoView?.({ behavior: "smooth", block: "start" });
    }
let categoriaActiva = "Todas";

function getCategoriasUnicas(){
  const set = new Set(["Todas"]);
  (CATALOGO_CULTIVOS || []).forEach(c => set.add((c.categoria || "Otro").trim() || "Otro"));
  return Array.from(set);
}

function openCatSheet(){
  const back = document.getElementById("catSheetBackdrop");
  const sheet = document.getElementById("catSheet");
  const list = document.getElementById("catSheetList");
  if (!back || !sheet || !list) return;

  list.innerHTML = "";
  getCategoriasUnicas().forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "sheet-chip" + (cat === categoriaActiva ? " active" : "");
    chip.textContent = cat;
    chip.onclick = () => {
      categoriaActiva = cat;

      // Cambia texto del bot√≥n de categor√≠as
      const btn = document.querySelector(".btn-categorias");
      if (btn) btn.textContent = cat === "Todas" ? "üå± Categor√≠as" : `üå± ${cat}`;

      closeCatSheet();
      const input = document.getElementById("catalogoBusqueda");
      renderCatalogo(input ? input.value : "");
    };
    list.appendChild(chip);
  });

  back.hidden = false;
  sheet.hidden = false;
}

function closeCatSheet(){
  const back = document.getElementById("catSheetBackdrop");
  const sheet = document.getElementById("catSheet");
  if (back) back.hidden = true;
  if (sheet) sheet.hidden = true;
}
function renderCatalogo(filtroTexto = "") {
  const listEl = document.getElementById("catalogoList");
  if (!listEl) return;

  const filtro = filtroTexto.trim().toLowerCase();
let lista = CATALOGO_CULTIVOS.filter(c => {
  // Filtro por categor√≠a seleccionada
  if (categoriaActiva !== "Todas" && (c.categoria || "") !== categoriaActiva) return false;

  if (!filtro) return true;

  return (
    (c.nombre || "").toLowerCase().includes(filtro) ||
    (c.id || "").toLowerCase().includes(filtro) ||
    (c.categoria || "").toLowerCase().includes(filtro)
  );
});

  // ORDEN: por categor√≠a y luego por nombre
  lista.sort((a, b) => catSortKey(a).localeCompare(catSortKey(b), "es", { sensitivity: "base" }));

  if (!lista.length) {
    listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${escapeHTML(filtroTexto)}".</p>`;
    return;
  }
  listEl.innerHTML = "";

  let categoriaActual = null;

  lista.forEach(c => {
    const categoria = (c.categoria || "Otro").trim();
    const categoriaKey = categoria.toLowerCase();

    if (categoriaKey !== categoriaActual) {
      categoriaActual = categoriaKey;

      const header = document.createElement("div");
      header.className = "catalogo-categoria-title";
      header.innerHTML = `
        <span>${getCategoriaIcon(categoria)} ${escapeHTML(categoria)}</span>
        <span class="chip">Categor√≠a</span>
      `;
      listEl.appendChild(header);
    }

    const imgSrc = c.imagen || "img/placeholder.jpg";
    const icon = getCategoriaIcon(c.categoria);
    const plagasTxt = Array.isArray(c.plagas) && c.plagas.length ? c.plagas.join(", ") : "";

    const accionesExtra = c.esPersonalizado ? `
      <button class="btn btn-secondary" data-action="editar-custom" data-id="${escapeHTML(c.id)}">‚úèÔ∏è Editar</button>
      <button class="btn btn-danger" data-action="borrar-custom" data-id="${escapeHTML(c.id)}">üóë Borrar</button>
    ` : "";

    const infoRows = [];
    if (isFilled(c.dias)) infoRows.push(`<div><strong>D√≠as a cosecha:</strong> ${escapeHTML(c.dias)}</div>`);
    if (isFilled(c.luz)) infoRows.push(`<div><strong>Luz:</strong> ${escapeHTML(c.luz)}</div>`);
    if (isFilled(c.riego)) infoRows.push(`<div><strong>Riego:</strong> ${escapeHTML(c.riego)}</div>`);
    if (isFilled(c.tiesto)) infoRows.push(`<div><strong>Tiesto / suelo:</strong> ${escapeHTML(c.tiesto)}</div>`);
    if (isFilled(c.profundidad)) infoRows.push(`<div><strong>Profundidad:</strong> ${escapeHTML(c.profundidad)}</div>`);
    if (isFilled(plagasTxt)) infoRows.push(`<div><strong>Plagas:</strong> ${escapeHTML(plagasTxt)}</div>`);

    const bodyHtml = infoRows.length
      ? `<div class="cultivo-body">${infoRows.join("")}</div>`
      : `<div class="cultivo-body"><span class="chip chip--muted">Sin datos</span></div>`;

    const card = document.createElement("div");
    card.className = "cultivo-card";

    card.innerHTML = `
      <div class="cultivo-header">
        <div class="cultivo-title">
          <img
            src="${escapeHTML(imgSrc)}"
            alt=""
            class="cultivo-thumb"
            loading="lazy"
            decoding="async"
            onerror="this.onerror=null;this.src='img/placeholder.jpg';"
          />
          <span>${icon} ${escapeHTML(c.nombre || "Cultivo")}</span>
        </div>
        <span class="chip">${escapeHTML(categoria)}</span>
      </div>

      ${bodyHtml}

      <div class="cultivo-actions">
        <button class="btn btn-secondary" data-action="germinacion" data-id="${escapeHTML(c.id)}">üå± Germinaci√≥n</button>
        ${accionesExtra}
      </div>

      <div class="germinacion-panel"></div>
    `;

    listEl.appendChild(card);
  });
}
    function getRiegoYCosechaParaNombre(nombre, fechaSiembraISO) {
      let frecuenciaRiego = null;
      let fechaCosechaEstimada = null;
      if (!nombre) return { frecuenciaRiego, fechaCosechaEstimada };

      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(c =>
        (c.nombre || "").toLowerCase() === nombreLower || (c.id || "").toLowerCase() === nombreLower
      );

      if (cultivoCatalogo) {
        frecuenciaRiego = 3; // simple
        if (fechaSiembraISO && cultivoCatalogo.dias) {
          const match = String(cultivoCatalogo.dias).match(/(\d+)/);
          if (match) {
            const dias = parseInt(match[1], 10);
            if (Number.isFinite(dias) && dias > 0) fechaCosechaEstimada = addDays(fechaSiembraISO, dias);
          }
        }
      }
      return { frecuenciaRiego, fechaCosechaEstimada };
    }

    function renderCultivos() {
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      if (!listEl) return;

      const count = stateCultivos.length;
      if (chip) chip.textContent = `${count} cultivo${count === 1 ? "" : "s"}`;

      if (!count) {
        listEl.innerHTML = '<p class="muted">Todav√≠a no has registrado cultivos. Usa el formulario de arriba para a√±adir tu primera siembra.</p>';
        return;
      }

      const tipoLabelMap = { hoja:"Hoja", fruto:"Fruto", raiz:"Ra√≠z", tuberculo:"Tub√©rculo", aromaticas:"Arom√°ticas", otro:"Otro" };

      listEl.innerHTML = "";
      stateCultivos.forEach(c => {
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";

        const ultimaAbonoTexto = c.ultimaFertilizacion ? formatDate(c.ultimaFertilizacion) : "Sin registro";
        const frecuenciaAbonoTexto = c.frecuenciaAbonoDias ? c.frecuenciaAbonoDias + " d√≠as" : "No definida";

        const ultimoRiegoTexto = c.ultimoRiego ? formatDate(c.ultimoRiego) : "Sin registro";
        const frecuenciaRiegoTexto = c.frecuenciaRiegoDias ? c.frecuenciaRiegoDias + " d√≠as" : "No definida";

        const fechaCosechaTexto = c.fechaCosechaEstimada ? formatDate(c.fechaCosechaEstimada) : "No definida";

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title"><span>üåø</span><span>${escapeHTML(c.nombre)}</span></div>
            <span class="chip">${escapeHTML(tipoLabel)}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${escapeHTML(c.variedad || "Sin especificar")}</div>
            <div><strong>Fecha de siembra:</strong> ${escapeHTML(formatDate(c.fechaSiembra))}</div>
            <div><strong>Notas:</strong> ${escapeHTML((c.notas || "‚Äî").slice(0, 140))}</div>
            <div><strong>Registro creado:</strong> ${escapeHTML(formatDate(c.creadoEl))}</div>
            <div><strong>√öltimo abono:</strong> ${escapeHTML(ultimaAbonoTexto)}</div>
            <div><strong>Frecuencia de abono:</strong> ${escapeHTML(frecuenciaAbonoTexto)}</div>
            <div><strong>√öltimo riego:</strong> ${escapeHTML(ultimoRiegoTexto)}</div>
            <div><strong>Frecuencia de riego:</strong> ${escapeHTML(frecuenciaRiegoTexto)}</div>
            <div><strong>Fecha est. cosecha:</strong> ${escapeHTML(fechaCosechaTexto)}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="nota">‚úèÔ∏è A√±adir nota</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="riego">üí¶ Riego hoy</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="abono">üíß Abono hoy</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="plaga">üêõ Plagas</button>
            <button class="btn btn-danger" data-id="${escapeHTML(c.id)}" data-action="borrar">üóë Eliminar</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function renderDiario() {
      const listEl = document.getElementById("diarioList");
      const chip = document.getElementById("diarioCountChip");
      const resumenHoyEl = document.getElementById("diarioResumenHoy");
      if (!listEl) return;

      const arrOrdenada = [...stateDiario].sort((a, b) => b.fecha.localeCompare(a.fecha));
      const countTotal = arrOrdenada.length;

      if (chip) chip.textContent = `${countTotal} entrada${countTotal === 1 ? "" : "s"}`;

      if (resumenHoyEl) {
        const hoy = todayISO();
        const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);

        if (!hoyEntries.length) {
          resumenHoyEl.textContent = "Hoy a√∫n no has registrado nada en el diario.";
        } else {
          const riegos = hoyEntries.filter(e => e.tipo === "Riego").length;
          const abonos = hoyEntries.filter(e => e.tipo === "Abono").length;
          const otros = hoyEntries.length - riegos - abonos;
          const partes = [];
          if (riegos) partes.push(`${riegos} riego(s)`);
          if (abonos) partes.push(`${abonos} abono(s)`);
          if (otros) partes.push(`${otros} nota(s) general(es)`);
          resumenHoyEl.textContent = `Hoy registraste: ${partes.join(", ")}.`;
        }
      }

      const arrFiltrada = arrOrdenada.filter(e => {
        if (diarioFiltroActual === "todos") return true;
        return (e.tipo || "General") === diarioFiltroActual;
      });

      if (!arrFiltrada.length) {
        listEl.innerHTML = '<p class="muted">No hay entradas que coincidan con el filtro seleccionado.</p>';
        return;
      }

      listEl.innerHTML = "";
      arrFiltrada.forEach(e => {
        const div = document.createElement("div");
        div.className = "diario-item";
        div.innerHTML = `
          <div class="diario-item-header">
            <span><strong>${escapeHTML(formatDate(e.fecha))}</strong></span>
            <div>
  <span class="chip">${escapeHTML(e.tipo || "General")}</span>

  <button class="btn btn-secondary" data-action="editar-diario" data-id="${escapeHTML(e.id)}"
          style="padding:4px 8px;font-size:0.7rem;margin-left:6px;">
    ‚úèÔ∏è Editar
  </button>

  <button class="btn btn-danger" data-action="borrar-diario" data-id="${escapeHTML(e.id)}"
          style="padding:4px 8px;font-size:0.7rem;margin-left:6px;">
    üóë Borrar
  </button>
</div>
          </div>
          <div>${escapeHTML(e.texto || "")}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function renderPlagas(highlightId) {
      const listEl = document.getElementById("plagasList");
      if (!listEl) return;

      listEl.innerHTML = "";
      PLAGAS_DATA.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card" + (highlightId && highlightId === p.id ? " plaga-card--highlight" : "");
        div.innerHTML = `
          <div class="media-item-title">üêõ ${escapeHTML(p.nombre)}</div>
          <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.comoSeVe)}</div>
          <div class="media-item-body"><strong>Manejo suave:</strong> ${escapeHTML(p.manejoSuave)}</div>
          <div class="media-item-body"><strong>Preparados caseros:</strong> ${escapeHTML(p.preparadosCaseros)}</div>
          <div class="media-item-body"><strong>Productos comerciales:</strong> ${escapeHTML(p.productosComerciales)}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function renderPesticidas() {
      const listEl = document.getElementById("pesticidasList");
      if (!listEl) return;

      const data = [
        {
          nombre: "Jab√≥n pot√°sico / neutro suave",
          paraQue: "Ayuda a controlar pulgones, mosca blanca y cochinillas.",
          ingredientes: "- 10‚Äì15 ml de jab√≥n pot√°sico o jab√≥n neutro l√≠quido\n- 1 litro de agua",
          preparacion: "Mezcla el jab√≥n en el agua hasta que quede bien disuelto.",
          aplicacion: "Pulverizar sobre hojas (env√©s) al atardecer, cada 5‚Äì7 d√≠as seg√∫n necesidad.",
          advertencias: "No usar m√°s concentrado; puede quemar hojas delicadas. No aplicar a pleno sol."
        },
        {
          nombre: "Infusi√≥n de ajo y aj√≠ picante",
          paraQue: "Repelente general para pulgones y orugas peque√±as.",
          ingredientes: "- 3‚Äì4 dientes de ajo\n- 1 trocito de aj√≠ picante\n- 1 litro de agua\n- 3‚Äì5 ml de jab√≥n neutro (opcional)",
          preparacion: "Tritura ajo y aj√≠, deja reposar 12‚Äì24 h, cuela y completa hasta 1 litro. A√±ade jab√≥n si quieres mejor adherencia.",
          aplicacion: "Pulverizar sobre hojas y tallos al atardecer, 1‚Äì2 veces por semana.",
          advertencias: "Evita contacto con ojos y piel. Lava bien las manos luego."
        },
        {
          nombre: "Bicarbonato para hongos de hoja",
          paraQue: "Apoyo preventivo contra o√≠dio y algunos hongos de superficie.",
          ingredientes: "- 5 g (1 cdta) de bicarbonato de sodio\n- 1 litro de agua\n- 5 ml de jab√≥n neutro (opcional)",
          preparacion: "Disolver el bicarbonato en agua y a√±adir el jab√≥n.",
          aplicacion: "Pulverizar sobre hojas 1 vez por semana, siempre al atardecer.",
          advertencias: "No exceder la dosis; demasiado bicarbonato puede quemar hojas."
        }
      ];

      listEl.innerHTML = "";
      data.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card";
        div.innerHTML = `
          <div class="media-item-title">üíß ${escapeHTML(p.nombre)}</div>
          <div class="media-item-body"><strong>¬øPara qu√© sirve?</strong> ${escapeHTML(p.paraQue)}</div>
          <div class="media-item-body"><strong>Ingredientes:</strong><br>${escapeHTML(p.ingredientes).replace(/\n/g,"<br>")}</div>
          <div class="media-item-body"><strong>Preparaci√≥n:</strong> ${escapeHTML(p.preparacion)}</div>
          <div class="media-item-body"><strong>C√≥mo aplicar:</strong> ${escapeHTML(p.aplicacion)}</div>
          <div class="media-item-body"><strong>Advertencias:</strong> ${escapeHTML(p.advertencias)}</div>
        `;
        listEl.appendChild(div);
      });
    }

    /*********************
     * Setups (event listeners)
     *********************/
    function setupNavigation() {
  const nav = document.querySelector(".nav");
  if (!nav) return;
  if (nav.dataset.bound === "1") return;
  nav.dataset.bound = "1";

  nav.addEventListener("click", (ev) => {
    const btn = ev.target.closest(".nav-btn[data-section]");
    if (!btn) return;

    const section = btn.getAttribute("data-section");
    if (!section) return;

    nav.querySelectorAll(".nav-btn").forEach(b =>
      b.classList.toggle("nav-btn--active", b === btn)
    );

    document.querySelectorAll(".section").forEach(sec => {
      sec.classList.toggle("section--active", sec.id === `section-${section}`);
    });
  });
}
    function setupMesesPills() {
  const wrap = document.getElementById("mesesPills");
  if (!wrap) return;
  if (wrap.dataset.bound === "1") return;
  wrap.dataset.bound = "1";

  wrap.addEventListener("click", (ev) => {
    const pill = ev.target.closest(".pill[data-mes]");
    if (!pill) return;

    wrap.querySelectorAll(".pill").forEach(p =>
      p.classList.toggle("pill--active", p === pill)
    );

    const month = parseInt(pill.dataset.mes, 10);
    if (Number.isFinite(month)) renderCalendario(month);
  });

  // Selecci√≥n inicial (solo una vez)
  const currentMonth = new Date().getMonth();
  const target = wrap.querySelector(`.pill[data-mes="${currentMonth}"]`);
  if (target) target.click();
  else renderCalendario(5);
}

function setupCatalogo() {
  const input = document.getElementById("catalogoBusqueda");
  const listEl = document.getElementById("catalogoList");

  if (input) {
    if (input.dataset.bound !== "1") {
      input.dataset.bound = "1";
      input.addEventListener("input", () => renderCatalogo(input.value));
    }
  }

  if (!listEl) return;
  if (listEl.dataset.bound === "1") return;
  listEl.dataset.bound = "1";

  listEl.addEventListener("click", ev => {
    const btn = ev.target.closest("button[data-action]");
    if (!btn) return;

    const action = btn.getAttribute("data-action");
    const id = btn.getAttribute("data-id");

    if (action === "germinacion") {
      const info = getInfoGerminacion(id);
      if (!info) { alert("Todav√≠a no tengo la gu√≠a de germinaci√≥n para este cultivo."); return; }

      const card = btn.closest(".cultivo-card");
      if (!card) return;

      const panel = card.querySelector(".germinacion-panel");
      if (!panel) return;

      if (panel.style.display === "block") { panel.style.display = "none"; return; }

      const pasosHtml = info.pasos.map((p, i) => `${i + 1}. ${escapeHTML(p)}`).join("<br>");
      panel.innerHTML = `
        <div class="media-item-title">${escapeHTML(info.titulo)}</div>
        <div class="media-item-body"><strong>M√©todo:</strong> ${escapeHTML(info.metodo)}</div>
        <div class="media-item-body"><strong>Pasos:</strong><br>${pasosHtml}</div>
        <div class="media-item-body"><strong>Tip:</strong> ${escapeHTML(info.tip)}</div>
      `;
      panel.style.display = "block";
      return;
    }

    if (action === "editar-custom") {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === id && c.esPersonalizado);
      if (!cultivo) { alert("Ese cultivo no es personalizado o no existe."); return; }
      startEditCustomCultivo(cultivo);
      return;
    }

    if (action === "borrar-custom") {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === id && c.esPersonalizado);
      if (!cultivo) { alert("Ese cultivo no es personalizado o no existe."); return; }
      if (!confirm(`¬øBorrar el cultivo personalizado "${cultivo.nombre}"?`)) return;
      deleteCustomCultivoById(id);
      renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
    }
  });
}

    function setupCalendarioLinks() {
  const calendarList = document.getElementById("calendarList");
  if (!calendarList) return;
  if (calendarList.dataset.bound === "1") return;
  calendarList.dataset.bound = "1";

  calendarList.addEventListener("click", ev => {
    const btn = ev.target.closest("button[data-action='ver-catalogo']");
    if (!btn) return;
    const id = btn.getAttribute("data-id");
    if (id) irACultivoEnCatalogo(id);
  });
}
function setupMiHuertoForm() {
  const btn = document.getElementById("btnAgregarCultivo");
  const list = document.getElementById("cultivosList");
  if (!btn || !list) return;

  // Guardar cultivo (solo 1 vez)
  if (btn.dataset.bound !== "1") {
    btn.dataset.bound = "1";

    btn.addEventListener("click", () => {
      const nombre = (document.getElementById("cultivoNombre")?.value || "").trim();
      const variedad = (document.getElementById("cultivoVariedad")?.value || "").trim();
      const tipo = (document.getElementById("cultivoTipo")?.value || "otro").trim();
      const fechaSiembra = (document.getElementById("cultivoFecha")?.value || "").trim() || todayISO();
      const notas = (document.getElementById("cultivoNotas")?.value || "").trim();

      if (!nombre) { alert("Escribe el nombre del cultivo."); return; }

      const { frecuenciaRiego, fechaCosechaEstimada } = getRiegoYCosechaParaNombre(nombre, fechaSiembra);

      const nuevo = {
        id: Date.now().toString(36),
        nombre,
        variedad,
        tipo,
        fechaSiembra,
        notas,
        creadoEl: todayISO(),
        ultimoRiego: null,
        frecuenciaRiegoDias: frecuenciaRiego || null,
        ultimaFertilizacion: null,
        frecuenciaAbonoDias: null,
        fechaCosechaEstimada: fechaCosechaEstimada || null
      };

      stateCultivos.push(nuevo);
      saveCultivos(stateCultivos);

      renderCultivos();
      renderInicio();

      // Limpia form
      const n = document.getElementById("cultivoNombre"); if (n) n.value = "";
      const v = document.getElementById("cultivoVariedad"); if (v) v.value = "";
      const t = document.getElementById("cultivoTipo"); if (t) t.value = "hoja";
      const f = document.getElementById("cultivoFecha"); if (f) f.value = todayISO();
      const no = document.getElementById("cultivoNotas"); if (no) no.value = "";

      alert("Cultivo guardado ‚úÖ");
    });
  }

  // Acciones en la lista (solo 1 vez)
  if (list.dataset.bound !== "1") {
    list.dataset.bound = "1";

    list.addEventListener("click", (ev) => {
      const b = ev.target.closest("button[data-id][data-action]");
      if (!b) return;

      const id = b.getAttribute("data-id");
      const action = b.getAttribute("data-action");

      const cultivo = stateCultivos.find(c => c.id === id);
      if (!cultivo) return;

      if (action === "borrar") {
        if (!confirm(`¬øEliminar el cultivo "${cultivo.nombre}"?`)) return;
        stateCultivos = stateCultivos.filter(c => c.id !== id);
        saveCultivos(stateCultivos);
        renderCultivos();
        renderInicio();
        return;
      }

      if (action === "nota") {
        document.querySelector('.nav-btn[data-section="diario"]')?.click();
        const campo = document.getElementById("diarioTexto");
        if (campo) {
          campo.value = `Cultivo: ${cultivo.nombre}${cultivo.variedad ? ` (${cultivo.variedad})` : ""}. `;
          campo.focus();
        }
        return;
      }

      if (action === "riego") {
        cultivo.ultimoRiego = todayISO();

        if (!cultivo.frecuenciaRiegoDias) {
          const entrada = prompt("¬øCada cu√°ntos d√≠as quieres regar este cultivo?", "3");
          const n = parseInt(entrada, 10);
          if (Number.isFinite(n) && n > 0) cultivo.frecuenciaRiegoDias = n;
        }

        stateDiario.push({
          id: Date.now().toString(36),
          fecha: todayISO(),
          texto: `Riego registrado para ${cultivo.nombre}${cultivo.variedad ? ` (${cultivo.variedad})` : ""}.`,
          tipo: "Riego"
        });

        saveCultivos(stateCultivos);
        saveDiario(stateDiario);
        renderCultivos();
        renderDiario();
        renderInicio();
        alert("Riego registrado ‚úÖ");
        return;
      }

      if (action === "abono") {
        cultivo.ultimaFertilizacion = todayISO();

        if (!cultivo.frecuenciaAbonoDias) {
          const entrada = prompt("¬øCada cu√°ntos d√≠as quieres abonar este cultivo?", "30");
          const n = parseInt(entrada, 10);
          if (Number.isFinite(n) && n > 0) cultivo.frecuenciaAbonoDias = n;
        }

        stateDiario.push({
          id: Date.now().toString(36),
          fecha: todayISO(),
          texto: `Abono registrado para ${cultivo.nombre}${cultivo.variedad ? ` (${cultivo.variedad})` : ""}.`,
          tipo: "Abono"
        });

        saveCultivos(stateCultivos);
        saveDiario(stateDiario);
        renderCultivos();
        renderDiario();
        renderInicio();
        alert("Abono registrado ‚úÖ");
        return;
      }

      if (action === "plaga") {
        const entrada = prompt('Escribe la plaga (ej. "pulgones", "mosca blanca", "ara√±a roja"):');
        if (!entrada) return;

        const texto = entrada.trim().toLowerCase();
        const plaga = PLAGAS_DATA.find(p => p.nombre.toLowerCase().includes(texto));
        if (!plaga) { alert("No encontr√© esa plaga. Prueba: pulgones, mosca blanca, ara√±a roja, etc."); return; }

        document.querySelector('.nav-btn[data-section="plagas"]')?.click();
        renderPlagas(plaga.id);
        alert(`Mostrando informaci√≥n para: ${plaga.nombre}.`);
      }
    });
  }
}
    function setupDiario() {
  const btn = document.getElementById("btnGuardarDiario");
  const campo = document.getElementById("diarioTexto");
  const filtros = document.querySelectorAll("#diarioFiltros .pill");
  const listEl = document.getElementById("diarioList");

  if (!btn || !campo || !listEl) return;

  // Evitar duplicar listeners si se llama 2 veces por error
  if (btn.dataset.bound === "1") return;
  btn.dataset.bound = "1";

  // Guardar / actualizar
  btn.addEventListener("click", () => {
    const texto = campo.value.trim();
    if (!texto) { alert("Escribe algo antes de guardar."); return; }

    const titleEl = document.getElementById("diarioFormTitle");

    // EDITAR
    if (diarioEnEdicionId) {
      const idx = stateDiario.findIndex(e => e.id === diarioEnEdicionId);
      if (idx !== -1) {
        stateDiario[idx].texto = texto;
        saveDiario(stateDiario);
      }
      diarioEnEdicionId = null;
      campo.value = "";
      if (titleEl) titleEl.textContent = "Nueva entrada";
      btn.innerHTML = '<span>üíæ</span> Guardar en el diario';
      renderDiario();
      renderInicio();
      alert("Entrada actualizada ‚úÖ");
      return;
    }

    // NUEVA
    stateDiario.push({ id: Date.now().toString(36), fecha: todayISO(), texto, tipo: "General" });
    saveDiario(stateDiario);
    campo.value = "";
    renderDiario();
    renderInicio();
    alert("Entrada guardada ‚úÖ");
  });

  // Filtros (solo una vez)
  if (document.getElementById("diarioFiltros")?.dataset.bound !== "1") {
    document.getElementById("diarioFiltros").dataset.bound = "1";
    filtros.forEach(f => {
      f.addEventListener("click", () => {
        filtros.forEach(b => b.classList.remove("pill--active"));
        f.classList.add("pill--active");
        diarioFiltroActual = f.dataset.filtro || "todos";
        renderDiario();
      });
    });
  }

  // Clicks en lista: Editar / Borrar (solo una vez)
  if (listEl.dataset.bound !== "1") {
    listEl.dataset.bound = "1";

    listEl.addEventListener("click", (ev) => {
      const b = ev.target.closest("button[data-action]");
      if (!b) return;

      const action = b.getAttribute("data-action");
      const id = b.getAttribute("data-id");
      if (!id) return;

      if (action === "editar-diario") {
        const entrada = stateDiario.find(e => e.id === id);
        if (!entrada) return;

        diarioEnEdicionId = id;
        campo.value = entrada.texto || "";
        campo.focus();

        const titleEl = document.getElementById("diarioFormTitle");
        if (titleEl) titleEl.textContent = "Editar entrada";
        btn.innerHTML = '<span>üíæ</span> Actualizar entrada';

        document.getElementById("diarioFormCard")?.scrollIntoView?.({ behavior: "smooth", block: "start" });
        return;
      }

      if (action === "borrar-diario") {
        const entrada = stateDiario.find(e => e.id === id);
        if (!entrada) return;

        if (!confirm(`¬øBorrar esta entrada del ${formatDate(entrada.fecha)}?`)) return;

        stateDiario = stateDiario.filter(e => e.id !== id);
        saveDiario(stateDiario);

        if (diarioEnEdicionId === id) {
          diarioEnEdicionId = null;
          campo.value = "";
          const titleEl = document.getElementById("diarioFormTitle");
          if (titleEl) titleEl.textContent = "Nueva entrada";
          btn.innerHTML = '<span>üíæ</span> Guardar en el diario';
        }

        renderDiario();
        renderInicio();
        alert("Entrada borrada ‚úÖ");
      }
    });
  }

  // PDF
  document.getElementById("btnExportarDiarioPdf")?.addEventListener("click", exportarDiarioPDF);
    }
    function setupOpciones() {
  const section = document.getElementById("section-opciones");
  if (!section) return;
  if (section.dataset.bound === "1") return;
  section.dataset.bound = "1";

  const nombreInput = document.getElementById("nombreHuerto");
  const climaSelect = document.getElementById("climaSelect");
  const hemisSelect = document.getElementById("hemisferioSelect");
  if (!nombreInput || !climaSelect || !hemisSelect) return;

  nombreInput.value = stateSettings.nombreHuerto || "";
  climaSelect.value = stateSettings.clima || "tropical";
  hemisSelect.value = stateSettings.hemisferio || "norte";

  document.getElementById("btnGuardarConfig")?.addEventListener("click", () => {
    const nuevoNombre = (nombreInput.value || "").trim() || "Mi huerto";
    const nuevoClima = climaSelect.value || "tropical";
    const nuevoHemis = hemisSelect.value || "norte";

    stateSettings = { ...stateSettings, nombreHuerto: nuevoNombre, clima: nuevoClima, hemisferio: nuevoHemis };
    saveSettings(stateSettings);

    updateHeader();
    updateSettingsContexts();
    renderInicio();
    renderCalendario(new Date().getMonth());
    alert("Configuraci√≥n guardada ‚úÖ");
  });

  document.getElementById("btnExportarDatosPdf")?.addEventListener("click", exportarDatosPDF);
  document.getElementById("btnExportarJson")?.addEventListener("click", exportarRespaldoJSON);
  document.getElementById("btnImportarJson")?.addEventListener("click", importarRespaldoJSON);
  document.getElementById("btnBorrarTodo")?.addEventListener("click", borrarTodo);
}

    /*********************
     * PDF y respaldo
     *********************/
    function exportarDatosPDF() {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) { alert("No se pudo cargar la librer√≠a para PDF."); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

        const marginLeft = 10;
        const maxWidth = 190 - marginLeft * 2;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Resumen de datos", marginLeft, y); y += 8;

        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleString()}`, marginLeft, y); y += 8;

        doc.setFontSize(11);
        doc.text("Ajustes del huerto", marginLeft, y); y += 6;

        doc.setFontSize(10);
        const textoSettings = `Nombre: ${stateSettings.nombreHuerto || ""}\nClima: ${stateSettings.clima}\nHemisferio: ${stateSettings.hemisferio}`;
        doc.splitTextToSize(textoSettings, maxWidth).forEach(line => {
          if (y > 280) { doc.addPage(); y = 10; }
          doc.text(line, marginLeft, y); y += 4;
        });

        y += 4;
        doc.setFontSize(11);
        doc.text("Cultivos registrados", marginLeft, y); y += 6;

        doc.setFontSize(10);
        if (!stateCultivos.length) {
          doc.text("No hay cultivos guardados.", marginLeft, y); y += 6;
        } else {
          stateCultivos.forEach(c => {
            const textoCultivo = `‚Ä¢ ${c.nombre}${c.variedad ? ` (${c.variedad})` : ""} ‚Äì siembra: ${formatDate(c.fechaSiembra)} ‚Äì notas: ${c.notas || "-"}`;
            doc.splitTextToSize(textoCultivo, maxWidth).forEach(line => {
              if (y > 280) { doc.addPage(); y = 10; }
              doc.text(line, marginLeft, y); y += 4;
            });
          });
          y += 4;
        }

        doc.setFontSize(11);
        doc.text("Resumen del diario", marginLeft, y); y += 6;

        doc.setFontSize(10);
        if (!stateDiario.length) doc.text("No hay entradas en el diario.", marginLeft, y);
        else doc.text(`Total de entradas: ${stateDiario.length}`, marginLeft, y);

        doc.save("mi-siembra-datos.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al crear el PDF.");
      }
    }

    function exportarDiarioPDF() {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) { alert("No se pudo cargar la librer√≠a para PDF."); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation:"p", unit:"mm", format:"a4" });

        const marginLeft = 10;
        const maxWidth = 190 - marginLeft * 2;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Diario de huerto", marginLeft, y); y += 8;

        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleString()}`, marginLeft, y); y += 8;

        if (!stateDiario.length) {
          doc.text("No hay entradas en el diario.", marginLeft, y);
          doc.save("mi-siembra-diario.pdf");
          return;
        }

        const entradasOrdenadas = [...stateDiario].sort((a, b) => a.fecha.localeCompare(b.fecha));

        entradasOrdenadas.forEach(e => {
          const encabezado = `${formatDate(e.fecha)} ‚Äì ${e.tipo || "General"}`;
          const texto = e.texto || "";
          doc.splitTextToSize(encabezado + "\n" + texto, maxWidth).forEach(line => {
            if (y > 280) { doc.addPage(); y = 10; }
            doc.text(line, marginLeft, y); y += 4;
          });
          y += 2;
        });

        doc.save("mi-siembra-diario.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al exportar el diario.");
      }
    }

    function exportarRespaldoJSON() {
  const respaldo = {
    settings: stateSettings,
    cultivos: stateCultivos,
    diario: stateDiario,
    customCultivos: loadCustomCultivos() // üëà IMPORTANT√çSIMO
  };

  const contenido = JSON.stringify(respaldo, null, 2);
  const blob = new Blob([contenido], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const enlace = document.createElement("a");
  const fecha = new Date().toISOString().slice(0, 10);
  enlace.href = url;
  enlace.download = `mi-siembra-respaldo-${fecha}.json`;

  document.body.appendChild(enlace);
  enlace.click();
  document.body.removeChild(enlace);
  URL.revokeObjectURL(url);

  alert("Respaldo (.json) exportado correctamente ‚úÖ");
}

    function importarRespaldoJSON() {
  const input = document.getElementById("inputRespaldoJSON");
  if (!input) { alert("No se encontr√≥ el campo de archivo para restaurar el respaldo."); return; }

  input.value = "";
  input.onchange = event => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = JSON.parse(e.target.result);
        if (!data || typeof data !== "object") throw new Error("Formato inv√°lido");

        if (!confirm("Esto reemplazar√° los datos actuales por los del respaldo. ¬øContinuar?")) return;

        stateSettings = { ...DEFAULT_SETTINGS, ...(data.settings || {}) };
        stateCultivos = Array.isArray(data.cultivos) ? data.cultivos : [];
        stateDiario   = Array.isArray(data.diario) ? data.diario : [];

        // üëá RESTAURA personalizados (si el respaldo los trae)
        const custom = Array.isArray(data.customCultivos) ? data.customCultivos : [];
        saveCustomCultivos(custom);
        injectCustomIntoCatalogo(custom);

        saveSettings(stateSettings);
        saveCultivos(stateCultivos);
        saveDiario(stateDiario);

        updateHeader();
        updateSettingsContexts();
        renderCultivos();
        renderDiario();
        renderInicio();
        renderCalendario(new Date().getMonth());
        renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());

        alert("Respaldo restaurado correctamente ‚úÖ");
      } catch (err) {
        console.error(err);
        alert("No se pudo leer el respaldo. Usa un .json exportado por esta app.");
      }
    };
    reader.readAsText(file);
  };

  input.click();
}

    function borrarTodo() {
  if (!confirm("Esto borrar√° ajustes, cultivos y diario en este dispositivo. ¬øSeguro?")) return;

  // Borra storage principal
  localStorage.removeItem(STORAGE_KEYS.settings);
  localStorage.removeItem(STORAGE_KEYS.cultivos);
  localStorage.removeItem(STORAGE_KEYS.diario);

  // Borra cultivos personalizados (y compat con versiones viejas)
  localStorage.removeItem(STORAGE_CUSTOM_CULTIVOS);
  ["msi-custom-cultivos", "msi-custom-cultivos-v16", "msi-custom-cultivos-v15"].forEach(k => {
    try { localStorage.removeItem(k); } catch {}
  });

  // Resetea estado
  stateSettings = { ...DEFAULT_SETTINGS };
  stateCultivos = [];
  stateDiario = [];

  // IMPORTANT√çSIMO: limpia personalizados del cat√°logo EN MEMORIA
  injectCustomIntoCatalogo([]);     // <- quita esPersonalizado del array base
  customEditId = null;

  // Resetea UI de formulario personalizado
  const card = document.getElementById("nuevoCultivoCard");
  if (card) card.style.display = "none";
  clearCustomCultivoUI();
  resetEditCustomCultivoUI();

  // Resetea inputs opciones
  const nombreInput = document.getElementById("nombreHuerto");
  const climaSelect = document.getElementById("climaSelect");
  const hemisSelect = document.getElementById("hemisferioSelect");

  if (nombreInput) nombreInput.value = stateSettings.nombreHuerto;
  if (climaSelect) climaSelect.value = stateSettings.clima;
  if (hemisSelect) hemisSelect.value = stateSettings.hemisferio;

  // Re-render todo (incluye cat√°logo)
  updateHeader();
  updateSettingsContexts();
  renderInicio();
  renderCalendario(new Date().getMonth());
  renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
  renderCultivos();
  renderDiario();

  alert("Se borraron todos los datos. Empezar√°s de cero üå±");
}

/*********************
 * PWA: service worker + instalar
 *********************/
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try {
      await navigator.serviceWorker.register("./sw.js", { scope: "./" });

      let reloaded = false;
      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (reloaded) return;
        reloaded = true;
        window.location.reload();
      });
    } catch (err) {
      console.error("Error registrando SW:", err);
    }
  });
}
    /*********************
 * INIT (ARRANQUE)
 *********************/
document.addEventListener("DOMContentLoaded", () => {
  try {
    // Estado + header
    updateHeader();
    updateSettingsContexts();

    // Setups
    setupNavigation();
    setupMesesPills();
    setupCalendarioLinks();
    setupCatalogo();
    setupMiHuertoForm();
    setupDiario();
    setupOpciones();

    // Custom cultivos
    initCustomCultivos();

    // Render inicial
    renderCatalogo("");
    renderCultivos();
    renderDiario();
    renderPlagas();
    renderPesticidas();
    renderInicio();

    // Fecha por defecto en "Mi huerto"
    const f = document.getElementById("cultivoFecha");
    if (f && !f.value) f.value = todayISO();
  } catch (e) {
    console.error("Fallo en INIT:", e);
    alert("Error arrancando la app. Abre la consola para ver el detalle.");
  }
});
    function openCatSheet(){
  const bd = document.getElementById("catSheetBackdrop");
  const sh = document.getElementById("catSheet");
  if (!bd || !sh) return;

  bd.hidden = false;
  sh.hidden = false;

  // forzar reflow para animaci√≥n si usas CSS con transform
  requestAnimationFrame(() => {
    bd.classList.add("show");
    sh.classList.add("show");
  });
}

function closeCatSheet(){
  const bd = document.getElementById("catSheetBackdrop");
  const sh = document.getElementById("catSheet");
  if (!bd || !sh) return;

  bd.classList.remove("show");
  sh.classList.remove("show");
  setTimeout(() => {
    bd.hidden = true;
    sh.hidden = true;
  }, 180);
}

function buildCatSheetList(categorias){
  const list = document.getElementById("catSheetList");
  if (!list) return;

  list.innerHTML = "";

  // Bot√≥n "Todas"
  const allBtn = document.createElement("button");
  allBtn.type = "button";
  allBtn.className = "sheet-chip";
  allBtn.textContent = "Todas";
  allBtn.onclick = () => {
    // ajusta a TU funci√≥n real de filtro
    if (typeof setCatalogCategoria === "function") setCatalogCategoria("");
    closeCatSheet();
  };
  list.appendChild(allBtn);

  (categorias || []).forEach(cat => {
    const b = document.createElement("button");
    b.type = "button";
    b.className = "sheet-chip";
    b.textContent = cat;
    b.onclick = () => {
      if (typeof setCatalogCategoria === "function") setCatalogCategoria(cat);
      closeCatSheet();
    };
    list.appendChild(b);
  });
}

function getCategoriasDesdeCultivos(){
  // CAMBIA estos nombres si en tu app se llaman distinto:
  // catalogCultivos / customCultivos / etc.
  const base = (window.catalogCultivos || []);
  const custom = (window.customCultivos || []);
  const all = [...base, ...custom];

  const set = new Set();
  all.forEach(c => {
    const cat = (c.categoria || "").trim();
    if (cat) set.add(cat);
  });

  return Array.from(set).sort((a,b)=>a.localeCompare(b));
}

document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btnCategorias");
  if (!btn) console.log("‚ùå No existe #btnCategorias");

  btn?.addEventListener("click", () => {
    console.log("‚úÖ Click Categor√≠as");
    openCatSheet();
});

  if (btnClose) btnClose.addEventListener("click", closeCatSheet);
  if (bd) bd.addEventListener("click", closeCatSheet);
});
  </script>
</body>
  </html>
