<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v18)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --bg-elevated:#02081f;
      --card:#02081f;
      --card-soft:#030919;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --accent-strong:rgba(34,197,94,0.45);
      --text-main:#f9fafb;
      --text-soft:#9ca3af;
      --border-subtle:rgba(148,163,184,0.3);
      --danger:#ef4444;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.7);
      --radius-xl:22px;
      --radius-lg:18px;
      --radius-full:999px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Roboto","Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#022c22 0,#020617 55%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;flex-direction:column;
    }
    .app-shell{max-width:960px;margin:0 auto;padding:16px 12px 28px}
    @media(min-width:768px){.app-shell{padding:20px 16px 40px}}
    .app-header{
      background:radial-gradient(circle at 0 0,#4ade80 0,#16a34a 28%,#052e16 85%);
      border-radius:28px;
      padding:18px 18px 16px;
      display:flex;align-items:center;gap:14px;
      box-shadow:var(--shadow-soft);
      position:relative;overflow:hidden;
      margin-bottom:14px;
    }
    .app-header::after{
      content:"";position:absolute;inset:0;
      background:radial-gradient(circle at 120% -10%,rgba(34,197,94,0.35) 0,transparent 55%);
      opacity:.9;pointer-events:none;
    }
    .app-header-icon{
      position:relative;z-index:1;
      width:52px;height:52px;border-radius:18px;
      background:radial-gradient(circle at 30% 10%,#bbf7d0 0,#16a34a 35%,#052e16 90%);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      flex-shrink:0;
    }
    .app-header-icon span{font-size:42px}
    .app-header-text{position:relative;z-index:1;display:flex;flex-direction:column;gap:4px}
    .app-title-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .app-title{font-size:1.35rem;font-weight:700;letter-spacing:.02em}
    .app-tag{
      font-size:.72rem;padding:2px 8px;border-radius:999px;
      background:rgba(15,23,42,.45);border:1px solid rgba(15,23,42,.8);
      text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb
    }
    .app-subtitle{
      font-size:.80rem;color:#e5e7eb;opacity:.95;
      display:flex;flex-wrap:wrap;gap:6px;align-items:center
    }
    .app-subtitle span{display:inline-flex;align-items:center;gap:4px}
    .app-subtitle-dot{width:3px;height:3px;border-radius:50%;background:rgba(226,232,240,.7)}

    .nav{
      margin-top:8px;
      background:linear-gradient(135deg,var(--bg-elevated),#020617);
      border-radius:26px;padding:10px;
      box-shadow:0 18px 40px rgba(15,23,42,.85);
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
      position:sticky;top:0;z-index:40;
      backdrop-filter:blur(16px);
      border:1px solid rgba(15,23,42,.85);
    }
    @media(min-width:660px){.nav{grid-template-columns:repeat(8,minmax(0,1fr))}}
    .nav-btn{
      border:none;border-radius:999px;
      padding:7px 6px 6px;
      font-size:.70rem;color:var(--text-soft);
      background:transparent;
      display:flex;flex-direction:column;align-items:center;gap:3px;
      cursor:pointer;transition:background .18s,color .18s,transform .12s;
      position:relative;min-height:52px;
    }
    .nav-btn span.nav-icon{font-size:1.40rem}
    .nav-btn.nav-btn--active{
      background:radial-gradient(circle at top,var(--accent) 0,var(--accent-soft) 45%,transparent 100%);
      color:#ecfdf5;
      box-shadow:0 0 0 1px rgba(34,197,94,.4),0 14px 30px rgba(22,163,74,.55);
      transform:translateY(-1px);
    }
    .nav-btn.nav-btn--active::after{
      content:"";position:absolute;inset:auto auto -3px 50%;
      width:32%;max-width:42px;height:3px;border-radius:999px;
      background:linear-gradient(90deg,rgba(34,197,94,.1),rgba(34,197,94,.6),rgba(34,197,94,.1));
      transform:translateX(-50%);
    }

    main{margin-top:14px}
    .section{display:none;animation:fadeIn .18s ease-out}
    .section--active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    .section > .section-title-row{display:flex;align-items:center;gap:10px;margin:14px 2px 8px}
    .section-icon-pill{
      width:26px;height:26px;border-radius:13px;
      background:radial-gradient(circle at 30% 15%,#fefce8 0,#fef9c3 25%,#0f172a 90%);
      display:flex;align-items:center;justify-content:center;font-size:1.3rem
    }
    .section-title-row h2{font-size:1.05rem;margin:0}
    .section-subtitle{font-size:.82rem;color:var(--text-soft);margin:2px 2px 10px}

    .app-card{
      background:radial-gradient(circle at top left,#020617 0,#020617 40%,#02081f 100%);
      border-radius:var(--radius-xl);
      padding:14px 16px 14px;
      border:1px solid var(--border-subtle);
      box-shadow:var(--shadow-soft);
      margin-bottom:14px;
    }
    .app-card-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
    .app-card-title{font-size:.96rem;font-weight:600}
    .chip{
      border-radius:var(--radius-full);
      padding:4px 10px;font-size:.74rem;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      display:inline-flex;align-items:center;gap:4px;white-space:nowrap
    }
    .chip.badge{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.6);color:#bbf7d0}
    .muted{color:var(--text-soft);font-size:.80rem}
    .divider-soft{
      height:1px;
      background:linear-gradient(90deg,transparent,rgba(148,163,184,.4),transparent);
      margin:8px -2px 10px;
    }

    .pill-group{display:flex;flex-wrap:wrap;gap:8px;margin:8px -1px 4px}
    .pill{
      border-radius:999px;
      padding:5px 12px;font-size:.78rem;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.9);
      cursor:pointer;color:var(--text-main);
    }
    .pill--active{background:var(--accent-soft);border-color:rgba(34,197,94,.85);color:#bbf7d0}

    .btn{
      border-radius:999px;border:none;
      padding:9px 14px;font-size:.82rem;font-weight:500;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#022c22;
      box-shadow:0 12px 30px rgba(22,163,74,.55);
      transition:transform .12s,box-shadow .12s,filter .12s;
    }
    .btn span{font-size:1rem}
    .btn:active{transform:translateY(1px);box-shadow:0 7px 18px rgba(22,163,74,.55);filter:brightness(.96)}
    .btn-secondary{background:rgba(15,23,42,.9);color:var(--text-main);border:1px solid var(--border-subtle);box-shadow:none}
    .btn-full{width:100%;justify-content:center}
    .btn-danger{background:linear-gradient(135deg,#b91c1c,#ef4444);color:#fee2e2;box-shadow:0 10px 26px rgba(248,113,113,.45)}
    .grid-two{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .small-label{font-size:.78rem;color:var(--text-soft);margin-bottom:2px}
    .big-number{font-size:1.3rem;font-weight:600}

    .form-grid{display:grid;grid-template-columns:1fr;gap:10px;margin:8px 0 4px}
    @media(min-width:660px){.form-grid--2{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:.78rem;color:var(--text-soft)}
    input[type="text"],input[type="date"],input[type="number"],select,textarea{
      background:rgba(15,23,42,.95);
      border-radius:14px;border:1px solid rgba(51,65,85,.9);
      padding:8px 10px;color:var(--text-main);
      font-size:.83rem;font-family:inherit;width:100%;outline:none;
      transition:border .12s,box-shadow .12s,background .12s;
    }
    select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      padding-right:26px;
      background-image:
        linear-gradient(45deg,transparent 50%,#9ca3af 50%),
        linear-gradient(135deg,#9ca3af 50%,transparent 50%);
      background-position:calc(100% - 15px) 10px,calc(100% - 11px) 10px;
      background-size:6px 6px,6px 6px;background-repeat:no-repeat;
    }
    textarea{min-height:72px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:rgba(34,197,94,.9);
      box-shadow:0 0 0 1px rgba(34,197,94,.5);
      background:rgba(15,23,42,.98);
    }

    .cultivos-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .cultivo-card{
      border-radius:var(--radius-lg);
      padding:10px 11px;
      background:radial-gradient(circle at top left,var(--card-soft) 0,#020617 60%);
      border:1px solid rgba(75,85,99,.9);
      display:flex;flex-direction:column;gap:4px;
    }
    .cultivo-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .cultivo-title{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:8px}
    .cultivo-thumb{width:56px;height:56px;border-radius:16px;object-fit:cover;flex-shrink:0}
    .cultivo-body{
      font-size:.78rem;color:var(--text-soft);
      display:grid;grid-template-columns:1.1fr .9fr;gap:4px 10px;margin-top:6px
    }
    @media(max-width:480px){.cultivo-body{grid-template-columns:1fr}}
    .cultivo-actions{margin-top:8px;display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap}
    .germinacion-panel{
      margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.5);
      font-size:.78rem;color:var(--text-soft);display:none;
    }

    .calendar-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .calendar-item{
      border-radius:16px;padding:9px 10px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.8rem;
    }
    .calendar-item-title{
      font-weight:600;margin-bottom:2px;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .calendar-empty{font-size:.8rem;color:var(--text-soft);margin-top:8px}

    .diario-list{display:flex;flex-direction:column;gap:8px;margin-top:6px;font-size:.8rem}
    .diario-item{
      border-radius:14px;padding:8px 10px;background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }
    .diario-item-header{
      display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;
    }

    .plaga-card{
      border-radius:14px;padding:8px 10px;background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);margin-bottom:6px;
    }
    .plaga-card--highlight{border-color:rgba(34,197,94,.9);box-shadow:0 0 0 1px rgba(34,197,94,.6)}
    .media-list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .media-item-title{font-size:.86rem;font-weight:600}
    .media-item-body{font-size:.8rem;color:var(--text-soft);margin-top:2px}

    footer{margin-top:6px;font-size:.76rem;color:var(--text-soft);text-align:center;padding-bottom:6px}

    /* Banner instalar */
    #installBanner{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(15,23,42,.97);
      border-radius:999px;padding:7px 12px;
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 16px 40px rgba(15,23,42,.85);
      font-size:.78rem;z-index:80;
    }
    #installBanner.hidden{display:none}
    #installBanner button{font-size:.78rem;padding:6px 10px}

    /* Toast */
    #toast{
      position:fixed;left:50%;top:14px;transform:translateX(-50%);
      z-index:90;display:none;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      border-radius:999px;
      padding:10px 12px;
      min-width:min(520px,calc(100vw - 28px));
      align-items:center;justify-content:space-between;gap:10px;
    }
    #toast.show{display:flex}
    #toast .msg{font-size:.82rem;color:#e5e7eb}
    #toast .actions{display:flex;gap:8px;align-items:center}
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon"><span>üå±</span></div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v18 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle"></div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio"><span class="nav-icon">üè†</span><span class="nav-label">Inicio</span></button>
      <button class="nav-btn" data-section="calendario"><span class="nav-icon">üìÖ</span><span class="nav-label">Calendario</span></button>
      <button class="nav-btn" data-section="catalogo"><span class="nav-icon">üå±</span><span class="nav-label">Cat√°logo</span></button>
      <button class="nav-btn" data-section="huerto"><span class="nav-icon">üåø</span><span class="nav-label">Mi huerto</span></button>
      <button class="nav-btn" data-section="diario"><span class="nav-icon">üìì</span><span class="nav-label">Diario</span></button>
      <button class="nav-btn" data-section="plagas"><span class="nav-icon">üêõ</span><span class="nav-label">Plagas</span></button>
      <button class="nav-btn" data-section="pesticidas"><span class="nav-icon">üíß</span><span class="nav-label">Pesticidas</span></button>
      <button class="nav-btn" data-section="opciones"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Opciones</span></button>
      <button class="nav-btn" data-section="guias"><span class="nav-icon">üìö</span><span class="nav-label">Gu√≠as</span></button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row"><div class="section-icon-pill">üè†</div><h2>Inicio</h2></div>
        <p class="section-subtitle">Resumen r√°pido de tu huerto y acceso a las funciones principales.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <div class="chip badge" id="estadoClimaChip">Clima tropical</div>
              <div class="chip" id="climaAhoraChip">Clima: ‚Äî</div>
            </div>
          </div>

          <div class="grid-two">
            <div><div class="small-label">Cultivos registrados</div><div class="big-number" id="estadoCultivosCount">0</div></div>
            <div><div class="small-label">Entradas hoy en el diario</div><div class="big-number" id="estadoEntradasCount">0</div></div>
          </div>

          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Recordatorios</div>
            <div class="chip" id="recordatoriosChip">0 pendientes</div>
          </div>
          <p class="muted" id="recordatoriosTxt">Sin recordatorios por ahora.</p>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìÖ</div><h2>Calendario de siembra</h2></div>
        <p class="section-subtitle">Selecciona un mes para ver sugerencias seg√∫n tu clima y hemisferio.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses del a√±o</div>
            <div class="chip" id="calendarioClimaChip2">Clima tropical</div>
          </div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button><button class="pill" data-mes="1">Feb</button><button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button><button class="pill" data-mes="4">May</button><button class="pill" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button><button class="pill" data-mes="7">Ago</button><button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button><button class="pill" data-mes="10">Nov</button><button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">Por ahora no hay recomendaciones espec√≠ficas para este mes y clima.</div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üå±</div><h2>Cat√°logo de cultivos</h2></div>
        <p class="section-subtitle">Lista de cultivos con informaci√≥n r√°pida y gu√≠a de germinaci√≥n / reproducci√≥n.</p>

        <div class="app-card">
          <div class="field">
            <label for="catalogoBusqueda">Buscar cultivo</label>
            <input type="text" id="catalogoBusqueda" placeholder="Ej. tomate, lechuga, pl√°tano..." />
          </div>

          <div style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary" id="btnToggleNuevoCultivo">‚ûï A√±adir cultivo manual</button>
          </div>

          <div class="cultivos-list" id="catalogoList"></div>

          <!-- Formulario cultivo manual -->
          <div class="app-card" id="nuevoCultivoCard" style="margin-top: 12px; display:none;">
            <div class="app-card-header">
              <div class="app-card-title" id="nuevoCultivoTitulo">Nuevo cultivo</div>
              <span class="chip badge">Personalizado</span>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoNombre">Nombre del cultivo *</label>
                <input type="text" id="nuevoCultivoNombre" placeholder="Ej. cilantro criollo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoCategoria">Categor√≠a</label>
                <select id="nuevoCultivoCategoria">
                  <option value="Hoja">Hoja</option>
                  <option value="Fruto">Fruto</option>
                  <option value="Ra√≠z">Ra√≠z</option>
                  <option value="Tub√©rculo">Tub√©rculo</option>
                  <option value="Arom√°tica">Arom√°tica</option>
                  <option value="Frutal perenne">Frutal perenne</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoDiasGerminacion">D√≠as de germinaci√≥n (opcional)</label>
                <input type="number" id="nuevoCultivoDiasGerminacion" min="0" placeholder="Ej. 7" />
              </div>
              <div class="field">
                <label for="nuevoCultivoDiasCosecha">D√≠as hasta cosecha (opcional)</label>
                <input type="number" id="nuevoCultivoDiasCosecha" min="0" placeholder="Ej. 90" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoLuz">Luz</label>
                <input type="text" id="nuevoCultivoLuz" placeholder="Ej. Sol directo (6‚Äì8 h)" />
              </div>
              <div class="field">
                <label for="nuevoCultivoRiego">Riego</label>
                <input type="text" id="nuevoCultivoRiego" placeholder="Ej. Suelo siempre ligeramente h√∫medo" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoTiesto">Tiesto / suelo</label>
                <input type="text" id="nuevoCultivoTiesto" placeholder="Ej. Maceta 5+ galones o suelo directo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoProfundidad">Profundidad de siembra</label>
                <input type="text" id="nuevoCultivoProfundidad" placeholder="Ej. 0.5‚Äì1 cm" />
              </div>
            </div>

            <div class="field">
              <label for="nuevoCultivoPlagas">Plagas frecuentes (separadas por coma)</label>
              <input type="text" id="nuevoCultivoPlagas" placeholder="Ej. pulgones, babosas, hongos" />
            </div>

            <div class="field" style="margin-top: 10px;">
              <label>Meses de siembra (para recomendaciones del Calendario)</label>
              <div class="pill-group" id="nuevoCultivoMesesPills">
                <button type="button" class="pill" data-mes="0">Ene</button><button type="button" class="pill" data-mes="1">Feb</button>
                <button type="button" class="pill" data-mes="2">Mar</button><button type="button" class="pill" data-mes="3">Abr</button>
                <button type="button" class="pill" data-mes="4">May</button><button type="button" class="pill" data-mes="5">Jun</button>
                <button type="button" class="pill" data-mes="6">Jul</button><button type="button" class="pill" data-mes="7">Ago</button>
                <button type="button" class="pill" data-mes="8">Sep</button><button type="button" class="pill" data-mes="9">Oct</button>
                <button type="button" class="pill" data-mes="10">Nov</button><button type="button" class="pill" data-mes="11">Dic</button>
              </div>
              <p class="muted" style="margin-top:6px;">Si no seleccionas ninguno, se asumir√° <strong>todo el a√±o</strong>.</p>
            </div>

            <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btnGuardarNuevoCultivo">Guardar cultivo</button>
              <button type="button" class="btn btn-secondary" id="btnCancelarNuevoCultivo">Cancelar</button>
            </div>

            <p class="muted" style="margin-top: 10px;">
              El cultivo se guardar√° en este dispositivo y aparecer√° en el cat√°logo como <strong>‚ÄúCultivo personalizado‚Äù</strong>.
            </p>
          </div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üåø</div><h2>Mi huerto</h2></div>
        <p class="section-subtitle">Registra tus cultivos y consulta los detalles de cada planta.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>
          <div class="media-list settings-context"></div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoFrecuenciaRiego">Frecuencia riego (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaRiego" min="0" placeholder="Ej. 3" />
            </div>
            <div class="field">
              <label for="cultivoFrecuenciaAbono">Frecuencia abono (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaAbono" min="0" placeholder="Ej. 30" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>
            <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo"><span>‚ûï</span> Guardar cultivo</button>
          <p class="muted" style="margin-top:6px;">* Solo el nombre es obligatorio. Puedes editar o eliminar luego.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>
          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìì</div><h2>Diario de huerto</h2></div>
        <p class="section-subtitle">Anota riegos, abonados, fertilizaci√≥n, podas o eventos.</p>

        <div class="app-card" id="diarioFormCard">
          <div class="app-card-header">
            <div class="app-card-title" id="diarioFormTitle">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="diarioTipo">Tipo</label>
              <select id="diarioTipo">
                <option value="General">General</option>
                <option value="Riego">Riego</option>
                <option value="Abono">Abono</option>
                <option value="Fertilizante">Fertilizante</option>
                <option value="Poda">Poda</option>
                <option value="Plagas">Plagas</option>
              </select>
            </div>
            <div class="field">
              <label for="diarioFecha">Fecha</label>
              <input type="date" id="diarioFecha" />
            </div>
          </div>

          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates. Apliqu√© compost."></textarea>
          </div>
          <button class="btn btn-full" id="btnGuardarDiario"><span>üíæ</span> Guardar en el diario</button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas</div>
            <div class="chip" id="diarioCountChip">0 entradas</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="Fertilizante">Fertilizante</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>
          <div class="diario-list" id="diarioList"></div>

          <button class="btn btn-secondary btn-full" id="btnExportarDiarioPdf"><span>üì¶</span> Exportar diario (PDF)</button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üêõ</div><h2>Plagas comunes</h2></div>
        <p class="section-subtitle">Referencia r√°pida de plagas y manejo b√°sico.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Cat√°logo b√°sico de plagas</div><div class="chip">Referencia</div></div>
          <div class="media-list" id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üíß</div><h2>Pesticidas y preparados</h2></div>
        <p class="section-subtitle">Opciones suaves y de bajo impacto para huerto casero.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Preparados sugeridos</div><div class="chip">Uso responsable</div></div>
          <div class="media-list" id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row"><div class="section-icon-pill">‚öôÔ∏è</div><h2>Opciones</h2></div>
        <p class="section-subtitle">Ajusta nombre, clima, hemisferio y clima local.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Datos generales</div></div>
          <div class="media-list settings-context"></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima principal</label>
              <select id="climaSelect">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <div class="divider-soft"></div>

          <div class="app-card-header" style="margin-top:2px">
            <div class="app-card-title">Clima local (sin API key)</div>
            <div class="chip" id="climaStatusChip">‚Äî</div>
          </div>
          <p class="muted" style="margin-top:0">
            Usa ubicaci√≥n del tel√©fono para mostrar temperatura y lluvia (Open-Meteo). Solo se consulta cuando t√∫ lo pides o al abrir la app.
          </p>
          <div class="pill-group" style="margin-top:6px">
            <button class="btn btn-secondary" id="btnPedirUbicacion">üìç Usar ubicaci√≥n</button>
            <button class="btn btn-secondary" id="btnActualizarClima">‚òÅÔ∏è Actualizar clima</button>
          </div>

          <div class="divider-soft"></div>

          <button class="btn btn-full" id="btnGuardarConfig"><span>üíæ</span> Guardar configuraci√≥n</button>

          <div class="divider-soft"></div>
          <p class="muted">Todo se guarda <strong>solo en tu dispositivo</strong> (almacenamiento local).</p>

          <div class="pill-group" style="flex-direction:column;">
            <button class="btn btn-secondary btn-full" id="btnExportarDatosPdf"><span>üìÑ</span> Exportar datos (PDF)</button>
            <button class="btn btn-secondary btn-full" id="btnExportarJson"><span>üíæ</span> Exportar respaldo (.json)</button>
            <button class="btn btn-secondary btn-full" id="btnImportarJson"><span>üç∞</span> Restaurar respaldo</button>
            <button class="btn btn-danger btn-full" id="btnBorrarTodo"><span>üßπ</span> Borrar todo</button>
          </div>

          <input type="file" id="inputRespaldoJSON" accept="application/json" style="display:none" />
        </div>
      </section>

      <!-- GUIAS -->
      <section id="section-guias" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìö</div><h2>Gu√≠as r√°pidas</h2></div>
        <p class="section-subtitle">Consejos b√°sicos para sacar m√°s provecho.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Antes de sembrar</div><div class="chip">Paso 1</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Preparar el suelo</div>
              <div class="media-item-body">Retira piedras, agrega materia org√°nica y afloja la tierra.</div>
            </div>
            <div>
              <div class="media-item-title">Elegir el lugar</div>
              <div class="media-item-body">La mayor√≠a necesita 4‚Äì6 h de sol directo.</div>
            </div>
          </div>
        </div>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Riego inteligente</div><div class="chip">Paso 2</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Revisar humedad</div>
              <div class="media-item-body">Introduce un dedo 2‚Äì3 cm. Si est√° h√∫medo, espera.</div>
            </div>
            <div>
              <div class="media-item-title">Horario recomendado</div>
              <div class="media-item-body">En climas c√°lidos, mejor temprano o al atardecer.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer><span>Mi Siembra Inteligente ¬∑ Datos locales üåø</span></footer>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div class="msg" id="toastMsg">‚Äî</div>
    <div class="actions">
      <button class="btn btn-secondary" id="toastClose">Cerrar</button>
    </div>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>
    <button class="btn btn-secondary" id="btnInstalarPwa"><span>üì≤</span> Instalar</button>
  </div>

  <script>
    "use strict";

    /*********************
     * Helpers
     *********************/
    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function todayISO() { return new Date().toISOString().slice(0,10); }
    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    function formatDate(dateStr) {
      if (!dateStr) return "Sin fecha";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      const dia = String(d.getDate()).padStart(2,"0");
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }

    // Toast simple
    function showToast(msg) {
      const t = document.getElementById("toast");
      const m = document.getElementById("toastMsg");
      if (!t || !m) return;
      m.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._to);
      showToast._to = setTimeout(() => t.classList.remove("show"), 4500);
    }
    function bindToastClose() {
      const btn = document.getElementById("toastClose");
      const t = document.getElementById("toast");
      if (!btn || !t) return;
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", () => t.classList.remove("show"));
    }

    /*********************
     * Storage keys (compat v17/v18)
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario"
    };
    const STORAGE_CUSTOM_CULTIVOS = "msi-custom-cultivos-v18";
    const STORAGE_GEO = "msi-geo-v18";
    const STORAGE_WEATHER = "msi-weather-v18";

    const DEFAULT_SETTINGS = { nombreHuerto:"Mi huerto", clima:"tropical", hemisferio:"norte" };

    const CLIMA_LABEL = {
      tropical:"tropical",
      subtropical:"subtropical/templado",
      templado:"templado/fr√≠o"
    };
    const HEMISFERIO_LABEL = { norte:"hemisferio norte", sur:"hemisferio sur" };

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch { return fallback; }
    }
    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadSettings() {
      const obj = loadJSON(STORAGE_KEYS.settings, null);
      return { ...DEFAULT_SETTINGS, ...(obj && typeof obj === "object" ? obj : {}) };
    }
    function saveSettings(s) { saveJSON(STORAGE_KEYS.settings, s); }

    function loadCultivos() {
      const arr = loadJSON(STORAGE_KEYS.cultivos, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCultivos(arr) { saveJSON(STORAGE_KEYS.cultivos, arr); }

    function loadDiario() {
      const arr = loadJSON(STORAGE_KEYS.diario, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveDiario(arr) { saveJSON(STORAGE_KEYS.diario, arr); }

    function loadCustomCultivos() {
      const arr = loadJSON(STORAGE_CUSTOM_CULTIVOS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCustomCultivos(arr) { saveJSON(STORAGE_CUSTOM_CULTIVOS, arr); }

    function loadGeo() {
      const obj = loadJSON(STORAGE_GEO, null);
      if (!obj || typeof obj !== "object") return null;
      const { lat, lon, label } = obj;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { lat, lon, label: String(label || "") };
    }
    function saveGeo(geo) { saveJSON(STORAGE_GEO, geo); }

    /*********************
     * Calendario (base)
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        0: [{ titulo:"Cilantro", tipo:"Arom√°tica", detalle:"Ideal en meses frescos; siembra escalonada." }],
        5: [
          { titulo:"Re-siembra de lechugas", tipo:"Hoja", detalle:"Siembra escalonada cada 2‚Äì3 semanas." },
          { titulo:"R√°banos", tipo:"Ra√≠z", detalle:"Cosecha r√°pida (20‚Äì30 d√≠as)." }
        ],
        6: [
          { titulo:"Berenjena", tipo:"Fruto", detalle:"Le gustan noches c√°lidas; buen drenaje." },
          { titulo:"Aj√≠es y pimientos", tipo:"Fruto", detalle:"Sol y riego constante sin charcos." }
        ]
      },
      subtropical: { 5: [{ titulo:"Tomates", tipo:"Fruto", detalle:"Variedades adaptadas a tu zona." }] },
      templado: { 2: [{ titulo:"Lechugas", tipo:"Hoja", detalle:"Siembra temprana si hay riesgo de heladas." }] }
    };

    function ajustarMesPorHemisferio(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      if (settings.hemisferio === "sur" && (climaKey === "templado" || climaKey === "subtropical")) {
        return (monthIndex + 6) % 12;
      }
      return monthIndex;
    }
    function getCalendarData(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);
      const base = CALENDARIO_SIEMBRA[climaKey] || {};
      return base[mesAjustado] || [];
    }

    /*********************
     * Cat√°logo base
     *********************/
    const CATALOGO_CULTIVOS = [
      { id:"tomate", nombre:"Tomate", categoria:"Fruto", dias:"70‚Äì90 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, sin encharcar", tiesto:"Macetas profundas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones","Mosca blanca","Orugas"], meses:[0,1,2,3,4,5,6,7], imagen:"img/tomate.jpg" },
      { id:"lechuga", nombre:"Lechuga", categoria:"Hoja", dias:"45‚Äì60 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo ligeramente h√∫medo", tiesto:"Macetas anchas de 3+ galones", profundidad:"0.5 cm", plagas:["Babosas","Caracoles","Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/lechuga.jpg" },
      { id:"rabano", nombre:"R√°bano", categoria:"Ra√≠z", dias:"25‚Äì35 d√≠as", luz:"Sol o media sombra", riego:"H√∫medo constante", tiesto:"Macetas 3+ galones", profundidad:"1 cm", plagas:["Pulguillas","Babosas"], meses:[0,1,2,3,8,9,10,11], imagen:"img/rabano.jpg" },
      { id:"cilantro", nombre:"Cilantro", categoria:"Arom√°tica", dias:"30‚Äì50 d√≠as", luz:"Sol suave / sombra parcial", riego:"Suelo fresco", tiesto:"Macetas 3+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/cilantro.jpg" },
      { id:"platano", nombre:"Pl√°tano", categoria:"Fruto perenne", dias:"9‚Äì12 meses", luz:"Sol directo", riego:"Regular", tiesto:"Suelo directo", profundidad:"Cormo firme", plagas:["Picudo","Sigatoka"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/platano.jpg" },
      { id:"limon", nombre:"Lim√≥n", categoria:"Frutal c√≠trico", dias:"2‚Äì3 a√±os", luz:"Sol directo", riego:"Regular en sequ√≠a", tiesto:"Macet√≥n grande o suelo", profundidad:"Al nivel del cuello", plagas:["Minador","Cochinillas"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/limon.jpg" },
      { id:"mango", nombre:"Mango", categoria:"Frutal perenne", dias:"Varios a√±os", luz:"Sol fuerte", riego:"Poco (ya establecido)", tiesto:"Suelo directo", profundidad:"Al nivel del cuello", plagas:["Mosca fruta","Hongos"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/mango.jpg" }
    ];

    /*********************
     * Germinaci√≥n / reproducci√≥n
     *********************/
    const GERMINACION_POR_CULTIVO = {
      tomate: { titulo:"Tomate ‚Äì germinaci√≥n", metodo:"Semilla en alm√°cigo y trasplante.", pasos:["Sustrato suelto y drenado.","Sembrar 0.5‚Äì1 cm.","Humedad constante sin charcos.","Trasplantar con 3‚Äì4 hojas verdaderas."], tip:"Luz buena desde temprano para que no se espigue." },
      lechuga:{ titulo:"Lechuga ‚Äì germinaci√≥n", metodo:"Semilla directa o alm√°cigo.", pasos:["Sembrar superficial.","Humedad constante.","Trasplantar con 3‚Äì4 hojas.","Raleo si es directa."], tip:"Germina mejor con temperaturas moderadas." },
      platano:{ titulo:"Pl√°tano ‚Äì reproducci√≥n", metodo:"Hijuelos / cormos (no semilla).", pasos:["Elegir hijuelo sano.","Cortar y orear unas horas.","Plantar en suelo con drenaje.","Riego moderado."], tip:"Evita charcos." }
    };
    const GERMINACION_GENERIC = {
      hoja:{ titulo:"Hoja ‚Äì gu√≠a", metodo:"Semilla superficial.", pasos:["Sustrato suelto.","Sembrar casi en superficie.","Humedad fina constante.","Trasplantar con 3‚Äì4 hojas."], tip:"Sol suave / media sombra." },
      fruto:{ titulo:"Fruto ‚Äì gu√≠a", metodo:"Semilla en alm√°cigo o directa.", pasos:["1‚Äì2 cm seg√∫n semilla.","Humedad sin charcos.","Buena luz.","Trasplante cuando est√© fuerte."], tip:"Mucho sol y sustrato profundo." },
      raiz:{ titulo:"Ra√≠z ‚Äì gu√≠a", metodo:"Siempre semilla directa.", pasos:["Suelo profundo.","0.5‚Äì1 cm.","Humedad constante.","Raleo."], tip:"No trasplantar." },
      generico:{ titulo:"Gu√≠a general", metodo:"Semilla directa o bandeja.", pasos:["Lee sobre de semilla.","Sustrato limpio.","2‚Äì3x tama√±o de semilla.","Humedad constante."], tip:"Prueba en alm√°cigo y directo." }
    };
    function getInfoGerminacion(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      if (!cultivo) return null;
      if (GERMINACION_POR_CULTIVO[cultivoId]) return GERMINACION_POR_CULTIVO[cultivoId];
      const cat = (cultivo.categoria||"").toLowerCase();
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;
      if (cat.includes("fruto")) return GERMINACION_GENERIC.fruto;
      return GERMINACION_GENERIC.generico;
    }

    /*********************
     * Plagas base
     *********************/
    const PLAGAS_DATA = [
      { id:"pulgones", nombre:"Pulgones", comoSeVe:"Insectos peque√±os en brotes. Hojas deformadas.", manejoSuave:"Lavado con agua suave y revisi√≥n frecuente.", preparadosCaseros:"Jab√≥n pot√°sico bien diluido al atardecer.", productosComerciales:"Insecticidas de contacto autorizados." },
      { id:"mosca_blanca", nombre:"Mosca blanca", comoSeVe:"Volantitos blancos al mover hoja.", manejoSuave:"Retira hojas afectadas y mejora ventilaci√≥n.", preparadosCaseros:"Trampas amarillas + jab√≥n pot√°sico.", productosComerciales:"Productos espec√≠ficos dom√©sticos." },
      { id:"hongos_hoja", nombre:"Hongos (o√≠dio/manchas)", comoSeVe:"Manchas y/o polvillo blanco.", manejoSuave:"Ventilaci√≥n y evitar mojar hojas de noche.", preparadosCaseros:"Bicarbonato suave (dosis baja).", productosComerciales:"Fungicidas autorizados." }
    ];

    /*********************
     * Estado global
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";
    let diarioEnEdicionId = null;
    let customEditId = null;

    /*********************
     * Cultivos personalizados (Cat√°logo)
     *********************/
    function parsePlagas(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
    function allMonths(){ return [0,1,2,3,4,5,6,7,8,9,10,11]; }
    function getMesesSeleccionadosUI(){
      return Array.from(document.querySelectorAll("#nuevoCultivoMesesPills .pill.pill--active"))
        .map(b=>parseInt(b.dataset.mes,10)).filter(n=>Number.isFinite(n));
    }
    function setMesesSeleccionadosUI(meses){
      const set = new Set((meses||[]).map(Number));
      document.querySelectorAll("#nuevoCultivoMesesPills .pill").forEach(b=>{
        const m = parseInt(b.dataset.mes,10);
        b.classList.toggle("pill--active", set.has(m));
      });
    }
    function setupNuevoCultivoMesesPills(){
      const wrap = document.getElementById("nuevoCultivoMesesPills");
      if (!wrap) return;
      if (wrap.dataset.bound === "1") return;
      wrap.dataset.bound = "1";
      wrap.addEventListener("click",(ev)=>{
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        b.classList.toggle("pill--active");
      });
    }
    function removeCustomFromCatalogo(){
      for (let i = CATALOGO_CULTIVOS.length - 1; i >= 0; i--){
        if (CATALOGO_CULTIVOS[i]?.esPersonalizado) CATALOGO_CULTIVOS.splice(i,1);
      }
    }
    function injectCustomIntoCatalogo(customList){
      removeCustomFromCatalogo();
      customList.forEach(c => CATALOGO_CULTIVOS.push({ ...c, esPersonalizado:true }));
    }
    function buildCustomCultivoFromUI(existingId){
      const nombre = (document.getElementById("nuevoCultivoNombre")?.value||"").trim();
      const categoria = (document.getElementById("nuevoCultivoCategoria")?.value||"Otro").trim();
      const diasG = parseInt(document.getElementById("nuevoCultivoDiasGerminacion")?.value||"",10);
      const diasC = parseInt(document.getElementById("nuevoCultivoDiasCosecha")?.value||"",10);
      const luz = (document.getElementById("nuevoCultivoLuz")?.value||"").trim() || "‚Äî";
      const riego = (document.getElementById("nuevoCultivoRiego")?.value||"").trim() || "‚Äî";
      const tiesto = (document.getElementById("nuevoCultivoTiesto")?.value||"").trim() || "‚Äî";
      const profundidad = (document.getElementById("nuevoCultivoProfundidad")?.value||"").trim() || "‚Äî";
      const plagasStr = (document.getElementById("nuevoCultivoPlagas")?.value||"").trim();

      if (!nombre) { alert("Escribe el nombre del cultivo."); return null; }

      let meses = getMesesSeleccionadosUI();
      if (!meses.length) meses = allMonths();

      const id = existingId || `custom-${Date.now().toString(36)}`;
      const diasTexto = Number.isFinite(diasC) && diasC > 0 ? `${diasC} d√≠as` : "‚Äî";

      return {
        id, nombre, categoria,
        dias: diasTexto,
        luz, riego, tiesto, profundidad,
        plagas: parsePlagas(plagasStr),
        meses,
        imagen: "img/placeholder.jpg",
        esPersonalizado:true,
        diasGerminacion: Number.isFinite(diasG) && diasG > 0 ? diasG : null,
        diasCosecha: Number.isFinite(diasC) && diasC > 0 ? diasC : null
      };
    }
    function clearCustomCultivoUI(){
      ["nuevoCultivoNombre","nuevoCultivoDiasGerminacion","nuevoCultivoDiasCosecha","nuevoCultivoLuz","nuevoCultivoRiego","nuevoCultivoTiesto","nuevoCultivoProfundidad","nuevoCultivoPlagas"]
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
      const cat = document.getElementById("nuevoCultivoCategoria");
      if (cat) cat.value = "Otro";
      setMesesSeleccionadosUI([]);
    }
    function resetEditCustomCultivoUI(){
      customEditId = null;
      const t = document.getElementById("nuevoCultivoTitulo");
      if (t) t.textContent = "Nuevo cultivo";
      const btn = document.getElementById("btnGuardarNuevoCultivo");
      if (btn) btn.textContent = "Guardar cultivo";
    }
    function startEditCustomCultivo(cultivo){
      customEditId = cultivo.id;
      const card = document.getElementById("nuevoCultivoCard");
      if (card) card.style.display = "block";

      document.getElementById("nuevoCultivoTitulo").textContent = "Editar cultivo";
      document.getElementById("btnGuardarNuevoCultivo").textContent = "Actualizar cultivo";

      document.getElementById("nuevoCultivoNombre").value = cultivo.nombre || "";
      document.getElementById("nuevoCultivoCategoria").value = cultivo.categoria || "Otro";
      document.getElementById("nuevoCultivoDiasGerminacion").value = cultivo.diasGerminacion || "";
      document.getElementById("nuevoCultivoDiasCosecha").value = cultivo.diasCosecha || "";
      document.getElementById("nuevoCultivoLuz").value = cultivo.luz || "";
      document.getElementById("nuevoCultivoRiego").value = cultivo.riego || "";
      document.getElementById("nuevoCultivoTiesto").value = cultivo.tiesto || "";
      document.getElementById("nuevoCultivoProfundidad").value = cultivo.profundidad || "";
      document.getElementById("nuevoCultivoPlagas").value = Array.isArray(cultivo.plagas) ? cultivo.plagas.join(", ") : "";
      setMesesSeleccionadosUI(Array.isArray(cultivo.meses) ? cultivo.meses : []);
      setupNuevoCultivoMesesPills();

      card?.scrollIntoView({ behavior:"smooth", block:"start" });
      document.getElementById("nuevoCultivoNombre")?.focus();
    }
    function deleteCustomCultivoById(id){
      const customList = loadCustomCultivos().filter(c => c.id !== id);
      saveCustomCultivos(customList);
      injectCustomIntoCatalogo(customList);
      if (customEditId === id) {
        resetEditCustomCultivoUI();
        document.getElementById("nuevoCultivoCard").style.display = "none";
        clearCustomCultivoUI();
      }
    }
    function setupCultivoManualUI(){
      const btnToggle = document.getElementById("btnToggleNuevoCultivo");
      const card = document.getElementById("nuevoCultivoCard");
      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");
      const btnCancelar = document.getElementById("btnCancelarNuevoCultivo");
      if (!btnToggle || !card || !btnGuardar || !btnCancelar) return;

      setupNuevoCultivoMesesPills();
      if (btnToggle.dataset.bound === "1") return;
      btnToggle.dataset.bound = "1";

      btnToggle.addEventListener("click", () => {
        const visible = card.style.display !== "none";
        card.style.display = visible ? "none" : "block";
        if (!visible) document.getElementById("nuevoCultivoNombre")?.focus();
        else { clearCustomCultivoUI(); resetEditCustomCultivoUI(); }
      });

      btnCancelar.addEventListener("click", () => {
        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
      });

      btnGuardar.addEventListener("click", () => {
        const wasEditing = Boolean(customEditId);
        const cultivo = buildCustomCultivoFromUI(customEditId);
        if (!cultivo) return;

        let customList = loadCustomCultivos();
        if (customEditId) {
          customList = customList.filter(c => c.id !== customEditId);
        } else {
          const nameLower = (cultivo.nombre||"").toLowerCase();
          customList = customList.filter(c => (c.nombre||"").toLowerCase() !== nameLower);
        }

        customList.push(cultivo);
        saveCustomCultivos(customList);
        injectCustomIntoCatalogo(customList);

        renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());

        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
        alert(wasEditing ? "Cultivo actualizado ‚úÖ" : "Cultivo guardado ‚úÖ");
      });
    }
    function initCustomCultivos(){
      const customList = loadCustomCultivos();
      injectCustomIntoCatalogo(customList);
      setupCultivoManualUI();
    }

    /*********************
     * UI updates
     *********************/
    function updateHeader(){
      const subtitleEl = document.getElementById("appSubtitle");
      if (!subtitleEl) return;
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${escapeHTML(nombre)}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${escapeHTML(clima)}</span>
        <span class="app-subtitle-dot"></span>
        <span>${escapeHTML(hemis)}</span>
      `;
    }
    function updateSettingsContexts(){
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      document.querySelectorAll(".settings-context").forEach(el => {
        el.innerHTML = `
          <span class="chip"><span>üåø</span> Huerto: ${escapeHTML(nombre)}</span>
          <span class="chip"><span>‚òÅÔ∏è</span> Clima: ${escapeHTML(clima)}</span>
          <span class="chip"><span>üß≠</span> ${escapeHTML(hemis)}</span>
        `;
      });

      const climaText = `Clima ${clima}`;
      document.getElementById("estadoClimaChip")?.textContent = climaText;
      document.getElementById("calendarioClimaChip2")?.textContent = climaText;
    }

    function renderInicio(){
      const cultivosCount = stateCultivos.length;
      const hoyISO = todayISO();
      const entradasHoy = stateDiario.filter(e => e.fecha === hoyISO).length;

      document.getElementById("estadoCultivosCount")?.textContent = String(cultivosCount);
      document.getElementById("estadoEntradasCount")?.textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      if (!resumen) return;

      const nombre = stateSettings.nombreHuerto || "tu huerto";
      let texto = "";
      if (!cultivosCount && !entradasHoy) {
        texto = 'Todav√≠a no has registrado cultivos ni entradas. Empieza en "Mi huerto".';
      } else if (cultivosCount && !entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) en ${nombre}. A√∫n no escribes en el diario hoy.`;
      } else if (cultivosCount && entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) y hoy registraste ${entradasHoy} entrada(s). ¬°Buen ritmo!`;
      } else {
        texto = 'Tienes notas en el diario pero no has a√±adido cultivos. Usa "Mi huerto".';
      }
      resumen.textContent = texto;

      // Recordatorios
      const reminders = calcularRecordatorios();
      document.getElementById("recordatoriosChip")?.textContent = `${reminders.length} pendiente${reminders.length===1?"":"s"}`;
      const txt = document.getElementById("recordatoriosTxt");
      if (txt) {
        if (!reminders.length) txt.textContent = "Sin recordatorios por ahora.";
        else txt.textContent = reminders.slice(0,3).map(r => `‚Ä¢ ${r}`).join(" ");
      }
    }

    function renderCalendario(monthIndex){
      const listEl = document.getElementById("calendarList");
      const emptyEl = document.getElementById("calendarEmpty");
      if (!listEl || !emptyEl) return;

      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      const data = getCalendarData(stateSettings, monthIndex);

      // Mensaje hemisferio sur
      const MESES_ABR = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      const mesAjustado = ajustarMesPorHemisferio(stateSettings, monthIndex);
      if (mesAjustado !== monthIndex) {
        const info = document.createElement("p");
        info.className = "muted";
        info.textContent = `Hemisferio sur: ${MESES_ABR[monthIndex]} se interpreta como ${MESES_ABR[mesAjustado]} (+6m).`;
        listEl.appendChild(info);
      }

      if (data.length) {
        data.forEach(item => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${escapeHTML(item.titulo)}</span>
              <span class="chip">${escapeHTML(item.tipo)}</span>
            </div>
            <div>${escapeHTML(item.detalle)}</div>
          `;
          listEl.appendChild(div);
        });
      }

      // Cat√°logo recomendado por mes
      const mesCatalogo = ajustarMesPorHemisferio(stateSettings, monthIndex);
      const sugeridos = CATALOGO_CULTIVOS.filter(c => Array.isArray(c.meses) && c.meses.includes(mesCatalogo));

      if (!data.length && !sugeridos.length) {
        emptyEl.style.display = "block";
        return;
      }

      if (sugeridos.length) {
        const separador = document.createElement("div");
        separador.className = "divider-soft";
        listEl.appendChild(separador);

        const tituloExtra = document.createElement("p");
        tituloExtra.className = "muted";
        tituloExtra.textContent = "Desde el cat√°logo: cultivos recomendados para este mes.";
        listEl.appendChild(tituloExtra);

        sugeridos.forEach(c => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${escapeHTML(c.nombre)}</span>
              <span class="chip">${escapeHTML(c.categoria)}</span>
            </div>
            <div>D√≠as a cosecha: ${escapeHTML(c.dias)}. Luz: ${escapeHTML(c.luz)}.</div>
            <div style="margin-top:6px;">
              <button class="btn btn-secondary btn-full" data-action="ver-catalogo" data-id="${escapeHTML(c.id)}">
                üîç Ver en cat√°logo
              </button>
            </div>
          `;
          listEl.appendChild(div);
        });
      }
    }

    function irACultivoEnCatalogo(cultivoId){
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      const textoBusqueda = cultivo ? cultivo.nombre : "";
      document.querySelector('.nav-btn[data-section="catalogo"]')?.click();
      const input = document.getElementById("catalogoBusqueda");
      if (input) input.value = textoBusqueda;
      renderCatalogo(textoBusqueda);
      document.getElementById("section-catalogo")?.scrollIntoView?.({ behavior:"smooth", block:"start" });
    }

    function renderCatalogo(filtroTexto=""){
      const listEl = document.getElementById("catalogoList");
      if (!listEl) return;

      const filtro = (filtroTexto||"").trim().toLowerCase();
      const lista = CATALOGO_CULTIVOS.filter(c => {
        if (!filtro) return true;
        return (c.nombre||"").toLowerCase().includes(filtro) || (c.id||"").toLowerCase().includes(filtro);
      });

      if (!lista.length) {
        listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${escapeHTML(filtroTexto)}".</p>`;
        return;
      }

      listEl.innerHTML = "";
      lista.forEach(c => {
        const imgSrc = c.imagen || "img/placeholder.jpg";
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const plagasTxt = Array.isArray(c.plagas) && c.plagas.length ? c.plagas.join(", ") : "‚Äî";

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <img src="${escapeHTML(imgSrc)}" alt="${escapeHTML(c.nombre)}" class="cultivo-thumb"
                   onerror="this.onerror=null;this.src='img/placeholder.jpg';" />
              <span>üå± ${escapeHTML(c.nombre)}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
              <span class="chip">${escapeHTML(c.categoria)}</span>
              ${c.esPersonalizado ? `<span class="chip badge">Personalizado</span>` : ``}
            </div>
          </div>

          <div class="cultivo-body">
            <div><strong>D√≠as a cosecha:</strong> ${escapeHTML(c.dias)}</div>
            <div><strong>Luz:</strong> ${escapeHTML(c.luz)}</div>
            <div><strong>Riego:</strong> ${escapeHTML(c.riego)}</div>
            <div><strong>Tiesto / suelo:</strong> ${escapeHTML(c.tiesto)}</div>
            <div><strong>Profundidad de siembra:</strong> ${escapeHTML(c.profundidad)}</div>
            <div><strong>Plagas frecuentes:</strong> ${escapeHTML(plagasTxt)}</div>
          </div>

          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="germinacion">üîÅ Germinaci√≥n / reproducci√≥n</button>
            ${c.esPersonalizado ? `
              <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="editar-custom">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" data-id="${escapeHTML(c.id)}" data-action="borrar-custom">üóë Borrar</button>
            ` : ``}
          </div>
        `;

        const panel = document.createElement("div");
        panel.className = "germinacion-panel";
        card.appendChild(panel);
        listEl.appendChild(card);
      });
    }

    /*********************
     * Mi huerto (riego/cosecha sugerida)
     *********************/
    function getRiegoYCosechaParaNombre(nombre, fechaSiembraISO){
      let frecuenciaRiego = null;
      let fechaCosechaEstimada = null;
      if (!nombre) return { frecuenciaRiego, fechaCosechaEstimada };

      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(c =>
        (c.nombre||"").toLowerCase() === nombreLower || (c.id||"").toLowerCase() === nombreLower
      );

      if (cultivoCatalogo) {
        frecuenciaRiego = 3;
        if (fechaSiembraISO && cultivoCatalogo.dias) {
          const match = String(cultivoCatalogo.dias).match(/(\d+)/);
          if (match) {
            const dias = parseInt(match[1],10);
            if (Number.isFinite(dias) && dias > 0) fechaCosechaEstimada = addDays(fechaSiembraISO, dias);
          }
        }
      }
      return { frecuenciaRiego, fechaCosechaEstimada };
    }

    function nextDueDateISO(lastISO, freqDays){
      if (!lastISO || !Number.isFinite(freqDays) || freqDays <= 0) return null;
      return addDays(lastISO, freqDays);
    }
    function isoToTime(dateISO){
      if (!dateISO) return null;
      const d = new Date(dateISO + "T00:00:00");
      const t = d.getTime();
      return Number.isNaN(t) ? null : t;
    }

    function calcularRecordatorios(){
      const hoy = todayISO();
      const hoyT = isoToTime(hoy);
      const out = [];

      stateCultivos.forEach(c => {
        const fR = Number(c.frecuenciaRiegoDias);
        const fA = Number(c.frecuenciaAbonoDias);

        // Si nunca se reg√≥ pero existe frecuencia => usar fecha de siembra como base
        const baseR = c.ultimoRiego || c.fechaSiembra;
        const baseA = c.ultimaFertilizacion || c.fechaSiembra;

        const dueR = nextDueDateISO(baseR, Number.isFinite(fR) ? fR : NaN);
        const dueA = nextDueDateISO(baseA, Number.isFinite(fA) ? fA : NaN);

        if (dueR) {
          const t = isoToTime(dueR);
          if (t !== null && hoyT !== null && t <= hoyT) out.push(`Riego: ${c.nombre} (deb√≠a: ${formatDate(dueR)})`);
        }
        if (dueA) {
          const t = isoToTime(dueA);
          if (t !== null && hoyT !== null && t <= hoyT) out.push(`Abono: ${c.nombre} (deb√≠a: ${formatDate(dueA)})`);
        }
      });

      return out.slice(0, 8);
    }

    function renderCultivos(){
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      if (!listEl) return;

      const count = stateCultivos.length;
      if (chip) chip.textContent = `${count} cultivo${count===1?"":"s"}`;

      if (!count) {
        listEl.innerHTML = '<p class="muted">Todav√≠a no has registrado cultivos. Usa el formulario de arriba.</p>';
        return;
      }

      const tipoLabelMap = { hoja:"Hoja", fruto:"Fruto", raiz:"Ra√≠z", tuberculo:"Tub√©rculo", aromaticas:"Arom√°ticas", otro:"Otro" };

      listEl.innerHTML = "";
      stateCultivos.forEach(c => {
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";
        const ultimaAbonoTexto = c.ultimaFertilizacion ? formatDate(c.ultimaFertilizacion) : "Sin registro";
        const frecuenciaAbonoTexto = c.frecuenciaAbonoDias ? (c.frecuenciaAbonoDias + " d√≠as") : "No definida";
        const ultimoRiegoTexto = c.ultimoRiego ? formatDate(c.ultimoRiego) : "Sin registro";
        const frecuenciaRiegoTexto = c.frecuenciaRiegoDias ? (c.frecuenciaRiegoDias + " d√≠as") : "No definida";
        const fechaCosechaTexto = c.fechaCosechaEstimada ? formatDate(c.fechaCosechaEstimada) : "No definida";

        const dueR = nextDueDateISO(c.ultimoRiego || c.fechaSiembra, Number(c.frecuenciaRiegoDias));
        const dueA = nextDueDateISO(c.ultimaFertilizacion || c.fechaSiembra, Number(c.frecuenciaAbonoDias));

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title"><span>üåø</span><span>${escapeHTML(c.nombre)}</span></div>
            <span class="chip">${escapeHTML(tipoLabel)}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${escapeHTML(c.variedad || "‚Äî")}</div>
            <div><strong>Siembra:</strong> ${escapeHTML(formatDate(c.fechaSiembra))}</div>
            <div><strong>Notas:</strong> ${escapeHTML((c.notas || "‚Äî").slice(0, 140))}</div>
            <div><strong>Creado:</strong> ${escapeHTML(formatDate(c.creadoEl))}</div>

            <div><strong>√ölt. riego:</strong> ${escapeHTML(ultimoRiegoTexto)}</div>
            <div><strong>Freq riego:</strong> ${escapeHTML(frecuenciaRiegoTexto)}</div>
            <div><strong>Pr√≥x riego:</strong> ${escapeHTML(dueR ? formatDate(dueR) : "‚Äî")}</div>

            <div><strong>√ölt. abono:</strong> ${escapeHTML(ultimaAbonoTexto)}</div>
            <div><strong>Freq abono:</strong> ${escapeHTML(frecuenciaAbonoTexto)}</div>
            <div><strong>Pr√≥x abono:</strong> ${escapeHTML(dueA ? formatDate(dueA) : "‚Äî")}</div>

            <div><strong>Cosecha est.:</strong> ${escapeHTML(fechaCosechaTexto)}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="nota">‚úèÔ∏è Nota</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="riego">üí¶ Riego</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="abono">üíß Abono</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="plaga">üêõ Plagas</button>
            <button class="btn btn-danger" data-id="${escapeHTML(c.id)}" data-action="borrar">üóë Eliminar</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    <!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v18)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />

  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --bg-elevated:#02081f;
      --card:#02081f;
      --card-soft:#030919;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --accent-strong:rgba(34,197,94,0.45);
      --text-main:#f9fafb;
      --text-soft:#9ca3af;
      --border-subtle:rgba(148,163,184,0.3);
      --danger:#ef4444;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.7);
      --radius-xl:22px;
      --radius-lg:18px;
      --radius-full:999px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Roboto","Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#022c22 0,#020617 55%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;flex-direction:column;
    }
    .app-shell{max-width:960px;margin:0 auto;padding:16px 12px 28px}
    @media(min-width:768px){.app-shell{padding:20px 16px 40px}}
    .app-header{
      background:radial-gradient(circle at 0 0,#4ade80 0,#16a34a 28%,#052e16 85%);
      border-radius:28px;
      padding:18px 18px 16px;
      display:flex;align-items:center;gap:14px;
      box-shadow:var(--shadow-soft);
      position:relative;overflow:hidden;
      margin-bottom:14px;
    }
    .app-header::after{
      content:"";position:absolute;inset:0;
      background:radial-gradient(circle at 120% -10%,rgba(34,197,94,0.35) 0,transparent 55%);
      opacity:.9;pointer-events:none;
    }
    .app-header-icon{
      position:relative;z-index:1;
      width:52px;height:52px;border-radius:18px;
      background:radial-gradient(circle at 30% 10%,#bbf7d0 0,#16a34a 35%,#052e16 90%);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      flex-shrink:0;
    }
    .app-header-icon span{font-size:42px}
    .app-header-text{position:relative;z-index:1;display:flex;flex-direction:column;gap:4px}
    .app-title-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .app-title{font-size:1.35rem;font-weight:700;letter-spacing:.02em}
    .app-tag{
      font-size:.72rem;padding:2px 8px;border-radius:999px;
      background:rgba(15,23,42,.45);border:1px solid rgba(15,23,42,.8);
      text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb
    }
    .app-subtitle{
      font-size:.80rem;color:#e5e7eb;opacity:.95;
      display:flex;flex-wrap:wrap;gap:6px;align-items:center
    }
    .app-subtitle span{display:inline-flex;align-items:center;gap:4px}
    .app-subtitle-dot{width:3px;height:3px;border-radius:50%;background:rgba(226,232,240,.7)}

    .nav{
      margin-top:8px;
      background:linear-gradient(135deg,var(--bg-elevated),#020617);
      border-radius:26px;padding:10px;
      box-shadow:0 18px 40px rgba(15,23,42,.85);
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
      position:sticky;top:0;z-index:40;
      backdrop-filter:blur(16px);
      border:1px solid rgba(15,23,42,.85);
    }
    @media(min-width:660px){.nav{grid-template-columns:repeat(8,minmax(0,1fr))}}
    .nav-btn{
      border:none;border-radius:999px;
      padding:7px 6px 6px;
      font-size:.70rem;color:var(--text-soft);
      background:transparent;
      display:flex;flex-direction:column;align-items:center;gap:3px;
      cursor:pointer;transition:background .18s,color .18s,transform .12s;
      position:relative;min-height:52px;
    }
    .nav-btn span.nav-icon{font-size:1.40rem}
    .nav-btn.nav-btn--active{
      background:radial-gradient(circle at top,var(--accent) 0,var(--accent-soft) 45%,transparent 100%);
      color:#ecfdf5;
      box-shadow:0 0 0 1px rgba(34,197,94,.4),0 14px 30px rgba(22,163,74,.55);
      transform:translateY(-1px);
    }
    .nav-btn.nav-btn--active::after{
      content:"";position:absolute;inset:auto auto -3px 50%;
      width:32%;max-width:42px;height:3px;border-radius:999px;
      background:linear-gradient(90deg,rgba(34,197,94,.1),rgba(34,197,94,.6),rgba(34,197,94,.1));
      transform:translateX(-50%);
    }

    main{margin-top:14px}
    .section{display:none;animation:fadeIn .18s ease-out}
    .section--active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    .section > .section-title-row{display:flex;align-items:center;gap:10px;margin:14px 2px 8px}
    .section-icon-pill{
      width:26px;height:26px;border-radius:13px;
      background:radial-gradient(circle at 30% 15%,#fefce8 0,#fef9c3 25%,#0f172a 90%);
      display:flex;align-items:center;justify-content:center;font-size:1.3rem
    }
    .section-title-row h2{font-size:1.05rem;margin:0}
    .section-subtitle{font-size:.82rem;color:var(--text-soft);margin:2px 2px 10px}

    .app-card{
      background:radial-gradient(circle at top left,#020617 0,#020617 40%,#02081f 100%);
      border-radius:var(--radius-xl);
      padding:14px 16px 14px;
      border:1px solid var(--border-subtle);
      box-shadow:var(--shadow-soft);
      margin-bottom:14px;
    }
    .app-card-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
    .app-card-title{font-size:.96rem;font-weight:600}
    .chip{
      border-radius:var(--radius-full);
      padding:4px 10px;font-size:.74rem;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      display:inline-flex;align-items:center;gap:4px;white-space:nowrap
    }
    .chip.badge{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.6);color:#bbf7d0}
    .muted{color:var(--text-soft);font-size:.80rem}
    .divider-soft{
      height:1px;
      background:linear-gradient(90deg,transparent,rgba(148,163,184,.4),transparent);
      margin:8px -2px 10px;
    }

    .pill-group{display:flex;flex-wrap:wrap;gap:8px;margin:8px -1px 4px}
    .pill{
      border-radius:999px;
      padding:5px 12px;font-size:.78rem;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.9);
      cursor:pointer;color:var(--text-main);
    }
    .pill--active{background:var(--accent-soft);border-color:rgba(34,197,94,.85);color:#bbf7d0}

    .btn{
      border-radius:999px;border:none;
      padding:9px 14px;font-size:.82rem;font-weight:500;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#022c22;
      box-shadow:0 12px 30px rgba(22,163,74,.55);
      transition:transform .12s,box-shadow .12s,filter .12s;
    }
    .btn span{font-size:1rem}
    .btn:active{transform:translateY(1px);box-shadow:0 7px 18px rgba(22,163,74,.55);filter:brightness(.96)}
    .btn-secondary{background:rgba(15,23,42,.9);color:var(--text-main);border:1px solid var(--border-subtle);box-shadow:none}
    .btn-full{width:100%;justify-content:center}
    .btn-danger{background:linear-gradient(135deg,#b91c1c,#ef4444);color:#fee2e2;box-shadow:0 10px 26px rgba(248,113,113,.45)}
    .grid-two{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .small-label{font-size:.78rem;color:var(--text-soft);margin-bottom:2px}
    .big-number{font-size:1.3rem;font-weight:600}

    .form-grid{display:grid;grid-template-columns:1fr;gap:10px;margin:8px 0 4px}
    @media(min-width:660px){.form-grid--2{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:.78rem;color:var(--text-soft)}
    input[type="text"],input[type="date"],input[type="number"],select,textarea{
      background:rgba(15,23,42,.95);
      border-radius:14px;border:1px solid rgba(51,65,85,.9);
      padding:8px 10px;color:var(--text-main);
      font-size:.83rem;font-family:inherit;width:100%;outline:none;
      transition:border .12s,box-shadow .12s,background .12s;
    }
    select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      padding-right:26px;
      background-image:
        linear-gradient(45deg,transparent 50%,#9ca3af 50%),
        linear-gradient(135deg,#9ca3af 50%,transparent 50%);
      background-position:calc(100% - 15px) 10px,calc(100% - 11px) 10px;
      background-size:6px 6px,6px 6px;background-repeat:no-repeat;
    }
    textarea{min-height:72px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:rgba(34,197,94,.9);
      box-shadow:0 0 0 1px rgba(34,197,94,.5);
      background:rgba(15,23,42,.98);
    }

    .cultivos-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .cultivo-card{
      border-radius:var(--radius-lg);
      padding:10px 11px;
      background:radial-gradient(circle at top left,var(--card-soft) 0,#020617 60%);
      border:1px solid rgba(75,85,99,.9);
      display:flex;flex-direction:column;gap:4px;
    }
    .cultivo-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .cultivo-title{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:8px}
    .cultivo-thumb{width:56px;height:56px;border-radius:16px;object-fit:cover;flex-shrink:0}
    .cultivo-body{
      font-size:.78rem;color:var(--text-soft);
      display:grid;grid-template-columns:1.1fr .9fr;gap:4px 10px;margin-top:6px
    }
    @media(max-width:480px){.cultivo-body{grid-template-columns:1fr}}
    .cultivo-actions{margin-top:8px;display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap}
    .germinacion-panel{
      margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.5);
      font-size:.78rem;color:var(--text-soft);display:none;
    }

    .calendar-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .calendar-item{
      border-radius:16px;padding:9px 10px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.8rem;
    }
    .calendar-item-title{
      font-weight:600;margin-bottom:2px;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .calendar-empty{font-size:.8rem;color:var(--text-soft);margin-top:8px}

    .diario-list{display:flex;flex-direction:column;gap:8px;margin-top:6px;font-size:.8rem}
    .diario-item{
      border-radius:14px;padding:8px 10px;background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }
    .diario-item-header{
      display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;
    }

    .plaga-card{
      border-radius:14px;padding:8px 10px;background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);margin-bottom:6px;
    }
    .plaga-card--highlight{border-color:rgba(34,197,94,.9);box-shadow:0 0 0 1px rgba(34,197,94,.6)}
    .media-list{display:flex;flex-direction:column;gap:10px;margin-top:6px}
    .media-item-title{font-size:.86rem;font-weight:600}
    .media-item-body{font-size:.8rem;color:var(--text-soft);margin-top:2px}

    footer{margin-top:6px;font-size:.76rem;color:var(--text-soft);text-align:center;padding-bottom:6px}

    /* Banner instalar */
    #installBanner{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(15,23,42,.97);
      border-radius:999px;padding:7px 12px;
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 16px 40px rgba(15,23,42,.85);
      font-size:.78rem;z-index:80;
    }
    #installBanner.hidden{display:none}
    #installBanner button{font-size:.78rem;padding:6px 10px}

    /* Toast */
    #toast{
      position:fixed;left:50%;top:14px;transform:translateX(-50%);
      z-index:90;display:none;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      border-radius:999px;
      padding:10px 12px;
      min-width:min(520px,calc(100vw - 28px));
      align-items:center;justify-content:space-between;gap:10px;
    }
    #toast.show{display:flex}
    #toast .msg{font-size:.82rem;color:#e5e7eb}
    #toast .actions{display:flex;gap:8px;align-items:center}
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon"><span>üå±</span></div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v18 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle"></div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio"><span class="nav-icon">üè†</span><span class="nav-label">Inicio</span></button>
      <button class="nav-btn" data-section="calendario"><span class="nav-icon">üìÖ</span><span class="nav-label">Calendario</span></button>
      <button class="nav-btn" data-section="catalogo"><span class="nav-icon">üå±</span><span class="nav-label">Cat√°logo</span></button>
      <button class="nav-btn" data-section="huerto"><span class="nav-icon">üåø</span><span class="nav-label">Mi huerto</span></button>
      <button class="nav-btn" data-section="diario"><span class="nav-icon">üìì</span><span class="nav-label">Diario</span></button>
      <button class="nav-btn" data-section="plagas"><span class="nav-icon">üêõ</span><span class="nav-label">Plagas</span></button>
      <button class="nav-btn" data-section="pesticidas"><span class="nav-icon">üíß</span><span class="nav-label">Pesticidas</span></button>
      <button class="nav-btn" data-section="opciones"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-label">Opciones</span></button>
      <button class="nav-btn" data-section="guias"><span class="nav-icon">üìö</span><span class="nav-label">Gu√≠as</span></button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row"><div class="section-icon-pill">üè†</div><h2>Inicio</h2></div>
        <p class="section-subtitle">Resumen r√°pido de tu huerto y acceso a las funciones principales.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <div class="chip badge" id="estadoClimaChip">Clima tropical</div>
              <div class="chip" id="climaAhoraChip">Clima: ‚Äî</div>
            </div>
          </div>

          <div class="grid-two">
            <div><div class="small-label">Cultivos registrados</div><div class="big-number" id="estadoCultivosCount">0</div></div>
            <div><div class="small-label">Entradas hoy en el diario</div><div class="big-number" id="estadoEntradasCount">0</div></div>
          </div>

          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Recordatorios</div>
            <div class="chip" id="recordatoriosChip">0 pendientes</div>
          </div>
          <p class="muted" id="recordatoriosTxt">Sin recordatorios por ahora.</p>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìÖ</div><h2>Calendario de siembra</h2></div>
        <p class="section-subtitle">Selecciona un mes para ver sugerencias seg√∫n tu clima y hemisferio.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses del a√±o</div>
            <div class="chip" id="calendarioClimaChip2">Clima tropical</div>
          </div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button><button class="pill" data-mes="1">Feb</button><button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button><button class="pill" data-mes="4">May</button><button class="pill" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button><button class="pill" data-mes="7">Ago</button><button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button><button class="pill" data-mes="10">Nov</button><button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">Por ahora no hay recomendaciones espec√≠ficas para este mes y clima.</div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üå±</div><h2>Cat√°logo de cultivos</h2></div>
        <p class="section-subtitle">Lista de cultivos con informaci√≥n r√°pida y gu√≠a de germinaci√≥n / reproducci√≥n.</p>

        <div class="app-card">
          <div class="field">
            <label for="catalogoBusqueda">Buscar cultivo</label>
            <input type="text" id="catalogoBusqueda" placeholder="Ej. tomate, lechuga, pl√°tano..." />
          </div>

          <div style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary" id="btnToggleNuevoCultivo">‚ûï A√±adir cultivo manual</button>
          </div>

          <div class="cultivos-list" id="catalogoList"></div>

          <!-- Formulario cultivo manual -->
          <div class="app-card" id="nuevoCultivoCard" style="margin-top: 12px; display:none;">
            <div class="app-card-header">
              <div class="app-card-title" id="nuevoCultivoTitulo">Nuevo cultivo</div>
              <span class="chip badge">Personalizado</span>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoNombre">Nombre del cultivo *</label>
                <input type="text" id="nuevoCultivoNombre" placeholder="Ej. cilantro criollo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoCategoria">Categor√≠a</label>
                <select id="nuevoCultivoCategoria">
                  <option value="Hoja">Hoja</option>
                  <option value="Fruto">Fruto</option>
                  <option value="Ra√≠z">Ra√≠z</option>
                  <option value="Tub√©rculo">Tub√©rculo</option>
                  <option value="Arom√°tica">Arom√°tica</option>
                  <option value="Frutal perenne">Frutal perenne</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoDiasGerminacion">D√≠as de germinaci√≥n (opcional)</label>
                <input type="number" id="nuevoCultivoDiasGerminacion" min="0" placeholder="Ej. 7" />
              </div>
              <div class="field">
                <label for="nuevoCultivoDiasCosecha">D√≠as hasta cosecha (opcional)</label>
                <input type="number" id="nuevoCultivoDiasCosecha" min="0" placeholder="Ej. 90" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoLuz">Luz</label>
                <input type="text" id="nuevoCultivoLuz" placeholder="Ej. Sol directo (6‚Äì8 h)" />
              </div>
              <div class="field">
                <label for="nuevoCultivoRiego">Riego</label>
                <input type="text" id="nuevoCultivoRiego" placeholder="Ej. Suelo siempre ligeramente h√∫medo" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoTiesto">Tiesto / suelo</label>
                <input type="text" id="nuevoCultivoTiesto" placeholder="Ej. Maceta 5+ galones o suelo directo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoProfundidad">Profundidad de siembra</label>
                <input type="text" id="nuevoCultivoProfundidad" placeholder="Ej. 0.5‚Äì1 cm" />
              </div>
            </div>

            <div class="field">
              <label for="nuevoCultivoPlagas">Plagas frecuentes (separadas por coma)</label>
              <input type="text" id="nuevoCultivoPlagas" placeholder="Ej. pulgones, babosas, hongos" />
            </div>

            <div class="field" style="margin-top: 10px;">
              <label>Meses de siembra (para recomendaciones del Calendario)</label>
              <div class="pill-group" id="nuevoCultivoMesesPills">
                <button type="button" class="pill" data-mes="0">Ene</button><button type="button" class="pill" data-mes="1">Feb</button>
                <button type="button" class="pill" data-mes="2">Mar</button><button type="button" class="pill" data-mes="3">Abr</button>
                <button type="button" class="pill" data-mes="4">May</button><button type="button" class="pill" data-mes="5">Jun</button>
                <button type="button" class="pill" data-mes="6">Jul</button><button type="button" class="pill" data-mes="7">Ago</button>
                <button type="button" class="pill" data-mes="8">Sep</button><button type="button" class="pill" data-mes="9">Oct</button>
                <button type="button" class="pill" data-mes="10">Nov</button><button type="button" class="pill" data-mes="11">Dic</button>
              </div>
              <p class="muted" style="margin-top:6px;">Si no seleccionas ninguno, se asumir√° <strong>todo el a√±o</strong>.</p>
            </div>

            <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btnGuardarNuevoCultivo">Guardar cultivo</button>
              <button type="button" class="btn btn-secondary" id="btnCancelarNuevoCultivo">Cancelar</button>
            </div>

            <p class="muted" style="margin-top: 10px;">
              El cultivo se guardar√° en este dispositivo y aparecer√° en el cat√°logo como <strong>‚ÄúCultivo personalizado‚Äù</strong>.
            </p>
          </div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üåø</div><h2>Mi huerto</h2></div>
        <p class="section-subtitle">Registra tus cultivos y consulta los detalles de cada planta.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>
          <div class="media-list settings-context"></div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoFrecuenciaRiego">Frecuencia riego (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaRiego" min="0" placeholder="Ej. 3" />
            </div>
            <div class="field">
              <label for="cultivoFrecuenciaAbono">Frecuencia abono (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaAbono" min="0" placeholder="Ej. 30" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>
            <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo"><span>‚ûï</span> Guardar cultivo</button>
          <p class="muted" style="margin-top:6px;">* Solo el nombre es obligatorio. Puedes editar o eliminar luego.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>
          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìì</div><h2>Diario de huerto</h2></div>
        <p class="section-subtitle">Anota riegos, abonados, fertilizaci√≥n, podas o eventos.</p>

        <div class="app-card" id="diarioFormCard">
          <div class="app-card-header">
            <div class="app-card-title" id="diarioFormTitle">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="diarioTipo">Tipo</label>
              <select id="diarioTipo">
                <option value="General">General</option>
                <option value="Riego">Riego</option>
                <option value="Abono">Abono</option>
                <option value="Fertilizante">Fertilizante</option>
                <option value="Poda">Poda</option>
                <option value="Plagas">Plagas</option>
              </select>
            </div>
            <div class="field">
              <label for="diarioFecha">Fecha</label>
              <input type="date" id="diarioFecha" />
            </div>
          </div>

          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates. Apliqu√© compost."></textarea>
          </div>
          <button class="btn btn-full" id="btnGuardarDiario"><span>üíæ</span> Guardar en el diario</button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas</div>
            <div class="chip" id="diarioCountChip">0 entradas</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="Fertilizante">Fertilizante</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>
          <div class="diario-list" id="diarioList"></div>

          <button class="btn btn-secondary btn-full" id="btnExportarDiarioPdf"><span>üì¶</span> Exportar diario (PDF)</button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üêõ</div><h2>Plagas comunes</h2></div>
        <p class="section-subtitle">Referencia r√°pida de plagas y manejo b√°sico.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Cat√°logo b√°sico de plagas</div><div class="chip">Referencia</div></div>
          <div class="media-list" id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üíß</div><h2>Pesticidas y preparados</h2></div>
        <p class="section-subtitle">Opciones suaves y de bajo impacto para huerto casero.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Preparados sugeridos</div><div class="chip">Uso responsable</div></div>
          <div class="media-list" id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row"><div class="section-icon-pill">‚öôÔ∏è</div><h2>Opciones</h2></div>
        <p class="section-subtitle">Ajusta nombre, clima, hemisferio y clima local.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Datos generales</div></div>
          <div class="media-list settings-context"></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima principal</label>
              <select id="climaSelect">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <div class="divider-soft"></div>

          <div class="app-card-header" style="margin-top:2px">
            <div class="app-card-title">Clima local (sin API key)</div>
            <div class="chip" id="climaStatusChip">‚Äî</div>
          </div>
          <p class="muted" style="margin-top:0">
            Usa ubicaci√≥n del tel√©fono para mostrar temperatura y lluvia (Open-Meteo). Solo se consulta cuando t√∫ lo pides o al abrir la app.
          </p>
          <div class="pill-group" style="margin-top:6px">
            <button class="btn btn-secondary" id="btnPedirUbicacion">üìç Usar ubicaci√≥n</button>
            <button class="btn btn-secondary" id="btnActualizarClima">‚òÅÔ∏è Actualizar clima</button>
          </div>

          <div class="divider-soft"></div>

          <button class="btn btn-full" id="btnGuardarConfig"><span>üíæ</span> Guardar configuraci√≥n</button>

          <div class="divider-soft"></div>
          <p class="muted">Todo se guarda <strong>solo en tu dispositivo</strong> (almacenamiento local).</p>

          <div class="pill-group" style="flex-direction:column;">
            <button class="btn btn-secondary btn-full" id="btnExportarDatosPdf"><span>üìÑ</span> Exportar datos (PDF)</button>
            <button class="btn btn-secondary btn-full" id="btnExportarJson"><span>üíæ</span> Exportar respaldo (.json)</button>
            <button class="btn btn-secondary btn-full" id="btnImportarJson"><span>üç∞</span> Restaurar respaldo</button>
            <button class="btn btn-danger btn-full" id="btnBorrarTodo"><span>üßπ</span> Borrar todo</button>
          </div>

          <input type="file" id="inputRespaldoJSON" accept="application/json" style="display:none" />
        </div>
      </section>

      <!-- GUIAS -->
      <section id="section-guias" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìö</div><h2>Gu√≠as r√°pidas</h2></div>
        <p class="section-subtitle">Consejos b√°sicos para sacar m√°s provecho.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Antes de sembrar</div><div class="chip">Paso 1</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Preparar el suelo</div>
              <div class="media-item-body">Retira piedras, agrega materia org√°nica y afloja la tierra.</div>
            </div>
            <div>
              <div class="media-item-title">Elegir el lugar</div>
              <div class="media-item-body">La mayor√≠a necesita 4‚Äì6 h de sol directo.</div>
            </div>
          </div>
        </div>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Riego inteligente</div><div class="chip">Paso 2</div></div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Revisar humedad</div>
              <div class="media-item-body">Introduce un dedo 2‚Äì3 cm. Si est√° h√∫medo, espera.</div>
            </div>
            <div>
              <div class="media-item-title">Horario recomendado</div>
              <div class="media-item-body">En climas c√°lidos, mejor temprano o al atardecer.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer><span>Mi Siembra Inteligente ¬∑ Datos locales üåø</span></footer>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div class="msg" id="toastMsg">‚Äî</div>
    <div class="actions">
      <button class="btn btn-secondary" id="toastClose">Cerrar</button>
    </div>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>
    <button class="btn btn-secondary" id="btnInstalarPwa"><span>üì≤</span> Instalar</button>
  </div>

  <script>
    "use strict";

    /*********************
     * Helpers
     *********************/
    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function todayISO() { return new Date().toISOString().slice(0,10); }
    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    function formatDate(dateStr) {
      if (!dateStr) return "Sin fecha";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      const dia = String(d.getDate()).padStart(2,"0");
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }

    // Toast simple
    function showToast(msg) {
      const t = document.getElementById("toast");
      const m = document.getElementById("toastMsg");
      if (!t || !m) return;
      m.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._to);
      showToast._to = setTimeout(() => t.classList.remove("show"), 4500);
    }
    function bindToastClose() {
      const btn = document.getElementById("toastClose");
      const t = document.getElementById("toast");
      if (!btn || !t) return;
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", () => t.classList.remove("show"));
    }

    /*********************
     * Storage keys (compat v17/v18)
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario"
    };
    const STORAGE_CUSTOM_CULTIVOS = "msi-custom-cultivos-v18";
    const STORAGE_GEO = "msi-geo-v18";
    const STORAGE_WEATHER = "msi-weather-v18";

    const DEFAULT_SETTINGS = { nombreHuerto:"Mi huerto", clima:"tropical", hemisferio:"norte" };

    const CLIMA_LABEL = {
      tropical:"tropical",
      subtropical:"subtropical/templado",
      templado:"templado/fr√≠o"
    };
    const HEMISFERIO_LABEL = { norte:"hemisferio norte", sur:"hemisferio sur" };

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch { return fallback; }
    }
    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    function loadSettings() {
      const obj = loadJSON(STORAGE_KEYS.settings, null);
      return { ...DEFAULT_SETTINGS, ...(obj && typeof obj === "object" ? obj : {}) };
    }
    function saveSettings(s) { saveJSON(STORAGE_KEYS.settings, s); }

    function loadCultivos() {
      const arr = loadJSON(STORAGE_KEYS.cultivos, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCultivos(arr) { saveJSON(STORAGE_KEYS.cultivos, arr); }

    function loadDiario() {
      const arr = loadJSON(STORAGE_KEYS.diario, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveDiario(arr) { saveJSON(STORAGE_KEYS.diario, arr); }

    function loadCustomCultivos() {
      const arr = loadJSON(STORAGE_CUSTOM_CULTIVOS, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCustomCultivos(arr) { saveJSON(STORAGE_CUSTOM_CULTIVOS, arr); }

    function loadGeo() {
      const obj = loadJSON(STORAGE_GEO, null);
      if (!obj || typeof obj !== "object") return null;
      const { lat, lon, label } = obj;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { lat, lon, label: String(label || "") };
    }
    function saveGeo(geo) { saveJSON(STORAGE_GEO, geo); }

    /*********************
     * Calendario (base)
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        0: [{ titulo:"Cilantro", tipo:"Arom√°tica", detalle:"Ideal en meses frescos; siembra escalonada." }],
        5: [
          { titulo:"Re-siembra de lechugas", tipo:"Hoja", detalle:"Siembra escalonada cada 2‚Äì3 semanas." },
          { titulo:"R√°banos", tipo:"Ra√≠z", detalle:"Cosecha r√°pida (20‚Äì30 d√≠as)." }
        ],
        6: [
          { titulo:"Berenjena", tipo:"Fruto", detalle:"Le gustan noches c√°lidas; buen drenaje." },
          { titulo:"Aj√≠es y pimientos", tipo:"Fruto", detalle:"Sol y riego constante sin charcos." }
        ]
      },
      subtropical: { 5: [{ titulo:"Tomates", tipo:"Fruto", detalle:"Variedades adaptadas a tu zona." }] },
      templado: { 2: [{ titulo:"Lechugas", tipo:"Hoja", detalle:"Siembra temprana si hay riesgo de heladas." }] }
    };

    function ajustarMesPorHemisferio(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      if (settings.hemisferio === "sur" && (climaKey === "templado" || climaKey === "subtropical")) {
        return (monthIndex + 6) % 12;
      }
      return monthIndex;
    }
    function getCalendarData(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);
      const base = CALENDARIO_SIEMBRA[climaKey] || {};
      return base[mesAjustado] || [];
    }

    /*********************
     * Cat√°logo base
     *********************/
    const CATALOGO_CULTIVOS = [
      { id:"tomate", nombre:"Tomate", categoria:"Fruto", dias:"70‚Äì90 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, sin encharcar", tiesto:"Macetas profundas de 5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones","Mosca blanca","Orugas"], meses:[0,1,2,3,4,5,6,7], imagen:"img/tomate.jpg" },
      { id:"lechuga", nombre:"Lechuga", categoria:"Hoja", dias:"45‚Äì60 d√≠as", luz:"Sol suave o sombra parcial", riego:"Suelo ligeramente h√∫medo", tiesto:"Macetas anchas de 3+ galones", profundidad:"0.5 cm", plagas:["Babosas","Caracoles","Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/lechuga.jpg" },
      { id:"rabano", nombre:"R√°bano", categoria:"Ra√≠z", dias:"25‚Äì35 d√≠as", luz:"Sol o media sombra", riego:"H√∫medo constante", tiesto:"Macetas 3+ galones", profundidad:"1 cm", plagas:["Pulguillas","Babosas"], meses:[0,1,2,3,8,9,10,11], imagen:"img/rabano.jpg" },
      { id:"cilantro", nombre:"Cilantro", categoria:"Arom√°tica", dias:"30‚Äì50 d√≠as", luz:"Sol suave / sombra parcial", riego:"Suelo fresco", tiesto:"Macetas 3+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/cilantro.jpg" },
      { id:"platano", nombre:"Pl√°tano", categoria:"Fruto perenne", dias:"9‚Äì12 meses", luz:"Sol directo", riego:"Regular", tiesto:"Suelo directo", profundidad:"Cormo firme", plagas:["Picudo","Sigatoka"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/platano.jpg" },
      { id:"limon", nombre:"Lim√≥n", categoria:"Frutal c√≠trico", dias:"2‚Äì3 a√±os", luz:"Sol directo", riego:"Regular en sequ√≠a", tiesto:"Macet√≥n grande o suelo", profundidad:"Al nivel del cuello", plagas:["Minador","Cochinillas"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/limon.jpg" },
      { id:"mango", nombre:"Mango", categoria:"Frutal perenne", dias:"Varios a√±os", luz:"Sol fuerte", riego:"Poco (ya establecido)", tiesto:"Suelo directo", profundidad:"Al nivel del cuello", plagas:["Mosca fruta","Hongos"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/mango.jpg" }
    ];

    /*********************
     * Germinaci√≥n / reproducci√≥n
     *********************/
    const GERMINACION_POR_CULTIVO = {
      tomate: { titulo:"Tomate ‚Äì germinaci√≥n", metodo:"Semilla en alm√°cigo y trasplante.", pasos:["Sustrato suelto y drenado.","Sembrar 0.5‚Äì1 cm.","Humedad constante sin charcos.","Trasplantar con 3‚Äì4 hojas verdaderas."], tip:"Luz buena desde temprano para que no se espigue." },
      lechuga:{ titulo:"Lechuga ‚Äì germinaci√≥n", metodo:"Semilla directa o alm√°cigo.", pasos:["Sembrar superficial.","Humedad constante.","Trasplantar con 3‚Äì4 hojas.","Raleo si es directa."], tip:"Germina mejor con temperaturas moderadas." },
      platano:{ titulo:"Pl√°tano ‚Äì reproducci√≥n", metodo:"Hijuelos / cormos (no semilla).", pasos:["Elegir hijuelo sano.","Cortar y orear unas horas.","Plantar en suelo con drenaje.","Riego moderado."], tip:"Evita charcos." }
    };
    const GERMINACION_GENERIC = {
      hoja:{ titulo:"Hoja ‚Äì gu√≠a", metodo:"Semilla superficial.", pasos:["Sustrato suelto.","Sembrar casi en superficie.","Humedad fina constante.","Trasplantar con 3‚Äì4 hojas."], tip:"Sol suave / media sombra." },
      fruto:{ titulo:"Fruto ‚Äì gu√≠a", metodo:"Semilla en alm√°cigo o directa.", pasos:["1‚Äì2 cm seg√∫n semilla.","Humedad sin charcos.","Buena luz.","Trasplante cuando est√© fuerte."], tip:"Mucho sol y sustrato profundo." },
      raiz:{ titulo:"Ra√≠z ‚Äì gu√≠a", metodo:"Siempre semilla directa.", pasos:["Suelo profundo.","0.5‚Äì1 cm.","Humedad constante.","Raleo."], tip:"No trasplantar." },
      generico:{ titulo:"Gu√≠a general", metodo:"Semilla directa o bandeja.", pasos:["Lee sobre de semilla.","Sustrato limpio.","2‚Äì3x tama√±o de semilla.","Humedad constante."], tip:"Prueba en alm√°cigo y directo." }
    };
    function getInfoGerminacion(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      if (!cultivo) return null;
      if (GERMINACION_POR_CULTIVO[cultivoId]) return GERMINACION_POR_CULTIVO[cultivoId];
      const cat = (cultivo.categoria||"").toLowerCase();
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;
      if (cat.includes("fruto")) return GERMINACION_GENERIC.fruto;
      return GERMINACION_GENERIC.generico;
    }

    /*********************
     * Plagas base
     *********************/
    const PLAGAS_DATA = [
      { id:"pulgones", nombre:"Pulgones", comoSeVe:"Insectos peque√±os en brotes. Hojas deformadas.", manejoSuave:"Lavado con agua suave y revisi√≥n frecuente.", preparadosCaseros:"Jab√≥n pot√°sico bien diluido al atardecer.", productosComerciales:"Insecticidas de contacto autorizados." },
      { id:"mosca_blanca", nombre:"Mosca blanca", comoSeVe:"Volantitos blancos al mover hoja.", manejoSuave:"Retira hojas afectadas y mejora ventilaci√≥n.", preparadosCaseros:"Trampas amarillas + jab√≥n pot√°sico.", productosComerciales:"Productos espec√≠ficos dom√©sticos." },
      { id:"hongos_hoja", nombre:"Hongos (o√≠dio/manchas)", comoSeVe:"Manchas y/o polvillo blanco.", manejoSuave:"Ventilaci√≥n y evitar mojar hojas de noche.", preparadosCaseros:"Bicarbonato suave (dosis baja).", productosComerciales:"Fungicidas autorizados." }
    ];

    /*********************
     * Estado global
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";
    let diarioEnEdicionId = null;
    let customEditId = null;

    /*********************
     * Cultivos personalizados (Cat√°logo)
     *********************/
    function parsePlagas(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
    function allMonths(){ return [0,1,2,3,4,5,6,7,8,9,10,11]; }
    function getMesesSeleccionadosUI(){
      return Array.from(document.querySelectorAll("#nuevoCultivoMesesPills .pill.pill--active"))
        .map(b=>parseInt(b.dataset.mes,10)).filter(n=>Number.isFinite(n));
    }
    function setMesesSeleccionadosUI(meses){
      const set = new Set((meses||[]).map(Number));
      document.querySelectorAll("#nuevoCultivoMesesPills .pill").forEach(b=>{
        const m = parseInt(b.dataset.mes,10);
        b.classList.toggle("pill--active", set.has(m));
      });
    }
    function setupNuevoCultivoMesesPills(){
      const wrap = document.getElementById("nuevoCultivoMesesPills");
      if (!wrap) return;
      if (wrap.dataset.bound === "1") return;
      wrap.dataset.bound = "1";
      wrap.addEventListener("click",(ev)=>{
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        b.classList.toggle("pill--active");
      });
    }
    function removeCustomFromCatalogo(){
      for (let i = CATALOGO_CULTIVOS.length - 1; i >= 0; i--){
        if (CATALOGO_CULTIVOS[i]?.esPersonalizado) CATALOGO_CULTIVOS.splice(i,1);
      }
    }
    function injectCustomIntoCatalogo(customList){
      removeCustomFromCatalogo();
      customList.forEach(c => CATALOGO_CULTIVOS.push({ ...c, esPersonalizado:true }));
    }
    function buildCustomCultivoFromUI(existingId){
      const nombre = (document.getElementById("nuevoCultivoNombre")?.value||"").trim();
      const categoria = (document.getElementById("nuevoCultivoCategoria")?.value||"Otro").trim();
      const diasG = parseInt(document.getElementById("nuevoCultivoDiasGerminacion")?.value||"",10);
      const diasC = parseInt(document.getElementById("nuevoCultivoDiasCosecha")?.value||"",10);
      const luz = (document.getElementById("nuevoCultivoLuz")?.value||"").trim() || "‚Äî";
      const riego = (document.getElementById("nuevoCultivoRiego")?.value||"").trim() || "‚Äî";
      const tiesto = (document.getElementById("nuevoCultivoTiesto")?.value||"").trim() || "‚Äî";
      const profundidad = (document.getElementById("nuevoCultivoProfundidad")?.value||"").trim() || "‚Äî";
      const plagasStr = (document.getElementById("nuevoCultivoPlagas")?.value||"").trim();

      if (!nombre) { alert("Escribe el nombre del cultivo."); return null; }

      let meses = getMesesSeleccionadosUI();
      if (!meses.length) meses = allMonths();

      const id = existingId || `custom-${Date.now().toString(36)}`;
      const diasTexto = Number.isFinite(diasC) && diasC > 0 ? `${diasC} d√≠as` : "‚Äî";

      return {
        id, nombre, categoria,
        dias: diasTexto,
        luz, riego, tiesto, profundidad,
        plagas: parsePlagas(plagasStr),
        meses,
        imagen: "img/placeholder.jpg",
        esPersonalizado:true,
        diasGerminacion: Number.isFinite(diasG) && diasG > 0 ? diasG : null,
        diasCosecha: Number.isFinite(diasC) && diasC > 0 ? diasC : null
      };
    }
    function clearCustomCultivoUI(){
      ["nuevoCultivoNombre","nuevoCultivoDiasGerminacion","nuevoCultivoDiasCosecha","nuevoCultivoLuz","nuevoCultivoRiego","nuevoCultivoTiesto","nuevoCultivoProfundidad","nuevoCultivoPlagas"]
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
      const cat = document.getElementById("nuevoCultivoCategoria");
      if (cat) cat.value = "Otro";
      setMesesSeleccionadosUI([]);
    }
    function resetEditCustomCultivoUI(){
      customEditId = null;
      const t = document.getElementById("nuevoCultivoTitulo");
      if (t) t.textContent = "Nuevo cultivo";
      const btn = document.getElementById("btnGuardarNuevoCultivo");
      if (btn) btn.textContent = "Guardar cultivo";
    }
    function startEditCustomCultivo(cultivo){
      customEditId = cultivo.id;
      const card = document.getElementById("nuevoCultivoCard");
      if (card) card.style.display = "block";

      document.getElementById("nuevoCultivoTitulo").textContent = "Editar cultivo";
      document.getElementById("btnGuardarNuevoCultivo").textContent = "Actualizar cultivo";

      document.getElementById("nuevoCultivoNombre").value = cultivo.nombre || "";
      document.getElementById("nuevoCultivoCategoria").value = cultivo.categoria || "Otro";
      document.getElementById("nuevoCultivoDiasGerminacion").value = cultivo.diasGerminacion || "";
      document.getElementById("nuevoCultivoDiasCosecha").value = cultivo.diasCosecha || "";
      document.getElementById("nuevoCultivoLuz").value = cultivo.luz || "";
      document.getElementById("nuevoCultivoRiego").value = cultivo.riego || "";
      document.getElementById("nuevoCultivoTiesto").value = cultivo.tiesto || "";
      document.getElementById("nuevoCultivoProfundidad").value = cultivo.profundidad || "";
      document.getElementById("nuevoCultivoPlagas").value = Array.isArray(cultivo.plagas) ? cultivo.plagas.join(", ") : "";
      setMesesSeleccionadosUI(Array.isArray(cultivo.meses) ? cultivo.meses : []);
      setupNuevoCultivoMesesPills();

      card?.scrollIntoView({ behavior:"smooth", block:"start" });
      document.getElementById("nuevoCultivoNombre")?.focus();
    }
    function deleteCustomCultivoById(id){
      const customList = loadCustomCultivos().filter(c => c.id !== id);
      saveCustomCultivos(customList);
      injectCustomIntoCatalogo(customList);
      if (customEditId === id) {
        resetEditCustomCultivoUI();
        document.getElementById("nuevoCultivoCard").style.display = "none";
        clearCustomCultivoUI();
      }
    }
    function setupCultivoManualUI(){
      const btnToggle = document.getElementById("btnToggleNuevoCultivo");
      const card = document.getElementById("nuevoCultivoCard");
      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");
      const btnCancelar = document.getElementById("btnCancelarNuevoCultivo");
      if (!btnToggle || !card || !btnGuardar || !btnCancelar) return;

      setupNuevoCultivoMesesPills();
      if (btnToggle.dataset.bound === "1") return;
      btnToggle.dataset.bound = "1";

      btnToggle.addEventListener("click", () => {
        const visible = card.style.display !== "none";
        card.style.display = visible ? "none" : "block";
        if (!visible) document.getElementById("nuevoCultivoNombre")?.focus();
        else { clearCustomCultivoUI(); resetEditCustomCultivoUI(); }
      });

      btnCancelar.addEventListener("click", () => {
        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
      });

      btnGuardar.addEventListener("click", () => {
        const wasEditing = Boolean(customEditId);
        const cultivo = buildCustomCultivoFromUI(customEditId);
        if (!cultivo) return;

        let customList = loadCustomCultivos();
        if (customEditId) {
          customList = customList.filter(c => c.id !== customEditId);
        } else {
          const nameLower = (cultivo.nombre||"").toLowerCase();
          customList = customList.filter(c => (c.nombre||"").toLowerCase() !== nameLower);
        }

        customList.push(cultivo);
        saveCustomCultivos(customList);
        injectCustomIntoCatalogo(customList);

        renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());

        card.style.display = "none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
        alert(wasEditing ? "Cultivo actualizado ‚úÖ" : "Cultivo guardado ‚úÖ");
      });
    }
    function initCustomCultivos(){
      const customList = loadCustomCultivos();
      injectCustomIntoCatalogo(customList);
      setupCultivoManualUI();
    }

    /*********************
     * UI updates
     *********************/
    function updateHeader(){
      const subtitleEl = document.getElementById("appSubtitle");
      if (!subtitleEl) return;
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${escapeHTML(nombre)}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${escapeHTML(clima)}</span>
        <span class="app-subtitle-dot"></span>
        <span>${escapeHTML(hemis)}</span>
      `;
    }
    function updateSettingsContexts(){
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      document.querySelectorAll(".settings-context").forEach(el => {
        el.innerHTML = `
          <span class="chip"><span>üåø</span> Huerto: ${escapeHTML(nombre)}</span>
          <span class="chip"><span>‚òÅÔ∏è</span> Clima: ${escapeHTML(clima)}</span>
          <span class="chip"><span>üß≠</span> ${escapeHTML(hemis)}</span>
        `;
      });

      const climaText = `Clima ${clima}`;
      document.getElementById("estadoClimaChip")?.textContent = climaText;
      document.getElementById("calendarioClimaChip2")?.textContent = climaText;
    }

    function renderInicio(){
      const cultivosCount = stateCultivos.length;
      const hoyISO = todayISO();
      const entradasHoy = stateDiario.filter(e => e.fecha === hoyISO).length;

      document.getElementById("estadoCultivosCount")?.textContent = String(cultivosCount);
      document.getElementById("estadoEntradasCount")?.textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      if (!resumen) return;

      const nombre = stateSettings.nombreHuerto || "tu huerto";
      let texto = "";
      if (!cultivosCount && !entradasHoy) {
        texto = 'Todav√≠a no has registrado cultivos ni entradas. Empieza en "Mi huerto".';
      } else if (cultivosCount && !entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) en ${nombre}. A√∫n no escribes en el diario hoy.`;
      } else if (cultivosCount && entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) y hoy registraste ${entradasHoy} entrada(s). ¬°Buen ritmo!`;
      } else {
        texto = 'Tienes notas en el diario pero no has a√±adido cultivos. Usa "Mi huerto".';
      }
      resumen.textContent = texto;

      // Recordatorios
      const reminders = calcularRecordatorios();
      document.getElementById("recordatoriosChip")?.textContent = `${reminders.length} pendiente${reminders.length===1?"":"s"}`;
      const txt = document.getElementById("recordatoriosTxt");
      if (txt) {
        if (!reminders.length) txt.textContent = "Sin recordatorios por ahora.";
        else txt.textContent = reminders.slice(0,3).map(r => `‚Ä¢ ${r}`).join(" ");
      }
    }

    function renderCalendario(monthIndex){
      const listEl = document.getElementById("calendarList");
      const emptyEl = document.getElementById("calendarEmpty");
      if (!listEl || !emptyEl) return;

      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      const data = getCalendarData(stateSettings, monthIndex);

      // Mensaje hemisferio sur
      const MESES_ABR = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
      const mesAjustado = ajustarMesPorHemisferio(stateSettings, monthIndex);
      if (mesAjustado !== monthIndex) {
        const info = document.createElement("p");
        info.className = "muted";
        info.textContent = `Hemisferio sur: ${MESES_ABR[monthIndex]} se interpreta como ${MESES_ABR[mesAjustado]} (+6m).`;
        listEl.appendChild(info);
      }

      if (data.length) {
        data.forEach(item => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${escapeHTML(item.titulo)}</span>
              <span class="chip">${escapeHTML(item.tipo)}</span>
            </div>
            <div>${escapeHTML(item.detalle)}</div>
          `;
          listEl.appendChild(div);
        });
      }

      // Cat√°logo recomendado por mes
      const mesCatalogo = ajustarMesPorHemisferio(stateSettings, monthIndex);
      const sugeridos = CATALOGO_CULTIVOS.filter(c => Array.isArray(c.meses) && c.meses.includes(mesCatalogo));

      if (!data.length && !sugeridos.length) {
        emptyEl.style.display = "block";
        return;
      }

      if (sugeridos.length) {
        const separador = document.createElement("div");
        separador.className = "divider-soft";
        listEl.appendChild(separador);

        const tituloExtra = document.createElement("p");
        tituloExtra.className = "muted";
        tituloExtra.textContent = "Desde el cat√°logo: cultivos recomendados para este mes.";
        listEl.appendChild(tituloExtra);

        sugeridos.forEach(c => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${escapeHTML(c.nombre)}</span>
              <span class="chip">${escapeHTML(c.categoria)}</span>
            </div>
            <div>D√≠as a cosecha: ${escapeHTML(c.dias)}. Luz: ${escapeHTML(c.luz)}.</div>
            <div style="margin-top:6px;">
              <button class="btn btn-secondary btn-full" data-action="ver-catalogo" data-id="${escapeHTML(c.id)}">
                üîç Ver en cat√°logo
              </button>
            </div>
          `;
          listEl.appendChild(div);
        });
      }
    }

    function irACultivoEnCatalogo(cultivoId){
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      const textoBusqueda = cultivo ? cultivo.nombre : "";
      document.querySelector('.nav-btn[data-section="catalogo"]')?.click();
      const input = document.getElementById("catalogoBusqueda");
      if (input) input.value = textoBusqueda;
      renderCatalogo(textoBusqueda);
      document.getElementById("section-catalogo")?.scrollIntoView?.({ behavior:"smooth", block:"start" });
    }

    function renderCatalogo(filtroTexto=""){
      const listEl = document.getElementById("catalogoList");
      if (!listEl) return;

      const filtro = (filtroTexto||"").trim().toLowerCase();
      const lista = CATALOGO_CULTIVOS.filter(c => {
        if (!filtro) return true;
        return (c.nombre||"").toLowerCase().includes(filtro) || (c.id||"").toLowerCase().includes(filtro);
      });

      if (!lista.length) {
        listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${escapeHTML(filtroTexto)}".</p>`;
        return;
      }

      listEl.innerHTML = "";
      lista.forEach(c => {
        const imgSrc = c.imagen || "img/placeholder.jpg";
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const plagasTxt = Array.isArray(c.plagas) && c.plagas.length ? c.plagas.join(", ") : "‚Äî";

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <img src="${escapeHTML(imgSrc)}" alt="${escapeHTML(c.nombre)}" class="cultivo-thumb"
                   onerror="this.onerror=null;this.src='img/placeholder.jpg';" />
              <span>üå± ${escapeHTML(c.nombre)}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end;">
              <span class="chip">${escapeHTML(c.categoria)}</span>
              ${c.esPersonalizado ? `<span class="chip badge">Personalizado</span>` : ``}
            </div>
          </div>

          <div class="cultivo-body">
            <div><strong>D√≠as a cosecha:</strong> ${escapeHTML(c.dias)}</div>
            <div><strong>Luz:</strong> ${escapeHTML(c.luz)}</div>
            <div><strong>Riego:</strong> ${escapeHTML(c.riego)}</div>
            <div><strong>Tiesto / suelo:</strong> ${escapeHTML(c.tiesto)}</div>
            <div><strong>Profundidad de siembra:</strong> ${escapeHTML(c.profundidad)}</div>
            <div><strong>Plagas frecuentes:</strong> ${escapeHTML(plagasTxt)}</div>
          </div>

          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="germinacion">üîÅ Germinaci√≥n / reproducci√≥n</button>
            ${c.esPersonalizado ? `
              <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="editar-custom">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" data-id="${escapeHTML(c.id)}" data-action="borrar-custom">üóë Borrar</button>
            ` : ``}
          </div>
        `;

        const panel = document.createElement("div");
        panel.className = "germinacion-panel";
        card.appendChild(panel);
        listEl.appendChild(card);
      });
    }

    /*********************
     * Mi huerto (riego/cosecha sugerida)
     *********************/
    function getRiegoYCosechaParaNombre(nombre, fechaSiembraISO){
      let frecuenciaRiego = null;
      let fechaCosechaEstimada = null;
      if (!nombre) return { frecuenciaRiego, fechaCosechaEstimada };

      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(c =>
        (c.nombre||"").toLowerCase() === nombreLower || (c.id||"").toLowerCase() === nombreLower
      );

      if (cultivoCatalogo) {
        frecuenciaRiego = 3;
        if (fechaSiembraISO && cultivoCatalogo.dias) {
          const match = String(cultivoCatalogo.dias).match(/(\d+)/);
          if (match) {
            const dias = parseInt(match[1],10);
            if (Number.isFinite(dias) && dias > 0) fechaCosechaEstimada = addDays(fechaSiembraISO, dias);
          }
        }
      }
      return { frecuenciaRiego, fechaCosechaEstimada };
    }

    function nextDueDateISO(lastISO, freqDays){
      if (!lastISO || !Number.isFinite(freqDays) || freqDays <= 0) return null;
      return addDays(lastISO, freqDays);
    }
    function isoToTime(dateISO){
      if (!dateISO) return null;
      const d = new Date(dateISO + "T00:00:00");
      const t = d.getTime();
      return Number.isNaN(t) ? null : t;
    }

    function calcularRecordatorios(){
      const hoy = todayISO();
      const hoyT = isoToTime(hoy);
      const out = [];

      stateCultivos.forEach(c => {
        const fR = Number(c.frecuenciaRiegoDias);
        const fA = Number(c.frecuenciaAbonoDias);

        // Si nunca se reg√≥ pero existe frecuencia => usar fecha de siembra como base
        const baseR = c.ultimoRiego || c.fechaSiembra;
        const baseA = c.ultimaFertilizacion || c.fechaSiembra;

        const dueR = nextDueDateISO(baseR, Number.isFinite(fR) ? fR : NaN);
        const dueA = nextDueDateISO(baseA, Number.isFinite(fA) ? fA : NaN);

        if (dueR) {
          const t = isoToTime(dueR);
          if (t !== null && hoyT !== null && t <= hoyT) out.push(`Riego: ${c.nombre} (deb√≠a: ${formatDate(dueR)})`);
        }
        if (dueA) {
          const t = isoToTime(dueA);
          if (t !== null && hoyT !== null && t <= hoyT) out.push(`Abono: ${c.nombre} (deb√≠a: ${formatDate(dueA)})`);
        }
      });

      return out.slice(0, 8);
    }

    function renderCultivos(){
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      if (!listEl) return;

      const count = stateCultivos.length;
      if (chip) chip.textContent = `${count} cultivo${count===1?"":"s"}`;

      if (!count) {
        listEl.innerHTML = '<p class="muted">Todav√≠a no has registrado cultivos. Usa el formulario de arriba.</p>';
        return;
      }

      const tipoLabelMap = { hoja:"Hoja", fruto:"Fruto", raiz:"Ra√≠z", tuberculo:"Tub√©rculo", aromaticas:"Arom√°ticas", otro:"Otro" };

      listEl.innerHTML = "";
      stateCultivos.forEach(c => {
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";
        const ultimaAbonoTexto = c.ultimaFertilizacion ? formatDate(c.ultimaFertilizacion) : "Sin registro";
        const frecuenciaAbonoTexto = c.frecuenciaAbonoDias ? (c.frecuenciaAbonoDias + " d√≠as") : "No definida";
        const ultimoRiegoTexto = c.ultimoRiego ? formatDate(c.ultimoRiego) : "Sin registro";
        const frecuenciaRiegoTexto = c.frecuenciaRiegoDias ? (c.frecuenciaRiegoDias + " d√≠as") : "No definida";
        const fechaCosechaTexto = c.fechaCosechaEstimada ? formatDate(c.fechaCosechaEstimada) : "No definida";

        const dueR = nextDueDateISO(c.ultimoRiego || c.fechaSiembra, Number(c.frecuenciaRiegoDias));
        const dueA = nextDueDateISO(c.ultimaFertilizacion || c.fechaSiembra, Number(c.frecuenciaAbonoDias));

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title"><span>üåø</span><span>${escapeHTML(c.nombre)}</span></div>
            <span class="chip">${escapeHTML(tipoLabel)}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${escapeHTML(c.variedad || "‚Äî")}</div>
            <div><strong>Siembra:</strong> ${escapeHTML(formatDate(c.fechaSiembra))}</div>
            <div><strong>Notas:</strong> ${escapeHTML((c.notas || "‚Äî").slice(0, 140))}</div>
            <div><strong>Creado:</strong> ${escapeHTML(formatDate(c.creadoEl))}</div>

            <div><strong>√ölt. riego:</strong> ${escapeHTML(ultimoRiegoTexto)}</div>
            <div><strong>Freq riego:</strong> ${escapeHTML(frecuenciaRiegoTexto)}</div>
            <div><strong>Pr√≥x riego:</strong> ${escapeHTML(dueR ? formatDate(dueR) : "‚Äî")}</div>

            <div><strong>√ölt. abono:</strong> ${escapeHTML(ultimaAbonoTexto)}</div>
            <div><strong>Freq abono:</strong> ${escapeHTML(frecuenciaAbonoTexto)}</div>
            <div><strong>Pr√≥x abono:</strong> ${escapeHTML(dueA ? formatDate(dueA) : "‚Äî")}</div>

            <div><strong>Cosecha est.:</strong> ${escapeHTML(fechaCosechaTexto)}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="nota">‚úèÔ∏è Nota</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="riego">üí¶ Riego</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="abono">üíß Abono</button>
            <button class="btn btn-secondary" data-id="${escapeHTML(c.id)}" data-action="plaga">üêõ Plagas</button>
            <button class="btn btn-danger" data-id="${escapeHTML(c.id)}" data-action="borrar">üóë Eliminar</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }
    function renderDiario(){
      const listEl = document.getElementById("diarioList");
      const chip = document.getElementById("diarioCountChip");
      const resumenHoyEl = document.getElementById("diarioResumenHoy");
      if (!listEl) return;

      const arrOrdenada = [...stateDiario].sort((a,b)=> (b.fecha||"").localeCompare(a.fecha||""));
      const countTotal = arrOrdenada.length;
      if (chip) chip.textContent = `${countTotal} entrada${countTotal===1?"":"s"}`;

      if (resumenHoyEl) {
        const hoy = todayISO();
        const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);
        if (!hoyEntries.length) resumenHoyEl.textContent = "Hoy a√∫n no has registrado nada.";
        else {
          const tipos = {};
          hoyEntries.forEach(e => { const t = e.tipo || "General"; tipos[t] = (tipos[t]||0) + 1; });
          const parts = Object.entries(tipos).map(([k,v]) => `${v} ${k}`);
          resumenHoyEl.textContent = `Hoy: ${parts.join(", ")}.`;
        }
      }

      const arrFiltrada = arrOrdenada.filter(e => {
        if (diarioFiltroActual === "todos") return true;
        return (e.tipo || "General") === diarioFiltroActual;
      });

      if (!arrFiltrada.length) {
        listEl.innerHTML = `<p class="muted">No hay entradas para este filtro.</p>`;
        return;
      }

      listEl.innerHTML = "";
      arrFiltrada.forEach(e => {
        const item = document.createElement("div");
        item.className = "diario-item";
        item.innerHTML = `
          <div class="diario-item-header">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <span class="chip badge">${escapeHTML(e.tipo || "General")}</span>
              <span class="chip">${escapeHTML(formatDate(e.fecha))}</span>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
              <button class="btn btn-secondary" data-action="diario-editar" data-id="${escapeHTML(e.id)}">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" data-action="diario-borrar" data-id="${escapeHTML(e.id)}">üóë</button>
            </div>
          </div>
          <div>${escapeHTML(e.texto || "")}</div>
        `;
        listEl.appendChild(item);
      });
    }

    function setDiarioEditMode(entry){
      diarioEnEdicionId = entry ? entry.id : null;
      const title = document.getElementById("diarioFormTitle");
      if (title) title.textContent = entry ? "Editar entrada" : "Nueva entrada";

      if (entry) {
        const tipo = document.getElementById("diarioTipo");
        const fecha = document.getElementById("diarioFecha");
        const texto = document.getElementById("diarioTexto");
        if (tipo) tipo.value = entry.tipo || "General";
        if (fecha) fecha.value = entry.fecha || todayISO();
        if (texto) texto.value = entry.texto || "";
      } else {
        const fecha = document.getElementById("diarioFecha");
        if (fecha) fecha.value = todayISO();
        const texto = document.getElementById("diarioTexto");
        if (texto) texto.value = "";
        const tipo = document.getElementById("diarioTipo");
        if (tipo) tipo.value = "General";
      }
    }

    function addDiarioEntry(tipo, texto, fechaISO){
      const entry = {
        id: `d-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,
        tipo: tipo || "General",
        fecha: fechaISO || todayISO(),
        texto: (texto || "").trim()
      };
      stateDiario.push(entry);
      saveDiario(stateDiario);
      renderDiario();
      renderInicio();
      return entry;
    }

    /*********************
     * Plagas / Pesticidas render
     *********************/
    function renderPlagas(){
      const el = document.getElementById("plagasList");
      if (!el) return;

      el.innerHTML = "";
      PLAGAS_DATA.forEach(p => {
        const card = document.createElement("div");
        card.className = "plaga-card";
        card.innerHTML = `
          <div class="media-item-title">üêõ ${escapeHTML(p.nombre)}</div>
          <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.comoSeVe)}</div>
          <div class="media-item-body"><strong>Manejo suave:</strong> ${escapeHTML(p.manejoSuave)}</div>
          <div class="media-item-body"><strong>Casero:</strong> ${escapeHTML(p.preparadosCaseros)}</div>
          <div class="media-item-body"><strong>Comercial:</strong> ${escapeHTML(p.productosComerciales)}</div>
        `;
        el.appendChild(card);
      });
    }

    const PESTICIDAS_DATA = [
      { titulo:"Jab√≥n pot√°sico (suave)", uso:"Pulgones / mosca blanca (contacto).", nota:"Aplicar al atardecer y probar en una hoja primero." },
      { titulo:"Aceite de neem (seg√∫n etiqueta)", uso:"Preventivo y control ligero.", nota:"Evitar sol fuerte tras aplicar." },
      { titulo:"Trampas amarillas", uso:"Mosca blanca / insectos voladores.", nota:"√ötil para monitorear y reducir presi√≥n." },
      { titulo:"Bacillus thuringiensis (BT)", uso:"Orugas (biol√≥gico).", nota:"Solo cuando veas da√±o por oruga." }
    ];

    function renderPesticidas(){
      const el = document.getElementById("pesticidasList");
      if (!el) return;

      el.innerHTML = "";
      PESTICIDAS_DATA.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `
          <div class="media-item-title">üíß ${escapeHTML(p.titulo)}</div>
          <div class="media-item-body"><strong>Uso:</strong> ${escapeHTML(p.uso)}</div>
          <div class="media-item-body"><strong>Nota:</strong> ${escapeHTML(p.nota)}</div>
        `;
        el.appendChild(div);
      });
    }

    /*********************
     * Open-Meteo (sin API key)
     *********************/
    async function fetchWeatherOpenMeteo(lat, lon){
      const url =
        `https://api.open-meteo.com/v1/forecast` +
        `?latitude=${encodeURIComponent(lat)}` +
        `&longitude=${encodeURIComponent(lon)}` +
        `&current=temperature_2m,precipitation,wind_speed_10m` +
        `&timezone=auto`;
      const r = await fetch(url, { cache:"no-store" });
      if (!r.ok) throw new Error("No se pudo obtener clima");
      return await r.json();
    }

    function setWeatherUI(obj){
      const chipHome = document.getElementById("climaAhoraChip");
      const chipStatus = document.getElementById("climaStatusChip");
      if (!chipHome && !chipStatus) return;

      if (!obj || !obj.current) {
        if (chipHome) chipHome.textContent = "Clima: ‚Äî";
        if (chipStatus) chipStatus.textContent = "‚Äî";
        return;
      }

      const t = obj.current.temperature_2m;
      const p = obj.current.precipitation;
      const w = obj.current.wind_speed_10m;

      const text = `Temp ${Math.round(t)}¬∞ ¬∑ Lluvia ${p}mm ¬∑ Viento ${Math.round(w)}km/h`;
      if (chipHome) chipHome.textContent = `Clima: ${text}`;
      if (chipStatus) chipStatus.textContent = "OK";
    }

    async function updateWeather(){
      const geo = loadGeo();
      if (!geo) {
        setWeatherUI(null);
        showToast("Primero usa üìç Ubicaci√≥n.");
        return;
      }
      try {
        const data = await fetchWeatherOpenMeteo(geo.lat, geo.lon);
        saveJSON(STORAGE_WEATHER, { at: Date.now(), data });
        setWeatherUI(data);
      } catch {
        showToast("No pude actualizar el clima ahora.");
      }
    }

    function loadWeatherFromCache(){
      const cached = loadJSON(STORAGE_WEATHER, null);
      if (cached && cached.data) setWeatherUI(cached.data);
      else setWeatherUI(null);
    }

    function askGeolocation(){
      if (!navigator.geolocation) {
        showToast("Tu dispositivo no soporta ubicaci√≥n.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const geo = {
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            label: "Ubicaci√≥n guardada"
          };
          saveGeo(geo);
          showToast("Ubicaci√≥n guardada ‚úÖ");
          updateWeather();
        },
        () => showToast("No se pudo obtener ubicaci√≥n (permiso denegado)."),
        { enableHighAccuracy:false, timeout:12000, maximumAge: 60_000 }
      );
    }

    /*********************
     * PDF (jsPDF)
     *********************/
    function exportDiarioPDF(){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { showToast("jsPDF no carg√≥."); return; }

      const doc = new jsPDF({ unit:"pt", format:"letter" });
      const margin = 42;
      let y = margin;

      doc.setFontSize(16);
      doc.text("Mi Siembra Inteligente ‚Äî Diario", margin, y); y += 18;

      doc.setFontSize(10);
      doc.text(`Huerto: ${stateSettings.nombreHuerto || "Mi huerto"} ¬∑ Exportado: ${formatDate(todayISO())}`, margin, y);
      y += 18;

      const entries = [...stateDiario].sort((a,b)=> (b.fecha||"").localeCompare(a.fecha||""));
      if (!entries.length) {
        doc.text("No hay entradas.", margin, y);
        doc.save("msi-diario.pdf");
        return;
      }

      doc.setFontSize(11);
      entries.forEach(e => {
        const header = `${formatDate(e.fecha)} ‚Äî ${e.tipo || "General"}`;
        const body = (e.texto || "").trim();

        if (y > 740) { doc.addPage(); y = margin; }
        doc.setFont(undefined, "bold");
        doc.text(header, margin, y); y += 14;
        doc.setFont(undefined, "normal");

        const lines = doc.splitTextToSize(body || "‚Äî", 520);
        lines.forEach(line => {
          if (y > 740) { doc.addPage(); y = margin; }
          doc.text(line, margin, y);
          y += 12;
        });

        y += 10;
      });

      doc.save("msi-diario.pdf");
    }

    function exportDatosPDF(){
      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { showToast("jsPDF no carg√≥."); return; }

      const doc = new jsPDF({ unit:"pt", format:"letter" });
      const margin = 42;
      let y = margin;

      doc.setFontSize(16);
      doc.text("Mi Siembra Inteligente ‚Äî Resumen", margin, y); y += 18;

      doc.setFontSize(11);
      doc.text(`Huerto: ${stateSettings.nombreHuerto || "Mi huerto"}`, margin, y); y += 14;
      doc.text(`Clima: ${CLIMA_LABEL[stateSettings.clima] || "tropical"}`, margin, y); y += 14;
      doc.text(`Hemisferio: ${HEMISFERIO_LABEL[stateSettings.hemisferio] || "hemisferio norte"}`, margin, y); y += 18;

      doc.text(`Cultivos: ${stateCultivos.length}`, margin, y); y += 14;
      doc.text(`Entradas diario: ${stateDiario.length}`, margin, y); y += 18;

      doc.setFontSize(12);
      doc.text("Cultivos", margin, y); y += 14;

      doc.setFontSize(10);
      if (!stateCultivos.length) {
        doc.text("‚Äî", margin, y); y += 12;
      } else {
        stateCultivos.slice(0, 60).forEach(c => {
          const line = `‚Ä¢ ${c.nombre} (${formatDate(c.fechaSiembra)})`;
          if (y > 740) { doc.addPage(); y = margin; }
          doc.text(line, margin, y); y += 12;
        });
      }

      doc.save("msi-datos.pdf");
    }

    /*********************
     * Export/Import JSON
     *********************/
    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function exportRespaldoJSON(){
      const payload = {
        version: "v18",
        exportedAt: new Date().toISOString(),
        settings: stateSettings,
        cultivos: stateCultivos,
        diario: stateDiario,
        customCultivos: loadCustomCultivos(),
        geo: loadGeo(),
        weather: loadJSON(STORAGE_WEATHER, null)
      };
      downloadJSON("msi-respaldo-v18.json", payload);
    }

    function importRespaldoJSON(file){
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(String(reader.result || ""));
          if (!data || typeof data !== "object") throw new Error("Formato inv√°lido");

          if (data.settings) saveSettings({ ...DEFAULT_SETTINGS, ...(data.settings||{}) });
          if (Array.isArray(data.cultivos)) saveCultivos(data.cultivos);
          if (Array.isArray(data.diario)) saveDiario(data.diario);
          if (Array.isArray(data.customCultivos)) saveCustomCultivos(data.customCultivos);
          if (data.geo) saveGeo(data.geo);
          if (data.weather) saveJSON(STORAGE_WEATHER, data.weather);

          // recargar estado
          stateSettings = loadSettings();
          stateCultivos = loadCultivos();
          stateDiario = loadDiario();
          initCustomCultivos();
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          renderCultivos();
          renderDiario();
          renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
          loadWeatherFromCache();

          showToast("Respaldo restaurado ‚úÖ");
        } catch {
          alert("No pude importar ese archivo. Verifica que sea un respaldo v√°lido.");
        }
      };
      reader.readAsText(file);
    }

    /*********************
     * Navegaci√≥n UI
     *********************/
    function showSection(sectionKey){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("section--active"));
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("nav-btn--active"));

      const sec = document.getElementById(`section-${sectionKey}`);
      if (sec) sec.classList.add("section--active");

      const btn = document.querySelector(`.nav-btn[data-section="${sectionKey}"]`);
      if (btn) btn.classList.add("nav-btn--active");
    }

    function setupNav(){
      const nav = document.querySelector(".nav");
      if (!nav) return;
      if (nav.dataset.bound === "1") return;
      nav.dataset.bound = "1";

      nav.addEventListener("click", (ev) => {
        const b = ev.target.closest("button.nav-btn[data-section]");
        if (!b) return;
        const key = b.dataset.section;
        showSection(key);

        // renders r√°pidos por secci√≥n
        if (key === "inicio") renderInicio();
        if (key === "huerto") renderCultivos();
        if (key === "diario") renderDiario();
        if (key === "catalogo") renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
      });
    }

    /*********************
     * Eventos de UI
     *********************/
    function setupCalendario(){
      const wrap = document.getElementById("mesesPills");
      if (!wrap) return;
      if (wrap.dataset.bound === "1") return;
      wrap.dataset.bound = "1";

      const now = new Date();
      let activeMonth = now.getMonth();

      const setActive = (m) => {
        wrap.querySelectorAll(".pill").forEach(p => p.classList.toggle("pill--active", Number(p.dataset.mes)===m));
      };

      setActive(activeMonth);
      renderCalendario(activeMonth);

      wrap.addEventListener("click", (ev) => {
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        activeMonth = parseInt(b.dataset.mes,10);
        setActive(activeMonth);
        renderCalendario(activeMonth);
      });

      // clicks "ver en cat√°logo"
      const listEl = document.getElementById("calendarList");
      if (listEl && listEl.dataset.bound !== "1") {
        listEl.dataset.bound = "1";
        listEl.addEventListener("click",(ev)=>{
          const btn = ev.target.closest("button[data-action='ver-catalogo'][data-id]");
          if (!btn) return;
          irACultivoEnCatalogo(btn.dataset.id);
        });
      }
    }

    function setupCatalogo(){
      const input = document.getElementById("catalogoBusqueda");
      const list = document.getElementById("catalogoList");
      if (input && input.dataset.bound !== "1") {
        input.dataset.bound = "1";
        input.addEventListener("input", () => {
          renderCatalogo(input.value);
        });
      }
      if (list && list.dataset.bound !== "1") {
        list.dataset.bound = "1";
        list.addEventListener("click",(ev)=>{
          const btn = ev.target.closest("button[data-action][data-id]");
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          if (action === "germinacion") {
            const card = btn.closest(".cultivo-card");
            const panel = card?.querySelector(".germinacion-panel");
            if (!panel) return;

            const info = getInfoGerminacion(id);
            if (!info) return;

            const cultivo = CATALOGO_CULTIVOS.find(c=>c.id===id);
            const extra = (cultivo && cultivo.esPersonalizado && cultivo.diasGerminacion)
              ? `<div style="margin-top:6px"><strong>D√≠as germinaci√≥n:</strong> ${escapeHTML(String(cultivo.diasGerminacion))}</div>`
              : "";

            panel.innerHTML = `
              <div><strong>${escapeHTML(info.titulo)}</strong></div>
              <div style="margin-top:4px"><strong>M√©todo:</strong> ${escapeHTML(info.metodo)}</div>
              <div style="margin-top:6px"><strong>Pasos:</strong></div>
              <div style="margin-top:4px">${info.pasos.map(p=>`‚Ä¢ ${escapeHTML(p)}`).join("<br>")}</div>
              <div style="margin-top:6px"><strong>Tip:</strong> ${escapeHTML(info.tip)}</div>
              ${extra}
            `;
            const open = panel.style.display === "block";
            panel.style.display = open ? "none" : "block";
            if (!open) panel.scrollIntoView({ behavior:"smooth", block:"nearest" });
            return;
          }

          if (action === "editar-custom") {
            const custom = loadCustomCultivos().find(c=>c.id===id);
            if (custom) startEditCustomCultivo(custom);
            return;
          }
          if (action === "borrar-custom") {
            if (confirm("¬øBorrar este cultivo personalizado?")) {
              deleteCustomCultivoById(id);
              renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
              showToast("Cultivo borrado ‚úÖ");
            }
            return;
          }
        });
      }
    }

    function setupMiHuerto(){
      const btn = document.getElementById("btnAgregarCultivo");
      const list = document.getElementById("cultivosList");
      if (btn && btn.dataset.bound !== "1") {
        btn.dataset.bound = "1";
        btn.addEventListener("click", () => {
          const nombre = (document.getElementById("cultivoNombre")?.value || "").trim();
          if (!nombre) { alert("Escribe el nombre del cultivo."); return; }

          const variedad = (document.getElementById("cultivoVariedad")?.value || "").trim();
          const tipo = document.getElementById("cultivoTipo")?.value || "otro";
          const fechaSiembra = document.getElementById("cultivoFecha")?.value || todayISO();
          const freqR = Number(document.getElementById("cultivoFrecuenciaRiego")?.value || "");
          const freqA = Number(document.getElementById("cultivoFrecuenciaAbono")?.value || "");
          const notas = (document.getElementById("cultivoNotas")?.value || "").trim();

          const { frecuenciaRiego, fechaCosechaEstimada } = getRiegoYCosechaParaNombre(nombre, fechaSiembra);

          const cultivo = {
            id: `c-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,8)}`,
            nombre,
            variedad,
            tipo,
            fechaSiembra,
            creadoEl: todayISO(),
            notas,
            frecuenciaRiegoDias: Number.isFinite(freqR) && freqR > 0 ? freqR : (frecuenciaRiego || ""),
            frecuenciaAbonoDias: Number.isFinite(freqA) && freqA > 0 ? freqA : "",
            ultimoRiego: "",
            ultimaFertilizacion: "",
            fechaCosechaEstimada: fechaCosechaEstimada || ""
          };

          stateCultivos.push(cultivo);
          saveCultivos(stateCultivos);

          // limpiar
          document.getElementById("cultivoNombre").value = "";
          document.getElementById("cultivoVariedad").value = "";
          document.getElementById("cultivoFrecuenciaRiego").value = "";
          document.getElementById("cultivoFrecuenciaAbono").value = "";
          document.getElementById("cultivoNotas").value = "";
          document.getElementById("cultivoFecha").value = todayISO();

          renderCultivos();
          renderInicio();
          showToast("Cultivo guardado ‚úÖ");
        });
      }

      if (list && list.dataset.bound !== "1") {
        list.dataset.bound = "1";
        list.addEventListener("click",(ev)=>{
          const b = ev.target.closest("button[data-action][data-id]");
          if (!b) return;
          const id = b.dataset.id;
          const action = b.dataset.action;

          const idx = stateCultivos.findIndex(c=>c.id===id);
          if (idx < 0) return;
          const c = stateCultivos[idx];

          if (action === "nota") {
            const txt = prompt("Escribe una nota para este cultivo:", c.notas || "");
            if (txt === null) return;
            c.notas = txt.trim();
            saveCultivos(stateCultivos);
            renderCultivos();
            showToast("Nota guardada ‚úÖ");
            return;
          }

          if (action === "riego") {
            c.ultimoRiego = todayISO();
            saveCultivos(stateCultivos);
            addDiarioEntry("Riego", `Riego a: ${c.nombre}`, todayISO());
            renderCultivos();
            showToast("Riego registrado ‚úÖ");
            return;
          }

          if (action === "abono") {
            c.ultimaFertilizacion = todayISO();
            saveCultivos(stateCultivos);
            addDiarioEntry("Abono", `Abono a: ${c.nombre}`, todayISO());
            renderCultivos();
            showToast("Abono registrado ‚úÖ");
            return;
          }

          if (action === "plaga") {
            const txt = prompt("¬øQu√© plaga o problema viste? (se guardar√° en el diario)", "");
            if (txt === null) return;
            if (txt.trim()) addDiarioEntry("Plagas", `${c.nombre}: ${txt.trim()}`, todayISO());
            showToast("Registrado ‚úÖ");
            return;
          }

          if (action === "borrar") {
            if (!confirm(`¬øEliminar "${c.nombre}"?`)) return;
            stateCultivos.splice(idx,1);
            saveCultivos(stateCultivos);
            renderCultivos();
            renderInicio();
            showToast("Cultivo eliminado ‚úÖ");
            return;
          }
        });
      }
    }

    function setupDiario(){
      const btn = document.getElementById("btnGuardarDiario");
      const filtros = document.getElementById("diarioFiltros");
      const list = document.getElementById("diarioList");
      if (btn && btn.dataset.bound !== "1") {
        btn.dataset.bound = "1";
        btn.addEventListener("click", () => {
          const tipo = document.getElementById("diarioTipo")?.value || "General";
          const fecha = document.getElementById("diarioFecha")?.value || todayISO();
          const texto = (document.getElementById("diarioTexto")?.value || "").trim();
          if (!texto) { alert("Escribe algo para guardar."); return; }

          if (diarioEnEdicionId) {
            const i = stateDiario.findIndex(e=>e.id===diarioEnEdicionId);
            if (i >= 0) {
              stateDiario[i].tipo = tipo;
              stateDiario[i].fecha = fecha;
              stateDiario[i].texto = texto;
              saveDiario(stateDiario);
              setDiarioEditMode(null);
              renderDiario();
              renderInicio();
              showToast("Entrada actualizada ‚úÖ");
              return;
            }
          }

          addDiarioEntry(tipo, texto, fecha);
          setDiarioEditMode(null);
          showToast("Guardado ‚úÖ");
        });
      }

      if (filtros && filtros.dataset.bound !== "1") {
        filtros.dataset.bound = "1";
        filtros.addEventListener("click",(ev)=>{
          const b = ev.target.closest("button.pill[data-filtro]");
          if (!b) return;
          diarioFiltroActual = b.dataset.filtro || "todos";
          filtros.querySelectorAll(".pill").forEach(p=>p.classList.toggle("pill--active", p===b));
          renderDiario();
        });
      }

      if (list && list.dataset.bound !== "1") {
        list.dataset.bound = "1";
        list.addEventListener("click",(ev)=>{
          const btn = ev.target.closest("button[data-action][data-id]");
          if (!btn) return;
          const id = btn.dataset.id;
          const action = btn.dataset.action;

          if (action === "diario-borrar") {
            if (!confirm("¬øBorrar esta entrada?")) return;
            stateDiario = stateDiario.filter(e=>e.id!==id);
            saveDiario(stateDiario);
            renderDiario();
            renderInicio();
            showToast("Entrada borrada ‚úÖ");
            return;
          }
          if (action === "diario-editar") {
            const entry = stateDiario.find(e=>e.id===id);
            if (entry) {
              setDiarioEditMode(entry);
              document.getElementById("diarioTexto")?.focus();
              document.getElementById("diarioFormCard")?.scrollIntoView({ behavior:"smooth", block:"start" });
            }
            return;
          }
        });
      }

      const btnPdf = document.getElementById("btnExportarDiarioPdf");
      if (btnPdf && btnPdf.dataset.bound !== "1") {
        btnPdf.dataset.bound = "1";
        btnPdf.addEventListener("click", exportDiarioPDF);
      }
    }

    function setupOpciones(){
      const nombre = document.getElementById("nombreHuerto");
      const clima = document.getElementById("climaSelect");
      const hemis = document.getElementById("hemisferioSelect");
      const btnGuardar = document.getElementById("btnGuardarConfig");
      const btnGeo = document.getElementById("btnPedirUbicacion");
      const btnClima = document.getElementById("btnActualizarClima");
      const btnPdf = document.getElementById("btnExportarDatosPdf");
      const btnJson = document.getElementById("btnExportarJson");
      const btnImp = document.getElementById("btnImportarJson");
      const input = document.getElementById("inputRespaldoJSON");
      const btnBorrar = document.getElementById("btnBorrarTodo");

      if (nombre) nombre.value = stateSettings.nombreHuerto || "";
      if (clima) clima.value = stateSettings.clima || "tropical";
      if (hemis) hemis.value = stateSettings.hemisferio || "norte";

      if (btnGuardar && btnGuardar.dataset.bound !== "1") {
        btnGuardar.dataset.bound = "1";
        btnGuardar.addEventListener("click", () => {
          stateSettings = {
            nombreHuerto: (nombre?.value || DEFAULT_SETTINGS.nombreHuerto).trim() || DEFAULT_SETTINGS.nombreHuerto,
            clima: clima?.value || DEFAULT_SETTINGS.clima,
            hemisferio: hemis?.value || DEFAULT_SETTINGS.hemisferio
          };
          saveSettings(stateSettings);
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          showToast("Configuraci√≥n guardada ‚úÖ");
        });
      }

      if (btnGeo && btnGeo.dataset.bound !== "1") {
        btnGeo.dataset.bound = "1";
        btnGeo.addEventListener("click", askGeolocation);
      }
      if (btnClima && btnClima.dataset.bound !== "1") {
        btnClima.dataset.bound = "1";
        btnClima.addEventListener("click", updateWeather);
      }

      if (btnPdf && btnPdf.dataset.bound !== "1") {
        btnPdf.dataset.bound = "1";
        btnPdf.addEventListener("click", exportDatosPDF);
      }
      if (btnJson && btnJson.dataset.bound !== "1") {
        btnJson.dataset.bound = "1";
        btnJson.addEventListener("click", exportRespaldoJSON);
      }
      if (btnImp && btnImp.dataset.bound !== "1") {
        btnImp.dataset.bound = "1";
        btnImp.addEventListener("click", () => input?.click());
      }
      if (input && input.dataset.bound !== "1") {
        input.dataset.bound = "1";
        input.addEventListener("change", () => {
          const f = input.files?.[0];
          if (f) importRespaldoJSON(f);
          input.value = "";
        });
      }

      if (btnBorrar && btnBorrar.dataset.bound !== "1") {
        btnBorrar.dataset.bound = "1";
        btnBorrar.addEventListener("click", () => {
          if (!confirm("Esto borra TODO en este dispositivo. ¬øSeguro?")) return;

          [
            STORAGE_KEYS.settings,
            STORAGE_KEYS.cultivos,
            STORAGE_KEYS.diario,
            STORAGE_CUSTOM_CULTIVOS,
            STORAGE_GEO,
            STORAGE_WEATHER
          ].forEach(k => localStorage.removeItem(k));

          stateSettings = loadSettings();
          stateCultivos = loadCultivos();
          stateDiario = loadDiario();
          diarioFiltroActual = "todos";
          setDiarioEditMode(null);

          initCustomCultivos();
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          renderCultivos();
          renderDiario();
          renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
          loadWeatherFromCache();

          showToast("Todo borrado ‚úÖ");
        });
      }
    }

    /*********************
     * PWA install banner
     *********************/
    let deferredPrompt = null;
    function setupPwaInstall(){
      const banner = document.getElementById("installBanner");
      const btn = document.getElementById("btnInstalarPwa");
      if (!banner || !btn) return;

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        banner.classList.remove("hidden");
      });

      if (btn.dataset.bound !== "1") {
        btn.dataset.bound = "1";
        btn.addEventListener("click", async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          try { await deferredPrompt.userChoice; } catch {}
          deferredPrompt = null;
          banner.classList.add("hidden");
        });
      }

      window.addEventListener("appinstalled", () => {
        banner.classList.add("hidden");
        deferredPrompt = null;
        showToast("Instalada ‚úÖ");
      });

      // Service worker (si existe)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
      }
    }

    /*********************
     * INIT
     *********************/
    function initDefaults(){
      document.getElementById("cultivoFecha")?.setAttribute("value", todayISO());
      const f1 = document.getElementById("cultivoFecha");
      if (f1 && !f1.value) f1.value = todayISO();

      const f2 = document.getElementById("diarioFecha");
      if (f2 && !f2.value) f2.value = todayISO();
    }

    document.addEventListener("DOMContentLoaded", () => {
      bindToastClose();

      // Estado
      stateSettings = loadSettings();
      stateCultivos = loadCultivos();
      stateDiario = loadDiario();

      // Header + context
      updateHeader();
      updateSettingsContexts();

      // Init custom cultivos
      initCustomCultivos();

      // Setup
      setupNav();
      setupCalendario();
      setupCatalogo();
      setupMiHuerto();
      setupDiario();
      setupOpciones();
      setupPwaInstall();
      initDefaults();

      // Renders iniciales
      renderInicio();
      renderCultivos();
      renderDiario();
      renderCatalogo("");
      renderPlagas();
      renderPesticidas();

      loadWeatherFromCache();
      // Si ya tienes geo guardado, refresca clima al abrir (suave)
      if (loadGeo()) updateWeather().catch(()=>{});
    });
  </script>
</body>
</html>
