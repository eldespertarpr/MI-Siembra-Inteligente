<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v18)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />

  <!-- jsPDF -->
  <script>
    src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js">
    
  <style>
    :root{
      color-scheme: dark;
      --bg:#020617;
      --bg-elevated:#02081f;
      --card:#02081f;
      --card-soft:#030919;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,0.15);
      --accent-strong:rgba(34,197,94,0.45);
      --text-main:#f9fafb;
      --text-soft:#9ca3af;
      --border-subtle:rgba(148,163,184,0.3);
      --danger:#ef4444;
      --shadow-soft:0 18px 45px rgba(15,23,42,0.7);
      --radius-xl:22px;
      --radius-lg:18px;
      --radius-full:999px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Roboto","Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#022c22 0,#020617 55%);
      color:var(--text-main);
      min-height:100vh;
      display:flex;flex-direction:column;
    }
    .app-shell{max-width:960px;margin:0 auto;padding:16px 12px 28px}
    @media(min-width:768px){.app-shell{padding:20px 16px 40px}}
    .app-header{
      background:radial-gradient(circle at 0 0,#4ade80 0,#16a34a 28%,#052e16 85%);
      border-radius:28px;
      padding:18px 18px 16px;
      display:flex;align-items:center;gap:14px;
      box-shadow:var(--shadow-soft);
      position:relative;overflow:hidden;
      margin-bottom:14px;
    }
    .app-header::after{
      content:"";position:absolute;inset:0;
      background:radial-gradient(circle at 120% -10%,rgba(34,197,94,0.35) 0,transparent 55%);
      opacity:.9;pointer-events:none;
    }
    .app-header-icon{
      position:relative;z-index:1;
      width:52px;height:52px;border-radius:18px;
      background:radial-gradient(circle at 30% 10%,#bbf7d0 0,#16a34a 35%,#052e16 90%);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 14px 35px rgba(0,0,0,.45);
      flex-shrink:0;
    }
    .app-header-icon span{font-size:42px}
    .app-header-text{position:relative;z-index:1;display:flex;flex-direction:column;gap:4px}
    .app-title-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .app-title{font-size:1.35rem;font-weight:700;letter-spacing:.02em}
    .app-tag{
      font-size:.72rem;padding:2px 8px;border-radius:999px;
      background:rgba(15,23,42,.45);border:1px solid rgba(15,23,42,.8);
      text-transform:uppercase;letter-spacing:.12em;color:#e5e7eb
    }
    .app-subtitle{
      font-size:.80rem;color:#e5e7eb;opacity:.95;
      display:flex;flex-wrap:wrap;gap:6px;align-items:center
    }
    .app-subtitle span{display:inline-flex;align-items:center;gap:4px}
    .app-subtitle-dot{width:3px;height:3px;border-radius:50%;background:rgba(226,232,240,.7)}

    .nav{
      margin-top:8px;
      background:linear-gradient(135deg,var(--bg-elevated),#020617);
      border-radius:26px;padding:10px;
      box-shadow:0 18px 40px rgba(15,23,42,.85);
      display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
      position:sticky;top:0;z-index:40;
      backdrop-filter:blur(16px);
      border:1px solid rgba(15,23,42,.85);
    }
    @media(min-width:660px){.nav{grid-template-columns:repeat(8,minmax(0,1fr))}}
    .nav-btn{
      border:none;border-radius:999px;
      padding:7px 6px 6px;
      font-size:.70rem;color:var(--text-soft);
      background:transparent;
      display:flex;flex-direction:column;align-items:center;gap:3px;
      cursor:pointer;transition:background .18s,color .18s,transform .12s;
      position:relative;min-height:52px;
    }
    .nav-btn span.nav-icon{font-size:1.40rem}
    .nav-btn.nav-btn--active{
      background:radial-gradient(circle at top,var(--accent) 0,var(--accent-soft) 45%,transparent 100%);
      color:#ecfdf5;
      box-shadow:0 0 0 1px rgba(34,197,94,.4),0 14px 30px rgba(22,163,74,.55);
      transform:translateY(-1px);
    }
    .nav-btn.nav-btn--active::after{
      content:"";position:absolute;inset:auto auto -3px 50%;
      width:32%;max-width:42px;height:3px;border-radius:999px;
      background:linear-gradient(90deg,rgba(34,197,94,.1),rgba(34,197,94,.6),rgba(34,197,94,.1));
      transform:translateX(-50%);
    }

    main{margin-top:14px}
    .section{display:none;animation:fadeIn .18s ease-out}
    .section--active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    .section > .section-title-row{display:flex;align-items:center;gap:10px;margin:14px 2px 8px}
    .section-icon-pill{
      width:26px;height:26px;border-radius:13px;
      background:radial-gradient(circle at 30% 15%,#fefce8 0,#fef9c3 25%,#0f172a 90%);
      display:flex;align-items:center;justify-content:center;font-size:1.3rem
    }
    .section-title-row h2{font-size:1.05rem;margin:0}
    .section-subtitle{font-size:.82rem;color:var(--text-soft);margin:2px 2px 10px}

    .app-card{
      background:radial-gradient(circle at top left,#020617 0,#020617 40%,#02081f 100%);
      border-radius:var(--radius-xl);
      padding:14px 16px 14px;
      border:1px solid var(--border-subtle);
      box-shadow:var(--shadow-soft);
      margin-bottom:14px;
    }
    .app-card-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px}
    .app-card-title{font-size:.96rem;font-weight:600}
    .chip{
      border-radius:var(--radius-full);
      padding:4px 10px;font-size:.74rem;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);
      display:inline-flex;align-items:center;gap:4px;white-space:nowrap
    }
    .chip.badge{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.6);color:#bbf7d0}
    .muted{color:var(--text-soft);font-size:.80rem}
    .divider-soft{
      height:1px;
      background:linear-gradient(90deg,transparent,rgba(148,163,184,.4),transparent);
      margin:8px -2px 10px;
    }

    .pill-group{display:flex;flex-wrap:wrap;gap:8px;margin:8px -1px 4px}
    .pill{
      border-radius:999px;
      padding:5px 12px;font-size:.78rem;
      border:1px solid rgba(148,163,184,.55);
      background:rgba(15,23,42,.9);
      cursor:pointer;color:var(--text-main);
    }
    .pill--active{background:var(--accent-soft);border-color:rgba(34,197,94,.85);color:#bbf7d0}

    .btn{
      border-radius:999px;border:none;
      padding:9px 14px;font-size:.82rem;font-weight:500;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      background:linear-gradient(135deg,#16a34a,#22c55e);
      color:#022c22;
      box-shadow:0 12px 30px rgba(22,163,74,.55);
      transition:transform .12s,box-shadow .12s,filter .12s;
    }
    .btn span{font-size:1rem}
    .btn:active{transform:translateY(1px);box-shadow:0 7px 18px rgba(22,163,74,.55);filter:brightness(.96)}
    .btn-secondary{background:rgba(15,23,42,.9);color:var(--text-main);border:1px solid var(--border-subtle);box-shadow:none}
    .btn-full{width:100%;justify-content:center}
    .btn-danger{background:linear-gradient(135deg,#b91c1c,#ef4444);color:#fee2e2;box-shadow:0 10px 26px rgba(248,113,113,.45)}
    .grid-two{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .small-label{font-size:.78rem;color:var(--text-soft);margin-bottom:2px}
    .big-number{font-size:1.3rem;font-weight:600}

    .form-grid{display:grid;grid-template-columns:1fr;gap:10px;margin:8px 0 4px}
    @media(min-width:660px){.form-grid--2{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .field{display:flex;flex-direction:column;gap:4px}
    .field label{font-size:.78rem;color:var(--text-soft)}
    input[type="text"],input[type="date"],input[type="number"],select,textarea{
      background:rgba(15,23,42,.95);
      border-radius:14px;border:1px solid rgba(51,65,85,.9);
      padding:8px 10px;color:var(--text-main);
      font-size:.83rem;font-family:inherit;width:100%;outline:none;
      transition:border .12s,box-shadow .12s,background .12s;
    }
    select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      padding-right:26px;
      background-image:
        linear-gradient(45deg,transparent 50%,#9ca3af 50%),
        linear-gradient(135deg,#9ca3af 50%,transparent 50%);
      background-position:calc(100% - 15px) 10px,calc(100% - 11px) 10px;
      background-size:6px 6px,6px 6px;background-repeat:no-repeat;
    }
    textarea{min-height:72px;resize:vertical}
    input:focus,select:focus,textarea:focus{
      border-color:rgba(34,197,94,.9);
      box-shadow:0 0 0 1px rgba(34,197,94,.5);
      background:rgba(15,23,42,.98);
    }

    .cultivos-list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .cultivo-card{
      border-radius:var(--radius-lg);
      padding:10px 11px;
      background:radial-gradient(circle at top left,var(--card-soft) 0,#020617 60%);
      border:1px solid rgba(75,85,99,.9);
      display:flex;flex-direction:column;gap:4px;
    }
    .cultivo-header{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .cultivo-title{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .cultivo-thumb{width:56px;height:56px;border-radius:16px;object-fit:cover;flex-shrink:0}
    .cultivo-body{
      font-size:.78rem;color:var(--text-soft);
      display:grid;grid-template-columns:1.1fr .9fr;gap:4px 10px;margin-top:6px
    }
    @media(max-width:480px){.cultivo-body{grid-template-columns:1fr}}
    .cultivo-actions{margin-top:8px;display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap}
    .germinacion-panel{
      margin-top:10px;padding-top:10px;border-top:1px solid rgba(148,163,184,.5);
      font-size:.78rem;color:var(--text-soft);display:none;
    }

    .calendar-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .calendar-item{
      border-radius:16px;padding:9px 10px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
      font-size:.8rem;
    }
    .calendar-item-title{
      font-weight:600;margin-bottom:2px;
      display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .calendar-empty{font-size:.8rem;color:var(--text-soft);margin-top:8px}

    .diario-list{display:flex;flex-direction:column;gap:8px;margin-top:6px;font-size:.8rem}
    .diario-item{
      border-radius:14px;padding:8px 10px;background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.9);
    }
    .diario-item-header{
      display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;
    }

    footer{margin-top:6px;font-size:.76rem;color:var(--text-soft);text-align:center;padding-bottom:6px}

    /* Banner instalar */
    #installBanner{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(15,23,42,.97);
      border-radius:999px;padding:7px 12px;
      display:flex;align-items:center;gap:8px;
      border:1px solid rgba(148,163,184,.75);
      box-shadow:0 16px 40px rgba(15,23,42,.85);
      font-size:.78rem;z-index:80;
    }
    #installBanner.hidden{display:none}
    #installBanner button{font-size:.78rem;padding:6px 10px}

    /* Toast */
    #toast{
      position:fixed;left:50%;top:14px;transform:translateX(-50%);
      z-index:90;display:none;
      background:rgba(15,23,42,.96);
      border:1px solid rgba(148,163,184,.5);
      box-shadow:0 18px 45px rgba(0,0,0,.35);
      border-radius:999px;
      padding:10px 12px;
      min-width:min(520px,calc(100vw - 28px));
      align-items:center;justify-content:space-between;gap:10px;
    }
    #toast.show{display:flex}
    #toast .msg{font-size:.82rem;color:#e5e7eb}
    #toast .actions{display:flex;gap:8px;align-items:center}
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon"><span>üå±</span></div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v18 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle"></div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav" id="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio"><span class="nav-icon">üè†</span><span>Inicio</span></button>
      <button class="nav-btn" data-section="calendario"><span class="nav-icon">üìÖ</span><span>Calendario</span></button>
      <button class="nav-btn" data-section="catalogo"><span class="nav-icon">üå±</span><span>Cat√°logo</span></button>
      <button class="nav-btn" data-section="huerto"><span class="nav-icon">üåø</span><span>Mi huerto</span></button>
      <button class="nav-btn" data-section="diario"><span class="nav-icon">üìì</span><span>Diario</span></button>
      <button class="nav-btn" data-section="plagas"><span class="nav-icon">üêõ</span><span>Plagas</span></button>
      <button class="nav-btn" data-section="pesticidas"><span class="nav-icon">üíß</span><span>Pesticidas</span></button>
      <button class="nav-btn" data-section="opciones"><span class="nav-icon">‚öôÔ∏è</span><span>Opciones</span></button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row"><div class="section-icon-pill">üè†</div><h2>Inicio</h2></div>
        <p class="section-subtitle">Resumen r√°pido de tu huerto.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
              <div class="chip badge" id="estadoClimaChip">Clima ‚Äî</div>
              <div class="chip" id="climaAhoraChip">Clima: ‚Äî</div>
            </div>
          </div>

          <div class="grid-two">
            <div><div class="small-label">Cultivos registrados</div><div class="big-number" id="estadoCultivosCount">0</div></div>
            <div><div class="small-label">Entradas hoy</div><div class="big-number" id="estadoEntradasCount">0</div></div>
          </div>

          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">A√∫n no has registrado cultivos. Ve a ‚ÄúMi huerto‚Äù.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Recordatorios</div>
            <div class="chip" id="recordatoriosChip">0 pendientes</div>
          </div>
          <p class="muted" id="recordatoriosTxt">Sin recordatorios por ahora.</p>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìÖ</div><h2>Calendario de siembra</h2></div>
        <p class="section-subtitle">Elige un mes para ver sugerencias seg√∫n clima/hemisferio.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses</div>
            <div class="chip" id="calendarioClimaChip">Clima ‚Äî</div>
          </div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button><button class="pill" data-mes="1">Feb</button><button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button><button class="pill" data-mes="4">May</button><button class="pill" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button><button class="pill" data-mes="7">Ago</button><button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button><button class="pill" data-mes="10">Nov</button><button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">No hay recomendaciones para este mes.</div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üå±</div><h2>Cat√°logo de cultivos</h2></div>
        <p class="section-subtitle">Cultivos + germinaci√≥n/reproducci√≥n. Incluye personalizados.</p>

        <div class="app-card">
          <div class="field">
            <label for="catalogoBusqueda">Buscar cultivo</label>
            <input type="text" id="catalogoBusqueda" placeholder="Ej. tomate, lechuga, pl√°tano..." />
          </div>

          <div style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary" id="btnToggleNuevoCultivo">‚ûï A√±adir cultivo manual</button>
          </div>

          <!-- Formulario cultivo manual -->
          <div class="app-card" id="nuevoCultivoCard" style="margin-top: 12px; display:none;">
            <div class="app-card-header">
              <div class="app-card-title" id="nuevoCultivoTitulo">Nuevo cultivo</div>
              <span class="chip badge">Personalizado</span>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoNombre">Nombre del cultivo *</label>
                <input type="text" id="nuevoCultivoNombre" placeholder="Ej. cilantro criollo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoCategoria">Categor√≠a</label>
                <select id="nuevoCultivoCategoria">
                  <option value="Hoja">Hoja</option>
                  <option value="Fruto">Fruto</option>
                  <option value="Ra√≠z">Ra√≠z</option>
                  <option value="Tub√©rculo">Tub√©rculo</option>
                  <option value="Arom√°tica">Arom√°tica</option>
                  <option value="Frutal perenne">Frutal perenne</option>
                  <option value="Otro">Otro</option>
                </select>
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoDiasGerminacion">D√≠as de germinaci√≥n (opcional)</label>
                <input type="number" id="nuevoCultivoDiasGerminacion" min="0" placeholder="Ej. 7" />
              </div>
              <div class="field">
                <label for="nuevoCultivoDiasCosecha">D√≠as hasta cosecha (opcional)</label>
                <input type="number" id="nuevoCultivoDiasCosecha" min="0" placeholder="Ej. 90" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoLuz">Luz</label>
                <input type="text" id="nuevoCultivoLuz" placeholder="Ej. Sol directo (6‚Äì8 h)" />
              </div>
              <div class="field">
                <label for="nuevoCultivoRiego">Riego</label>
                <input type="text" id="nuevoCultivoRiego" placeholder="Ej. Suelo ligeramente h√∫medo" />
              </div>
            </div>

            <div class="form-grid form-grid--2">
              <div class="field">
                <label for="nuevoCultivoTiesto">Tiesto / suelo</label>
                <input type="text" id="nuevoCultivoTiesto" placeholder="Ej. Maceta 5+ galones o suelo directo" />
              </div>
              <div class="field">
                <label for="nuevoCultivoProfundidad">Profundidad de siembra</label>
                <input type="text" id="nuevoCultivoProfundidad" placeholder="Ej. 0.5‚Äì1 cm" />
              </div>
            </div>

            <div class="field">
              <label for="nuevoCultivoPlagas">Plagas frecuentes (coma)</label>
              <input type="text" id="nuevoCultivoPlagas" placeholder="Ej. pulgones, babosas, hongos" />
            </div>

            <div class="field" style="margin-top: 10px;">
              <label>Meses de siembra (Calendario)</label>
              <div class="pill-group" id="nuevoCultivoMesesPills">
                <button type="button" class="pill" data-mes="0">Ene</button><button type="button" class="pill" data-mes="1">Feb</button>
                <button type="button" class="pill" data-mes="2">Mar</button><button type="button" class="pill" data-mes="3">Abr</button>
                <button type="button" class="pill" data-mes="4">May</button><button type="button" class="pill" data-mes="5">Jun</button>
                <button type="button" class="pill" data-mes="6">Jul</button><button type="button" class="pill" data-mes="7">Ago</button>
                <button type="button" class="pill" data-mes="8">Sep</button><button type="button" class="pill" data-mes="9">Oct</button>
                <button type="button" class="pill" data-mes="10">Nov</button><button type="button" class="pill" data-mes="11">Dic</button>
              </div>
              <p class="muted" style="margin-top:6px;">Si no seleccionas ninguno, se asume <strong>todo el a√±o</strong>.</p>
            </div>

            <div style="margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap;">
              <button type="button" class="btn" id="btnGuardarNuevoCultivo">Guardar cultivo</button>
              <button type="button" class="btn btn-secondary" id="btnCancelarNuevoCultivo">Cancelar</button>
            </div>
          </div>

          <div class="cultivos-list" id="catalogoList"></div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üåø</div><h2>Mi huerto</h2></div>
        <p class="section-subtitle">Registra cultivos, riego/abono y notas.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga..." />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoFrecuenciaRiego">Frecuencia riego (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaRiego" min="0" placeholder="Ej. 3" />
            </div>
            <div class="field">
              <label for="cultivoFrecuenciaAbono">Frecuencia abono (d√≠as)</label>
              <input type="number" id="cultivoFrecuenciaAbono" min="0" placeholder="Ej. 30" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas</label>
            <textarea id="cultivoNotas" placeholder="Ej. Maceta 7 gal, cama 1..."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo"><span>‚ûï</span> Guardar cultivo</button>
          <p class="muted" style="margin-top:6px;">* Solo el nombre es obligatorio.</p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>
          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üìì</div><h2>Diario</h2></div>
        <p class="section-subtitle">Anota eventos: riegos, abonados, plagas, etc.</p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="diarioTipo">Tipo</label>
              <select id="diarioTipo">
                <option value="General">General</option>
                <option value="Riego">Riego</option>
                <option value="Abono">Abono</option>
                <option value="Fertilizante">Fertilizante</option>
                <option value="Poda">Poda</option>
                <option value="Plagas">Plagas</option>
              </select>
            </div>
            <div class="field">
              <label for="diarioFecha">Fecha</label>
              <input type="date" id="diarioFecha" />
            </div>
          </div>

          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates. Apliqu√© compost."></textarea>
          </div>

          <button class="btn btn-full" id="btnGuardarDiario"><span>üíæ</span> Guardar</button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas</div>
            <div class="chip" id="diarioCountChip">0</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="Plagas">Plagas</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>
          <div class="diario-list" id="diarioList"></div>

          <button class="btn btn-secondary btn-full" id="btnExportarDiarioPdf"><span>üì¶</span> Exportar diario (PDF)</button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üêõ</div><h2>Plagas</h2></div>
        <p class="section-subtitle">Referencia r√°pida.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Cat√°logo b√°sico</div><div class="chip">Referencia</div></div>
          <div id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row"><div class="section-icon-pill">üíß</div><h2>Pesticidas y preparados</h2></div>
        <p class="section-subtitle">Opciones suaves para huerto casero.</p>
        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Preparados sugeridos</div><div class="chip">Uso responsable</div></div>
          <div id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row"><div class="section-icon-pill">‚öôÔ∏è</div><h2>Opciones</h2></div>
        <p class="section-subtitle">Nombre, clima, hemisferio y respaldo.</p>

        <div class="app-card">
          <div class="app-card-header"><div class="app-card-title">Configuraci√≥n</div></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG" />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima</label>
              <select id="climaSelect">
                <option value="tropical">Tropical</option>
                <option value="subtropical">Subtropical</option>
                <option value="templado">Templado</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Norte</option>
                <option value="sur">Sur</option>
              </select>
            </div>
          </div>

          <div class="divider-soft"></div>

          <div class="app-card-header" style="margin-top:2px">
            <div class="app-card-title">Clima local (Open-Meteo)</div>
            <div class="chip" id="climaStatusChip">‚Äî</div>
          </div>
          <p class="muted" style="margin-top:0">
            Usa ubicaci√≥n del tel√©fono para mostrar temperatura y lluvia. Solo se consulta cuando t√∫ lo pides o al abrir.
          </p>
          <div class="pill-group" style="margin-top:6px">
            <button class="btn btn-secondary" id="btnPedirUbicacion">üìç Usar ubicaci√≥n</button>
            <button class="btn btn-secondary" id="btnActualizarClima">‚òÅÔ∏è Actualizar clima</button>
          </div>

          <div class="divider-soft"></div>

          <button class="btn btn-full" id="btnGuardarConfig"><span>üíæ</span> Guardar configuraci√≥n</button>

          <div class="divider-soft"></div>

          <div class="pill-group" style="flex-direction:column;">
            <button class="btn btn-secondary btn-full" id="btnExportarJson"><span>üíæ</span> Exportar respaldo (.json)</button>
            <button class="btn btn-secondary btn-full" id="btnImportarJson"><span>üç∞</span> Restaurar respaldo</button>
            <button class="btn btn-danger btn-full" id="btnBorrarTodo"><span>üßπ</span> Borrar todo</button>
          </div>

          <input type="file" id="inputRespaldoJSON" accept="application/json" style="display:none" />
        </div>
      </section>
    </main>

    <footer><span>Mi Siembra Inteligente ¬∑ v18</span></footer>
  </div>

  <!-- Toast -->
  <div id="toast">
    <div class="msg" id="toastMsg">‚Äî</div>
    <div class="actions">
      <button class="btn btn-secondary" id="toastClose">Cerrar</button>
    </div>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong></span>
    <button class="btn btn-secondary" id="btnInstalarPwa"><span>üì≤</span> Instalar</button>
  </div>

    "use strict";

    /*********************
     * Helpers
     *********************/
    function escapeHTML(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }
    function todayISO() { return new Date().toISOString().slice(0,10); }
    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0,10);
    }
    function formatDate(dateStr) {
      if (!dateStr) return "‚Äî";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
      const dia = String(d.getDate()).padStart(2,"0");
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }
    function uid(prefix="id"){ return `${prefix}-${Date.now().toString(36)}-${Math.random().toString(36).slice(2,7)}`; }

    // Toast simple
    function showToast(msg) {
      const t = document.getElementById("toast");
      const m = document.getElementById("toastMsg");
      if (!t || !m) return;
      m.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._to);
      showToast._to = setTimeout(() => t.classList.remove("show"), 3500);
    }
    function bindToastClose() {
      const btn = document.getElementById("toastClose");
      const t = document.getElementById("toast");
      if (!btn || !t) return;
      if (btn.dataset.bound === "1") return;
      btn.dataset.bound = "1";
      btn.addEventListener("click", () => t.classList.remove("show"));
    }

    /*********************
     * Storage
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario",
      customCultivos: "msi-custom-cultivos-v18",
      geo: "msi-geo-v18",
      weather: "msi-weather-v18"
    };

    const DEFAULT_SETTINGS = { nombreHuerto:"Mi huerto", clima:"tropical", hemisferio:"norte" };

    const CLIMA_LABEL = { tropical:"tropical", subtropical:"subtropical", templado:"templado" };
    const HEMISFERIO_LABEL = { norte:"hemisferio norte", sur:"hemisferio sur" };

    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch { return fallback; }
    }
    function saveJSON(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

    function loadSettings() {
      const obj = loadJSON(STORAGE_KEYS.settings, null);
      return { ...DEFAULT_SETTINGS, ...(obj && typeof obj === "object" ? obj : {}) };
    }
    function saveSettings(s) { saveJSON(STORAGE_KEYS.settings, s); }

    function loadCultivos() {
      const arr = loadJSON(STORAGE_KEYS.cultivos, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCultivos(arr) { saveJSON(STORAGE_KEYS.cultivos, arr); }

    function loadDiario() {
      const arr = loadJSON(STORAGE_KEYS.diario, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveDiario(arr) { saveJSON(STORAGE_KEYS.diario, arr); }

    function loadCustomCultivos() {
      const arr = loadJSON(STORAGE_KEYS.customCultivos, []);
      return Array.isArray(arr) ? arr : [];
    }
    function saveCustomCultivos(arr) { saveJSON(STORAGE_KEYS.customCultivos, arr); }

    function loadGeo() {
      const obj = loadJSON(STORAGE_KEYS.geo, null);
      if (!obj || typeof obj !== "object") return null;
      const { lat, lon, label } = obj;
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return null;
      return { lat, lon, label: String(label || "") };
    }
    function saveGeo(geo) { saveJSON(STORAGE_KEYS.geo, geo); }

    /*********************
     * Data base
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        0: [{ titulo:"Cilantro", tipo:"Arom√°tica", detalle:"Siembra escalonada; mejor en meses frescos." }],
        5: [{ titulo:"R√°banos", tipo:"Ra√≠z", detalle:"Cosecha r√°pida (20‚Äì30 d√≠as)." }],
        6: [{ titulo:"Aj√≠es", tipo:"Fruto", detalle:"Sol y riego constante sin charcos." }]
      },
      subtropical: { 5: [{ titulo:"Tomates", tipo:"Fruto", detalle:"Variedades adaptadas a tu zona." }] },
      templado: { 2: [{ titulo:"Lechugas", tipo:"Hoja", detalle:"Siembra cuando bajen calor/heladas." }] }
    };

    const CATALOGO_BASE = [
      { id:"tomate", nombre:"Tomate", categoria:"Fruto", dias:"70‚Äì90 d√≠as", luz:"Sol directo (6‚Äì8 h)", riego:"Regular, sin encharcar", tiesto:"5+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones","Mosca blanca","Orugas"], meses:[0,1,2,3,4,5,6,7], imagen:"img/tomate.jpg" },
      { id:"lechuga", nombre:"Lechuga", categoria:"Hoja", dias:"45‚Äì60 d√≠as", luz:"Sol suave / sombra parcial", riego:"H√∫medo", tiesto:"3+ galones", profundidad:"0.5 cm", plagas:["Babosas","Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/lechuga.jpg" },
      { id:"rabano", nombre:"R√°bano", categoria:"Ra√≠z", dias:"25‚Äì35 d√≠as", luz:"Sol / media sombra", riego:"Constante", tiesto:"3+ galones", profundidad:"1 cm", plagas:["Pulguillas","Babosas"], meses:[0,1,2,3,8,9,10,11], imagen:"img/rabano.jpg" },
      { id:"cilantro", nombre:"Cilantro", categoria:"Arom√°tica", dias:"30‚Äì50 d√≠as", luz:"Sol suave", riego:"Suelo fresco", tiesto:"3+ galones", profundidad:"0.5‚Äì1 cm", plagas:["Pulgones"], meses:[0,1,2,3,8,9,10,11], imagen:"img/cilantro.jpg" },
      { id:"platano", nombre:"Pl√°tano", categoria:"Frutal perenne", dias:"9‚Äì12 meses", luz:"Sol directo", riego:"Regular", tiesto:"Suelo directo", profundidad:"Cormo", plagas:["Picudo","Sigatoka"], meses:[0,1,2,3,4,5,6,7,8,9,10,11], imagen:"img/platano.jpg" },
    ];

    const GERMINACION = {
      tomate: { titulo:"Tomate ‚Äì germinaci√≥n", metodo:"Alm√°cigo y trasplante.", pasos:["Sembrar 0.5‚Äì1 cm","Humedad constante","Trasplantar con 3‚Äì4 hojas"], tip:"Buena luz para evitar espigado." },
      lechuga:{ titulo:"Lechuga ‚Äì germinaci√≥n", metodo:"Semilla superficial.", pasos:["Sembrar muy poco profundo","Humedad constante","Raleo / trasplante"], tip:"Mejor con temperatura moderada." },
      platano:{ titulo:"Pl√°tano ‚Äì reproducci√≥n", metodo:"Hijuelos / cormos.", pasos:["Elegir hijuelo sano","Plantar en suelo drenado","Riego moderado"], tip:"Evita charcos." },
      generic:{ titulo:"Gu√≠a general", metodo:"Semilla directa o bandeja.", pasos:["Sustrato limpio","Profundidad 2‚Äì3x semilla","Humedad constante"], tip:"Prueba alm√°cigo y directo." }
    };

    const PLAGAS_DATA = [
      { nombre:"Pulgones", como:"Peque√±os insectos en brotes, hojas deformadas.", manejo:"Agua a presi√≥n suave; revisi√≥n frecuente.", tip:"Jab√≥n pot√°sico diluido al atardecer." },
      { nombre:"Mosca blanca", como:"Vuelan al mover la hoja.", manejo:"Retira hojas afectadas; mejora ventilaci√≥n.", tip:"Trampas amarillas + jab√≥n pot√°sico." },
      { nombre:"O√≠dio / hongos", como:"Polvo blanco o manchas.", manejo:"Ventilar y evitar mojar hojas de noche.", tip:"Bicarbonato suave (dosis baja) o fungicida permitido." }
    ];

    const PESTICIDAS_DATA = [
      { nombre:"Jab√≥n pot√°sico", uso:"Pulgones y mosca blanca (contacto).", tip:"Aplicar al atardecer; repetir 5‚Äì7 d√≠as." },
      { nombre:"Aceite de neem (suave)", uso:"Insectos chupadores (seg√∫n etiqueta).", tip:"No aplicar con sol fuerte; seguir dosis." },
      { nombre:"Bicarbonato (suave)", uso:"O√≠dio (preventivo/leve).", tip:"Dosis baja y no abusar." }
    ];

    /*********************
     * Estado
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";

    let customEditId = null;

    function getCatalogoFull(){
      const custom = loadCustomCultivos().map(c => ({...c, esPersonalizado:true, imagen: c.imagen || "img/placeholder.jpg"}));
      const base = CATALOGO_BASE.map(c => ({...c, esPersonalizado:false}));
      return [...base, ...custom].sort((a,b)=>String(a.nombre).localeCompare(String(b.nombre)));
    }

    /*********************
     * UI header/context
     *********************/
    function updateHeader(){
      const subtitleEl = document.getElementById("appSubtitle");
      if (!subtitleEl) return;
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || "tropical";
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || "hemisferio norte";

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${escapeHTML(nombre)}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${escapeHTML(clima)}</span>
        <span class="app-subtitle-dot"></span>
        <span>${escapeHTML(hemis)}</span>
      `;

      document.getElementById("estadoClimaChip")?.textContent = `Clima ${clima}`;
      document.getElementById("calendarioClimaChip")?.textContent = `Clima ${clima}`;
    }

    function setDefaultsDates(){
      const f1 = document.getElementById("cultivoFecha");
      if (f1 && !f1.value) f1.value = todayISO();
      const f2 = document.getElementById("diarioFecha");
      if (f2 && !f2.value) f2.value = todayISO();
    }

    /*********************
     * Navigation
     *********************/
    function showSection(key){
      document.querySelectorAll(".section").forEach(s => s.classList.remove("section--active"));
      document.getElementById(`section-${key}`)?.classList.add("section--active");

      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("nav-btn--active"));
      document.querySelector(`.nav-btn[data-section="${key}"]`)?.classList.add("nav-btn--active");
    }

    function setupNav(){
      const nav = document.getElementById("nav");
      if (!nav) return;
      nav.addEventListener("click",(ev)=>{
        const btn = ev.target.closest(".nav-btn[data-section]");
        if (!btn) return;
        showSection(btn.dataset.section);
      });
    }

    /*********************
     * Calendario
     *********************/
    const MESES_ABR = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    function ajustarMesPorHemisferio(monthIndex){
      const climaKey = stateSettings.clima || "tropical";
      if (stateSettings.hemisferio === "sur" && (climaKey === "templado" || climaKey === "subtropical")) {
        return (monthIndex + 6) % 12;
      }
      return monthIndex;
    }

    function renderCalendario(monthIndex){
      const listEl = document.getElementById("calendarList");
      const emptyEl = document.getElementById("calendarEmpty");
      if (!listEl || !emptyEl) return;

      listEl.innerHTML = "";
      emptyEl.style.display = "none";

      const climaKey = stateSettings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(monthIndex);

      if (mesAjustado !== monthIndex){
        const info = document.createElement("p");
        info.className = "muted";
        info.textContent = `Hemisferio sur: ${MESES_ABR[monthIndex]} se interpreta como ${MESES_ABR[mesAjustado]} (+6m).`;
        listEl.appendChild(info);
      }

      const base = (CALENDARIO_SIEMBRA[climaKey] || {})[mesAjustado] || [];
      base.forEach(item=>{
        const div = document.createElement("div");
        div.className = "calendar-item";
        div.innerHTML = `
          <div class="calendar-item-title">
            <span>${escapeHTML(item.titulo)}</span>
            <span class="chip">${escapeHTML(item.tipo)}</span>
          </div>
          <div>${escapeHTML(item.detalle)}</div>
        `;
        listEl.appendChild(div);
      });

      const catalogo = getCatalogoFull();
      const sugeridos = catalogo.filter(c => Array.isArray(c.meses) && c.meses.includes(mesAjustado));

      if (!base.length && !sugeridos.length){
        emptyEl.style.display = "block";
        return;
      }

      if (sugeridos.length){
        const sep = document.createElement("div");
        sep.className = "divider-soft";
        listEl.appendChild(sep);

        const t = document.createElement("p");
        t.className = "muted";
        t.textContent = "Desde el cat√°logo: recomendados para este mes.";
        listEl.appendChild(t);

        sugeridos.slice(0,10).forEach(c=>{
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${escapeHTML(c.nombre)}</span>
              <span class="chip">${escapeHTML(c.categoria)}</span>
            </div>
            <div>D√≠as a cosecha: ${escapeHTML(c.dias)} ¬∑ Luz: ${escapeHTML(c.luz)}</div>
            <div style="margin-top:6px;">
              <button class="btn btn-secondary btn-full" data-action="ver-catalogo" data-id="${escapeHTML(c.id)}">üîç Ver en cat√°logo</button>
            </div>
          `;
          listEl.appendChild(div);
        });
      }
    }

    function setupCalendario(){
      const wrap = document.getElementById("mesesPills");
      if (!wrap) return;

      // activar mes actual
      const current = new Date().getMonth();
      wrap.querySelectorAll(".pill").forEach(p => p.classList.toggle("pill--active", Number(p.dataset.mes) === current));
      renderCalendario(current);

      wrap.addEventListener("click",(ev)=>{
        const b = ev.target.closest(".pill[data-mes]");
        if (!b) return;
        const mes = Number(b.dataset.mes);
        wrap.querySelectorAll(".pill").forEach(p => p.classList.remove("pill--active"));
        b.classList.add("pill--active");
        renderCalendario(mes);
      });

      // click ‚Äúver en cat√°logo‚Äù (delegaci√≥n)
      document.getElementById("calendarList")?.addEventListener("click",(ev)=>{
        const b = ev.target.closest('button[data-action="ver-catalogo"][data-id]');
        if (!b) return;
        const id = b.dataset.id;
        showSection("catalogo");
        const cultivo = getCatalogoFull().find(c => c.id === id);
        const q = cultivo ? cultivo.nombre : "";
        const input = document.getElementById("catalogoBusqueda");
        if (input) input.value = q;
        renderCatalogo(q);
        document.getElementById("section-catalogo")?.scrollIntoView?.({behavior:"smooth", block:"start"});
      });
    }

    // === FIN PARTE 1 (PEGA PARTE 2 DEBAJO) ===
    /*********************
     * Cat√°logo + personalizados
     *********************/
    function parsePlagas(str){ return (str||"").split(",").map(s=>s.trim()).filter(Boolean); }
    function allMonths(){ return [0,1,2,3,4,5,6,7,8,9,10,11]; }

    function getMesesSeleccionadosUI(){
      return Array.from(document.querySelectorAll("#nuevoCultivoMesesPills .pill.pill--active"))
        .map(b=>Number(b.dataset.mes)).filter(n=>Number.isFinite(n));
    }
    function setMesesSeleccionadosUI(meses){
      const set = new Set((meses||[]).map(Number));
      document.querySelectorAll("#nuevoCultivoMesesPills .pill").forEach(b=>{
        const m = Number(b.dataset.mes);
        b.classList.toggle("pill--active", set.has(m));
      });
    }
    function setupNuevoCultivoMesesPills(){
      const wrap = document.getElementById("nuevoCultivoMesesPills");
      if (!wrap || wrap.dataset.bound==="1") return;
      wrap.dataset.bound="1";
      wrap.addEventListener("click",(ev)=>{
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        b.classList.toggle("pill--active");
      });
    }

    function clearCustomCultivoUI(){
      ["nuevoCultivoNombre","nuevoCultivoDiasGerminacion","nuevoCultivoDiasCosecha","nuevoCultivoLuz","nuevoCultivoRiego","nuevoCultivoTiesto","nuevoCultivoProfundidad","nuevoCultivoPlagas"]
        .forEach(id => { const el = document.getElementById(id); if (el) el.value=""; });
      document.getElementById("nuevoCultivoCategoria").value = "Otro";
      setMesesSeleccionadosUI([]);
    }
    function resetEditCustomCultivoUI(){
      customEditId = null;
      document.getElementById("nuevoCultivoTitulo").textContent = "Nuevo cultivo";
      document.getElementById("btnGuardarNuevoCultivo").textContent = "Guardar cultivo";
    }

    function buildCustomCultivoFromUI(existingId){
      const nombre = (document.getElementById("nuevoCultivoNombre").value||"").trim();
      if (!nombre) { alert("Escribe el nombre del cultivo."); return null; }

      const categoria = (document.getElementById("nuevoCultivoCategoria").value||"Otro").trim();
      const diasG = parseInt(document.getElementById("nuevoCultivoDiasGerminacion").value||"",10);
      const diasC = parseInt(document.getElementById("nuevoCultivoDiasCosecha").value||"",10);

      const luz = (document.getElementById("nuevoCultivoLuz").value||"").trim() || "‚Äî";
      const riego = (document.getElementById("nuevoCultivoRiego").value||"").trim() || "‚Äî";
      const tiesto = (document.getElementById("nuevoCultivoTiesto").value||"").trim() || "‚Äî";
      const profundidad = (document.getElementById("nuevoCultivoProfundidad").value||"").trim() || "‚Äî";
      const plagas = parsePlagas((document.getElementById("nuevoCultivoPlagas").value||"").trim());

      let meses = getMesesSeleccionadosUI();
      if (!meses.length) meses = allMonths();

      const id = existingId || uid("custom");
      const diasTexto = Number.isFinite(diasC) && diasC>0 ? `${diasC} d√≠as` : "‚Äî";

      return {
        id, nombre, categoria,
        dias: diasTexto,
        luz, riego, tiesto, profundidad,
        plagas, meses,
        imagen:"img/placeholder.jpg",
        diasGerminacion: Number.isFinite(diasG) && diasG>0 ? diasG : null,
        diasCosecha: Number.isFinite(diasC) && diasC>0 ? diasC : null,
      };
    }

    function startEditCustomCultivo(cultivo){
      customEditId = cultivo.id;
      const card = document.getElementById("nuevoCultivoCard");
      card.style.display = "block";

      document.getElementById("nuevoCultivoTitulo").textContent = "Editar cultivo";
      document.getElementById("btnGuardarNuevoCultivo").textContent = "Actualizar cultivo";

      document.getElementById("nuevoCultivoNombre").value = cultivo.nombre || "";
      document.getElementById("nuevoCultivoCategoria").value = cultivo.categoria || "Otro";
      document.getElementById("nuevoCultivoDiasGerminacion").value = cultivo.diasGerminacion || "";
      document.getElementById("nuevoCultivoDiasCosecha").value = cultivo.diasCosecha || "";
      document.getElementById("nuevoCultivoLuz").value = cultivo.luz || "";
      document.getElementById("nuevoCultivoRiego").value = cultivo.riego || "";
      document.getElementById("nuevoCultivoTiesto").value = cultivo.tiesto || "";
      document.getElementById("nuevoCultivoProfundidad").value = cultivo.profundidad || "";
      document.getElementById("nuevoCultivoPlagas").value = Array.isArray(cultivo.plagas) ? cultivo.plagas.join(", ") : "";
      setMesesSeleccionadosUI(Array.isArray(cultivo.meses) ? cultivo.meses : []);
      setupNuevoCultivoMesesPills();

      card.scrollIntoView({ behavior:"smooth", block:"start" });
      document.getElementById("nuevoCultivoNombre").focus();
    }

    function deleteCustomCultivoById(id){
      const list = loadCustomCultivos().filter(c => c.id !== id);
      saveCustomCultivos(list);
      if (customEditId === id){
        document.getElementById("nuevoCultivoCard").style.display="none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
      }
      renderCatalogo((document.getElementById("catalogoBusqueda").value||"").trim());
    }

    function getGerminacionFor(c){
      return GERMINACION[c.id] || GERMINACION.generic;
    }

    function renderCatalogo(filtroTexto=""){
      const listEl = document.getElementById("catalogoList");
      if (!listEl) return;

      const filtro = (filtroTexto||"").trim().toLowerCase();
      const catalogo = getCatalogoFull();
      const lista = catalogo.filter(c => {
        if (!filtro) return true;
        return (c.nombre||"").toLowerCase().includes(filtro) || (c.id||"").toLowerCase().includes(filtro);
      });

      if (!lista.length){
        listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${escapeHTML(filtroTexto)}".</p>`;
        return;
      }

      listEl.innerHTML = "";
      lista.forEach(c=>{
        const imgSrc = c.imagen || "img/placeholder.jpg";
        const plagasTxt = Array.isArray(c.plagas) && c.plagas.length ? c.plagas.join(", ") : "‚Äî";

        const card = document.createElement("div");
        card.className = "cultivo-card";
        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <img src="${escapeHTML(imgSrc)}" class="cultivo-thumb" alt="${escapeHTML(c.nombre)}"
                onerror="this.onerror=null;this.src='img/placeholder.jpg';">
              <span>üå± ${escapeHTML(c.nombre)}</span>
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
              <span class="chip">${escapeHTML(c.categoria)}</span>
              ${c.esPersonalizado ? `<span class="chip badge">Personalizado</span>` : ``}
            </div>
          </div>

          <div class="cultivo-body">
            <div><strong>D√≠as:</strong> ${escapeHTML(c.dias)}</div>
            <div><strong>Luz:</strong> ${escapeHTML(c.luz)}</div>
            <div><strong>Riego:</strong> ${escapeHTML(c.riego)}</div>
            <div><strong>Tiesto:</strong> ${escapeHTML(c.tiesto)}</div>
            <div><strong>Profundidad:</strong> ${escapeHTML(c.profundidad)}</div>
            <div><strong>Plagas:</strong> ${escapeHTML(plagasTxt)}</div>
          </div>

          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-action="germinacion" data-id="${escapeHTML(c.id)}">üîÅ Germinaci√≥n</button>
            ${c.esPersonalizado ? `
              <button class="btn btn-secondary" data-action="editar-custom" data-id="${escapeHTML(c.id)}">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger" data-action="borrar-custom" data-id="${escapeHTML(c.id)}">üóë Borrar</button>
            ` : ``}
          </div>
          <div class="germinacion-panel" id="germ-${escapeHTML(c.id)}"></div>
        `;
        listEl.appendChild(card);
      });
    }

    function setupCatalogo(){
      const input = document.getElementById("catalogoBusqueda");
      const list = document.getElementById("catalogoList");
      const btnToggle = document.getElementById("btnToggleNuevoCultivo");
      const card = document.getElementById("nuevoCultivoCard");
      const btnGuardar = document.getElementById("btnGuardarNuevoCultivo");
      const btnCancelar = document.getElementById("btnCancelarNuevoCultivo");

      setupNuevoCultivoMesesPills();

      input.addEventListener("input", ()=> renderCatalogo(input.value));

      btnToggle.addEventListener("click",()=>{
        const visible = card.style.display !== "none";
        card.style.display = visible ? "none" : "block";
        if (!visible) document.getElementById("nuevoCultivoNombre").focus();
        else { clearCustomCultivoUI(); resetEditCustomCultivoUI(); }
      });

      btnCancelar.addEventListener("click",()=>{
        card.style.display="none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();
      });

      btnGuardar.addEventListener("click",()=>{
        const cultivo = buildCustomCultivoFromUI(customEditId);
        if (!cultivo) return;

        let customList = loadCustomCultivos();
        if (customEditId) customList = customList.filter(c => c.id !== customEditId);
        // evita duplicado por nombre si no es edici√≥n
        if (!customEditId){
          const nameLower = (cultivo.nombre||"").toLowerCase();
          customList = customList.filter(c => (c.nombre||"").toLowerCase() !== nameLower);
        }

        customList.push(cultivo);
        saveCustomCultivos(customList);

        card.style.display="none";
        clearCustomCultivoUI();
        resetEditCustomCultivoUI();

        renderCatalogo((document.getElementById("catalogoBusqueda").value||"").trim());
        showToast("Cultivo guardado ‚úÖ");
      });

      // acciones cat√°logo (delegaci√≥n)
      list.addEventListener("click",(ev)=>{
        const b = ev.target.closest("button[data-action][data-id]");
        if (!b) return;
        const id = b.dataset.id;
        const action = b.dataset.action;
        const cultivo = getCatalogoFull().find(c => c.id === id);
        if (!cultivo) return;

        if (action === "germinacion"){
          const panel = document.getElementById(`germ-${id}`);
          if (!panel) return;
          const visible = panel.style.display === "block";
          if (visible){ panel.style.display="none"; return; }
          const g = getGerminacionFor(cultivo);
          const pasos = (g.pasos||[]).map(p=>`<li>${escapeHTML(p)}</li>`).join("");
          panel.innerHTML = `
            <div><strong>${escapeHTML(g.titulo)}</strong></div>
            <div>${escapeHTML(g.metodo)}</div>
            <ul style="margin:8px 0 6px 18px;">${pasos}</ul>
            <div><em>Tip:</em> ${escapeHTML(g.tip||"")}</div>
          `;
          panel.style.display="block";
          return;
        }

        if (action === "editar-custom"){
          startEditCustomCultivo(cultivo);
          return;
        }

        if (action === "borrar-custom"){
          if (confirm(`¬øBorrar "${cultivo.nombre}"?`)) deleteCustomCultivoById(id);
          return;
        }
      });

      renderCatalogo("");
    }

    /*********************
     * Mi huerto
     *********************/
    function nextDueDateISO(lastISO, freqDays){
      if (!lastISO || !Number.isFinite(freqDays) || freqDays <= 0) return null;
      return addDays(lastISO, freqDays);
    }
    function isoToTime(dateISO){
      if (!dateISO) return null;
      const d = new Date(dateISO + "T00:00:00");
      const t = d.getTime();
      return Number.isNaN(t) ? null : t;
    }
    function calcularRecordatorios(){
      const hoy = todayISO();
      const hoyT = isoToTime(hoy);
      const out = [];

      stateCultivos.forEach(c=>{
        const fR = Number(c.frecuenciaRiegoDias);
        const fA = Number(c.frecuenciaAbonoDias);

        const baseR = c.ultimoRiego || c.fechaSiembra;
        const baseA = c.ultimaFertilizacion || c.fechaSiembra;

        const dueR = nextDueDateISO(baseR, Number.isFinite(fR) ? fR : NaN);
        const dueA = nextDueDateISO(baseA, Number.isFinite(fA) ? fA : NaN);

        if (dueR){
          const t = isoToTime(dueR);
          if (t!==null && hoyT!==null && t<=hoyT) out.push(`Riego: ${c.nombre} (deb√≠a: ${formatDate(dueR)})`);
        }
        if (dueA){
          const t = isoToTime(dueA);
          if (t!==null && hoyT!==null && t<=hoyT) out.push(`Abono: ${c.nombre} (deb√≠a: ${formatDate(dueA)})`);
        }
      });

      return out.slice(0,8);
    }

    function renderCultivos(){
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      if (!listEl) return;

      const count = stateCultivos.length;
      chip.textContent = `${count} cultivo${count===1?"":"s"}`;

      if (!count){
        listEl.innerHTML = '<p class="muted">Todav√≠a no has registrado cultivos.</p>';
        return;
      }

      const tipoLabelMap = { hoja:"Hoja", fruto:"Fruto", raiz:"Ra√≠z", tuberculo:"Tub√©rculo", aromaticas:"Arom√°ticas", otro:"Otro" };

      listEl.innerHTML = "";
      stateCultivos.forEach(c=>{
        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";
        const dueR = nextDueDateISO(c.ultimoRiego || c.fechaSiembra, Number(c.frecuenciaRiegoDias));
        const dueA = nextDueDateISO(c.ultimaFertilizacion || c.fechaSiembra, Number(c.frecuenciaAbonoDias));

        const card = document.createElement("div");
        card.className = "cultivo-card";
        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title"><span>üåø</span><span>${escapeHTML(c.nombre)}</span></div>
            <span class="chip">${escapeHTML(tipoLabel)}</span>
          </div>

          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${escapeHTML(c.variedad || "‚Äî")}</div>
            <div><strong>Siembra:</strong> ${escapeHTML(formatDate(c.fechaSiembra))}</div>
            <div><strong>Notas:</strong> ${escapeHTML((c.notas || "‚Äî").slice(0,160))}</div>

            <div><strong>√ölt. riego:</strong> ${escapeHTML(c.ultimoRiego ? formatDate(c.ultimoRiego) : "‚Äî")}</div>
            <div><strong>Pr√≥x riego:</strong> ${escapeHTML(dueR ? formatDate(dueR) : "‚Äî")}</div>

            <div><strong>√ölt. abono:</strong> ${escapeHTML(c.ultimaFertilizacion ? formatDate(c.ultimaFertilizacion) : "‚Äî")}</div>
            <div><strong>Pr√≥x abono:</strong> ${escapeHTML(dueA ? formatDate(dueA) : "‚Äî")}</div>
          </div>

          <div class="cultivo-actions">
            <button class="btn btn-secondary" data-action="nota" data-id="${escapeHTML(c.id)}">‚úèÔ∏è Nota</button>
            <button class="btn btn-secondary" data-action="riego" data-id="${escapeHTML(c.id)}">üí¶ Riego</button>
            <button class="btn btn-secondary" data-action="abono" data-id="${escapeHTML(c.id)}">üíß Abono</button>
            <button class="btn btn-danger" data-action="borrar" data-id="${escapeHTML(c.id)}">üóë Eliminar</button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function setupMiHuerto(){
      const btn = document.getElementById("btnAgregarCultivo");
      const list = document.getElementById("cultivosList");

      btn.addEventListener("click",()=>{
        const nombre = (document.getElementById("cultivoNombre").value||"").trim();
        if (!nombre) { alert("Escribe el nombre del cultivo."); return; }

        const cultivo = {
          id: uid("c"),
          nombre,
          variedad: (document.getElementById("cultivoVariedad").value||"").trim(),
          tipo: document.getElementById("cultivoTipo").value,
          fechaSiembra: document.getElementById("cultivoFecha").value || todayISO(),
          frecuenciaRiegoDias: Number(document.getElementById("cultivoFrecuenciaRiego").value||0) || 0,
          frecuenciaAbonoDias: Number(document.getElementById("cultivoFrecuenciaAbono").value||0) || 0,
          notas: (document.getElementById("cultivoNotas").value||"").trim(),
          creadoEl: todayISO(),
          ultimoRiego: null,
          ultimaFertilizacion: null
        };

        stateCultivos = [cultivo, ...stateCultivos];
        saveCultivos(stateCultivos);

        // limpia
        document.getElementById("cultivoNombre").value="";
        document.getElementById("cultivoVariedad").value="";
        document.getElementById("cultivoFrecuenciaRiego").value="";
        document.getElementById("cultivoFrecuenciaAbono").value="";
        document.getElementById("cultivoNotas").value="";

        renderCultivos();
        renderInicio();
        showToast("Cultivo guardado ‚úÖ");
      });

      list.addEventListener("click",(ev)=>{
        const b = ev.target.closest("button[data-action][data-id]");
        if (!b) return;
        const id = b.dataset.id;
        const action = b.dataset.action;
        const idx = stateCultivos.findIndex(c=>c.id===id);
        if (idx<0) return;
        const c = stateCultivos[idx];

        if (action==="nota"){
          const txt = prompt("Editar nota:", c.notas || "");
          if (txt===null) return;
          c.notas = String(txt).trim();
        }
        if (action==="riego"){
          c.ultimoRiego = todayISO();
          // opcional: crear entrada en diario
          stateDiario = [{ id: uid("d"), tipo:"Riego", fecha: todayISO(), texto:`Riego a ${c.nombre}.` }, ...stateDiario];
          saveDiario(stateDiario);
        }
        if (action==="abono"){
          c.ultimaFertilizacion = todayISO();
          stateDiario = [{ id: uid("d"), tipo:"Abono", fecha: todayISO(), texto:`Abono a ${c.nombre}.` }, ...stateDiario];
          saveDiario(stateDiario);
        }
        if (action==="borrar"){
          if (!confirm(`¬øEliminar "${c.nombre}"?`)) return;
          stateCultivos.splice(idx,1);
        }

        saveCultivos(stateCultivos);
        renderCultivos();
        renderDiario();
        renderInicio();
        showToast("Actualizado ‚úÖ");
      });
    }

    /*********************
     * Diario
     *********************/
    function renderDiario(){
      const listEl = document.getElementById("diarioList");
      const chip = document.getElementById("diarioCountChip");
      const resumenHoyEl = document.getElementById("diarioResumenHoy");
      if (!listEl) return;

      const arrOrdenada = [...stateDiario].sort((a,b)=>String(b.fecha).localeCompare(String(a.fecha)));
      chip.textContent = `${arrOrdenada.length}`;

      const hoy = todayISO();
      const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);
      resumenHoyEl.textContent = hoyEntries.length ? `Hoy: ${hoyEntries.length} entrada(s).` : "Hoy a√∫n no has registrado nada.";

      const arrFiltrada = arrOrdenada.filter(e => {
        if (diarioFiltroActual === "todos") return true;
        return (e.tipo || "General") === diarioFiltroActual;
      });

      if (!arrFiltrada.length){
        listEl.innerHTML = `<p class="muted">No hay entradas para este filtro.</p>`;
        return;
      }

      listEl.innerHTML = "";
      arrFiltrada.forEach(e=>{
        const div = document.createElement("div");
        div.className = "diario-item";
        div.innerHTML = `
          <div class="diario-item-header">
            <div><strong>${escapeHTML(e.tipo || "General")}</strong> ¬∑ ${escapeHTML(formatDate(e.fecha))}</div>
            <button class="btn btn-danger" data-action="del-diario" data-id="${escapeHTML(e.id)}">üóë</button>
          </div>
          <div class="muted">${escapeHTML(e.texto || "")}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function setupDiario(){
      document.getElementById("diarioFiltros").addEventListener("click",(ev)=>{
        const b = ev.target.closest(".pill[data-filtro]");
        if (!b) return;
        diarioFiltroActual = b.dataset.filtro;
        document.querySelectorAll("#diarioFiltros .pill").forEach(p=>p.classList.remove("pill--active"));
        b.classList.add("pill--active");
        renderDiario();
      });

      document.getElementById("btnGuardarDiario").addEventListener("click",()=>{
        const tipo = document.getElementById("diarioTipo").value || "General";
        const fecha = document.getElementById("diarioFecha").value || todayISO();
        const texto = (document.getElementById("diarioTexto").value||"").trim();
        if (!texto) { alert("Escribe algo en el diario."); return; }

        stateDiario = [{ id: uid("d"), tipo, fecha, texto }, ...stateDiario];
        saveDiario(stateDiario);

        document.getElementById("diarioTexto").value="";
        renderDiario();
        renderInicio();
        showToast("Guardado ‚úÖ");
      });

      document.getElementById("diarioList").addEventListener("click",(ev)=>{
        const b = ev.target.closest('button[data-action="del-diario"][data-id]');
        if (!b) return;
        const id = b.dataset.id;
        if (!confirm("¬øBorrar esta entrada?")) return;
        stateDiario = stateDiario.filter(e=>e.id!==id);
        saveDiario(stateDiario);
        renderDiario();
        renderInicio();
        showToast("Borrado ‚úÖ");
      });

      document.getElementById("btnExportarDiarioPdf").addEventListener("click",()=>{
        if (!window.jspdf?.jsPDF){ alert("jsPDF no carg√≥."); return; }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(12);
        doc.text(`Diario - ${stateSettings.nombreHuerto || "Mi huerto"}`, 10, 12);

        let y = 20;
        const entries = [...stateDiario].sort((a,b)=>String(b.fecha).localeCompare(String(a.fecha))).slice(0,120);
        entries.forEach(e=>{
          const line1 = `${formatDate(e.fecha)} ¬∑ ${e.tipo || "General"}`;
          const line2 = (e.texto || "").slice(0,120);
          doc.text(line1, 10, y); y += 6;
          doc.setFontSize(10);
          doc.text(line2, 10, y); y += 8;
          doc.setFontSize(12);
          if (y > 275){ doc.addPage(); y = 12; }
        });

        doc.save("mi-siembra-diario.pdf");
      });
    }

    /*********************
     * Inicio
     *********************/
    function renderInicio(){
      const cultivosCount = stateCultivos.length;
      const hoyISO = todayISO();
      const entradasHoy = stateDiario.filter(e => e.fecha === hoyISO).length;

      document.getElementById("estadoCultivosCount").textContent = String(cultivosCount);
      document.getElementById("estadoEntradasCount").textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      if (cultivosCount===0 && entradasHoy===0) resumen.textContent = 'Todav√≠a no has registrado nada. Empieza en ‚ÄúMi huerto‚Äù.';
      else if (cultivosCount>0 && entradasHoy===0) resumen.textContent = `Tienes ${cultivosCount} cultivo(s). Escribe una nota en ‚ÄúDiario‚Äù.`;
      else resumen.textContent = `Tienes ${cultivosCount} cultivo(s) y hoy registraste ${entradasHoy} entrada(s). ¬°Buen ritmo!`;

      const reminders = calcularRecordatorios();
      document.getElementById("recordatoriosChip").textContent = `${reminders.length} pendiente${reminders.length===1?"":"s"}`;
      const txt = document.getElementById("recordatoriosTxt");
      txt.textContent = reminders.length ? reminders.slice(0,3).map(r=>`‚Ä¢ ${r}`).join(" ") : "Sin recordatorios por ahora.";
    }

    /*********************
     * Plagas / Pesticidas
     *********************/
    function renderPlagas(){
      const el = document.getElementById("plagasList");
      el.innerHTML = "";
      PLAGAS_DATA.forEach(p=>{
        const div = document.createElement("div");
        div.className = "diario-item";
        div.innerHTML = `
          <div><strong>${escapeHTML(p.nombre)}</strong></div>
          <div class="muted"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.como)}</div>
          <div class="muted"><strong>Manejo:</strong> ${escapeHTML(p.manejo)}</div>
          <div class="muted"><strong>Tip:</strong> ${escapeHTML(p.tip)}</div>
        `;
        el.appendChild(div);
      });
    }
    function renderPesticidas(){
      const el = document.getElementById("pesticidasList");
      el.innerHTML = "";
      PESTICIDAS_DATA.forEach(p=>{
        const div = document.createElement("div"

/*********************
 * Diario (COMPLETO)
 *********************/
function renderDiario(){
  const listEl = document.getElementById("diarioList");
  const chip = document.getElementById("diarioCountChip");
  const resumenHoyEl = document.getElementById("diarioResumenHoy");
  if (!listEl) return;

  const arrOrdenada = [...stateDiario].sort((a,b)=> (b.fecha||"").localeCompare(a.fecha||""));
  const countTotal = arrOrdenada.length;
  if (chip) chip.textContent = `${countTotal} entrada${countTotal===1?"":"s"}`;

  // resumen de hoy
  if (resumenHoyEl) {
    const hoy = todayISO();
    const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);
    if (!hoyEntries.length) resumenHoyEl.textContent = "Hoy a√∫n no has registrado nada.";
    else {
      const tipos = {};
      hoyEntries.forEach(e => { const t = e.tipo || "General"; tipos[t] = (tipos[t]||0)+1; });
      const parts = Object.entries(tipos).map(([k,v]) => `${v} ${k}`);
      resumenHoyEl.textContent = `Hoy: ${parts.join(", ")}.`;
    }
  }

  const arrFiltrada = arrOrdenada.filter(e => {
    if (diarioFiltroActual === "todos") return true;
    return (e.tipo || "General") === diarioFiltroActual;
  });

  if (!arrFiltrada.length) {
    listEl.innerHTML = `<p class="muted">No hay entradas para el filtro seleccionado.</p>`;
    return;
  }

  listEl.innerHTML = "";
  arrFiltrada.forEach(e => {
    const div = document.createElement("div");
    div.className = "diario-item";
    div.innerHTML = `
      <div class="diario-item-header">
        <div>
          <span class="chip badge">${escapeHTML(e.tipo || "General")}</span>
          <span class="chip">${escapeHTML(formatDate(e.fecha))}</span>
        </div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btn-secondary" data-action="edit-diario" data-id="${escapeHTML(e.id)}">‚úèÔ∏è Editar</button>
          <button class="btn btn-danger" data-action="del-diario" data-id="${escapeHTML(e.id)}">üóë Borrar</button>
        </div>
      </div>
      <div class="muted" style="white-space:pre-wrap;">${escapeHTML(e.texto || "")}</div>
    `;
    listEl.appendChild(div);
  });
}

function setupDiario(){
  const btnGuardar = document.getElementById("btnGuardarDiario");
  const inputFecha = document.getElementById("diarioFecha");
  const inputTipo = document.getElementById("diarioTipo");
  const inputTexto = document.getElementById("diarioTexto");
  const filtros = document.getElementById("diarioFiltros");
  const listEl = document.getElementById("diarioList");
  const btnPdf = document.getElementById("btnExportarDiarioPdf");
  if (!btnGuardar || !inputFecha || !inputTipo || !inputTexto || !filtros || !listEl) return;

  // filtros
  if (filtros.dataset.bound !== "1") {
    filtros.dataset.bound = "1";
    filtros.addEventListener("click",(ev)=>{
      const b = ev.target.closest("button.pill[data-filtro]");
      if (!b) return;
      filtros.querySelectorAll(".pill").forEach(x=>x.classList.remove("pill--active"));
      b.classList.add("pill--active");
      diarioFiltroActual = b.dataset.filtro || "todos";
      renderDiario();
    });
  }

  // guardar / actualizar
  if (btnGuardar.dataset.bound !== "1") {
    btnGuardar.dataset.bound = "1";
    btnGuardar.addEventListener("click",()=>{
      const fecha = inputFecha.value || todayISO();
      const tipo = inputTipo.value || "General";
      const texto = (inputTexto.value||"").trim();
      if (!texto) { alert("Escribe algo para guardar."); return; }

      if (diarioEnEdicionId) {
        stateDiario = stateDiario.map(e => e.id===diarioEnEdicionId ? { ...e, fecha, tipo, texto } : e);
        diarioEnEdicionId = null;
        document.getElementById("diarioFormTitle").textContent = "Nueva entrada";
        showToast("Entrada actualizada ‚úÖ");
      } else {
        const entry = { id:`d-${Date.now().toString(36)}`, fecha, tipo, texto };
        stateDiario.unshift(entry);
        showToast("Guardado ‚úÖ");
      }

      saveDiario(stateDiario);
      inputTexto.value = "";
      renderDiario();
      renderInicio();
    });
  }

  // acciones lista (editar/borrar)
  if (listEl.dataset.bound !== "1") {
    listEl.dataset.bound = "1";
    listEl.addEventListener("click",(ev)=>{
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      if (action === "del-diario") {
        if (!confirm("¬øBorrar esta entrada del diario?")) return;
        stateDiario = stateDiario.filter(e => e.id !== id);
        saveDiario(stateDiario);
        renderDiario();
        renderInicio();
        return;
      }

      if (action === "edit-diario") {
        const e = stateDiario.find(x => x.id === id);
        if (!e) return;
        diarioEnEdicionId = id;
        document.getElementById("diarioFormTitle").textContent = "Editar entrada";
        inputFecha.value = e.fecha || todayISO();
        inputTipo.value = e.tipo || "General";
        inputTexto.value = e.texto || "";
        document.getElementById("diarioFormCard")?.scrollIntoView({behavior:"smooth", block:"start"});
        inputTexto.focus();
      }
    });
  }

  // PDF diario
  if (btnPdf && btnPdf.dataset.bound !== "1") {
    btnPdf.dataset.bound = "1";
    btnPdf.addEventListener("click", exportarDiarioPDF);
  }
}

/*********************
 * Plagas / Pesticidas (render)
 *********************/
function renderPlagas(){
  const el = document.getElementById("plagasList");
  if (!el) return;
  el.innerHTML = "";
  PLAGAS_DATA.forEach(p=>{
    const div = document.createElement("div");
    div.className = "plaga-card";
    div.innerHTML = `
      <div class="media-item-title">üêõ ${escapeHTML(p.nombre)}</div>
      <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.comoSeVe)}</div>
      <div class="media-item-body"><strong>Manejo suave:</strong> ${escapeHTML(p.manejoSuave)}</div>
      <div class="media-item-body"><strong>Casero:</strong> ${escapeHTML(p.preparadosCaseros)}</div>
      <div class="media-item-body"><strong>Comercial:</strong> ${escapeHTML(p.productosComerciales)}</div>
    `;
    el.appendChild(div);
  });
}

const PESTICIDAS_DATA = [
  { nombre:"Jab√≥n pot√°sico (diluido)", detalle:"Contra insectos blandos (pulg√≥n/mosca blanca). Aplicar al atardecer." },
  { nombre:"Aceite de neem (si tienes)", detalle:"Uso preventivo en dosis baja, evitando sol fuerte." },
  { nombre:"Bicarbonato (suave)", detalle:"Apoyo contra o√≠dio en dosis bajas + buena ventilaci√≥n." }
];

function renderPesticidas(){
  const el = document.getElementById("pesticidasList");
  if (!el) return;
  el.innerHTML = "";
  PESTICIDAS_DATA.forEach(x=>{
    const div = document.createElement("div");
    div.className = "plaga-card";
    div.innerHTML = `
      <div class="media-item-title">üíß ${escapeHTML(x.nombre)}</div>
      <div class="media-item-body">${escapeHTML(x.detalle)}</div>
    `;
    el.appendChild(div);
  });
}

/*********************
 * Cat√°logo (eventos)
 *********************/
function setupCatalogo(){
  const input = document.getElementById("catalogoBusqueda");
  const list = document.getElementById("catalogoList");
  const calendarList = document.getElementById("calendarList");
  if (!input || !list) return;

  if (input.dataset.bound !== "1") {
    input.dataset.bound = "1";
    input.addEventListener("input", ()=> renderCatalogo(input.value));
  }

  if (list.dataset.bound !== "1") {
    list.dataset.bound = "1";
    list.addEventListener("click",(ev)=>{
      const btn = ev.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;

      if (action === "germinacion") {
        const card = btn.closest(".cultivo-card");
        const panel = card?.querySelector(".germinacion-panel");
        if (!panel) return;

        const visible = panel.style.display === "block";
        if (visible) { panel.style.display = "none"; return; }

        const info = getInfoGerminacion(id);
        if (!info) { panel.innerHTML = `<p class="muted">No hay info disponible.</p>`; panel.style.display="block"; return; }

        panel.innerHTML = `
          <div class="media-item-title">üîÅ ${escapeHTML(info.titulo)}</div>
          <div class="media-item-body"><strong>M√©todo:</strong> ${escapeHTML(info.metodo)}</div>
          <div class="media-item-body"><strong>Pasos:</strong> ${escapeHTML((info.pasos||[]).join(" ‚Ä¢ "))}</div>
          <div class="media-item-body"><strong>Tip:</strong> ${escapeHTML(info.tip || "‚Äî")}</div>
        `;
        panel.style.display = "block";
        return;
      }

      if (action === "editar-custom") {
        const cultivo = CATALOGO_CULTIVOS.find(c => c.id === id);
        if (cultivo) startEditCustomCultivo(cultivo);
        return;
      }

      if (action === "borrar-custom") {
        if (!confirm("¬øBorrar este cultivo personalizado?")) return;
        deleteCustomCultivoById(id);
        renderCatalogo(input.value);
        showToast("Cultivo personalizado borrado ‚úÖ");
        return;
      }
    });
  }

  // Bot√≥n "Ver en cat√°logo" desde calendario
  if (calendarList && calendarList.dataset.bound !== "1") {
    calendarList.dataset.bound = "1";
    calendarList.addEventListener("click",(ev)=>{
      const b = ev.target.closest("button[data-action='ver-catalogo']");
      if (!b) return;
      irACultivoEnCatalogo(b.dataset.id);
    });
  }
}

/*********************
 * Calendario (meses)
 *********************/
function setupCalendario(){
  const wrap = document.getElementById("mesesPills");
  if (!wrap) return;
  if (wrap.dataset.bound === "1") return;
  wrap.dataset.bound = "1";

  const now = new Date();
  let currentMonth = now.getMonth();
  // activar pill por defecto
  wrap.querySelectorAll(".pill").forEach(p=>{
    p.classList.toggle("pill--active", parseInt(p.dataset.mes,10) === currentMonth);
  });
  renderCalendario(currentMonth);

  wrap.addEventListener("click",(ev)=>{
    const b = ev.target.closest("button.pill[data-mes]");
    if (!b) return;
    wrap.querySelectorAll(".pill").forEach(p=>p.classList.remove("pill--active"));
    b.classList.add("pill--active");
    const m = parseInt(b.dataset.mes,10);
    if (Number.isFinite(m)) renderCalendario(m);
  });
}

/*********************
 * Mi Huerto (eventos)
 *********************/
function setupMiHuerto(){
  const btn = document.getElementById("btnAgregarCultivo");
  const list = document.getElementById("cultivosList");
  if (!btn || !list) return;

  if (btn.dataset.bound !== "1") {
    btn.dataset.bound = "1";
    btn.addEventListener("click",()=>{
      const nombre = (document.getElementById("cultivoNombre")?.value||"").trim();
      if (!nombre) { alert("Escribe el nombre del cultivo."); return; }

      const variedad = (document.getElementById("cultivoVariedad")?.value||"").trim();
      const tipo = document.getElementById("cultivoTipo")?.value || "otro";
      const fechaSiembra = document.getElementById("cultivoFecha")?.value || todayISO();
      let freqR = parseInt(document.getElementById("cultivoFrecuenciaRiego")?.value||"",10);
      let freqA = parseInt(document.getElementById("cultivoFrecuenciaAbono")?.value||"",10);
      const notas = (document.getElementById("cultivoNotas")?.value||"").trim();

      // sugerencias si faltan
      const sug = getRiegoYCosechaParaNombre(nombre, fechaSiembra);
      if (!Number.isFinite(freqR) && sug.frecuenciaRiego) freqR = sug.frecuenciaRiego;

      const cultivo = {
        id:`c-${Date.now().toString(36)}`,
        nombre, variedad, tipo,
        fechaSiembra,
        frecuenciaRiegoDias: Number.isFinite(freqR) ? freqR : "",
        frecuenciaAbonoDias: Number.isFinite(freqA) ? freqA : "",
        notas,
        creadoEl: todayISO(),
        ultimoRiego: "",
        ultimaFertilizacion: "",
        fechaCosechaEstimada: sug.fechaCosechaEstimada || ""
      };

      stateCultivos.unshift(cultivo);
      saveCultivos(stateCultivos);

      // limpiar m√≠nimos
      document.getElementById("cultivoNombre").value = "";
      document.getElementById("cultivoVariedad").value = "";
      document.getElementById("cultivoNotas").value = "";

      renderCultivos();
      renderInicio();
      showToast("Cultivo guardado ‚úÖ");
    });
  }

  // acciones por cultivo
  if (list.dataset.bound !== "1") {
    list.dataset.bound = "1";
    list.addEventListener("click",(ev)=>{
      const b = ev.target.closest("button[data-action]");
      if (!b) return;
      const id = b.dataset.id;
      const action = b.dataset.action;
      const idx = stateCultivos.findIndex(c => c.id === id);
      if (idx < 0) return;

      const hoy = todayISO();

      if (action === "borrar") {
        if (!confirm("¬øEliminar este cultivo?")) return;
        stateCultivos.splice(idx,1);
        saveCultivos(stateCultivos);
        renderCultivos(); renderInicio();
        return;
      }

      if (action === "nota") {
        const nuevo = prompt("Escribe/actualiza la nota:", stateCultivos[idx].notas || "");
        if (nuevo === null) return;
        stateCultivos[idx].notas = String(nuevo);
        saveCultivos(stateCultivos);
        renderCultivos();
        showToast("Nota guardada ‚úÖ");
        return;
      }

      if (action === "riego") {
        stateCultivos[idx].ultimoRiego = hoy;
        saveCultivos(stateCultivos);
        stateDiario.unshift({ id:`d-${Date.now().toString(36)}`, fecha:hoy, tipo:"Riego", texto:`Riego: ${stateCultivos[idx].nombre}` });
        saveDiario(stateDiario);
        renderCultivos(); renderDiario(); renderInicio();
        showToast("Riego registrado üí¶");
        return;
      }

      if (action === "abono") {
        stateCultivos[idx].ultimaFertilizacion = hoy;
        saveCultivos(stateCultivos);
        stateDiario.unshift({ id:`d-${Date.now().toString(36)}`, fecha:hoy, tipo:"Abono", texto:`Abono: ${stateCultivos[idx].nombre}` });
        saveDiario(stateDiario);
        renderCultivos(); renderDiario(); renderInicio();
        showToast("Abono registrado üíß");
        return;
      }

      if (action === "plaga") {
        const txt = prompt("¬øQu√© plaga viste? (ej. pulg√≥n, mosca blanca, hongo)", "");
        if (!txt) return;
        stateDiario.unshift({ id:`d-${Date.now().toString(36)}`, fecha:hoy, tipo:"Plagas", texto:`${stateCultivos[idx].nombre}: ${txt}` });
        saveDiario(stateDiario);
        renderDiario(); renderInicio();
        showToast("Registrado üêõ");
      }
    });
  }
}

/*********************
 * Opciones + Clima (Open-Meteo)
 *********************/
function setupOpciones(){
  const nombreEl = document.getElementById("nombreHuerto");
  const climaEl = document.getElementById("climaSelect");
  const hemisEl = document.getElementById("hemisferioSelect");
  const btnGuardar = document.getElementById("btnGuardarConfig");
  const btnGeo = document.getElementById("btnPedirUbicacion");
  const btnWeather = document.getElementById("btnActualizarClima");
  const btnExportPdf = document.getElementById("btnExportarDatosPdf");
  const btnExportJson = document.getElementById("btnExportarJson");
  const btnImportJson = document.getElementById("btnImportarJson");
  const inputJson = document.getElementById("inputRespaldoJSON");
  const btnBorrar = document.getElementById("btnBorrarTodo");

  if (nombreEl) nombreEl.value = stateSettings.nombreHuerto || "Mi huerto";
  if (climaEl) climaEl.value = stateSettings.clima || "tropical";
  if (hemisEl) hemisEl.value = stateSettings.hemisferio || "norte";

  if (btnGuardar && btnGuardar.dataset.bound !== "1") {
    btnGuardar.dataset.bound = "1";
    btnGuardar.addEventListener("click",()=>{
      stateSettings.nombreHuerto = (nombreEl?.value||"Mi huerto").trim() || "Mi huerto";
      stateSettings.clima = climaEl?.value || "tropical";
      stateSettings.hemisferio = hemisEl?.value || "norte";
      saveSettings(stateSettings);
      updateHeader();
      updateSettingsContexts();
      renderInicio();
      showToast("Configuraci√≥n guardada ‚úÖ");
    });
  }

  if (btnGeo && btnGeo.dataset.bound !== "1") {
    btnGeo.dataset.bound = "1";
    btnGeo.addEventListener("click", pedirUbicacionYGuardar);
  }

  if (btnWeather && btnWeather.dataset.bound !== "1") {
    btnWeather.dataset.bound = "1";
    btnWeather.addEventListener("click", ()=> updateWeather().catch(()=>showToast("No se pudo actualizar clima")));
  }

  if (btnExportPdf && btnExportPdf.dataset.bound !== "1") {
    btnExportPdf.dataset.bound = "1";
    btnExportPdf.addEventListener("click", exportarDatosPDF);
  }

  if (btnExportJson && btnExportJson.dataset.bound !== "1") {
    btnExportJson.dataset.bound = "1";
    btnExportJson.addEventListener("click", exportarRespaldoJSON);
  }

  if (btnImportJson && inputJson && btnImportJson.dataset.bound !== "1") {
    btnImportJson.dataset.bound = "1";
    btnImportJson.addEventListener("click", ()=> inputJson.click());
    inputJson.addEventListener("change",(ev)=>{
      const file = ev.target.files?.[0];
      if (!file) return;
      importarRespaldoJSON(file);
      inputJson.value = "";
    });
  }

  if (btnBorrar && btnBorrar.dataset.bound !== "1") {
    btnBorrar.dataset.bound = "1";
    btnBorrar.addEventListener("click",()=>{
      if (!confirm("¬øBorrar TODO (cultivos, diario, ajustes y personalizados) de este dispositivo?")) return;

      localStorage.removeItem(STORAGE_KEYS.settings);
      localStorage.removeItem(STORAGE_KEYS.cultivos);
      localStorage.removeItem(STORAGE_KEYS.diario);
      localStorage.removeItem(STORAGE_CUSTOM_CULTIVOS);
      localStorage.removeItem(STORAGE_GEO);
      localStorage.removeItem(STORAGE_WEATHER);

      stateSettings = loadSettings();
      stateCultivos = loadCultivos();
      stateDiario = loadDiario();

      initCustomCultivos();
      updateHeader();
      updateSettingsContexts();
      renderInicio();
      renderCultivos();
      renderDiario();
      renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
      loadWeatherFromCache();

      showToast("Todo borrado ‚úÖ");
    });
  }
}

// clima helpers
const WEATHER_CODE_LABEL = {
  0:"Despejado", 1:"Mayormente despejado", 2:"Parcial nublado", 3:"Nublado",
  45:"Niebla", 48:"Niebla",
  51:"Llovizna", 53:"Llovizna", 55:"Llovizna",
  61:"Lluvia", 63:"Lluvia", 65:"Lluvia fuerte",
  80:"Chubascos", 81:"Chubascos", 82:"Chubascos fuertes",
  95:"Tormenta"
};

function setWeatherUI(text, status="ok"){
  document.getElementById("climaAhoraChip")?.textContent = text || "Clima: ‚Äî";
  const s = document.getElementById("climaStatusChip");
  if (s) s.textContent = status==="ok" ? "Listo" : (status==="warn" ? "Sin ubicaci√≥n" : "Error");
}

function loadWeatherFromCache(){
  const cached = loadJSON(STORAGE_WEATHER, null);
  if (!cached || typeof cached !== "object") { setWeatherUI("Clima: ‚Äî","warn"); return; }
  if (!cached.text) { setWeatherUI("Clima: ‚Äî","warn"); return; }
  setWeatherUI(cached.text, "ok");
}

async function pedirUbicacionYGuardar(){
  if (!("geolocation" in navigator)) { alert("Tu navegador no soporta geolocalizaci√≥n."); return; }

  setWeatherUI("Clima: obteniendo ubicaci√≥n‚Ä¶","warn");

  const pos = await new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy:false, timeout:12000, maximumAge: 600000 });
  }).catch(()=>null);

  if (!pos?.coords) { setWeatherUI("Clima: sin ubicaci√≥n","warn"); return; }

  const lat = Number(pos.coords.latitude);
  const lon = Number(pos.coords.longitude);

  let label = "";
  try {
    const url = `https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=es&format=json`;
    const r = await fetch(url);
    const j = await r.json();
    const place = j?.results?.[0];
    if (place) label = [place.name, place.admin1].filter(Boolean).join(", ");
  } catch {}

  saveGeo({ lat, lon, label });
  showToast("Ubicaci√≥n guardada ‚úÖ");
  await updateWeather().catch(()=>{});
}

async function updateWeather(){
  const geo = loadGeo();
  if (!geo) { setWeatherUI("Clima: usa ubicaci√≥n","warn"); return; }

  setWeatherUI("Clima: actualizando‚Ä¶","warn");

  const url = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,precipitation,weather_code&timezone=auto`;
  const r = await fetch(url);
  const j = await r.json();
  const cur = j?.current;
  if (!cur) { setWeatherUI("Clima: error","err"); return; }

  const t = cur.temperature_2m;
  const p = cur.precipitation;
  const code = cur.weather_code;
  const desc = WEATHER_CODE_LABEL[code] || "Clima";
  const place = geo.label ? ` ¬∑ ${geo.label}` : "";
  const text = `Clima: ${Math.round(t)}¬∞C ¬∑ ${desc} ¬∑ lluvia ${p}mm${place}`;

  saveJSON(STORAGE_WEATHER, { text, ts: Date.now() });
  setWeatherUI(text, "ok");
  showToast("Clima actualizado ‚òÅÔ∏è");
}

/*********************
 * Export / Import
 *********************/
function downloadFile(filename, content, mime){
  const blob = new Blob([content], { type: mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

function exportarRespaldoJSON(){
  const data = {
    version:"v18",
    settings: loadSettings(),
    cultivos: loadCultivos(),
    diario: loadDiario(),
    customCultivos: loadCustomCultivos(),
    geo: loadGeo(),
    weather: loadJSON(STORAGE_WEATHER, null)
  };
  downloadFile(`msi-respaldo-${todayISO()}.json`, JSON.stringify(data,null,2), "application/json");
  showToast("Respaldo exportado ‚úÖ");
}

async function importarRespaldoJSON(file){
  try {
    const text = await file.text();
    const data = JSON.parse(text);

    if (data.settings) saveSettings(data.settings);
    if (Array.isArray(data.cultivos)) saveCultivos(data.cultivos);
    if (Array.isArray(data.diario)) saveDiario(data.diario);
    if (Array.isArray(data.customCultivos)) saveCustomCultivos(data.customCultivos);
    if (data.geo && Number.isFinite(data.geo.lat) && Number.isFinite(data.geo.lon)) saveGeo(data.geo);
    if (data.weather && typeof data.weather === "object") saveJSON(STORAGE_WEATHER, data.weather);

    // recargar estado en memoria
    stateSettings = loadSettings();
    stateCultivos = loadCultivos();
    stateDiario = loadDiario();
    initCustomCultivos();

    updateHeader();
    updateSettingsContexts();
    renderInicio();
    renderCultivos();
    renderDiario();
    renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
    loadWeatherFromCache();

    showToast("Respaldo restaurado ‚úÖ");
  } catch {
    alert("Ese archivo no parece un respaldo v√°lido.");
  }
}

// PDF (diario)
function exportarDiarioPDF(){

    /*********************
     * Diario (completa)
     *********************/
    function renderDiario(){
      const listEl = document.getElementById("diarioList");
      const chip = document.getElementById("diarioCountChip");
      const resumenHoyEl = document.getElementById("diarioResumenHoy");
      if (!listEl) return;

      const arrOrdenada = [...stateDiario].sort((a,b)=> (b.fecha||"").localeCompare(a.fecha||""));
      const countTotal = arrOrdenada.length;
      if (chip) chip.textContent = `${countTotal} entrada${countTotal===1?"":"s"}`;

      // Resumen hoy
      if (resumenHoyEl) {
        const hoy = todayISO();
        const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);
        if (!hoyEntries.length) resumenHoyEl.textContent = "Hoy a√∫n no has registrado nada.";
        else {
          const tipos = {};
          hoyEntries.forEach(e => { const t = e.tipo || "General"; tipos[t] = (tipos[t]||0) + 1; });
          const parts = Object.entries(tipos).map(([k,v]) => `${v} ${k}`);
          resumenHoyEl.textContent = `Hoy: ${parts.join(", ")}.`;
        }
      }

      const arrFiltrada = arrOrdenada.filter(e => {
        if (diarioFiltroActual === "todos") return true;
        return (e.tipo || "General") === diarioFiltroActual;
      });

      if (!arrFiltrada.length) {
        listEl.innerHTML = `<p class="muted">No hay entradas para el filtro seleccionado.</p>`;
        return;
      }

      listEl.innerHTML = "";
      arrFiltrada.forEach(e => {
        const card = document.createElement("div");
        card.className = "diario-item";
        card.innerHTML = `
          <div class="diario-item-header">
            <div>
              <div style="font-weight:600">${escapeHTML(e.tipo || "General")}</div>
              <div class="muted">${escapeHTML(formatDate(e.fecha))}</div>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-secondary" data-action="editar-diario" data-id="${escapeHTML(e.id)}">‚úèÔ∏è</button>
              <button class="btn btn-danger" data-action="borrar-diario" data-id="${escapeHTML(e.id)}">üóë</button>
            </div>
          </div>
          <div>${escapeHTML(e.texto || "")}</div>
        `;
        listEl.appendChild(card);
      });
    }

    /*********************
     * Plagas y pesticidas (render)
     *********************/
    const PESTICIDAS_DATA = [
      { nombre:"Jab√≥n pot√°sico", uso:"Pulgones, mosca blanca, cochinillas (contacto).", nota:"Aplicar al atardecer y repetir 3‚Äì5 d√≠as si hace falta." },
      { nombre:"Aceite de neem", uso:"Repelente/antialimentario (plagas suaves).", nota:"No aplicar a pleno sol. Probar en pocas hojas primero." },
      { nombre:"Bicarbonato (suave)", uso:"O√≠dio/manchas leves (preventivo).", nota:"Dosis baja y no abusar. Mejor con buena ventilaci√≥n." },
      { nombre:"Trampas amarillas", uso:"Mosca blanca, minadores (monitoreo).", nota:"√ötiles para controlar poblaci√≥n y medir actividad." }
    ];

    function renderPlagas(){
      const el = document.getElementById("plagasList");
      if (!el) return;
      el.innerHTML = "";
      PLAGAS_DATA.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card";
        div.innerHTML = `
          <div class="media-item-title">üêõ ${escapeHTML(p.nombre)}</div>
          <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${escapeHTML(p.comoSeVe)}</div>
          <div class="media-item-body"><strong>Manejo suave:</strong> ${escapeHTML(p.manejoSuave)}</div>
          <div class="media-item-body"><strong>Casero:</strong> ${escapeHTML(p.preparadosCaseros)}</div>
          <div class="media-item-body"><strong>Comercial:</strong> ${escapeHTML(p.productosComerciales)}</div>
        `;
        el.appendChild(div);
      });
    }

    function renderPesticidas(){
      const el = document.getElementById("pesticidasList");
      if (!el) return;
      el.innerHTML = "";
      PESTICIDAS_DATA.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card";
        div.innerHTML = `
          <div class="media-item-title">üíß ${escapeHTML(p.nombre)}</div>
          <div class="media-item-body"><strong>Uso:</strong> ${escapeHTML(p.uso)}</div>
          <div class="media-item-body"><strong>Nota:</strong> ${escapeHTML(p.nota)}</div>
        `;
        el.appendChild(div);
      });
    }

    /*********************
     * NAV
     *********************/
    function setupNav(){
      const nav = document.querySelector(".nav");
      if (!nav || nav.dataset.bound === "1") return;
      nav.dataset.bound = "1";

      nav.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button.nav-btn[data-section]");
        if (!btn) return;
        const target = btn.dataset.section;

        document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("nav-btn--active"));
        btn.classList.add("nav-btn--active");

        document.querySelectorAll(".section").forEach(s => s.classList.remove("section--active"));
        document.getElementById(`section-${target}`)?.classList.add("section--active");

        // renders suaves al entrar
        if (target === "inicio") renderInicio();
        if (target === "huerto") renderCultivos();
        if (target === "diario") renderDiario();
        if (target === "catalogo") renderCatalogo((document.getElementById("catalogoBusqueda")?.value||"").trim());
        if (target === "plagas") renderPlagas();
        if (target === "pesticidas") renderPesticidas();
      });
    }

    /*********************
     * Calendario
     *********************/
    function setupCalendario(){
      const wrap = document.getElementById("mesesPills");
      if (!wrap || wrap.dataset.bound === "1") return;
      wrap.dataset.bound = "1";

      // seleccionar mes actual al entrar
      const nowM = new Date().getMonth();
      const pills = wrap.querySelectorAll("button.pill[data-mes]");
      pills.forEach(p => p.classList.remove("pill--active"));
      wrap.querySelector(`button.pill[data-mes="${nowM}"]`)?.classList.add("pill--active");
      renderCalendario(nowM);

      wrap.addEventListener("click", (ev) => {
        const b = ev.target.closest("button.pill[data-mes]");
        if (!b) return;
        pills.forEach(p => p.classList.remove("pill--active"));
        b.classList.add("pill--active");
        const m = parseInt(b.dataset.mes,10);
        if (Number.isFinite(m)) renderCalendario(m);
      });

      // bot√≥n ‚ÄúVer en cat√°logo‚Äù dentro del calendario
      document.getElementById("calendarList")?.addEventListener("click", (ev) => {
        const b = ev.target.closest("button[data-action='ver-catalogo'][data-id]");
        if (!b) return;
        irACultivoEnCatalogo(b.dataset.id);
      });
    }

    /*********************
     * Cat√°logo (events)
     *********************/
    function setupCatalogo(){
      const input = document.getElementById("catalogoBusqueda");
      const list = document.getElementById("catalogoList");
      if (input && input.dataset.bound !== "1"){
        input.dataset.bound = "1";
        input.addEventListener("input", () => renderCatalogo(input.value));
      }

      if (!list || list.dataset.bound === "1") return;
      list.dataset.bound = "1";

      list.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button[data-action][data-id]");
        if (!btn) return;
        const action = btn.dataset.action;
        const id = btn.dataset.id;

        if (action === "germinacion"){
          const card = btn.closest(".cultivo-card");
          const panel = card?.querySelector(".germinacion-panel");
          if (!panel) return;

          const info = getInfoGerminacion(id);
          if (!info) { showToast("No hay info de germinaci√≥n"); return; }

          const visible = panel.style.display === "block";
          if (visible){ panel.style.display = "none"; panel.innerHTML = ""; return; }

          panel.style.display = "block";
          panel.innerHTML = `
            <div style="font-weight:600;margin-bottom:6px;">${escapeHTML(info.titulo)}</div>
            <div><strong>M√©todo:</strong> ${escapeHTML(info.metodo)}</div>
            <div style="margin-top:6px;"><strong>Pasos:</strong></div>
            <ul style="margin:6px 0 0 18px;">
              ${(info.pasos||[]).map(x=>`<li>${escapeHTML(x)}</li>`).join("")}
            </ul>
            <div style="margin-top:6px;"><strong>Tip:</strong> ${escapeHTML(info.tip||"‚Äî")}</div>
          `;
          return;
        }

        if (action === "editar-custom"){
          const customList = loadCustomCultivos();
          const cultivo = customList.find(c => c.id === id);
          if (cultivo) startEditCustomCultivo(cultivo);
          return;
        }

        if (action === "borrar-custom"){
          if (confirm("¬øBorrar este cultivo personalizado?")) {
            deleteCustomCultivoById(id);
            renderCatalogo((document.getElementById("catalogoBusqueda")?.value || "").trim());
            showToast("Borrado ‚úÖ");
          }
          return;
        }
      });
    }

    /*********************
     * Mi huerto (events)
     *********************/
    function setupMiHuerto(){
      const btn = document.getElementById("btnAgregarCultivo");
      const list = document.getElementById("cultivosList");
      if (btn && btn.dataset.bound !== "1"){
        btn.dataset.bound = "1";
        btn.addEventListener("click", () => {
          const nombre = (document.getElementById("cultivoNombre")?.value||"").trim();
          if (!nombre) { alert("Escribe el nombre del cultivo."); return; }

          const variedad = (document.getElementById("cultivoVariedad")?.value||"").trim();
          const tipo = document.getElementById("cultivoTipo")?.value || "otro";
          const fechaSiembra = document.getElementById("cultivoFecha")?.value || todayISO();
          const frecR = Number(document.getElementById("cultivoFrecuenciaRiego")?.value || "");
          const frecA = Number(document.getElementById("cultivoFrecuenciaAbono")?.value || "");
          const notas = (document.getElementById("cultivoNotas")?.value||"").trim();

          const { fechaCosechaEstimada } = getRiegoYCosechaParaNombre(nombre, fechaSiembra);

          const item = {
            id: `c-${Date.now().toString(36)}`,
            nombre, variedad, tipo,
            fechaSiembra,
            frecuenciaRiegoDias: Number.isFinite(frecR) && frecR>0 ? frecR : null,
            frecuenciaAbonoDias: Number.isFinite(frecA) && frecA>0 ? frecA : null,
            ultimoRiego: null,
            ultimaFertilizacion: null,
            fechaCosechaEstimada: fechaCosechaEstimada || null,
            notas,
            creadoEl: todayISO()
          };

          stateCultivos = [...stateCultivos, item];
          saveCultivos(stateCultivos);

          // limpiar
          document.getElementById("cultivoNombre").value = "";
          document.getElementById("cultivoVariedad").value = "";
          document.getElementById("cultivoFrecuenciaRiego").value = "";
          document.getElementById("cultivoFrecuenciaAbono").value = "";
          document.getElementById("cultivoNotas").value = "";

          renderCultivos();
          renderInicio();
          showToast("Cultivo guardado ‚úÖ");
        });
      }

      if (!list || list.dataset.bound === "1") return;
      list.dataset.bound = "1";

      list.addEventListener("click", (ev) => {
        const btn = ev.target.closest("button[data-action][data-id]");
        if (!btn) return;
        const id = btn.dataset.id;
        const action = btn.dataset.action;
        const idx = stateCultivos.findIndex(x => x.id === id);
        if (idx < 0) return;

        const c = stateCultivos[idx];

        if (action === "nota"){
          const n = prompt("Editar notas:", c.notas || "");
          if (n === null) return;
          c.notas = n.trim();
        }

        if (action === "riego"){
          c.ultimoRiego = todayISO();
        }

        if (action === "abono"){
          c.ultimaFertilizacion = todayISO();
        }

        if (action === "plaga"){
          const n = prompt("Anota plaga observada:", "");
          if (n && n.trim()) {
            // tambi√©n al diario
            stateDiario.push({ id:`d-${Date.now().toString(36)}`, tipo:"Plagas", fecha: todayISO(), texto:`${c.nombre}: ${n.trim()}` });
            saveDiario(stateDiario);
          }
        }

        if (action === "borrar"){
          if (!confirm(`¬øEliminar "${c.nombre}"?`)) return;
          stateCultivos.splice(idx,1);
        }

        saveCultivos(stateCultivos);
        renderCultivos();
        renderInicio();
      });
    }

    /*********************
     * Diario (events)
     *********************/
    function setupDiario(){
      const btn = document.getElementById("btnGuardarDiario");
      const list = document.getElementById("diarioList");
      const filtros = document.getElementById("diarioFiltros");
      const btnPdf = document.getElementById("btnExportarDiarioPdf");

      if (btn && btn.dataset.bound !== "1"){
        btn.dataset.bound = "1";
        btn.addEventListener("click", () => {
          const tipo = document.getElementById("diarioTipo")?.value || "General";
          const fecha = document.getElementById("diarioFecha")?.value || todayISO();
          const texto = (document.getElementById("diarioTexto")?.value||"").trim();
          if (!texto) { alert("Escribe algo para el diario."); return; }

          // si est√°s editando
          if (diarioEnEdicionId){
            const i = stateDiario.findIndex(x=>x.id===diarioEnEdicionId);
            if (i>=0){
              stateDiario[i] = { ...stateDiario[i], tipo, fecha, texto };
            }
            diarioEnEdicionId = null;
            document.getElementById("diarioFormTitle").textContent = "Nueva entrada";
          } else {
            stateDiario.push({ id:`d-${Date.now().toString(36)}`, tipo, fecha, texto });
          }

          saveDiario(stateDiario);
          document.getElementById("diarioTexto").value = "";
          renderDiario();
          renderInicio();
          showToast("Diario guardado ‚úÖ");
        });
      }

      if (filtros && filtros.dataset.bound !== "1"){
        filtros.dataset.bound = "1";
        filtros.addEventListener("click",(ev)=>{
          const b = ev.target.closest("button.pill[data-filtro]");
          if (!b) return;
          document.querySelectorAll("#diarioFiltros .pill").forEach(x=>x.classList.remove("pill--active"));
          b.classList.add("pill--active");
          diarioFiltroActual = b.dataset.filtro;
          renderDiario();
        });
      }

      if (list && list.dataset.bound !== "1"){
        list.dataset.bound = "1";
        list.addEventListener("click",(ev)=>{
          const b = ev.target.closest("button[data-action][data-id]");
          if (!b) return;
          const id = b.dataset.id;
          const act = b.dataset.action;
          const i = stateDiario.findIndex(x=>x.id===id);
          if (i<0) return;

          if (act === "borrar-diario"){
            if (!confirm("¬øBorrar esta entrada?")) return;
            stateDiario.splice(i,1);
            saveDiario(stateDiario);
            renderDiario();
            renderInicio();
            return;
          }

          if (act === "editar-diario"){
            const e = stateDiario[i];
            diarioEnEdicionId = e.id;
            document.getElementById("diarioTipo").value = e.tipo || "General";
            document.getElementById("diarioFecha").value = e.fecha || todayISO();
            document.getElementById("diarioTexto").value = e.texto || "";
            document.getElementById("diarioFormTitle").textContent = "Editar entrada";
            document.getElementById("diarioTexto")?.focus();
            return;
          }
        });
      }

      if (btnPdf && btnPdf.dataset.bound !== "1"){
        btnPdf.dataset.bound = "1";
        btnPdf.addEventListener("click", exportDiarioPDF);
      }
    }

    /*********************
     * Export PDF (simple)
     *********************/
    function exportDiarioPDF(){
      const jspdf = window.jspdf?.jsPDF;
      if (!jspdf) { alert("jsPDF no carg√≥."); return; }
      const doc = new jspdf({ unit:"pt", format:"letter" });

      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text("Mi Siembra Inteligente - Diario", 40, 50);

      doc.setFont("helvetica","normal");
      doc.setFontSize(11);

      const arr = [...stateDiario].sort((a,b)=> (b.fecha||"").localeCompare(a.fecha||""));
      let y = 80;

      arr.forEach(e=>{
        const header = `${e.fecha || ""} ¬∑ ${e.tipo || "General"}`;
        const body = e.texto || "";
        const lines = doc.splitTextToSize(body, 520);

        if (y > 740){ doc.addPage(); y = 50; }

        doc.setFont("helvetica","bold");
        doc.text(header, 40, y); y += 16;
        doc.setFont("helvetica","normal");

        lines.forEach(line=>{
          if (y > 740){ doc.addPage(); y = 50; }
          doc.text(line, 40, y); y += 14;
        });

        y += 10;
      });

      doc.save("mi-siembra-diario.pdf");
    }

    /*********************
     * Opciones + Clima (Open-Meteo)
     *********************/
    function loadWeatherFromCache(){
      const w = loadJSON(STORAGE_WEATHER, null);
      if (!w || typeof w !== "object") return;
      const chip = document.getElementById("climaAhoraChip");
      if (chip && w.tempC != null) chip.textContent = `Clima: ${Math.round(w.tempC)}¬∞C`;
    }

    async function updateWeather(){
      const geo = loadGeo();
      if (!geo) { showToast("Primero guarda tu ubicaci√≥n üìç"); return; }

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${geo.lat}&longitude=${geo.lon}&current=temperature_2m,precipitation&timezone=auto`;
      const res = await fetch(url, { cache:"no-store" });
      if (!res.ok) throw new Error("Weather fetch error");
      const data = await res.json();

      const tempC = data?.current?.temperature_2m;
      saveJSON(STORAGE_WEATHER, { tempC, at: Date.now(), label: geo.label || "" });

      const chip = document.getElementById("climaAhoraChip");
      if (chip && tempC != null) chip.textContent = `Clima: ${Math.round(tempC)}¬∞C`;

      const st = document.getElementById("climaStatusChip");
      if (st) st.textContent = "OK ‚úÖ";

      showToast("Clima actualizado ‚úÖ");
    }

    function pedirUbicacion(){
      if (!navigator.geolocation) { alert("Geolocalizaci√≥n no disponible."); return; }

      const st = document.getElementById("climaStatusChip");
      if (st) st.textContent = "Buscando...";

      navigator.geolocation.getCurrentPosition((pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const geo = { lat, lon, label:"" };
        saveGeo(geo);
        if (st) st.textContent = "Guardada üìç";
        showToast("Ubicaci√≥n guardada ‚úÖ");
      }, ()=>{
        if (st) st.textContent = "Error";
        alert("No se pudo obtener ubicaci√≥n.");
      }, { enableHighAccuracy:false, timeout:10000 });
    }

    function setupOpciones(){
      const nombre = document.getElementById("nombreHuerto");
      const clima = document.getElementById("climaSelect");
      const hemi = document.getElementById("hemisferioSelect");

      if (nombre) nombre.value = stateSettings.nombreHuerto || "";
      if (clima) clima.value = stateSettings.clima || "tropical";
      if (hemi) hemi.value = stateSettings.hemisferio || "norte";

      const btnSave = document.getElementById("btnGuardarConfig");
      if (btnSave && btnSave.dataset.bound !== "1"){
        btnSave.dataset.bound = "1";
        btnSave.addEventListener("click", ()=>{
          stateSettings = {
            nombreHuerto: (nombre?.value || "Mi huerto").trim() || "Mi huerto",
            clima: clima?.value || "tropical",
            hemisferio: hemi?.value || "norte"
          };
          saveSettings(stateSettings);
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          showToast("Configuraci√≥n guardada ‚úÖ");
        });
      }

      const b1 = document.getElementById("btnPedirUbicacion");
      if (b1 && b1.dataset.bound !== "1"){
        b1.dataset.bound = "1";
        b1.addEventListener("click", pedirUbicacion);
      }

      const b2 = document.getElementById("btnActualizarClima");
      if (b2 && b2.dataset.bound !== "1"){
        b2.dataset.bound = "1";
        b2.addEventListener("click", ()=> updateWeather().catch(()=>showToast("No se pudo actualizar clima")));
      }

      const btnExportJson = document.getElementById("btnExportarJson");
      if (btnExportJson && btnExportJson.dataset.bound !== "1"){
        btnExportJson.dataset.bound = "1";
        btnExportJson.addEventListener("click", ()=>{
          const payload = {
            settings: stateSettings,
            cultivos: stateCultivos,
            diario: stateDiario,
            customCultivos: loadCustomCultivos(),
            geo: loadGeo()
          };
          const blob = new Blob([JSON.stringify(payload,null,2)], { type:"application/json" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "mi-siembra-respaldo.json";
          a.click();
          URL.revokeObjectURL(a.href);
        });
      }

      const input = document.getElementById("inputRespaldoJSON");
      const btnImport = document.getElementById("btnImportarJson");
      if (btnImport && input && btnImport.dataset.bound !== "1"){
        btnImport.dataset.bound = "1";
        btnImport.addEventListener("click", ()=> input.click());
        input.addEventListener("change", async ()=>{
          const file = input.files?.[0];
          if (!file) return;
          try {
            const txt = await file.text();
            const obj = JSON.parse(txt);

            if (obj.settings) { stateSettings = { ...DEFAULT_SETTINGS, ...obj.settings }; saveSettings(stateSettings); }
            if (Array.isArray(obj.cultivos)) { stateCultivos = obj.cultivos; saveCultivos(stateCultivos); }
            if (Array.isArray(obj.diario)) { stateDiario = obj.diario; saveDiario(stateDiario); }
            if (Array.isArray(obj.customCultivos)) { saveCustomCultivos(obj.customCultivos); injectCustomIntoCatalogo(obj.customCultivos); }
            if (obj.geo && typeof obj.geo === "object") { saveGeo(obj.geo); }

            updateHeader();
            updateSettingsContexts();
            renderInicio();
            renderCultivos();
            renderDiario();
            renderCatalogo("");
            showToast("Respaldo restaurado ‚úÖ");
          } catch {
            alert("Respaldo inv√°lido.");
          } finally {
            input.value = "";
          }
        });
      }

      const btnBorrar = document.getElementById("btnBorrarTodo");
      if (btnBorrar && btnBorrar.dataset.bound !== "1"){
        btnBorrar.dataset.bound = "1";
        btnBorrar.addEventListener("click", ()=>{
          if (!confirm("¬øBorrar TODO (cultivos, diario, config y personalizados)?")) return;
          localStorage.removeItem(STORAGE_KEYS.settings);
          localStorage.removeItem(STORAGE_KEYS.cultivos);
          localStorage.removeItem(STORAGE_KEYS.diario);
          localStorage.removeItem(STORAGE_CUSTOM_CULTIVOS);
          localStorage.removeItem(STORAGE_GEO);
          localStorage.removeItem(STORAGE_WEATHER);

          stateSettings = loadSettings();
          stateCultivos = loadCultivos();
          stateDiario = loadDiario();

          injectCustomIntoCatalogo(loadCustomCultivos());
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          renderCultivos();
          renderDiario();
          renderCatalogo("");
          loadWeatherFromCache();

          showToast("Todo borrado ‚úÖ");
        });
      }
    }

    /*********************
     * PWA install banner
     *********************/
    let deferredPrompt = null;
    function setupPwaInstall(){
      const banner = document.getElementById("installBanner");
      const btn = document.getElementById("btnInstalarPwa");
      if (!banner || !btn) return;

      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        banner.classList.remove("hidden");
      });

      if (btn.dataset.bound !== "1") {
        btn.dataset.bound = "1";
        btn.addEventListener("click", async () => {
          if (!deferredPrompt) return;
          deferredPrompt.prompt();
          try { await deferredPrompt.userChoice; } catch {}
          deferredPrompt = null;
          banner.classList.add("hidden");
        });
      }

      window.addEventListener("appinstalled", () => {
        banner.classList.add("hidden");
        deferredPrompt = null;
        showToast("Instalada ‚úÖ");
      });

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("sw.js").catch(()=>{});
      }
    }

    /*********************
     * INIT
     *********************/
    function initDefaults(){
      const f1 = document.getElementById("cultivoFecha");
      if (f1 && !f1.value) f1.value = todayISO();

      const f2 = document.getElementById("diarioFecha");
      if (f2 && !f2.value) f2.value = todayISO();
    }

    document.addEventListener("DOMContentLoaded", () => {
      bindToastClose();

      stateSettings = loadSettings();
      stateCultivos = loadCultivos();
      stateDiario = loadDiario();

      updateHeader();
      updateSettingsContexts();

      initCustomCultivos();

      setupNav();
      setupCalendario();
      setupCatalogo();
      setupMiHuerto();
      setupDiario();
      setupOpciones();
      setupPwaInstall();
      initDefaults();

      renderInicio();
      renderCultivos();
      renderDiario();
      renderCatalogo("");
      renderPlagas();
      renderPesticidas();

      loadWeatherFromCache();
      if (loadGeo()) updateWeather().catch(()=>{});
    });

<!-- FIN PARTE 2 -->
          </script>
