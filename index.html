<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente </title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #02081f;
      --card: #02081f;
      --card-soft: #030919;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: rgba(34, 197, 94, 0.4);
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --border-strong: rgba(148, 163, 184, 0.6);
      --danger: #f97373;
      --radius-lg: 18px;
      --radius-xl: 22px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: var(--bg);
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 880px; /* se adapta a m√≥viles pero tambi√©n se ve bien en tablet */
      min-height: 100vh;
      padding: 10px 10px 24px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 16px 16px 32px;
      }
    }

    /* HEADER ------------------------------------------------------------ */

    .app-header {
      background: radial-gradient(circle at top left, #16a34a, #166534 45%, #020617);
      border-radius: 32px;
      padding: 18px 18px 16px;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .app-title-main {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .app-logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 20% 0%, #bbf7d0, #22c55e 40%, #14532d 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.65);
    }

    .app-logo span {
      font-size: 24px;
    }

    .app-title-text {
      display: flex;
      flex-direction: column;
    }

    .app-title-text strong {
      font-size: 1.05rem;
      letter-spacing: 0.02em;
    }

    .app-title-text span {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .app-version {
      font-size: 0.7rem;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.35);
      background: rgba(15, 23, 42, 0.35);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .app-subtitle {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #e5e7eb;
      opacity: 0.9;
    }

    .app-subtitle span {
      opacity: 0.85;
    }

    /* NAV --------------------------------------------------------------- */

    .main-nav {
      background: rgba(15, 23, 42, 0.85);
      border-radius: 26px;
      padding: 6px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    @media (min-width: 640px) {
      .main-nav {
        grid-template-columns: repeat(8, 1fr);
      }
    }

    .tab-btn {
      border-radius: 20px;
      border: 1px solid transparent;
      padding: 6px 6px 5px;
      font-size: 0.75rem;
      background: transparent;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      transition: 0.15s ease-out;
    }

    .tab-btn span.icon {
      font-size: 1.2rem;
      line-height: 1;
    }

    .tab-btn span.label {
      font-size: 0.7rem;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top center, var(--accent-strong), var(--accent-soft));
      color: #ecfdf5;
      border-color: rgba(34, 197, 94, 0.8);
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.6);
    }

    .tab-btn:active {
      transform: scale(0.97);
    }

    /* MAIN -------------------------------------------------------------- */

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    .view {
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .view.active {
      display: flex;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), var(--card));
      border-radius: var(--radius-xl);
      padding: 14px 14px 13px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
    }

    .card + .card {
      margin-top: 2px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
      font-weight: 600;
    }

    .card-title span.icon {
      font-size: 1.1rem;
    }

    .card-subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .pill {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.7);
      color: #e5e7eb;
      white-space: nowrap;
    }

    .pill.accent {
      border-color: rgba(34, 197, 94, 0.8);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 4px 0 10px;
    }

    .stat-pill {
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.75rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.75);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .stat-pill strong {
      font-weight: 600;
    }

    .stat-pill span.badge {
      min-width: 18px;
      text-align: center;
      padding: 1px 5px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(34, 197, 94, 0.9);
      color: #bbf7d0;
      font-size: 0.7rem;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 7px 13px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      transition: 0.15s ease-out;
    }

    .btn.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(22, 163, 74, 0.55);
    }

    .btn.primary:active {
      transform: scale(0.97);
      box-shadow: 0 6px 14px rgba(22, 163, 74, 0.65);
    }

    .btn.soft {
      background: rgba(15, 23, 42, 0.9);
      border-color: var(--border-subtle);
    }

    .btn.full {
      width: 100%;
      justify-content: center;
    }

    .btn-icon {
      font-size: 1rem;
    }

    .quick-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    @media (min-width: 480px) {
      .quick-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .btn.chip {
      padding: 8px 10px;
      font-size: 0.78rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      justify-content: flex-start;
    }

    .btn.chip span.icon {
      font-size: 1.05rem;
    }

    p {
      margin: 4px 0;
      font-size: 0.82rem;
      color: var(--text-soft);
      line-height: 1.4;
    }

    h2.section-title {
      margin: 2px 2px 4px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* CALENDARIO -------------------------------------------------------- */

    .month-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0 10px;
    }

    .month-chip {
      padding: 4px 9px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
    }

    .month-chip.active {
      border-color: rgba(34, 197, 94, 0.9);
      background: var(--accent-soft);
      color: #bbf7d0;
    }

    .crops-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 8px;
      margin-top: 4px;
    }

    @media (min-width: 520px) {
      .crops-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .crop-card {
      border-radius: 16px;
      padding: 8px 9px;
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.98), var(--card-soft));
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
    }

    .crop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      margin-bottom: 3px;
    }

    .crop-name {
      font-weight: 600;
      font-size: 0.8rem;
    }

    .crop-tag {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.8);
      background: rgba(22, 163, 74, 0.12);
      color: #bbf7d0;
      white-space: nowrap;
    }

    .crop-meta {
      font-size: 0.73rem;
      color: var(--text-soft);
    }

    /* MI HUERTO --------------------------------------------------------- */

    .huerto-empty {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .huerto-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    @media (min-width: 520px) {
      .huerto-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .huerto-card {
      border-radius: 18px;
      padding: 9px 10px;
      background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.12), var(--card-soft));
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .huerto-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .huerto-header-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .huerto-icon {
      font-size: 1rem;
    }

    .huerto-name {
      font-weight: 600;
      font-size: 0.82rem;
    }

    .huerto-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .huerto-badge {
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 0.72rem;
      color: var(--text-soft);
    }

    .huerto-line {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .huerto-actions {
      display: flex;
      justify-content: flex-end;
      gap: 4px;
      margin-top: 4px;
    }

    .btn-xs {
      padding: 3px 7px;
      font-size: 0.7rem;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
    }

    .btn-xs.danger {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fecaca;
    }

    /* FORMULARIOS ------------------------------------------------------- */

    .form-grid {
      display: grid;
      grid-template-columns: repeat(1, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    @media (min-width: 520px) {
      .form-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.78rem;
    }

    .form-field label {
      color: var(--text-soft);
    }

    .form-field input,
    .form-field select,
    .form-field textarea {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.95);
      color: #f9fafb;
      padding: 7px 10px;
      font-size: 0.8rem;
      outline: none;
    }

    .form-field textarea {
      border-radius: 14px;
      resize: vertical;
      min-height: 56px;
      line-height: 1.35;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 9px;
      justify-content: flex-end;
    }

    /* DIARIO ------------------------------------------------------------ */

    .diario-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .diario-entry {
      border-radius: 16px;
      padding: 7px 9px;
      background: var(--card-soft);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
    }

    .diario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .diario-date {
      font-weight: 600;
      font-size: 0.8rem;
    }

    .diario-tag {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.12);
    }

    .diario-text {
      white-space: pre-wrap;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .empty-note {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* PLAGAS & PESTICIDAS ----------------------------------------------- */

    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 6px 0 6px;
    }

    .search-row input {
      flex: 1;
      min-width: 0;
    }

    .result-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .result-card {
      border-radius: 16px;
      padding: 8px 9px;
      background: var(--card-soft);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-bottom: 2px;
    }

    .result-name {
      font-weight: 600;
      font-size: 0.8rem;
    }

    .result-tag {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      color: var(--text-soft);
    }

    /* GUIAS ------------------------------------------------------------- */

    .guides-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .guide-item {
      border-radius: 16px;
      padding: 8px 9px;
      background: var(--card-soft);
      border: 1px solid var(--border-subtle);
      font-size: 0.78rem;
    }

    .guide-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 0.8rem;
    }

    /* FOOTER ------------------------------------------------------------ */

    .app-footer {
      margin-top: 10px;
      font-size: 0.72rem;
      color: var(--text-soft);
      text-align: center;
      opacity: 0.85;
    }

    .app-footer span.leaf {
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-title-row">
        <div class="app-title-main">
          <div class="app-logo">
            <span>üå±</span>
          </div>
          <div class="app-title-text">
            <strong>Mi Siembra Inteligente</strong>
            <span id="header-subtitle-smafont>Tu asistente de huerto</span>
          </div>
        </div>
        <div class="app-version">v16</div>
      </div>
      <div class="app-subtitle" id="header-subtitle">
        Huerto "<span id="header-huerto-nombre">Mi huerto</span>" ¬∑
        clima <span id="header-clima-label">tropical</span> ¬∑
        hemisferio <span id="header-hemisferio-label">norte</span>
      </div>
    </header>

    <nav class="main-nav">
      <button class="tab-btn active" data-view="inicio">
        <span class="icon">üè†</span>
        <span class="label">Inicio</span>
      </button>
      <button class="tab-btn" data-view="calendario">
        <span class="icon">üìÖ</span>
        <span class="label">Calendario</span>
      </button>
      <button class="tab-btn" data-view="huerto">
        <span class="icon">üåø</span>
        <span class="label">Mi huerto</span>
      </button>
      <button class="tab-btn" data-view="diario">
        <span class="icon">üìì</span>
        <span class="label">Diario</span>
      </button>
      <button class="tab-btn" data-view="plagas">
        <span class="icon">üêõ</span>
        <span class="label">Plagas</span>
      </button>
      <button class="tab-btn" data-view="pesticidas">
        <span class="icon">üíß</span>
        <span class="label">Pesticidas</span>
      </button>
      <button class="tab-btn" data-view="opciones">
        <span class="icon">‚öôÔ∏è</span>
        <span class="label">Opciones</span>
      </button>
      <button class="tab-btn" data-view="guias">
        <span class="icon">üìö</span>
        <span class="label">Gu√≠as</span>
      </button>
    </nav>

    <main>
      <!-- INICIO ------------------------------------------------------- -->
      <section class="view active" id="view-inicio">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚ú®</span>
              <span>Inicio</span>
            </div>
            <span class="pill" id="inicio-fecha-hoy"></span>
          </div>
          <p>Resumen r√°pido de tu huerto y acceso a las funciones principales.</p>
          <div class="stats-row">
            <div class="stat-pill">
              Cultivos <span class="badge" id="inicio-cultivos-count">0</span>
            </div>
            <div class="stat-pill">
              Entradas diario <span class="badge" id="inicio-diario-count">0</span>
            </div>
            <div class="stat-pill">
              Clima <span class="badge" id="inicio-clima-badge">tropical</span>
            </div>
          </div>
          <p id="inicio-resumen">
            A√∫n no has registrado cultivos ni notas en el diario hoy.
          </p>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìÜ</span>
              <span>Hoy en el calendario</span>
            </div>
            <span class="pill" id="inicio-mes-actual"></span>
          </div>
          <p id="inicio-calendario-text">
            En este mes no hay recomendaciones espec√≠ficas, pero puedes usar el calendario para revisar otros meses.
          </p>
          <button class="btn primary full" id="btn-ir-calendario">
            <span class="btn-icon">üìÖ</span>
            Ver calendario
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üöÄ</span>
              <span>Accesos r√°pidos</span>
            </div>
          </div>
          <div class="quick-grid">
            <button class="btn chip" id="btn-registrar-cultivo">
              <span class="icon">üåø</span>
              <span>Registrar cultivo</span>
            </button>
            <button class="btn chip" id="btn-nueva-nota">
              <span class="icon">‚úèÔ∏è</span>
              <span>Nueva nota</span>
            </button>
            <button class="btn chip" id="btn-buscar-plaga">
              <span class="icon">üêõ</span>
              <span>Buscar plaga</span>
            </button>
            <button class="btn chip" id="btn-ajustar-clima">
              <span class="icon">‚öôÔ∏è</span>
              <span>Ajustar clima</span>
            </button>
          </div>
        </div>
      </section>

      <!-- CALENDARIO ---------------------------------------------------- -->
      <section class="view" id="view-calendario">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìÖ</span>
              <span>Calendario de siembra</span>
            </div>
            <span class="pill" id="calendario-clima-pill">Clima tropical</span>
          </div>
          <p>
            Selecciona un mes para ver sugerencias de cultivos seg√∫n tu clima actual.
            Son recomendaciones generales; ajusta seg√∫n tu experiencia local.
          </p>
          <div class="month-selector" id="month-selector"></div>
          <div id="calendario-contenido">
            <p class="empty-note">
              Selecciona un mes para ver las tarjetas de cultivos recomendados.
            </p>
          </div>
        </div>
      </section>

      <!-- MI HUERTO ----------------------------------------------------- -->
      <section class="view" id="view-huerto">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üåø</span>
              <span>Mi huerto</span>
            </div>
            <span class="pill" id="huerto-count-pill">0 cultivos</span>
          </div>
          <p>
            Aqu√≠ llevas el control de lo que tienes sembrado: nombre, variedad, fecha de siembra,
            ubicaci√≥n y notas r√°pidas.
          </p>

          <h2 class="section-title">Agregar cultivo</h2>
          <div class="form-grid">
            <div class="form-field">
              <label for="cultivo-nombre">Cultivo</label>
              <input id="cultivo-nombre" type="text" placeholder="Ej. Tomate, lechuga..." />
            </div>
            <div class="form-field">
              <label for="cultivo-variedad">Variedad (opcional)</label>
              <input id="cultivo-variedad" type="text" placeholder="Ej. Roma, iceberg..." />
            </div>
            <div class="form-field">
              <label for="cultivo-fecha">Fecha de siembra</label>
              <input id="cultivo-fecha" type="date" />
            </div>
            <div class="form-field">
              <label for="cultivo-ubicacion">Ubicaci√≥n / cama</label>
              <input id="cultivo-ubicacion" type="text" placeholder="Maceta, cama 1, bancal..." />
            </div>
            <div class="form-field">
              <label for="cultivo-cantidad">Cantidad de plantas</label>
              <input id="cultivo-cantidad" type="number" min="1" step="1" placeholder="Ej. 4" />
            </div>
            <div class="form-field">
              <label for="cultivo-notas">Notas</label>
              <textarea
                id="cultivo-notas"
                placeholder="Riego, fertilizante, exposici√≥n al sol, etc."
              ></textarea>
            </div>
          </div>
          <div class="form-row">
            <button class="btn soft" id="btn-limpiar-cultivo">Limpiar</button>
            <button class="btn primary" id="btn-guardar-cultivo">
              <span class="btn-icon">üíæ</span>
              Guardar cultivo
            </button>
          </div>

          <h2 class="section-title">Cultivos registrados</h2>
          <div id="huerto-lista">
            <p class="huerto-empty">
              A√∫n no has registrado cultivos. Usa el formulario de arriba para a√±adir tu primera siembra.
            </p>
          </div>
        </div>
      </section>

      <!-- DIARIO -------------------------------------------------------- -->
      <section class="view" id="view-diario">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìì</span>
              <span>Diario de huerto</span>
            </div>
            <span class="pill" id="diario-count-pill">0 entradas</span>
          </div>
          <p>
            Registra riegos, fertilizaciones, plagas, cosechas o cualquier detalle importante
            del d√≠a a d√≠a.
          </p>
          <div class="form-grid">
            <div class="form-field">
              <label for="diario-fecha">Fecha</label>
              <input id="diario-fecha" type="date" />
            </div>
            <div class="form-field">
              <label for="diario-titulo">T√≠tulo breve</label>
              <input id="diario-titulo" type="text" placeholder="Ej. Riego profundo, cosecha de tomates..." />
            </div>
            <div class="form-field" style="grid-column: 1 / -1;">
              <label for="diario-texto">Detalle</label>
              <textarea
                id="diario-texto"
                placeholder="Describe qu√© hiciste hoy en el huerto."
              ></textarea>
            </div>
          </div>
          <div class="form-row">
            <button class="btn soft" id="btn-limpiar-diario">Limpiar</button>
            <button class="btn primary" id="btn-guardar-diario">
              <span class="btn-icon">üíæ</span>
              Guardar entrada
            </button>
          </div>

          <h2 class="section-title">Entradas recientes</h2>
          <div id="diario-lista">
            <p class="empty-note">
              A√∫n no has escrito nada en el diario. Empieza con una nota r√°pida.
            </p>
          </div>
        </div>
      </section>

      <!-- PLAGAS -------------------------------------------------------- -->
      <section class="view" id="view-plagas">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üêõ</span>
              <span>Plagas comunes</span>
            </div>
          </div>
          <p>Busca por nombre com√∫n (ej. pulgones, gusano, cochinilla).</p>
          <div class="search-row">
            <div class="form-field" style="flex: 1; min-width: 0;">
              <label for="plagas-buscar">Buscar plaga</label>
              <input id="plagas-buscar" type="text" placeholder="Ej. Pulgones, mosca blanca..." />
            </div>
            <button class="btn soft" id="btn-limpiar-plagas">Limpiar</button>
          </div>
          <div id="plagas-resultados" class="result-list">
            <!-- Se llena por JS -->
          </div>
        </div>
      </section>

      <!-- PESTICIDAS ---------------------------------------------------- -->
      <section class="view" id="view-pesticidas">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üíß</span>
              <span>Pesticidas y controles</span>
            </div>
          </div>
          <p>
            Informaci√≥n general y de referencia. Verifica siempre las etiquetas y las regulaciones
            de tu pa√≠s antes de aplicar cualquier producto.
          </p>

          <div class="search-row">
            <div class="form-field" style="flex: 1; min-width: 0;">
              <label for="pesticidas-buscar">Buscar por nombre o tipo</label>
              <input id="pesticidas-buscar" type="text" placeholder="Ej. jab√≥n pot√°sico, cobre..." />
            </div>
            <button class="btn soft" id="btn-limpiar-pesticidas">Limpiar</button>
          </div>

          <div id="pesticidas-resultados" class="result-list">
            <!-- Se llena por JS -->
          </div>
        </div>
      </section>

      <!-- OPCIONES ------------------------------------------------------ -->
      <section class="view" id="view-opciones">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚öôÔ∏è</span>
              <span>Opciones</span>
            </div>
            <span class="pill" id="opciones-resumen-pill">Configuraci√≥n b√°sica</span>
          </div>

          <h2 class="section-title">Datos generales</h2>
          <div class="form-grid">
            <div class="form-field">
              <label for="opt-nombre-huerto">Nombre de huerto</label>
              <input
                id="opt-nombre-huerto"
                type="text"
                placeholder="Ej. Huerto de la terraza"
              />
            </div>
            <div class="form-field">
              <label for="opt-clima">Clima</label>
              <select id="opt-clima">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="form-field">
              <label for="opt-hemisferio">Hemisferio</label>
              <select id="opt-hemisferio">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <div class="form-row" style="margin-top: 10px;">
            <button class="btn primary" id="btn-guardar-opciones">
              <span class="btn-icon">üíæ</span>
              Guardar configuraci√≥n
            </button>
          </div>

          <h2 class="section-title">Datos y almacenamiento</h2>
          <p>
            Toda la informaci√≥n se guarda <strong>solo en tu dispositivo</strong> usando almacenamiento local.
            Puedes borrar los datos si quieres empezar desde cero.
          </p>
          <div class="form-row">
            <button class="btn soft" id="btn-exportar-datos">Exportar datos (texto)</button>
            <button class="btn soft" id="btn-borrar-datos-todo">
              <span class="btn-icon">üßπ</span>
              Borrar todo
            </button>
          </div>
        </div>
      </section>

      <!-- GUIAS --------------------------------------------------------- -->
      <section class="view" id="view-guias">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìö</span>
              <span>Gu√≠as r√°pidas</span>
            </div>
          </div>
          <p>
            Peque√±as gu√≠as para recordar lo b√°sico: riego, luz, sustratos y rotaci√≥n de cultivos.
          </p>
          <div class="guides-list" id="guias-lista">
            <!-- Contenido por JS -->
          </div>
        </div>
      </section>
    </main>

    <footer class="app-footer">
      Mi Siembra Inteligente ¬∑ Datos guardados localmente en tu dispositivo
      <span class="leaf">üåø</span>
    </footer>
  </div>

  <script>
    // ------------------------- DATOS BASE ----------------------------------

    const STORAGE_KEYS = {
      SETTINGS: ['msi_settings', 'miSiembraSettings'],
      HUERTO: ['msi_huerto', 'miHuertoCultivos'],
      DIARIO: ['msi_diario', 'miSiembraDiario'],
    };

    const CLIMAS = {
      tropical: 'tropical',
      subtropical: 'subtropical/templado',
      templado: 'templado/fr√≠o',
    };

    const calendarioDatos = {
      // Mes: 0 = enero ...
      tropical: {
        0: [
          { nombre: 'Tomate', tipo: 'Hortaliza', metodo: 'Semillero protegido', nota: 'Ideal para trasplantar en febrero-marzo.' },
          { nombre: 'Pimiento', tipo: 'Hortaliza', metodo: 'Semillero', nota: 'Necesita calor constante.' },
          { nombre: 'Lechuga', tipo: 'Hoja', metodo: 'Siembra directa o bandeja', nota: 'Tolera algo de sombra.' },
        ],
        1: [
          { nombre: 'Calabac√≠n', tipo: 'Fruto', metodo: 'Siembra directa', nota: 'Suelo rico en materia org√°nica.' },
          { nombre: 'Habichuelas', tipo: 'Leguminosa', metodo: 'Directa', nota: 'Evita encharcamientos.' },
        ],
        2: [
          { nombre: 'Pepinillo', tipo: 'Fruto', metodo: 'Directa o semillero', nota: 'Requiere buena cantidad de agua.' },
          { nombre: 'Ma√≠z tierno', tipo: 'Cereal', metodo: 'Hilera directa', nota: 'Siembra en bloques para mejor polinizaci√≥n.' },
        ],
        3: [
          { nombre: 'Yaut√≠a / malanga', tipo: 'Rizoma', metodo: 'Trozo de cormo', nota: 'Buena √©poca para establecer.' },
          { nombre: 'Batata', tipo: 'Tub√©rculo', metodo: 'Estacas o bejucos', nota: 'Muy resistente a la sequ√≠a.' },
        ],
        4: [
          { nombre: 'Aj√≠ dulce', tipo: 'Hortaliza', metodo: 'Trasplante', nota: 'Protege del sol intenso las primeras semanas.' },
          { nombre: 'Cilantrillo', tipo: 'Arom√°tica', metodo: 'Siembra directa', nota: 'Siembra escalonada cada 2‚Äì3 semanas.' },
        ],
        5: [
          { nombre: 'Quimbomb√≥', tipo: 'Fruto', metodo: 'Directa', nota: 'Resiste altas temperaturas.' },
          { nombre: 'Mel√≥n', tipo: 'Fruto', metodo: 'Directa', nota: 'Necesita pleno sol y buen drenaje.' },
        ],
        6: [
          { nombre: 'Re-siembra de lechugas', tipo: 'Hoja', metodo: 'Bandeja o directa', nota: 'Buscar algo de sombra en verano fuerte.' },
          { nombre: 'R√°banos', tipo: 'Ra√≠z', metodo: 'Directa', nota: 'Cosecha muy r√°pida (20‚Äì30 d√≠as).' },
        ],
        7: [
          { nombre: 'Repollo', tipo: 'Hortaliza', metodo: 'Semillero', nota: 'Pensando en cosechas de finales de a√±o.' },
          { nombre: 'Br√≥coli', tipo: 'Hortaliza', metodo: 'Semillero', nota: 'Prefiere temperaturas m√°s suaves.' },
        ],
        8: [
          { nombre: 'Zanahoria', tipo: 'Ra√≠z', metodo: 'Directa', nota: 'Suelo suelto, sin piedras.' },
          { nombre: 'Remolacha', tipo: 'Ra√≠z', metodo: 'Directa', nota: 'Admite algo de sombra parcial.' },
        ],
        9: [
          { nombre: 'Cebolla', tipo: 'Bulbo', metodo: 'Semillero', nota: 'Trasplante cuando tengan grosor de l√°piz.' },
          { nombre: 'Ajo (en zonas frescas)', tipo: 'Bulbo', metodo: 'Diente', nota: 'Mejor en lugares algo m√°s frescos del patio.' },
        ],
        10: [
          { nombre: 'Arvejas / guisantes', tipo: 'Leguminosa', metodo: 'Directa', nota: 'Les gusta el clima m√°s fresco.' },
          { nombre: 'Espinaca', tipo: 'Hoja', metodo: 'Directa', nota: 'Requiere humedad constante.' },
        ],
        11: [
          { nombre: 'Cilantro', tipo: 'Arom√°tica', metodo: 'Directa', nota: 'Menos propenso a espigarse con clima fresco.' },
          { nombre: 'Lechugas de invierno', tipo: 'Hoja', metodo: 'Directa', nota: 'Buen mes para escalonar siembras.' },
        ],
      },
      // Por ahora reutilizamos la misma base para otros climas
      subtropical: {},
      templado: {},
    };

    // rellenar subtropical y templado con mismo contenido por defecto
    ['subtropical', 'templado'].forEach((cl) => {
      calendarioDatos[cl] = calendarioDatos.tropical;
    });

    const plagasBase = [
      {
        nombre: 'Pulgones',
        tipo: 'Insecto chupador',
        sintomas: 'Brote nuevo deformado, melaza pegajosa y hormigas asociadas.',
        control: 'Jab√≥n pot√°sico, extracto de neem, control de hormigas.',
      },
      {
        nombre: 'Mosca blanca',
        tipo: 'Insecto chupador',
        sintomas: 'Peque√±as moscas blancas al mover la planta, hojas amarillentas.',
        control: 'Trampas crom√°ticas amarillas y jab√≥n pot√°sico.',
      },
      {
        nombre: 'Cochinilla algodonosa',
        tipo: 'Insecto chupador',
        sintomas: 'Bultitos blancos algodonosos en tallos y env√©s de hojas.',
        control: 'Algod√≥n con alcohol, jab√≥n pot√°sico, mejorar ventilaci√≥n.',
      },
      {
        nombre: 'Orugas defoliadoras',
        tipo: 'Larva de mariposa',
        sintomas: 'Hojas con mordidas grandes, excrementos oscuros.',
        control: 'Revisi√≥n manual, Bacillus thuringiensis (Bt) en casos severos.',
      },
    ];

    const pesticidasBase = [
      {
        nombre: 'Jab√≥n pot√°sico',
        tipo: 'Insecticida suave',
        uso: 'Pulgones, mosca blanca, cochinillas j√≥venes.',
        nota: 'Aplicar al atardecer y nunca a pleno sol fuerte.',
      },
      {
        nombre: 'Aceite de neem',
        tipo: 'Insecticida-acaricida',
        uso: 'Amplio espectro sobre insectos chupadores.',
        nota: 'No usar en floraci√≥n si hay abejas; seguir siempre la etiqueta.',
      },
      {
        nombre: 'Bacillus thuringiensis (Bt)',
        tipo: 'Biol√≥gico',
        uso: 'Orugas defoliadoras en hortalizas.',
        nota: 'Solo afecta a larvas de lepid√≥pteros; muy espec√≠fico.',
      },
      {
        nombre: 'Cobre (caldo bordel√©s, oxicloruro)',
        tipo: 'Fungicida',
        uso: 'Hongos en tomate, papa y frutales.',
        nota: 'Usar con moderaci√≥n; puede acumularse en el suelo.',
      },
    ];

    const guiasBase = [
      {
        titulo: 'Riego b√°sico en macetas',
        texto:
          'Introduce el dedo 2‚Äì3 cm en el sustrato: si est√° seco, riega hasta que salga agua por debajo. Evita dejar agua estancada en los platos.',
      },
      {
        titulo: 'Luz para hortalizas',
        texto:
          'Hortalizas de fruto (tomate, pimiento, berenjena) necesitan 6‚Äì8 horas de sol directo. Hortalizas de hoja aceptan algo de sombra parcial.',
      },
      {
        titulo: 'Rotaci√≥n sencilla de cultivos',
        texto:
          'Alterna ra√≠ces, hojas, frutos y leguminosas para aprovechar mejor nutrientes y reducir plagas. Ej: tomate ‚Üí habichuelas ‚Üí lechuga ‚Üí zanahoria.',
      },
    ];

    // ------------------------- UTILIDADES STORAGE -------------------------

    function loadJsonFromKeys(keyList, defaultValue) {
      for (const key of keyList) {
        try {
          const raw = localStorage.getItem(key);
          if (raw) return JSON.parse(raw);
        } catch (e) {
          console.warn('Error leyendo', key, e);
        }
      }
      return defaultValue;
    }

    function saveJsonToFirstKey(keyList, value) {
      const key = keyList[0];
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn('Error guardando', key, e);
      }
    }

    // ------------------------- ESTADO GLOBAL -----------------------------

    let settings = {
      nombreHuerto: 'Mi huerto',
      clima: 'tropical',
      hemisferio: 'norte',
    };

    let huerto = [];
    let diario = [];

    // ------------------------- INICIALIZACI√ìN ----------------------------

    function initFromStorage() {
      const storedSettings = loadJsonFromKeys(STORAGE_KEYS.SETTINGS, null);
      if (storedSettings) {
        settings = Object.assign(settings, storedSettings);
      }

      huerto = loadJsonFromKeys(STORAGE_KEYS.HUERTO, []);
      diario = loadJsonFromKeys(STORAGE_KEYS.DIARIO, []);

      // normalizar posibles objetos antiguos
      huerto = Array.isArray(huerto) ? huerto : [];
      diario = Array.isArray(diario) ? diario : [];
    }

    function saveSettings() {
      saveJsonToFirstKey(STORAGE_KEYS.SETTINGS, settings);
    }

    function saveHuerto() {
      saveJsonToFirstKey(STORAGE_KEYS.HUERTO, huerto);
    }

    function saveDiario() {
      saveJsonToFirstKey(STORAGE_KEYS.DIARIO, diario);
    }

    // ------------------------- RENDER HEADER & INICIO --------------------

    function renderHeader() {
      const nombre = settings.nombreHuerto || 'Mi huerto';
      document.getElementById('header-huerto-nombre').textContent = nombre;

      const climaLabel = CLIMAS[settings.clima] || CLIMAS.tropical;
      document.getElementById('header-clima-label').textContent = climaLabel;

      const hemiLabel = settings.hemisferio === 'sur' ? 'sur' : 'norte';
      document.getElementById('header-hemisferio-label').textContent = hemiLabel;

      const subtitleSmall = `Huerto "${nombre}"`;
      document.getElementById('header-subtitle-small').textContent = subtitleSmall;
    }

    function formatDateFriendly(dateObj) {
      const opt = { weekday: 'short', day: 'numeric', month: 'short' };
      return dateObj.toLocaleDateString('es-PR', opt);
    }

    function getTodayISO() {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60 * 1000);
      return local.toISOString().slice(0, 10);
    }

    function renderInicio() {
      const hoy = new Date();
      document.getElementById('inicio-fecha-hoy').textContent = formatDateFriendly(hoy);

      document.getElementById('inicio-cultivos-count').textContent = huerto.length.toString();
      document.getElementById('inicio-diario-count').textContent = diario.length.toString();

      const climaLabel = CLIMAS[settings.clima] || CLIMAS.tropical;
      document.getElementById('inicio-clima-badge').textContent = climaLabel;

      const mes = hoy.toLocaleDateString('es-PR', { month: 'long' });
      document.getElementById('inicio-mes-actual').textContent =
        mes.charAt(0).toUpperCase() + mes.slice(1);

      let resumen;
      if (!huerto.length && !diario.length) {
        resumen = 'A√∫n no has registrado cultivos ni notas en el diario.';
      } else if (huerto.length && !diario.length) {
        resumen = `Tienes ${huerto.length} cultivo(s) registrado(s). Puedes a√±adir notas en el diario para llevar un mejor seguimiento.`;
      } else if (!huerto.length && diario.length) {
        resumen = `Tienes ${diario.length} entrada(s) en el diario. Cuando registres cultivos, ver√°s aqu√≠ el resumen r√°pido.`;
      } else {
        resumen = `Tienes ${huerto.length} cultivo(s) y ${diario.length} entrada(s) en el diario.`;
      }
      document.getElementById('inicio-resumen').textContent = resumen;

      // mini texto de recomendaciones para el mes actual
      const mesIndex = hoy.getMonth();
      const lista = (calendarioDatos[settings.clima] || calendarioDatos.tropical)[mesIndex] || [];
      const textoCal = document.getElementById('inicio-calendario-text');
      if (!lista.length) {
        textoCal.textContent =
          'En este mes no hay recomendaciones espec√≠ficas configuradas. Usa el calendario para revisar otros meses.';
      } else {
        const nombres = lista
          .slice(0, 4)
          .map((c) => c.nombre)
          .join(', ');
        textoCal.textContent = `En este mes suelen sembrarse: ${nombres}. Abre el calendario para ver las tarjetas completas.`;
      }
    }

    // ------------------------- CALENDARIO --------------------------------

    function renderMonthSelector() {
      const cont = document.getElementById('month-selector');
      cont.innerHTML = '';
      const meses = [
        'Ene',
        'Feb',
        'Mar',
        'Abr',
        'May',
        'Jun',
        'Jul',
        'Ago',
        'Sep',
        'Oct',
        'Nov',
        'Dic',
      ];
      const current = new Date().getMonth();

      meses.forEach((m, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'month-chip' + (idx === current ? ' active' : '');
        btn.textContent = m;
        btn.dataset.month = idx;
        btn.addEventListener('click', () => {
          Array.from(cont.children).forEach((c) => c.classList.remove('active'));
          btn.classList.add('active');
          renderCalendarioMes(idx);
        });
        cont.appendChild(btn);
      });

      // render mes actual
      renderCalendarioMes(current);
    }

    function renderCalendarioMes(mesIndex) {
      const climaData = calendarioDatos[settings.clima] || calendarioDatos.tropical;
      const lista = climaData[mesIndex] || [];
      const cont = document.getElementById('calendario-contenido');
      const climaLabel = CLIMAS[settings.clima] || CLIMAS.tropical;
      document.getElementById('calendario-clima-pill').textContent = `Clima ${climaLabel}`;

      if (!lista.length) {
        cont.innerHTML =
          '<p class="empty-note">A√∫n no hay tarjetas cargadas para este mes en este clima.</p>';
        return;
      }

      const wrapper = document.createElement('div');
      const grid = document.createElement('div');
      grid.className = 'crops-grid';

      lista.forEach((crop) => {
        const card = document.createElement('div');
        card.className = 'crop-card';

        const header = document.createElement('div');
        header.className = 'crop-header';

        const name = document.createElement('div');
        name.className = 'crop-name';
        name.textContent = crop.nombre;

        const tag = document.createElement('div');
        tag.className = 'crop-tag';
        tag.textContent = crop.tipo;

        header.appendChild(name);
        header.appendChild(tag);

        const meta = document.createElement('div');
        meta.className = 'crop-meta';
        meta.textContent = `${crop.metodo} ¬∑ ${crop.nota}`;

        card.appendChild(header);
        card.appendChild(meta);
        grid.appendChild(card);
      });

      wrapper.appendChild(grid);
      cont.innerHTML = '';
      cont.appendChild(wrapper);
    }

    // ------------------------- MI HUERTO ---------------------------------

    function renderHuerto() {
      const cont = document.getElementById('huerto-lista');
      const pill = document.getElementById('huerto-count-pill');
      pill.textContent = `${huerto.length} cultivo(s)`;

      if (!huerto.length) {
        cont.innerHTML =
          '<p class="huerto-empty">A√∫n no has registrado cultivos. Usa el formulario de arriba.</p>';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'huerto-grid';

      huerto.forEach((item, index) => {
        // intentamos leer campos est√°ndar y algunos nombres alternos
        const nombre =
          item.nombre ||
          item.cultivo ||
          item.cropName ||
          item.nombreCultivo ||
          'Cultivo sin nombre';

        const variedad = item.variedad || item.variety || '';
        const fecha =
          item.fechaSiembra || item.fecha || item.date || item.fechaRegistro || '';
        const ubicacion = item.ubicacion || item.sector || item.location || '';
        const cantidad =
          item.cantidadPlantas || item.cantidad || item.plantas || item.numPlantas || '';
        const notas = item.notas || item.nota || item.notes || '';

        const card = document.createElement('div');
        card.className = 'huerto-card';

        const header = document.createElement('div');
        header.className = 'huerto-header';

        const left = document.createElement('div');
        left.className = 'huerto-header-left';

        const icon = document.createElement('div');
        icon.className = 'huerto-icon';
        icon.textContent = 'üåø';

        const nameEl = document.createElement('div');
        nameEl.className = 'huerto-name';
        nameEl.textContent = nombre;

        left.appendChild(icon);
        left.appendChild(nameEl);

        const right = document.createElement('div');
        right.className = 'pill';
        right.textContent = fecha || 'Sin fecha';

        header.appendChild(left);
        header.appendChild(right);

        const badges = document.createElement('div');
        badges.className = 'huerto-badges';

        if (variedad) {
          const b = document.createElement('span');
          b.className = 'huerto-badge';
          b.textContent = `Variedad: ${variedad}`;
          badges.appendChild(b);
        }
        if (ubicacion) {
          const b = document.createElement('span');
          b.className = 'huerto-badge';
          b.textContent = `Ubicaci√≥n: ${ubicacion}`;
          badges.appendChild(b);
        }
        if (cantidad) {
          const b = document.createElement('span');
          b.className = 'huerto-badge';
          b.textContent = `Plantas: ${cantidad}`;
          badges.appendChild(b);
        }

        const lineNotas = document.createElement('div');
        lineNotas.className = 'huerto-line';
        lineNotas.textContent = notas ? notas : 'Sin notas adicionales.';

        const actions = document.createElement('div');
        actions.className = 'huerto-actions';

        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn-xs danger';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => {
          if (confirm(`¬øEliminar "${nombre}" del huerto?`)) {
            huerto.splice(index, 1);
            saveHuerto();
            renderHuerto();
            renderInicio();
          }
        });

        actions.appendChild(btnEliminar);

        card.appendChild(header);
        card.appendChild(badges);
        card.appendChild(lineNotas);
        card.appendChild(actions);

        grid.appendChild(card);
      });

      cont.innerHTML = '';
      cont.appendChild(grid);
    }

    function limpiarFormularioCultivo() {
      document.getElementById('cultivo-nombre').value = '';
      document.getElementById('cultivo-variedad').value = '';
      document.getElementById('cultivo-fecha').value = getTodayISO();
      document.getElementById('cultivo-ubicacion').value = '';
      document.getElementById('cultivo-cantidad').value = '';
      document.getElementById('cultivo-notas').value = '';
    }

    function guardarCultivoDesdeFormulario() {
      const nombre = document.getElementById('cultivo-nombre').value.trim();
      if (!nombre) {
        alert('Escribe al menos el nombre del cultivo.');
        return;
      }
      const nuevo = {
        id: Date.now(),
        nombre,
        variedad: document.getElementById('cultivo-variedad').value.trim(),
        fechaSiembra: document.getElementById('cultivo-fecha').value || getTodayISO(),
        ubicacion: document.getElementById('cultivo-ubicacion').value.trim(),
        cantidadPlantas: document.getElementById('cultivo-cantidad').value.trim(),
        notas: document.getElementById('cultivo-notas').value.trim(),
      };
      huerto.push(nuevo);
      saveHuerto();
      renderHuerto();
      renderInicio();
      limpiarFormularioCultivo();
    }

    // ------------------------- DIARIO -----------------------------------

    function renderDiario() {
      const cont = document.getElementById('diario-lista');
      const pill = document.getElementById('diario-count-pill');
      pill.textContent = `${diario.length} entrada(s)`;

      if (!diario.length) {
        cont.innerHTML =
          '<p class="empty-note">A√∫n no has escrito nada en el diario.</p>';
        return;
      }

      const list = document.createElement('div');
      list.className = 'diario-list';

      // ordenar descendente por fecha
      const copia = [...diario].sort((a, b) => (a.fecha > b.fecha ? -1 : 1));

      copia.forEach((item, idx) => {
        const entry = document.createElement('div');
        entry.className = 'diario-entry';

        const header = document.createElement('div');
        header.className = 'diario-header';

        const dateEl = document.createElement('div');
        dateEl.className = 'diario-date';
        dateEl.textContent = item.fecha || 'Sin fecha';

        const tag = document.createElement('div');
        tag.className = 'diario-tag';
        tag.textContent = item.titulo || 'Entrada';

        header.appendChild(dateEl);
        header.appendChild(tag);

        const text = document.createElement('div');
        text.className = 'diario-text';
        text.textContent = item.texto || '';

        const actions = document.createElement('div');
        actions.className = 'huerto-actions';

        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn-xs danger';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => {
          if (confirm('¬øEliminar esta entrada del diario?')) {
            const realIndex = diario.findIndex((d) => d.id === item.id);
            if (realIndex >= 0) diario.splice(realIndex, 1);
            saveDiario();
            renderDiario();
            renderInicio();
          }
        });

        actions.appendChild(btnEliminar);

        entry.appendChild(header);
        entry.appendChild(text);
        entry.appendChild(actions);

        list.appendChild(entry);
      });

      cont.innerHTML = '';
      cont.appendChild(list);
    }

    function limpiarFormularioDiario() {
      document.getElementById('diario-fecha').value = getTodayISO();
      document.getElementById('diario-titulo').value = '';
      document.getElementById('diario-texto').value = '';
    }

    function guardarDiarioDesdeFormulario() {
      const texto = document.getElementById('diario-texto').value.trim();
      const titulo =
        document.getElementById('diario-titulo').value.trim() || 'Entrada';
      if (!texto) {
        alert('Escribe algo en el detalle del diario.');
        return;
      }
      const entrada = {
        id: Date.now(),
        fecha: document.getElementById('diario-fecha').value || getTodayISO(),
        titulo,
        texto,
      };
      diario.push(entrada);
      saveDiario();
      renderDiario();
      renderInicio();
      limpiarFormularioDiario();
    }

    // ------------------------- PLAGAS & PESTICIDAS ----------------------

    function filtrarPorTexto(lista, query) {
      if (!query) return lista;
      const q = query.toLowerCase();
      return lista.filter((item) => {
        return (
          (item.nombre && item.nombre.toLowerCase().includes(q)) ||
          (item.tipo && item.tipo.toLowerCase().includes(q)) ||
          (item.uso && item.uso.toLowerCase().includes(q)) ||
          (item.sintomas && item.sintomas.toLowerCase().includes(q))
        );
      });
    }

    function renderPlagas() {
      const q = document.getElementById('plagas-buscar').value.trim();
      const lista = filtrarPorTexto(plagasBase, q);
      const cont = document.getElementById('plagas-resultados');
      cont.innerHTML = '';

      if (!lista.length) {
        cont.innerHTML =
          '<p class="empty-note">No hay resultados con ese t√©rmino.</p>';
        return;
      }

      lista.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'result-card';

        const header = document.createElement('div');
        header.className = 'result-header';

        const name = document.createElement('div');
        name.className = 'result-name';
        name.textContent = p.nombre;

        const tag = document.createElement('div');
        tag.className = 'result-tag';
        tag.textContent = p.tipo;

        header.appendChild(name);
        header.appendChild(tag);

        const sintomas = document.createElement('div');
        sintomas.className = 'diario-text';
        sintomas.textContent = `S√≠ntomas: ${p.sintomas}`;

        const control = document.createElement('div');
        control.className = 'diario-text';
        control.textContent = `Control sugerido: ${p.control}`;

        card.appendChild(header);
        card.appendChild(sintomas);
        card.appendChild(control);

        cont.appendChild(card);
      });
    }

    function renderPesticidas() {
      const q = document.getElementById('pesticidas-buscar').value.trim();
      const lista = filtrarPorTexto(pesticidasBase, q);
      const cont = document.getElementById('pesticidas-resultados');
      cont.innerHTML = '';

      if (!lista.length) {
        cont.innerHTML =
          '<p class="empty-note">No hay resultados con ese t√©rmino.</p>';
        return;
      }

      lista.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'result-card';

        const header = document.createElement('div');
        header.className = 'result-header';

        const name = document.createElement('div');
        name.className = 'result-name';
        name.textContent = p.nombre;

        const tag = document.createElement('div');
        tag.className = 'result-tag';
        tag.textContent = p.tipo;

        header.appendChild(name);
        header.appendChild(tag);

        const uso = document.createElement('div');
        uso.className = 'diario-text';
        uso.textContent = `Uso frecuente: ${p.uso}`;

        const nota = document.createElement('div');
        nota.className = 'diario-text';
        nota.textContent = `Nota: ${p.nota}`;

        card.appendChild(header);
        card.appendChild(uso);
        card.appendChild(nota);

        cont.appendChild(card);
      });
    }

    // ------------------------- OPCIONES & GUIAS -------------------------

    function rellenarFormularioOpciones() {
      document.getElementById('opt-nombre-huerto').value =
        settings.nombreHuerto || '';
      document.getElementById('opt-clima').value = settings.clima || 'tropical';
      document.getElementById('opt-hemisferio').value =
        settings.hemisferio || 'norte';

      const resumen = `Huerto: ${
        settings.nombreHuerto || 'Mi huerto'
      } ¬∑ Clima: ${CLIMAS[settings.clima]} ¬∑ Hemisferio: ${
        settings.hemisferio === 'sur' ? 'sur' : 'norte'
      }`;
      document.getElementById('opciones-resumen-pill').textContent = resumen;
    }

    function guardarOpcionesDesdeFormulario() {
      settings.nombreHuerto =
        document.getElementById('opt-nombre-huerto').value.trim() ||
        'Mi huerto';
      settings.clima = document.getElementById('opt-clima').value || 'tropical';
      settings.hemisferio =
        document.getElementById('opt-hemisferio').value || 'norte';
      saveSettings();
      renderHeader();
      renderInicio();
      renderCalendarioMes(new Date().getMonth());
      rellenarFormularioOpciones();
      alert('Configuraci√≥n guardada.');
    }

    function renderGuias() {
      const cont = document.getElementById('guias-lista');
      cont.innerHTML = '';
      guiasBase.forEach((g) => {
        const item = document.createElement('div');
        item.className = 'guide-item';

        const title = document.createElement('div');
        title.className = 'guide-title';
        title.textContent = g.titulo;

        const text = document.createElement('div');
        text.className = 'diario-text';
        text.textContent = g.texto;

        item.appendChild(title);
        item.appendChild(text);
        cont.appendChild(item);
      });
    }

    function exportarDatos() {
      const bundle = {
        settings,
        huerto,
        diario,
      };
      const texto = JSON.stringify(bundle, null, 2);
      alert(
        'Copia el siguiente texto y gu√°rdalo en un lugar seguro:\n\n' + texto
      );
    }

    function borrarTodosLosDatos() {
      if (
        !confirm(
          'Esto borrar√° cultivos, diario y configuraci√≥n guardados en este dispositivo. ¬øContinuar?'
        )
      ) {
        return;
      }
      Object.values(STORAGE_KEYS).flat().forEach((k) => localStorage.removeItem(k));
      settings = {
        nombreHuerto: 'Mi huerto',
        clima: 'tropical',
        hemisferio: 'norte',
      };
      huerto = [];
      diario = [];
      saveSettings();
      saveHuerto();
      saveDiario();
      renderHeader();
      renderInicio();
      renderHuerto();
      renderDiario();
      rellenarFormularioOpciones();
      alert('Datos borrados. La aplicaci√≥n se ha reiniciado.');
    }

    // ------------------------- NAVEGACI√ìN --------------------------------

    function showView(name) {
      document
        .querySelectorAll('.view')
        .forEach((v) => v.classList.remove('active'));
      document
        .querySelectorAll('.tab-btn')
        .forEach((b) => b.classList.remove('active'));

      const viewEl = document.getElementById(`view-${name}`);
      const btn = document.querySelector(`.tab-btn[data-view="${name}"]`);
      if (viewEl) viewEl.classList.add('active');
      if (btn) btn.classList.add('active');
    }

    function setupNavEvents() {
      document.querySelectorAll('.tab-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          showView(view);

          if (view === 'huerto') renderHuerto();
          if (view === 'diario') renderDiario();
          if (view === 'plagas') renderPlagas();
          if (view === 'pesticidas') renderPesticidas();
          if (view === 'opciones') rellenarFormularioOpciones();
        });
      });

      document
        .getElementById('btn-ir-calendario')
        .addEventListener('click', () => {
          showView('calendario');
        });

      document
        .getElementById('btn-registrar-cultivo')
        .addEventListener('click', () => {
          showView('huerto');
          document.getElementById('cultivo-nombre').focus();
        });

      document.getElementById('btn-nueva-nota').addEventListener('click', () => {
        showView('diario');
        document.getElementById('diario-texto').focus();
      });

      document.getElementById('btn-buscar-plaga').addEventListener('click', () => {
        showView('plagas');
        document.getElementById('plagas-buscar').focus();
      });

      document.getElementById('btn-ajustar-clima').addEventListener('click', () => {
        showView('opciones');
        document.getElementById('opt-clima').focus();
      });
    }

    // ------------------------- EVENTOS FORMULARIOS ----------------------

    function setupFormEvents() {
      document
        .getElementById('btn-guardar-cultivo')
        .addEventListener('click', guardarCultivoDesdeFormulario);
      document
        .getElementById('btn-limpiar-cultivo')
        .addEventListener('click', limpiarFormularioCultivo);

      document
        .getElementById('btn-guardar-diario')
        .addEventListener('click', guardarDiarioDesdeFormulario);
      document
        .getElementById('btn-limpiar-diario')
        .addEventListener('click', limpiarFormularioDiario);

      document
        .getElementById('plagas-buscar')
        .addEventListener('input', renderPlagas);
      document
        .getElementById('btn-limpiar-plagas')
        .addEventListener('click', () => {
          document.getElementById('plagas-buscar').value = '';
          renderPlagas();
        });

      document
        .getElementById('pesticidas-buscar')
        .addEventListener('input', renderPesticidas);
      document
        .getElementById('btn-limpiar-pesticidas')
        .addEventListener('click', () => {
          document.getElementById('pesticidas-buscar').value = '';
          renderPesticidas();
        });

      document
        .getElementById('btn-guardar-opciones')
        .addEventListener('click', guardarOpcionesDesdeFormulario);

      document
        .getElementById('btn-exportar-datos')
        .addEventListener('click', exportarDatos);

      document
        .getElementById('btn-borrar-datos-todo')
        .addEventListener('click', borrarTodosLosDatos);
    }

    // ------------------------- SERVICE WORKER / PWA ---------------------

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('sw.js')
          .catch((err) => console.warn('SW error', err));
      });
    }

    // ------------------------- ARRANQUE ---------------------------------

    (function start() {
      initFromStorage();
      renderHeader();
      renderInicio();
      renderMonthSelector();
      renderHuerto();
      renderDiario();
      renderPlagas();
      renderPesticidas();
      renderGuias();
      rellenarFormularioOpciones();
      setupNavEvents();
      setupFormEvents();

      // Inicializar fechas por defecto en formularios
      document.getElementById('cultivo-fecha').value = getTodayISO();
      document.getElementById('diario-fecha').value = getTodayISO();
    })();
  </script>
</body>
  </html>
