<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v17)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />
<!-- jsPDF para exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #02081f;
      --card: #02081f;
      --card-soft: #030919;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.15);
      --accent-strong: rgba(34,197,94,0.45);
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148,163,184,0.3);
      --danger: #f97373;
      --chip-bg: rgba(15,23,42,0.9);
      --chip-border: rgba(148,163,184,0.4);
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.7);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-full: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #022c22 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 28px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 20px 16px 40px;
      }
    }

    /* HEADER */

    .app-header {
      background: radial-gradient(circle at 0 0, #4ade80 0, #16a34a 28%, #052e16 85%);
      border-radius: 28px;
      padding: 18px 18px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 120% -10%, rgba(34,197,94,0.35) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .app-header-icon {
      position: relative;
      z-index: 1;
      width: 52px;
      height: 52px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 10%, #bbf7d0 0, #16a34a 35%, #052e16 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 14px 35px rgba(0,0,0,0.45);
      flex-shrink: 0;
    }

    .app-header-icon span {
      font-size: 42px;
    }

    .app-header-text {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-tag {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.45);
      border: 1px solid rgba(15,23,42,0.8);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .app-subtitle {
      font-size: 0.80rem;
      color: #e5e7eb;
      opacity: 0.95;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .app-subtitle span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .app-subtitle-dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: rgba(226,232,240,0.7);
    }

    /* NAV */

    .nav {
      margin-top: 8px;
      background: linear-gradient(135deg, var(--bg-elevated), #020617);
      border-radius: 26px;
      padding: 10px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(15,23,42,0.85);
    }

    @media (min-width: 660px) {
      .nav {
        grid-template-columns: repeat(8, minmax(0,1fr));
      }
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 6px 6px;
      font-size: 0.70rem;
      color: var(--text-soft);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, transform 0.12s;
      position: relative;
      min-height: 52px;
    }

    .nav-btn span.nav-icon {
      font-size: 1.40rem;
    }

    .nav-btn span.nav-label {
      line-height: 1.1;
    }

    .nav-btn.nav-btn--active {
      background: radial-gradient(circle at top, var(--accent) 0, var(--accent-soft) 45%, transparent 100%);
      color: #ecfdf5;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4), 0 14px 30px rgba(22,163,74,0.55);
      transform: translateY(-1px);
    }

    .nav-btn.nav-btn--active::after {
      content: "";
      position: absolute;
      inset: auto auto -3px 50%;
      width: 32%;
      max-width: 42px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,0.1), rgba(34,197,94,0.6), rgba(34,197,94,0.1));
      transform: translateX(-50%);
    }

    /* SECTIONS */

    main {
      margin-top: 14px;
    }

    .section {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }

    .section--active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section > .section-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 2px 8px;
    }

    .section-icon-pill {
      width: 26px;
      height: 26px;
      border-radius: 13px;
      background: radial-gradient(circle at 30% 15%, #fefce8 0, #fef9c3 25%, #0f172a 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .section-title-row h2 {
      font-size: 1.05rem;
      margin: 0;
    }

    .section-subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin: 2px 2px 10px;
    }

    .app-card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #02081f 100%);
      border-radius: var(--radius-xl);
      padding: 14px 16px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }

    .app-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .app-card-title {
      font-size: 0.96rem;
      font-weight: 600;
    }

    .chip {
      border-radius: var(--radius-full);
      padding: 4px 10px;
      font-size: 0.74rem;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .chip.badge {
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.6);
      color: #bbf7d0;
    }

    .chip-danger {
      border-color: rgba(239,68,68,0.7);
      color: #fecaca;
      background: rgba(127,29,29,0.5);
    }

    .context-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0 10px;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .divider-soft {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,184,0.4), transparent);
      margin: 8px -2px 10px;
    }

    .muted {
      color: var(--text-soft);
      font-size: 0.80rem;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px -1px 4px;
    }

    .pill {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
    }

    .pill--active {
      background: var(--accent-soft);
      border-color: rgba(34,197,94,0.85);
      color: #bbf7d0;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(22,163,74,0.55);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
    }

    .btn span {
      font-size: 1rem;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 7px 18px rgba(22,163,74,0.55);
      filter: brightness(0.96);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
      box-shadow: none;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-danger {
      background: linear-gradient(135deg, #b91c1c, #ef4444);
      color: #fee2e2;
      box-shadow: 0 10px 26px rgba(248,113,113,0.45);
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .small-label {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .big-number {
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* FORMS */

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 8px 0 4px;
    }

    @media (min-width: 660px) {
      .form-grid--2 {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      background: rgba(15,23,42,0.95);
      border-radius: 14px;
      border: 1px solid rgba(51,65,85,0.9);
      padding: 8px 10px;
      color: var(--text-main);
      font-size: 0.83rem;
      font-family: inherit;
      width: 100%;
      max-width: 100%;
      outline: none;
      transition: border 0.12s, box-shadow 0.12s, background 0.12s;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 10px, calc(100% - 11px) 10px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
      background: rgba(15,23,42,0.98);
    }

    /* Cat√°logo con imagen */
    .catalogo-card-main {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .catalogo-thumb {
      flex-shrink: 0;
    }

    .catalogo-thumb img {
      width: 70px;
      height: 70px;
      border-radius: 16px;
      object-fit: cover;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 8px 20px rgba(15,23,42,0.7);
    }

    @media (max-width: 480px) {
      .catalogo-card-main {
        flex-direction: row;
      }
    }

    /* Mi huerto ‚Äì tarjetas de cultivos */

    .cultivos-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    .cultivo-card {
      border-radius: var(--radius-lg);
      padding: 10px 11px;
      background: radial-gradient(circle at top left, var(--card-soft) 0, #020617 60%);
      border: 1px solid rgba(75,85,99,0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cultivo-card--ok {
      border-color: rgba(34,197,94,0.85);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.35);
    }

    .cultivo-card--alerta {
      border-color: rgba(234,179,8,0.9);
      box-shadow: 0 0 0 1px rgba(234,179,8,0.35);
    }

    .cultivo-card--critico {
      border-color: rgba(239,68,68,0.9);
      box-shadow: 0 0 0 1px rgba(239,68,68,0.4);
    }

    .cultivo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .cultivo-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cultivo-thumb {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .cultivo-title span {
      word-break: break-word;
    }

    .cultivo-body {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 4px 10px;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .cultivo-body {
        grid-template-columns: 1fr;
      }
    }

    .cultivo-notas {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    .cultivo-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }

    .link-like {
      font-size: 0.78rem;
      color: #4ade80;
      text-decoration: underline;
      cursor: pointer;
    }

    /* Calendario de siembra */

    .calendar-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .calendar-item {
      border-radius: 16px;
      padding: 9px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 0.8rem;
    }

    .calendar-item-title {
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .calendar-empty {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 8px;
    }

    /* Diario */

    .diario-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .diario-item {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
    }

    .plaga-card {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 6px;
    }

    .plaga-card--highlight {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6);
    }

    .diario-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }

    .media-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .media-item-title {
      font-size: 0.86rem;
      font-weight: 600;
    }

    .media-item-body {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    ul {
      margin: 4px 0 4px 18px;
      padding: 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    footer {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--text-soft);
      text-align: center;
      padding-bottom: 6px;
    }

    footer span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #installBanner {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.97);
      border-radius: 999px;
      padding: 7px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(148,163,184,0.75);
      box-shadow: 0 16px 40px rgba(15,23,42,0.85);
      font-size: 0.78rem;
      z-index: 80;
    }

    #installBanner.hidden {
      display: none;
    }

    #installBanner button {
      font-size: 0.78rem;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon">
        <span>üå±</span>
      </div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v17 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle">
          <!-- JS -->
        </div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Inicio</span>
      </button>
      <button class="nav-btn" data-section="calendario">
        <span class="nav-icon">üìÖ</span>
        <span class="nav-label">Calendario</span>
      </button>
      <button class="nav-btn" data-section="catalogo">
        <span class="nav-icon">üå±</span>
        <span class="nav-label">Cat√°logo</span>
      </button>
      <button class="nav-btn" data-section="huerto">
        <span class="nav-icon">üåø</span>
        <span class="nav-label">Mi huerto</span>
      </button>
      <button class="nav-btn" data-section="diario">
        <span class="nav-icon">üìì</span>
        <span class="nav-label">Diario</span>
      </button>
      <button class="nav-btn" data-section="plagas">
        <span class="nav-icon">üêõ</span>
        <span class="nav-label">Plagas</span>
      </button>
      <button class="nav-btn" data-section="pesticidas">
        <span class="nav-icon">üíß</span>
        <span class="nav-label">Pesticidas</span>
      </button>
      <button class="nav-btn" data-section="opciones">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Opciones</span>
      </button>
      <button class="nav-btn" data-section="guias">
        <span class="nav-icon">üìö</span>
        <span class="nav-label">Gu√≠as</span>
      </button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row">
          <div class="section-icon-pill">üè†</div>
          <h2>Inicio</h2>
        </div>
        <p class="section-subtitle">
          Resumen r√°pido de tu huerto y acceso a las funciones principales.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div class="chip badge" id="estadoClimaChip">Clima tropical</div>
          </div>
          <div class="context-chips settings-context"></div>
          <div class="grid-two">
            <div>
              <div class="small-label">Cultivos registrados</div>
              <div class="big-number" id="estadoCultivosCount">0</div>
            </div>
            <div>
              <div class="small-label">Entradas hoy en el diario</div>
              <div class="big-number" id="estadoEntradasCount">0</div>
            </div>
          </div>
          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">
            A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.
          </p>
        </div>

        <!-- Recordatorios -->
        <div class="app-card" id="recordatoriosCard" style="display:none;">
          <div class="app-card-header">
            <div class="app-card-title">Recordatorios de abono y riego</div>
            <div class="chip">Seg√∫n tus registros</div>
          </div>
          <p class="muted">
            Aqu√≠ ver√°s los cultivos que ya deber√≠an recibir abono o riego, usando la fecha del √∫ltimo registro y la frecuencia configurada.
          </p>
          <ul id="recordatoriosList"></ul>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìÖ</div>
          <h2>Calendario de siembra</h2>
        </div>
        <p class="section-subtitle">
          Selecciona un mes para ver sugerencias de cultivos seg√∫n tu clima actual.
          Son recomendaciones generales; aj√∫stalas a tu experiencia local.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses del a√±o</div>
            <div class="chip" id="calendarioClimaChip2">Clima tropical</div>
          </div>
          <div class="context-chips settings-context"></div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button>
            <button class="pill" data-mes="1">Feb</button>
            <button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button>
            <button class="pill" data-mes="4">May</button>
            <button class="pill pill--active" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button>
            <button class="pill" data-mes="7">Ago</button>
            <button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button>
            <button class="pill" data-mes="10">Nov</button>
            <button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">
            Por ahora no tenemos recomendaciones espec√≠ficas para este mes y clima.
            Puedes usar tu experiencia local o guiarte por cultivos similares.
          </div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üå±</div>
          <h2>Cat√°logo de cultivos</h2>
        </div>
        <p class="section-subtitle">
          Lista de cultivos con informaci√≥n r√°pida de luz, riego, tiempo de cosecha,
          tama√±o de tiesto y plagas m√°s frecuentes.
        </p>

        <div class="app-card">
          <div class="field">
            <label for="catalogoBusqueda">Buscar cultivo</label>
            <input
              type="text"
              id="catalogoBusqueda"
              placeholder="Ej. tomate, lechuga, pl√°tano..."
            />
          </div>
          <div class="cultivos-list" id="catalogoList"></div>
          <div class="app-card" id="germinacionPanel" style="display:none;">
          <div class="app-card-header">
            <div class="app-card-title" id="germinacionTitulo">
              Germinaci√≥n / reproducci√≥n
            </div>
          </div>
          <p class="muted" id="germinacionContenido" style="white-space:pre-wrap;"></p>
          </div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üåø</div>
          <h2>Mi huerto</h2>
        </div>
        <p class="section-subtitle">
          Registra tus cultivos y consulta los detalles de cada planta.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>
          <div class="context-chips settings-context"></div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>
            <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo">
            <span>‚ûï</span> Guardar cultivo
          </button>
          <p class="muted" style="margin-top:6px;">
            * Solo el nombre es obligatorio. Puedes editar o eliminar los cultivos luego.
          </p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>

          <div class="context-chips" id="huertoAbonoResumen"></div>

          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìì</div>
          <h2>Diario de huerto</h2>
        </div>
        <p class="section-subtitle">
          Anota riegos, abonados, podas o cualquier evento importante de tu huerto.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>
          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste hoy?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates y lechugas. Apliqu√© compost a las arom√°ticas."></textarea>
          </div>
          <button class="btn btn-full" id="btnGuardarDiario">
            <span>üíæ</span> Guardar en el diario
          </button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas recientes</div>
            <div class="chip" id="diarioCountChip">0 entradas</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>

          <div class="diario-list" id="diarioList"></div>

          <button
  class="btn-secondary btn btn-full"
  id="btnExportarDiario"
  type="button"
  onclick="exportarDatosPDF()"
>
  <span>üì¶</span> Exportar diario (texto)
</button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üêõ</div>
          <h2>Plagas comunes</h2>
        </div>
        <p class="section-subtitle">
          Referencia r√°pida de plagas frecuentes en huertos caseros y c√≥mo manejarlas
          de forma responsable.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cat√°logo b√°sico de plagas</div>
            <div class="chip">Referencia</div>
          </div>
          <div class="media-list" id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üíß</div>
          <h2>Pesticidas y preparados</h2>
        </div>
        <p class="section-subtitle">
          Opciones suaves y de bajo impacto para manejar plagas en un huerto casero.
          Siempre respeta las indicaciones de seguridad.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Preparados sugeridos</div>
            <div class="chip">Uso responsable</div>
          </div>
          <div class="media-list" id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">‚öôÔ∏è</div>
          <h2>Opciones</h2>
        </div>
        <p class="section-subtitle">
          Ajusta el nombre de tu huerto, el clima y el hemisferio. Estos datos
          actualizan el calendario y los textos de la aplicaci√≥n.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Datos generales</div>
          </div>
          <div class="context-chips settings-context"></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG, Mi huerto, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima principal</label>
              <select id="climaSelect">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <button class="btn btn-full" id="btnGuardarConfig">
            <span>üíæ</span> Guardar configuraci√≥n
          </button>

          <div class="divider-soft"></div>
          <p class="muted">
            Toda la informaci√≥n se guarda <strong>solo en tu dispositivo</strong> usando almacenamiento local.
            Puedes exportar los datos como texto para tener una copia de seguridad.
          </p>

          <div class="pill-group">
            <button class="btn-secondary btn" id="btnExportar">
              <span>üì§</span> Exportar datos (texto)
            </button>
            <button class="btn-secondary btn" id="btnImportar">
              <span>üì•</span> Importar datos (texto)
            </button>
            <button class="btn-danger btn" id="btnBorrarTodo">
              <span>üßπ</span> Borrar todo
            </button>
          </div>
        </div>
      </section>

      <!-- GUIAS -->
      <section id="section-guias" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìö</div>
          <h2>Gu√≠as r√°pidas</h2>
        </div>
        <p class="section-subtitle">
          Consejos b√°sicos para sacar m√°s provecho a tu huerto, sin reemplazar la
          experiencia de campo ni el consejo de especialistas.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Antes de sembrar</div>
            <div class="chip">Paso 1</div>
          </div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Preparar el suelo</div>
              <div class="media-item-body">
                Retira piedras y ra√≠ces gruesas, agrega materia org√°nica (compost, esti√©rcol bien
                descompuesto) y afloja la tierra sin voltearla en exceso para cuidar la vida
                del suelo.
              </div>
            </div>
            <div>
              <div class="media-item-title">Elegir el lugar</div>
              <div class="media-item-body">
                La mayor√≠a de los cultivos necesitan al menos 4‚Äì6 horas de sol directo. Observa
                tu patio o balc√≥n un d√≠a completo y elige las zonas con mejor iluminaci√≥n.
              </div>
            </div>
          </div>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Riego inteligente</div>
            <div class="chip">Paso 2</div>
          </div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Revisar la humedad</div>
              <div class="media-item-body">
                Antes de regar, introduce un dedo en el sustrato hasta 2‚Äì3&nbsp;cm. Si est√° h√∫medo,
                espera. Si est√° seco, riega de forma lenta y profunda.
              </div>
            </div>
            <div>
              <div class="media-item-title">Horario recomendado</div>
              <div class="media-item-body">
                En climas c√°lidos suele ser mejor regar temprano en la ma√±ana o al final de la
                tarde para reducir evaporaci√≥n y estr√©s en las plantas.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <footer>
      <span>Mi Siembra Inteligente ¬∑ Datos guardados localmente en tu dispositivo üåø</span>
    </footer>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>
    <button class="btn btn-secondary" id="btnInstalarPwa">
      <span>üì≤</span> Instalar
    </button>
  </div>
  
  <script>
    /*********************
     * Datos y utilidades
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario"
    };

    const DEFAULT_SETTINGS = {
      nombreHuerto: "Mi huerto",
      clima: "tropical",
      hemisferio: "norte"
    };

    const CLIMA_LABEL = {
      tropical: "tropical",
      subtropical: "subtropical/templado",
      templado: "templado/fr√≠o"
    };

    const HEMISFERIO_LABEL = {
      norte: "hemisferio norte",
      sur: "hemisferio sur"
    };

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.settings);
        if (!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...parsed };
      } catch (e) {
        return { ...DEFAULT_SETTINGS };
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings));
    }

    function loadCultivos() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.cultivos);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveCultivos(list) {
      localStorage.setItem(STORAGE_KEYS.cultivos, JSON.stringify(list));
    }

    function loadDiario() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.diario);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveDiario(list) {
      localStorage.setItem(STORAGE_KEYS.diario, JSON.stringify(list));
    }

    function formatDate(dateStr) {
      if (!dateStr) return "Sin fecha";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = [
        "ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"
      ];
      return `${d.getDate().toString().padStart(2, "0")} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function daysBetween(dateISO1, dateISO2) {
      const d1 = new Date(dateISO1 + "T00:00:00");
      const d2 = new Date(dateISO2 + "T00:00:00");
      const diffMs = d2 - d1;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function getPendientesAbono() {
      const hoyISO = todayISO();
      return stateCultivos.filter(c => {
        if (!c.ultimaFertilizacion || !c.frecuenciaAbonoDias) return false;
        const diasDesde = daysBetween(c.ultimaFertilizacion, hoyISO);
        return diasDesde >= c.frecuenciaAbonoDias;
      });
    }

    function getPendientesRiego() {
      const hoyISO = todayISO();
      return stateCultivos.filter(c => {
        if (!c.frecuenciaRiegoDias) return false;
        const base = c.ultimoRiego || c.fechaSiembra || c.creadoEl;
        if (!base) return false;
        const diasDesde = daysBetween(base, hoyISO);
        return diasDesde >= c.frecuenciaRiegoDias;
      });
    }

    function getCosechasHoy() {
      const hoyISO = todayISO();
      return stateCultivos.filter(
        c => c.fechaCosechaEstimada && c.fechaCosechaEstimada <= hoyISO
      );
    }

    function getRecordatoriosAbono() {
      const hoyISO = todayISO();

      return stateCultivos
        .filter(c => c.ultimaFertilizacion && c.frecuenciaAbonoDias)
        .map(c => {
          const diasDesde = daysBetween(c.ultimaFertilizacion, hoyISO);
          const diasRestantes = c.frecuenciaAbonoDias - diasDesde;

          let estadoLabel;
          if (diasRestantes > 0) {
            estadoLabel = `faltan ${diasRestantes} d√≠a(s)`;
          } else if (diasRestantes === 0) {
            estadoLabel = "toca hoy";
          } else {
            estadoLabel = `vencido hace ${Math.abs(diasRestantes)} d√≠a(s)`;
          }

          return {
            nombre: c.nombre,
            diasDesde,
            diasRestantes,
            estadoLabel
          };
        })
        .sort((a, b) => a.diasRestantes - b.diasRestantes);
    }

    function getResumenAbono() {
      const hoyISO = todayISO();
      let alDia = 0;
      let porVencer = 0;
      let atrasados = 0;

      stateCultivos.forEach(c => {
        if (!c.ultimaFertilizacion || !c.frecuenciaAbonoDias) return;

        const diasDesde = daysBetween(c.ultimaFertilizacion, hoyISO);
        const diasRestantes = c.frecuenciaAbonoDias - diasDesde;

        if (diasRestantes > 5) {
          alDia++;
        } else if (diasRestantes >= 0) {
          porVencer++;
        } else {
          atrasados++;
        }
      });

      return { alDia, porVencer, atrasados };
    }

    /*********************
     * Calendario de siembra
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        5: [
          {
            titulo: "Re-siembra de lechugas",
            tipo: "Hoja",
            detalle:
              "Siembra escalonada cada 2‚Äì3 semanas para cosechas continuas."
          },
          {
            titulo: "R√°banos",
            tipo: "Ra√≠z",
            detalle:
              "Cosecha r√°pida (20‚Äì30 d√≠as). Perfectos para ocupar huecos libres."
          }
        ],
        6: [
          {
            titulo: "Berenjena",
            tipo: "Fruto",
            detalle:
              "Le gustan las noches c√°lidas. Ideal para verano tropical."
          },
          {
            titulo: "Aj√≠es y pimientos",
            tipo: "Fruto",
            detalle:
              "Sembrar en lugar soleado y con buen drenaje."
          }
        ]
      },
      subtropical: {
        5: [
          {
            titulo: "Tomates de media estaci√≥n",
            tipo: "Fruto",
            detalle: "Elige variedades adaptadas a tu regi√≥n."
          }
        ]
      },
      templado: {
        2: [
          {
            titulo: "Lechugas de primavera",
            tipo: "Hoja",
            detalle:
              "Siembra temprana bajo protecci√≥n ligera si hay riesgo de heladas."
          }
        ]
      }
    };

    function ajustarMesPorHemisferio(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      let mes = monthIndex;
      if (
        settings.hemisferio === "sur" &&
        (climaKey === "templado" || climaKey === "subtropical")
      ) {
        mes = (monthIndex + 6) % 12;
      }
      return mes;
    }

    function getCalendarData(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);
      const base = CALENDARIO_SIEMBRA[climaKey] || {};
      return base[mesAjustado] || [];
    }

    /*********************
     * Cat√°logo de cultivos
     *********************/
    const CATALOGO_CULTIVOS = [
      {
        id: "tomate",
        nombre: "Tomate",
        categoria: "Fruto",
        dias: "70‚Äì90 d√≠as",
        luz: "Sol directo (6‚Äì8 h)",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas profundas de 5+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones", "Mosca blanca", "Orugas"],
        meses: [0, 1, 2, 3, 4, 5, 6, 7],
        imagen: "img/tomate.jpg"
      },
      {
        id: "lechuga",
        nombre: "Lechuga",
        categoria: "Hoja",
        dias: "45‚Äì60 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas anchas de 3+ galones",
        profundidad: "0.5 cm",
        plagas: ["Babosas", "Caracoles", "Pulgones"],
        meses: [0, 1, 2, 3, 8, 9, 10, 11],
        imagen: "img/lechuga.jpg"
      },
      {
        id: "pepinillo",
        nombre: "Pepinillo / Pepino",
        categoria: "Fruto",
        dias: "60‚Äì90 d√≠as",
        luz: "Sol directo",
        riego: "Abundante y constante",
        tiesto: "Macetas profundas de 5+ galones con tutor",
        profundidad: "1‚Äì2 cm",
        plagas: ["Mosca blanca", "√Åcaros", "Hongos"],
        meses: [3, 4, 5, 6, 7, 8],
        imagen: "img/pepinillo.jpg"
      },
      {
        id: "platano",
        nombre: "Pl√°tano",
        categoria: "Fruto perenne",
        dias: "Cosecha a partir de 9‚Äì12 meses",
        luz: "Sol directo",
        riego: "Regular, le gusta la humedad",
        tiesto: "Suelo directo, espacio amplio",
        profundidad: "Cormo enterrado firmemente",
        plagas: ["Picudo del pl√°tano", "Sigatoka"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/platano.jpg"
      },
      {
        id: "pimiento_morron",
        nombre: "Pimiento morron",
        categoria: "Fruto",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo (6‚Äì8 h)",
        riego: "Regular, evitando encharcamientos",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Trips", "Ara√±a roja"],
        meses: [2,3,4,5,6,7],
        imagen: "img/pimiento_morron.jpg"
      },
      {
        id: "aji",
        nombre: "Aj√≠",
        categoria: "Fruto",
        dias: "90‚Äì110 d√≠as",
        luz: "Sol directo",
        riego: "Moderado, prefiere suelos bien drenados",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Mosca blanca"],
        meses: [2,3,4,5,6,7],
        imagen: "img/aji.jpg"
      },
      {
        id: "berenjena",
        nombre: "Berenjena",
        categoria: "Fruto",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Constante, sin encharcar",
        tiesto: "Macetas de 5+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Escarabajos", "Pulgones", "Ara√±a roja"],
        meses: [3,4,5,6,7,8],
        imagen: "img/berenjena.jpg"
      },
      {
        id: "cebolla",
        nombre: "Cebolla",
        categoria: "Bulbo",
        dias: "100‚Äì150 d√≠as",
        luz: "Sol directo",
        riego: "Moderado, reducir antes de cosechar",
        tiesto: "Macetas profundas o suelo directo",
        profundidad: "1‚Äì2 cm",
        plagas: ["Trips", "Mosca de la cebolla"],
        meses: [0,1,2,6,7,8,9,10],
        imagen: "img/cebolla.jpg"
      },
      {
        id: "cebollin",
        nombre: "Ceboll√≠n / cebolleta",
        categoria: "Bulbo",
        dias: "60‚Äì90 d√≠as",
        luz: "Sol directo o media sombra",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 3+ galones",
        profundidad: "1 cm",
        plagas: ["Trips"],
        meses: [0,1,2,3,4,8,9,10,11],
        imagen: "img/cebollin.jpg"
      },
      {
        id: "zanahoria",
        nombre: "Zanahoria",
        categoria: "Ra√≠z",
        dias: "70‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas profundas (30+ cm)",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Mosca de la zanahoria", "Hongos"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/zanahoria.jpg"
      },
      {
        id: "rabano",
        nombre: "R√°bano",
        categoria: "Ra√≠z",
        dias: "25‚Äì35 d√≠as",
        luz: "Sol directo o media sombra",
        riego: "Suelo constantemente h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "1 cm",
        plagas: ["Pulguillas", "Babosas"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/rabano.jpg"
      },
      {
        id: "remolacha",
        nombre: "Remolacha",
        categoria: "Ra√≠z",
        dias: "60‚Äì80 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas profundas (25+ cm)",
        profundidad: "1‚Äì2 cm",
        plagas: ["Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/remolacha.jpg"
      },
      {
        id: "papa",
        nombre: "Papa",
        categoria: "Tub√©rculo",
        dias: "90‚Äì120 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Sacos o macetas profundas de 10+ galones",
        profundidad: "Tub√©rculo cubierto con 5‚Äì10 cm de sustrato",
        plagas: ["Escarabajo de la papa", "Hongos"],
        meses: [0,1,2,7,8,9],
        imagen: "img/papa.jpg"
      },
      {
        id: "batata",
        nombre: "Batata",
        categoria: "Tub√©rculo",
        dias: "120‚Äì150 d√≠as",
        luz: "Sol directo",
        riego: "Moderado, tolera algo de sequ√≠a",
        tiesto: "Suelo directo o macetas grandes",
        profundidad: "Estacas enterradas 5‚Äì10 cm",
        plagas: ["Gusanos de suelo", "Hongos"],
        meses: [2,3,4,5,6,7,8],
        imagen: "img/batata.jpg"
      },
      {
        id: "yuca",
        nombre: "Yuca",
        categoria: "Tub√©rculo perenne",
        dias: "8‚Äì12 meses",
        luz: "Sol directo",
        riego: "Poca exigencia, suelo bien drenado",
        tiesto: "Mejor en suelo directo",
        profundidad: "Estacas enterradas 15‚Äì20 cm",
        plagas: ["Mosca blanca", "√Åcaros"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/yuca.jpg"
      },
      {
        id: "maiz",
        nombre: "Ma√≠z",
        categoria: "Grano",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Regular, m√°s constante en floraci√≥n",
        tiesto: "Parterres o contenedores grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Gusanos del ma√≠z", "Pulgones"],
        meses: [2,3,4,5,6,7],
        imagen: "img/maiz.jpg"
      },
      {
        id: "habichuelas",
        nombre: "Habichuelas",
        categoria: "Leguminosa",
        dias: "60‚Äì80 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 5+ galones con tutor",
        profundidad: "2‚Äì3 cm",
        plagas: ["Pulgones", "Trips"],
        meses: [2,3,4,5,6,7],
        imagen: "img/habichuelas.jpg"
      },
      {
        id: "habichuela_arbustiva",
        nombre: "Habichuela arbustiva",
        categoria: "Leguminosa",
        dias: "55‚Äì70 d√≠as",
        luz: "Sol directo",
        riego: "Regular",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "2‚Äì3 cm",
        plagas: ["Pulgones", "Trips"],
        meses: [2,3,4,5,6,7],
        imagen: "img/habichuela_arbustiva.jpg"
      },
      {
        id: "gandules",
        nombre: "Gandules",
        categoria: "Leguminosa perenne",
        dias: "4‚Äì6 meses para la primera cosecha",
        luz: "Sol directo",
        riego: "Moderado, resistente a sequ√≠a",
        tiesto: "Suelo directo o macetas muy grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Gusanos de vaina", "Pulgones"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/gandules.jpg"
      },
      {
        id: "calabaza",
        nombre: "Calabaza",
        categoria: "Fruto rastrero",
        dias: "90‚Äì130 d√≠as",
        luz: "Sol directo",
        riego: "Regular, le gusta suelo f√©rtil",
        tiesto: "Suelo directo o macetas muy grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Barrenador de tallo", "Mosca blanca"],
        meses: [2,3,4,5,6,7],
        imagen: "img/calabaza.jpg"
      },
      {
        id: "calabacin_zucchini",
        nombre: "Calabac√≠n / Zucchini",
        categoria: "Fruto",
        dias: "45‚Äì60 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 8+ galones",
        profundidad: "2‚Äì3 cm",
        plagas: ["O√≠dio", "Pulgones"],
        meses: [2,3,4,5,6,7],
        imagen: "img/calabacin_zucchini.jpg"
      },
      {
        id: "melon",
        nombre: "Mel√≥n",
        categoria: "Fruto rastrero",
        dias: "90‚Äì120 d√≠as",
        luz: "Sol directo",
        riego: "Regular, reducir al madurar frutos",
        tiesto: "Suelo directo o macetas grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Mosca blanca", "O√≠dio"],
        meses: [3,4,5,6,7],
        imagen: "img/melon.jpg"
      },
      {
        id: "sandia",
        nombre: "Sand√≠a",
        categoria: "Fruto rastrero",
        dias: "90‚Äì120 d√≠as",
        luz: "Sol directo fuerte",
        riego: "Abundante al inicio, reducir en madurez",
        tiesto: "Suelo directo o contenedores muy grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Mosca blanca", "O√≠dio"],
        meses: [3,4,5,6,7],
        imagen: "img/sandia.jpg"
      },
      {
        id: "espinaca",
        nombre: "Espinaca",
        categoria: "Hoja",
        dias: "40‚Äì60 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Suelo fresco y h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Babosas", "Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/espinaca.jpg"
      },
      {
        id: "acelga",
        nombre: "Acelga",
        categoria: "Hoja",
        dias: "50‚Äì70 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "1‚Äì2 cm",
        plagas: ["Babosas", "Caracoles"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/acelga.jpg"
      },
      {
        id: "col_rizada",
        nombre: "Col rizada_kale",
        categoria: "Hoja",
        dias: "60‚Äì90 d√≠as",
        luz: "Sol directo o media sombra",
        riego: "Regular",
        tiesto: "Macetas de 5+ galones",
        profundidad: "1 cm",
        plagas: ["Orugas", "Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/col_rizada_kale.jpg"
      },
      {
        id: "cilantro",
        nombre: "Cilantro",
        categoria: "Arom√°tica",
        dias: "30‚Äì50 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Suelo fresco y h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/cilantro.jpg"
      },
      {
        id: "perejil",
        nombre: "Perejil",
        categoria: "Arom√°tica",
        dias: "70‚Äì90 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Regular",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones"],
        meses: [0,1,2,3,4,8,9,10,11],
        imagen: "img/perejil.jpg"
      },
      {
        id: "albahaca",
        nombre: "Albahaca",
        categoria: "Arom√°tica",
        dias: "40‚Äì60 d√≠as",
        luz: "Sol directo suave",
        riego: "Suelo ligeramente h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Mosca blanca"],
        meses: [2,3,4,5,6,7,8],
        imagen: "img/albahaca.jpg"
      },
      {
        id: "oregano",
        nombre: "Or√©gano",
        categoria: "Arom√°tica perenne",
        dias: "Cosecha a partir de 60 d√≠as",
        luz: "Sol directo",
        riego: "Escaso, prefiere suelos secos",
        tiesto: "Macetas de 3+ galones",
        profundidad: "Superficial, esquejes o plantines",
        plagas: ["Muy pocas plagas importantes"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/oregano.jpg"
      },
      {
        id: "menta",
        nombre: "Menta",
        categoria: "Arom√°tica perenne",
        dias: "Cosecha desde 40‚Äì60 d√≠as",
        luz: "Media sombra o sol suave",
        riego: "Le gusta humedad constante",
        tiesto: "Macetas profundas (mejor aislada, es invasiva)",
        profundidad: "Plantines o esquejes superficiales",
        plagas: ["Pulgones"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/menta.jpg"
      },
      {
        id: "romero",
        nombre: "Romero",
        categoria: "Arom√°tica perenne",
        dias: "Planta lenta, cosecha continua",
        luz: "Sol directo",
        riego: "Muy poco, prefiere suelos secos",
        tiesto: "Macetas de 5+ galones",
        profundidad: "Esquejes o plantines superficiales",
        plagas: ["Pocas plagas, a veces cochinilla"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/romero.jpg"
      },
      {
        id: "tomillo",
        nombre: "Tomillo",
        categoria: "Arom√°tica perenne",
        dias: "Cosecha desde 60 d√≠as",
        luz: "Sol directo",
        riego: "Escaso",
        tiesto: "Macetas peque√±as o medianas",
        profundidad: "Semilla muy superficial o plantines",
        plagas: ["Muy poco susceptible"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/tomillo.jpg"
      },
      {
        id: "fresas",
        nombre: "Fresas",
        categoria: "Fruto",
        dias: "4‚Äì6 meses desde plant√≠n",
        luz: "Sol directo suave",
        riego: "Regular, le gusta el sustrato h√∫medo",
        tiesto: "Jardineras o macetas colgantes",
        profundidad: "Plantines al nivel del cuello",
        plagas: ["Babosas", "Hongos"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/fresas.jpg"
      },
      {
        id: "papaya",
        nombre: "Papaya",
        categoria: "Frutal",
        dias: "9‚Äì14 meses hasta la primera cosecha",
        luz: "Sol directo",
        riego: "Regular, suelo bien drenado",
        tiesto: "Mejor en suelo directo",
        profundidad: "Semillas superficiales, luego trasplante",
        plagas: ["Mosca de la fruta", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/papaya.jpg"
      },
      {
        id: "guayaba",
        nombre: "Guayaba",
        categoria: "Frutal perenne",
        dias: "18‚Äì24 meses desde plant√≠n",
        luz: "Sol directo",
        riego: "Moderado, tolera algo de sequ√≠a",
        tiesto: "Mejor suelo directo, puede ir en macet√≥n",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Mosca de la fruta"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/guayaba.jpg"
      },
      {
        id: "parcha",
        nombre: "Parcha",
        categoria: "Frutal trepador",
        dias: "8‚Äì12 meses",
        luz: "Sol directo",
        riego: "Regular, suelo f√©rtil",
        tiesto: "Suelo directo con enredadera",
        profundidad: "Plantines al nivel del cuello",
        plagas: ["Mosca de la fruta", "√Åcaros"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/parcha.jpg"
      },
      {
        id: "mango",
        nombre: "Mango",
        categoria: "Frutal perenne",
        dias: "Varios a√±os hasta producir",
        luz: "Sol directo fuerte",
        riego: "Poco una vez establecido",
        tiesto: "Suelo directo; en macet√≥n solo variedades enanas",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Mosca de la fruta", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/mango.jpg"
      },
      {
        id: "limon",
        nombre: "Lim√≥n",
        categoria: "Frutal c√≠trico",
        dias: "2‚Äì3 a√±os desde plant√≠n",
        luz: "Sol directo",
        riego: "Regular en sequ√≠a",
        tiesto: "Macet√≥n grande o suelo directo",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Minador de hoja", "Cochinillas"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/limon.jpg"
      },
      {
        id: "cafe",
        nombre: "Caf√©",
        categoria: "Perene",
        dias: "2‚Äì3 a√±os hasta la primera cosecha",
        luz: "Sombra parcial o sol suave",
        riego: "Regular, no encharcar",
        tiesto: "Macetones profundos o suelo directo",
        profundidad: "Plantines al nivel del cuello",
        plagas: ["Broca del caf√©", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/cafe.jpg"
      },
      {
        id: "ajo",
        nombre: "Ajo",
        categoria: "Bulbo",
        dias: "120‚Äì180 d√≠as",
        luz: "Sol directo",
        riego: "Moderado, sin encharcar",
        tiesto: "Macetas profundas o suelo directo",
        profundidad: "2‚Äì3 cm",
        plagas: ["Trips", "Mosca de la cebolla"],
        meses: [0,1,2,6,7,8,9,10],
        imagen: "img/ajo.jpg"
      },
      {
        id: "pimiento",
        nombre: "Pimiento",
        categoria: "Fruto",
        dias: "75‚Äì95 d√≠as",
        luz: "Sol directo (6‚Äì8 h)",
        riego: "Regular, evitando encharcamientos",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Trips", "Ara√±a roja"],
        meses: [2,3,4,5,6,7],
        imagen: "img/pimiento.jpg"
      },
      {
        id: "brocoli",
        nombre: "Br√≥coli",
        categoria: "Br√°sica",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo suave",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas profundas de 5+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Orugas", "Pulgones", "Babosas"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/brocoli.jpg"
      },
      {
        id: "china",
        nombre: "China (naranja)",
        categoria: "Frutal c√≠trico",
        dias: "2‚Äì3 a√±os desde plant√≠n",
        luz: "Sol directo",
        riego: "Regular en √©poca seca",
        tiesto: "Macet√≥n grande o suelo directo",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Minador de hoja", "Cochinillas", "Mosca de la fruta"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/china.jpg"
      },
      {
        id: "coliflor",
        nombre: "Coliflor",
        categoria: "Br√°sica",
        dias: "80‚Äì110 d√≠as",
        luz: "Sol directo suave o media sombra",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas profundas de 5+ galones o suelo directo",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones", "Caracoles"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/coliflor.jpg"
      },
      {
        id: "quimbombo",
        nombre: "Quimbomb√≥ / Okra",
        categoria: "Fruto",
        dias: "60‚Äì80 d√≠as",
        luz: "Sol directo fuerte",
        riego: "Moderado, tolera algo de sequ√≠a",
        tiesto: "Macetas de 5+ galones o suelo directo",
        profundidad: "2‚Äì3 cm",
        plagas: ["Pulgones", "Trips", "√Åcaros"],
        meses: [2,3,4,5,6,7,8],
        imagen: "img/quimbombo.jpg"
      },
      {
        id: "chayote",
        nombre: "Chayote",
        categoria: "Fruto trepador",
        dias: "120‚Äì180 d√≠as (primera cosecha)",
        luz: "Sol directo o media sombra luminosa",
        riego: "Regular, suelos h√∫medos pero bien drenados",
        tiesto: "Mejor en suelo directo con enredadera",
        profundidad: "Fruto/semilla enterrado lateral, apenas cubierto",
        plagas: ["Babosas", "Caracoles", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/chayote.jpg"
      },
      {
        id: "pina",
        nombre: "Pi√±a",
        categoria: "Frutal perenne",
        dias: "15‚Äì18 meses hasta la primera cosecha",
        luz: "Sol directo fuerte",
        riego: "Moderado, evitando encharcamientos",
        tiesto: "Macetones profundos o suelo directo con buen drenaje",
        profundidad: "Corona plantada superficialmente",
        plagas: ["Cochinillas", "Hongos", "Mosca de la fruta"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/pina.jpg"
      }
    ];

    /*********************
     * Germinaci√≥n / reproducci√≥n
     *********************/
    const GERMINACION_POR_CULTIVO = {
      tomate: {
        titulo: "Tomate ‚Äì germinaci√≥n",
        metodo: "Semilla en alm√°cigo y luego trasplante.",
        pasos: [
          "Llenar bandeja o alm√°cigo con sustrato suelto y bien drenado.",
          "Sembrar la semilla a 0.5‚Äì1 cm de profundidad.",
          "Mantener siempre ligeramente h√∫medo, sin encharcar.",
          "Trasplantar cuando tenga 3‚Äì4 hojas verdaderas."
        ],
        tip: "Las pl√°ntulas al inicio prefieren luz filtrada, no sol directo fuerte."
      },
      lechuga: {
        titulo: "Lechuga ‚Äì germinaci√≥n",
        metodo: "Semilla directa o en alm√°cigo.",
        pasos: [
          "Sembrar muy superficial, apenas cubierta de sustrato.",
          "Mantener el sustrato siempre h√∫medo.",
          "Siembra en alm√°cigo: trasplantar con 3‚Äì4 hojas.",
          "Siembra directa: ralear, dejando espacio entre plantas."
        ],
        tip: "Germina mejor con temperaturas moderadas y sol suave."
      },
      calabacin_zucchini: {
        titulo: "Calabac√≠n / Zucchini ‚Äì germinaci√≥n",
        metodo: "Semilla directa en el sitio definitivo o tiesto grande.",
        pasos: [
          "Hacer hoyos de 2‚Äì3 cm de profundidad.",
          "Sembrar 2‚Äì3 semillas por hoyo y luego dejar la planta m√°s fuerte.",
          "Mantener el suelo h√∫medo pero sin charcos.",
          "Dejar buen espacio entre plantas, se abren bastante."
        ],
        tip: "Evita mojar hojas todo el tiempo para no favorecer el o√≠dio."
      },
      platano: {
        titulo: "Pl√°tano ‚Äì reproducci√≥n",
        metodo: "Hijuelos / cormos, no semilla.",
        pasos: [
          "Elegir hijuelos sanos, sin pudriciones.",
          "Cortar el hijo y dejarlo orear unas horas.",
          "Plantar enterrando bien el cormo en suelo con buen drenaje.",
          "Regar para asentar la tierra y luego mantener humedad moderada."
        ],
        tip: "No lo pongas donde se empoce el agua."
      },
      gandules: {
        titulo: "Gandules ‚Äì germinaci√≥n",
        metodo: "Semilla directa.",
        pasos: [
          "Sembrar a 2‚Äì3 cm de profundidad.",
          "Colocar 2‚Äì3 semillas por punto de siembra.",
          "Mantener h√∫medo hasta que germinen.",
          "Dejar solo la planta m√°s vigorosa por punto."
        ],
        tip: "No abuses del nitr√≥geno: ya fijan nitr√≥geno en el suelo."
      },
      romero: {
        titulo: "Romero ‚Äì reproducci√≥n",
        metodo: "Principalmente esquejes.",
        pasos: [
          "Cortar esquejes de 8‚Äì12 cm de ramas semile√±osas.",
          "Retirar hojas de la parte que va enterrada.",
          "Clavar en sustrato muy drenante (arena + tierra).",
          "Mantener apenas h√∫medo, en lugar luminoso sin sol fuerte."
        ],
        tip: "Odia el exceso de agua: mejor quedarse corto que pasarse."
      },
      menta: {
        titulo: "Menta ‚Äì reproducci√≥n",
        metodo: "Esquejes o divisi√≥n de mata.",
        pasos: [
          "Cortar tallos de 10‚Äì15 cm con varias hojas.",
          "Quitar las hojas de la parte inferior.",
          "Poner en agua hasta que saque ra√≠ces o en sustrato h√∫medo.",
          "Trasplantar a tiesto cuando tenga buen sistema de ra√≠ces."
        ],
        tip: "Es invasiva: mejor siempre en maceta."
      },
      papa: {
        titulo: "Papa ‚Äì siembra",
        metodo: "Trozos de tub√©rculo con al menos 1‚Äì2 ojos.",
        pasos: [
          "Cortar la papa en trozos con ojos y dejarlos secar 1 d√≠a.",
          "Sembrar a 10 cm de profundidad.",
          "Cuando crece, ir aporcando (echando tierra al tallo).",
          "Mantener riego regular sin encharcar."
        ],
        tip: "Rota el lugar de siembra para evitar plagas y enfermedades."
      },
      yuca: {
        titulo: "Yuca ‚Äì reproducci√≥n",
        metodo: "Estacas de tallo.",
        pasos: [
          "Cortar tallos de 20‚Äì30 cm.",
          "Dejar orear 1‚Äì2 d√≠as.",
          "Enterrar 15‚Äì20 cm del tallo en suelo con buen drenaje.",
          "Riego ligero al inicio; luego tolera bien sequ√≠a."
        ],
        tip: "Evita suelos pesados y encharcados."
      },
      chayote: {
        titulo: "Chayote ‚Äì germinaci√≥n",
        metodo: "El fruto entero se usa como semilla.",
        pasos: [
          "Elegir un chayote sano, sin golpes ni pudrici√≥n.",
          "Dejarlo brotar en un lugar ventilado y sombreado.",
          "Cuando el brote tenga buen tama√±o, plantar el fruto de lado en suelo suelto.",
          "Cubrir parcialmente con tierra y mantener el sustrato h√∫medo, sin encharcar."
        ],
        tip: "Dale una estructura para trepar; es muy vigoroso."
      }
    };

    const GERMINACION_GENERIC = {
      hoja: {
        titulo: "Cultivos de hoja ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla directa o en alm√°cigo, muy superficial.",
        pasos: [
          "Usar sustrato suelto y bien drenado.",
          "Sembrar la semilla casi en superficie, apenas cubierta.",
          "Mantener siempre ligeramente h√∫medo, sin charcos.",
          "Trasplantar (si es alm√°cigo) cuando tenga 3‚Äì4 hojas verdaderas."
        ],
        tip: "Prefieren sol suave o media sombra y riegos frecuentes."
      },
      fruto: {
        titulo: "Cultivos de fruto ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla en alm√°cigo o directa seg√∫n el espacio.",
        pasos: [
          "Sembrar a 1‚Äì2 cm de profundidad seg√∫n tama√±o de semilla.",
          "Mantener el sustrato h√∫medo, no encharcado.",
          "Dar buena luz desde peque√±os para que no se espiguen.",
          "Trasplantar a tiesto grande o suelo cuando est√©n fuertes."
        ],
        tip: "Necesitan mucho sol y macetas profundas o suelo suelto."
      },
      raiz: {
        titulo: "Ra√≠ces ‚Äì germinaci√≥n b√°sica",
        metodo: "Siempre semilla directa en el sitio definitivo.",
        pasos: [
          "Aflojar bien el suelo a buena profundidad.",
          "Sembrar muy superficial (0.5‚Äì1 cm).",
          "Mantener humedad constante hasta que germinen.",
          "Ralear dejando espacio entre plantas."
        ],
        tip: "No trasplantar: se deforman las ra√≠ces."
      },
      tuberculo: {
        titulo: "Tub√©rculos ‚Äì siembra b√°sica",
        metodo: "Trozos de tub√©rculo o estacas seg√∫n el cultivo.",
        pasos: [
          "Elegir material sano, sin pudriciones.",
          "Dejar orear si hace falta (como en papa o yuca).",
          "Enterrar a buena profundidad en suelo suelto.",
          "Mantener riego regular sin encharcar."
        ],
        tip: "Les va bien un suelo profundo y con buena materia org√°nica."
      },
      aromatica: {
        titulo: "Arom√°ticas ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla fina o esquejes, seg√∫n especie.",
        pasos: [
          "Semilla: sembrar muy superficial y mantener humedad fina.",
          "Esquejes: enterrar la parte baja en sustrato h√∫medo.",
          "Colocar en lugar luminoso, sin sol muy fuerte al inicio.",
          "Trasplantar cuando el cepell√≥n est√© firme."
        ],
        tip: "Muchas arom√°ticas prefieren maceta para controlarlas mejor."
      },
      frutal: {
        titulo: "Frutales ‚Äì establecimiento b√°sico",
        metodo: "Plantines o injertos, m√°s que semilla.",
        pasos: [
          "Comprar plant√≠n sano o injertado si es posible.",
          "Hacer hoyo amplio, mejorar el suelo con materia org√°nica.",
          "Plantar al nivel del cuello de la planta.",
          "Regar bien al inicio y tutorar si hace falta."
        ],
        tip: "Los frutales necesitan sitio fijo, sol y paciencia."
      },
      generico: {
        titulo: "Germinaci√≥n b√°sica ‚Äì gu√≠a general",
        metodo: "Semilla directa o en bandeja seg√∫n tama√±o de planta.",
        pasos: [
          "Leer siempre las indicaciones del sobre de semilla.",
          "Usar sustrato suelto y limpio.",
          "Respetar profundidad aproximada de 2‚Äì3 veces el tama√±o de la semilla.",
          "Mantener humedad constante hasta que germinen."
        ],
        tip: "Si dudas, siembra algunas en alm√°cigo y otras directo y observa."
      }
    };

    function getInfoGerminacion(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      if (!cultivo) return null;

      if (GERMINACION_POR_CULTIVO[cultivoId]) {
        return GERMINACION_POR_CULTIVO[cultivoId];
      }

      const cat = (cultivo.categoria || "").toLowerCase();
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;
      if (cat.includes("tub√©rculo") || cat.includes("tuberculo")) return GERMINACION_GENERIC.tuberculo;
      if (cat.includes("arom√°tica") || cat.includes("aromatica")) return GERMINACION_GENERIC.aromatica;
      if (cat.includes("frutal") || cat.includes("fruto")) return GERMINACION_GENERIC.frutal;

      return GERMINACION_GENERIC.generico;
    }

    /*********************
     * Frecuencias de abono / riego
     *********************/
    const FERTILIZACION_FRECUENCIAS = {
      tomate: 21,
      lechuga: 14,
      pepinillo: 21,
      platano: 45,
      pimiento_morron: 21,
      aji: 21,
      berenjena: 21,
      cebolla: 21,
      cebollin: 21,
      zanahoria: 21,
      rabano: 21,
      remolacha: 21,
      papa: 30,
      batata: 30,
      yuca: 45,
      maiz: 21,
      habichuelas: 21,
      habichuela_arbustiva: 21,
      gandules: 30,
      calabaza: 21,
      calabacin_zucchini: 21,
      melon: 21,
      sandia: 21,
      espinaca: 14,
      acelga: 14,
      col_rizada: 14,
      cilantro: 14,
      perejil: 14,
      albahaca: 14,
      oregano: 30,
      menta: 30,
      romero: 30,
      tomillo: 30,
      fresas: 21,
      papaya: 45,
      guayaba: 60,
      parcha: 45,
      mango: 60,
      limon: 60,
      cafe: 60,
      ajo: 21,
      pimiento: 21,
      brocoli: 21,
      china: 60,
      coliflor: 21,
      quimbombo: 21,
      chayote: 45,
      pina: 60
    };

    function getFrecuenciaAbonoParaNombre(nombre) {
      if (!nombre) return 30;
      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(
        c => c.nombre.toLowerCase() === nombreLower
      );
      if (!cultivoCatalogo) return 30;
      return FERTILIZACION_FRECUENCIAS[cultivoCatalogo.id] || 30;
    }

    function getRiegoYCosechaParaNombre(nombre, fechaSiembraISO) {
      let frecuenciaRiego = null;
      let fechaCosechaEstimada = null;

      if (!nombre) return { frecuenciaRiego, fechaCosechaEstimada };

      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(
        c => c.nombre.toLowerCase() === nombreLower
      );

      if (cultivoCatalogo) {
        const riegoTexto = (cultivoCatalogo.riego || "").toLowerCase();

        if (
          riegoTexto.includes("siempre ligeramente") ||
          riegoTexto.includes("constantemente h√∫medo") ||
          riegoTexto.includes("constantemente humedo") ||
          riegoTexto.includes("siempre h√∫medo") ||
          riegoTexto.includes("suelo siempre")
        ) {
          frecuenciaRiego = 2;
        } else if (riegoTexto.includes("abundante")) {
          frecuenciaRiego = 2;
        } else if (
          riegoTexto.includes("poca exigencia") ||
          riegoTexto.includes("sequ√≠a") ||
          riegoTexto.includes("sequia") ||
          riegoTexto.includes("escaso") ||
          riegoTexto.includes("toler")
        ) {
          frecuenciaRiego = 4;
        } else if (
          riegoTexto.includes("moderado") ||
          riegoTexto.includes("regular")
        ) {
          frecuenciaRiego = 3;
        } else if (riegoTexto) {
          frecuenciaRiego = 3;
        }

        if (fechaSiembraISO && cultivoCatalogo.dias) {
          const match = cultivoCatalogo.dias.match(/(\d+)/);
          if (match) {
            const dias = parseInt(match[1], 10);
            if (Number.isFinite(dias) && dias > 0) {
              fechaCosechaEstimada = addDays(fechaSiembraISO, dias);
            }
          }
        }
      }

      return { frecuenciaRiego, fechaCosechaEstimada };
    }

    /*********************
     * Plagas (datos base)
     *********************/
    const PLAGAS_DATA = [
      {
        id: "pulgones",
        nombre: "Pulgones",
        comoSeVe:
          "Peque√±os insectos verdes, negros o amarillos pegados en brotes tiernos y botones florales. Las hojas se enrollan o deforman.",
        manejoSuave:
          "Revisar con frecuencia la parte tierna de las plantas y lavar con agua a presi√≥n suave para tumbarlos.",
        preparadosCaseros:
          "Jab√≥n pot√°sico o una mezcla suave de agua con un poco de jab√≥n neutro (bien diluido) aplicado al atardecer, mojando el env√©s.",
        productosComerciales:
          "Insecticidas de contacto para pulgones autorizados para huerto casero. Siempre seguir la etiqueta y evitar horas de sol fuerte."
      },
      {
        id: "mosca_blanca",
        nombre: "Mosca blanca",
        comoSeVe:
          "Al mover la hoja salen volantitos blancos. En el env√©s se ven peque√±os puntos blancos fijos. Suelen dejar melaza pegajosa.",
        manejoSuave:
          "Retirar hojas muy afectadas y mantener buena ventilaci√≥n entre plantas.",
        preparadosCaseros:
          "Trampas amarillas adhesivas cerca de las plantas y aplicaciones suaves de jab√≥n pot√°sico o infusi√≥n de ajo como apoyo.",
        productosComerciales:
          "Productos espec√≠ficos para mosca blanca de uso dom√©stico, aplicados al atardecer y siguiendo instrucciones."
      },
      {
        id: "orugas",
        nombre: "Orugas (cortadoras de hojas)",
        comoSeVe:
          "Hojas con mordidas grandes o casi comidas completas. A veces se encuentran las orugas en el env√©s o escondidas entre hojas.",
        manejoSuave:
          "Revisi√≥n manual frecuente y retiro de orugas a mano (con guantes). Muy efectivo en huertos peque√±os.",
        preparadosCaseros:
          "Infusiones de ajo y aj√≠ como repelente, combinadas con la recolecci√≥n manual.",
        productosComerciales:
          "Bacillus thuringiensis (BT) para orugas j√≥venes, solo si es necesario y siguiendo la etiqueta."
      },
      {
        id: "caracoles_babosas",
        nombre: "Caracoles y babosas",
        comoSeVe:
          "Hojas con mordidas irregulares y rastros de baba plateada en el suelo o las macetas.",
        manejoSuave:
          "Mantener el √°rea limpia de escombros donde se escondan. Revisar al atardecer o de noche y recogerlos a mano.",
        preparadosCaseros:
          "Refugios-trampa donde se esconden y luego retirarlos; barreras de c√°scara de huevo triturada alrededor de plantas sensibles.",
        productosComerciales:
          "Cebos espec√≠ficos para babosas/caracoles aptos para huerto casero; usar en peque√±as cantidades y lejos de mascotas/ni√±os."
      },
      {
        id: "arana_roja",
        nombre: "Ara√±a roja",
        comoSeVe:
          "Puntos amarillos muy finos en las hojas, que luego se ven apagadas. En ataques severos aparece una fina telara√±a.",
        manejoSuave:
          "Aumentar humedad ambiental y duchas de agua en el env√©s de las hojas.",
        preparadosCaseros:
          "Jab√≥n pot√°sico muy diluido o infusi√≥n de ajo aplicada cada pocos d√≠as, siempre al atardecer.",
        productosComerciales:
          "Acaricidas autorizados para ara√±a roja en huerto casero; usar solo si el da√±o es muy fuerte."
      },
      {
        id: "trips",
        nombre: "Trips",
        comoSeVe:
          "Manchas plateadas o rayas en hojas y p√©talos. Al mirar de cerca se ven insectos alargados, muy finos y r√°pidos.",
        manejoSuave:
          "Eliminar flores y hojas muy da√±adas, mejorar ventilaci√≥n y evitar exceso de fertilizaci√≥n.",
        preparadosCaseros:
          "Trampas azules o amarillas adhesivas y jab√≥n pot√°sico suave como apoyo.",
        productosComerciales:
          "Insecticidas para trips de uso dom√©stico, respetando tiempos de seguridad antes de cosechar."
      },
      {
        id: "cochinillas",
        nombre: "Cochinillas",
        comoSeVe:
          "Bultitos algodonosos o duros pegados a tallos y hojas. Producen melaza pegajosa y atraen hormigas.",
        manejoSuave:
          "Quitar las cochinillas a mano o con hisopo y alcohol. Podar las partes muy infestadas.",
        preparadosCaseros:
          "Aplicaciones de jab√≥n pot√°sico y aceites vegetales suaves (hort√≠colas) en el env√©s y tallos.",
        productosComerciales:
          "Aceites hort√≠colas minerales o productos espec√≠ficos para cochinilla."
      },
      {
        id: "minador_hoja",
        nombre: "Minador de hoja (c√≠tricos)",
        comoSeVe:
          "Galer√≠as claras dentro de la hoja, como l√≠neas serpenteantes. Afecta sobre todo hojas tiernas.",
        manejoSuave:
          "Podar y desechar hojas y brotes m√°s da√±ados. Evitar exceso de fertilizante muy fuerte.",
        preparadosCaseros:
          "No hay remedio casero que lo elimine del todo, pero ayuda mantener plantas fuertes y retirar hojas reci√©n afectadas.",
        productosComerciales:
          "Aceites hort√≠colas o productos espec√≠ficos para minador de hoja en c√≠tricos."
      },
      {
        id: "hongos_hoja",
        nombre: "Hongos de hoja (mildiu, o√≠dio, manchas)",
        comoSeVe:
          "Manchas amarillas o caf√©s, a veces polvillo blanco sobre la hoja. Empeoran con humedad alta y poca ventilaci√≥n.",
        manejoSuave:
          "Mejorar ventilaci√≥n, evitar mojar el follaje de noche y quitar hojas muy enfermas.",
        preparadosCaseros:
          "Soluciones suaves de bicarbonato de potasio o infusiones de cola de caballo, usadas de forma preventiva.",
        productosComerciales:
          "Fungicidas autorizados para huerto casero, respetando tiempos de seguridad antes de cosechar."
      }
    ];

    /*********************
     * Estado global
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";

    /*********************
     * Render de UI
     *********************/
    function updateHeader() {
      const subtitleEl = document.getElementById("appSubtitle");
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${nombre}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${clima}</span>
        <span class="app-subtitle-dot"></span>
        <span>${hemis}</span>
      `;
    }

    function updateSettingsContexts() {
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      document.querySelectorAll(".settings-context").forEach(el => {
        el.innerHTML = `
          <span class="chip"><span>üåø</span> Huerto: ${nombre}</span>
          <span class="chip"><span>‚òÅÔ∏è</span> Clima: ${clima}</span>
          <span class="chip"><span>üß≠</span> ${hemis}</span>
        `;
      });

      const climaText = `Clima ${clima}`;
      const estadoClimaChip = document.getElementById("estadoClimaChip");
      if (estadoClimaChip) estadoClimaChip.textContent = climaText;
      const calChip = document.getElementById("calendarioClimaChip");
      if (calChip) calChip.textContent = climaText;
      const calChip2 = document.getElementById("calendarioClimaChip2");
      if (calChip2) calChip2.textContent = climaText;
    }

    function renderInicio() {
      const cultivos = stateCultivos;
      const diario = stateDiario;
      const cultivosCount = cultivos.length;
      const hoyISO = todayISO();

      const entradasHoy = diario.filter(e => e.fecha === hoyISO).length;

      const cultivosCountEl = document.getElementById("estadoCultivosCount");
      const entradasCountEl = document.getElementById("estadoEntradasCount");
      if (cultivosCountEl) cultivosCountEl.textContent = String(cultivosCount);
      if (entradasCountEl) entradasCountEl.textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      const nombre = stateSettings.nombreHuerto || "tu huerto";

      if (resumen) {
        let texto;

        if (!cultivosCount && !entradasHoy) {
          texto =
            'Todav√≠a no has registrado cultivos ni entradas en el diario. Empieza a√±adiendo tu primer cultivo en "Mi huerto".';
        } else if (cultivosCount && !entradasHoy) {
          texto = `Tienes ${cultivosCount} cultivo(s) registrado(s) en ${nombre}. A√∫n no has escrito nada en el diario hoy.`;
        } else if (cultivosCount && entradasHoy) {
          texto = `Llevas ${cultivosCount} cultivo(s) activo(s) y ya registraste ${entradasHoy} nota(s) en el diario hoy. ¬°Buen trabajo!`;
        } else {
          texto =
            'Tienes anotaciones en el diario pero a√∫n no has a√±adido cultivos. Usa "Mi huerto" para registrar lo que est√°s sembrando.';
        }

        const pendientesAbono = getPendientesAbono();
        const pendientesRiego = getPendientesRiego();
        const cosechasHoy = getCosechasHoy();

        if (pendientesAbono.length) {
          const nombresAbono = pendientesAbono.map(c => c.nombre).join(", ");
          texto += ` Hoy toca revisar abonado de: ${nombresAbono}.`;
        }
        if (pendientesRiego.length) {
          const nombresRiego = pendientesRiego.map(c => c.nombre).join(", ");
          texto += ` Tambi√©n toca riego para: ${nombresRiego}.`;
        }
        if (cosechasHoy.length) {
          const nombresCosecha = cosechasHoy.map(c => c.nombre).join(", ");
          texto += ` Posibles cosechas listas: ${nombresCosecha}.`;
        }

        resumen.textContent = texto;
      }

      const cardRecord = document.getElementById("recordatoriosCard");
      const listRecord = document.getElementById("recordatoriosList");

      if (cardRecord && listRecord) {
        const pendientesAbono = getPendientesAbono();
        const pendientesRiego = getPendientesRiego();
        const cosechasHoy = getCosechasHoy();

        if (
          !pendientesAbono.length &&
          !pendientesRiego.length &&
          !cosechasHoy.length
        ) {
          cardRecord.style.display = "none";
          listRecord.innerHTML = "";
        } else {
          cardRecord.style.display = "block";
          listRecord.innerHTML = "";

          const hoyISO2 = todayISO();

          pendientesAbono.forEach(c => {
            const dias = daysBetween(c.ultimaFertilizacion, hoyISO2);
            const li = document.createElement("li");
            li.textContent = `Abono ¬∑ ${c.nombre} ‚Äî √∫ltimo abono hace ${dias} d√≠a(s). Frecuencia: cada ${c.frecuenciaAbonoDias} d√≠a(s).`;
            listRecord.appendChild(li);
          });

          pendientesRiego.forEach(c => {
            const base = c.ultimoRiego || c.fechaSiembra || c.creadoEl;
            const dias = base ? daysBetween(base, hoyISO2) : "?";
            const freq = c.frecuenciaRiegoDias || "?";
            const li = document.createElement("li");
            li.textContent = `Riego ¬∑ ${c.nombre} ‚Äî √∫ltimo riego hace ${dias} d√≠a(s). Frecuencia: cada ${freq} d√≠a(s).`;
            listRecord.appendChild(li);
          });

          cosechasHoy.forEach(c => {
            const li = document.createElement("li");
            li.textContent = `Cosecha ¬∑ ${c.nombre} ‚Äî fecha estimada ${formatDate(
              c.fechaCosechaEstimada
            )}.`;
            listRecord.appendChild(li);
          });
        }
      }

      const now = new Date();
      const monthIndex = now.getMonth();
      const data = getCalendarData(stateSettings, monthIndex);
      const calHoyTexto = document.getElementById("calendarioHoyTexto");

      if (calHoyTexto) {
        if (data.length === 0) {
          calHoyTexto.textContent = `En ${nombre} no hay recomendaciones espec√≠ficas para este mes con el clima actual, pero puedes consultar los dem√°s meses en el calendario.`;
        } else {
          const nombres = data.map(d => d.titulo).join(", ");
          calHoyTexto.textContent = `Para este mes se sugieren cultivos como: ${nombres}. Revisa el calendario para ver el detalle.`;
        }
      }
    }

    function renderCultivos() {
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      const resumenEl = document.getElementById("huertoAbonoResumen");
      if (!listEl) return;

      const count = stateCultivos.length;
      if (chip) chip.textContent = `${count} cultivo${count === 1 ? "" : "s"}`;

      const hoyISO = todayISO();

      function estadoAbono(cultivo) {
        if (!cultivo.ultimaFertilizacion || !cultivo.frecuenciaAbonoDias) return null;
        const diasDesde = daysBetween(cultivo.ultimaFertilizacion, hoyISO);
        const diasRestantes = cultivo.frecuenciaAbonoDias - diasDesde;
        if (diasRestantes > 5) return "alDia";
        if (diasRestantes >= 0) return "proximo";
        return "atrasado";
      }

      if (resumenEl) {
        if (!count) {
          resumenEl.innerHTML = "";
        } else {
          const { alDia, porVencer, atrasados } = getResumenAbono();
          resumenEl.innerHTML = `
            <button type="button" class="chip" id="chipAlDia">
              <span>‚úÖ</span> Al d√≠a: ${alDia}
            </button>
            <button type="button" class="chip" id="chipProx">
              <span>‚è∞</span> Pr√≥x. 5 d√≠as: ${porVencer}
            </button>
            <button type="button" class="chip chip-danger" id="chipAtrasados">
              <span>‚ö†Ô∏è</span> Atrasados: ${atrasados}
            </button>
          `;

          function mostrarGrupo(grupo) {
            const nombres = stateCultivos
              .filter(c => estadoAbono(c) === grupo)
              .map(c => `‚Ä¢ ${c.nombre}`);
            if (!nombres.length) {
              alert("No hay cultivos en ese grupo ahora mismo.");
              return;
            }
            const titulo =
              grupo === "alDia"
                ? "Cultivos al d√≠a:"
                : grupo === "proximo"
                ? "Cultivos que tocar√°n en los pr√≥ximos 5 d√≠as:"
                : "Cultivos atrasados:";
            alert(titulo + "\n\n" + nombres.join("\n"));
          }

          const chipAlDia = document.getElementById("chipAlDia");
          const chipProx = document.getElementById("chipProx");
          const chipAtr = document.getElementById("chipAtrasados");

          if (chipAlDia)
            chipAlDia.addEventListener("click", () => mostrarGrupo("alDia"));
          if (chipProx)
            chipProx.addEventListener("click", () => mostrarGrupo("proximo"));
          if (chipAtr)
            chipAtr.addEventListener("click", () => mostrarGrupo("atrasado"));
        }
      }

      if (!count) {
        listEl.innerHTML =
          '<p class="muted">Todav√≠a no has registrado cultivos. Usa el formulario de arriba para a√±adir tu primera siembra.</p>';
        return;
      }

      listEl.innerHTML = "";
      stateCultivos.forEach(c => {
        const est = estadoAbono(c);

        let claseEstado = "";
        if (est === "alDia") claseEstado = " cultivo-card--ok";
        else if (est === "proximo") claseEstado = " cultivo-card--alerta";
        else if (est === "atrasado") claseEstado = " cultivo-card--critico";

        const card = document.createElement("div");
        card.className = "cultivo-card" + claseEstado;

        const tipoLabelMap = {
          hoja: "Hoja",
          fruto: "Fruto",
          raiz: "Ra√≠z",
          tuberculo: "Tub√©rculo",
          aromaticas: "Arom√°ticas",
          otro: "Otro"
        };
        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";

        const ultimaAbonoTexto = c.ultimaFertilizacion
          ? formatDate(c.ultimaFertilizacion)
          : "Sin registro";
        const frecuenciaAbonoTexto = c.frecuenciaAbonoDias
          ? c.frecuenciaAbonoDias + " d√≠as"
          : "No definida";

        const ultimoRiegoTexto = c.ultimoRiego
          ? formatDate(c.ultimoRiego)
          : "Sin registro";
        const frecuenciaRiegoTexto = c.frecuenciaRiegoDias
          ? c.frecuenciaRiegoDias + " d√≠as"
          : "No definida";

        const fechaCosechaTexto = c.fechaCosechaEstimada
          ? formatDate(c.fechaCosechaEstimada)
          : "No definida";

        let etiquetaEstado = "";
        if (est === "alDia") etiquetaEstado = "‚úÖ Al d√≠a";
        else if (est === "proximo") etiquetaEstado = "‚è∞ Pr√≥x. 5 d√≠as";
        else if (est === "atrasado") etiquetaEstado = "‚ö†Ô∏è Atrasado";

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <span>üåø</span>
              <span>${c.nombre}</span>
            </div>
            <span class="chip">${tipoLabel}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${c.variedad || "Sin especificar"}</div>
            <div><strong>Fecha de siembra:</strong> ${formatDate(c.fechaSiembra)}</div>
            <div><strong>Ubicaci√≥n / notas cortas:</strong> ${
              c.notas ? c.notas.slice(0, 140) : "‚Äî"
            }</div>
            <div><strong>Registro creado:</strong> ${formatDate(c.creadoEl)}</div>
            <div><strong>√öltimo abono:</strong> ${ultimaAbonoTexto}</div>
            <div><strong>Frecuencia de abono:</strong> ${frecuenciaAbonoTexto}</div>
            <div><strong>√öltimo riego:</strong> ${ultimoRiegoTexto}</div>
            <div><strong>Frecuencia de riego:</strong> ${frecuenciaRiegoTexto}</div>
            <div><strong>Fecha est. cosecha:</strong> ${fechaCosechaTexto}</div>
          </div>
          ${
            etiquetaEstado
              ? `<div class="cultivo-notas"><strong>Estado de abono:</strong> ${etiquetaEstado}</div>`
              : ""
          }
          <div class="cultivo-actions">
            <button class="btn-secondary btn" data-id="${c.id}" data-action="nota">‚úèÔ∏è A√±adir nota en diario</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="riego">üí¶ Registrar riego hoy</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="abono">üíß Registrar abono hoy</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="plaga">üêõ Plagas de este cultivo</button>
            <button class="btn-danger btn" data-id="${c.id}" data-action="borrar">üóë Eliminar</button>
          </div>
        `;

        listEl.appendChild(card);
      });
    }

    function renderCalendario(monthIndex = 5) {
      const listEl = document.getElementById("calendarList");
      const emptyEl = document.getElementById("calendarEmpty");
      if (!listEl || !emptyEl) return;

      const data = getCalendarData(stateSettings, monthIndex);

      listEl.innerHTML = "";

      if (data.length) {
        emptyEl.style.display = "none";

        data.forEach(item => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${item.titulo}</span>
              <span class="chip">${item.tipo}</span>
            </div>
            <div>${item.detalle}</div>
          `;
          listEl.appendChild(div);
        });
      } else {
        emptyEl.style.display = "block";
      }

      const mesCatalogo = ajustarMesPorHemisferio(stateSettings, monthIndex);

      const sugeridos = CATALOGO_CULTIVOS.filter(
        c => Array.isArray(c.meses) && c.meses.includes(mesCatalogo)
      );

      if (sugeridos.length) {
        const separador = document.createElement("div");
        separador.className = "divider-soft";
        listEl.appendChild(separador);

        const tituloExtra = document.createElement("p");
        tituloExtra.className = "muted";
        tituloExtra.textContent =
          "Desde el cat√°logo: cultivos recomendados para este mes.";
        listEl.appendChild(tituloExtra);

        sugeridos.forEach(c => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${c.nombre}</span>
              <span class="chip">${c.categoria || "Cultivo"}</span>
            </div>
            <div>
              D√≠as a cosecha: ${c.dias}. Luz: ${c.luz}.
              Plagas frecuentes: ${c.plagas.join(", ")}.
            </div>
          `;
          listEl.appendChild(div);
        });
      }
    }

    function renderDiario() {
      const listEl = document.getElementById("diarioList");
      const chip = document.getElementById("diarioCountChip");
      const resumenHoyEl = document.getElementById("diarioResumenHoy");
      if (!listEl) return;

      const arrOrdenada = [...stateDiario].sort((a, b) =>
        b.fecha.localeCompare(a.fecha)
      );
      const countTotal = arrOrdenada.length;

      if (chip) {
        chip.textContent = `${countTotal} entrada${countTotal === 1 ? "" : "s"}`;
      }

      if (resumenHoyEl) {
        const hoy = todayISO();
        const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);

        if (!hoyEntries.length) {
          resumenHoyEl.textContent =
            "Hoy a√∫n no has registrado nada en el diario.";
        } else {
          const riegos = hoyEntries.filter(e => e.tipo === "Riego").length;
          const abonos = hoyEntries.filter(e => e.tipo === "Abono").length;
          const otros = hoyEntries.length - riegos - abonos;

          const partes = [];
          if (riegos) partes.push(`${riegos} riego(s)`);
          if (abonos) partes.push(`${abonos} abono(s)`);
          if (otros) partes.push(`${otros} nota(s) general(es)`);

          resumenHoyEl.textContent = `Hoy registraste: ${partes.join(", ")}.`;
        }
      }

      const arrFiltrada = arrOrdenada.filter(e => {
        if (diarioFiltroActual === "todos") return true;
        return (e.tipo || "General") === diarioFiltroActual;
      });

      if (!arrFiltrada.length) {
        listEl.innerHTML =
          '<p class="muted">No hay entradas que coincidan con el filtro seleccionado.</p>';
        return;
      }

      listEl.innerHTML = "";
      arrFiltrada.forEach(e => {
        const div = document.createElement("div");
        div.className = "diario-item";
        div.innerHTML = `
          <div class="diario-item-header">
            <span><strong>${formatDate(e.fecha)}</strong></span>
            <span class="chip">${e.tipo || "General"}</span>
          </div>
          <div>${e.texto}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function renderPlagas(highlightId) {
      const listEl = document.getElementById("plagasList");
      if (!listEl) return;

      listEl.innerHTML = "";
      PLAGAS_DATA.forEach(p => {
        const isHighlighted = highlightId && p.id === highlightId;
        const div = document.createElement("div");
        div.className =
          "plaga-card" + (isHighlighted ? " plaga-card--highlight" : "");
        div.innerHTML = `
          <div class="media-item-title">üêõ ${p.nombre}</div>
          <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${p.comoSeVe}</div>
          <div class="media-item-body"><strong>Manejo suave:</strong> ${p.manejoSuave}</div>
          <div class="media-item-body"><strong>Preparados caseros / apoyo:</strong> ${p.preparadosCaseros}</div>
          <div class="media-item-body"><strong>Productos comerciales (lee la etiqueta):</strong> ${p.productosComerciales}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function renderPesticidas() {
      const listEl = document.getElementById("pesticidasList");
      if (!listEl) return;

      const data = [
        {
          nombre: "Jab√≥n pot√°sico / neutro suave",
          paraQue: "Ayuda a controlar pulgones, mosca blanca y cochinillas en la parte a√©rea.",
          ingredientes: "- 10‚Äì15 ml de jab√≥n pot√°sico o jab√≥n neutro l√≠quido\n- 1 litro de agua",
          preparacion: "Mezcla el jab√≥n en el agua hasta que quede bien disuelto.",
          aplicacion: "Aplicar en pulverizaci√≥n fina sobre hojas (sobre todo env√©s) al atardecer, cada 5‚Äì7 d√≠as seg√∫n necesidad.",
          advertencias: "No usar dosis m√°s concentradas; puede quemar hojas delicadas. No aplicar a pleno sol."
        },
        {
          nombre: "Infusi√≥n de ajo y aj√≠ picante",
          paraQue: "Repelente general para pulgones, orugas peque√±as y algunas plagas chupadoras.",
          ingredientes: "- 3‚Äì4 dientes de ajo\n- 1 trocito de aj√≠ picante o 1/2 cdta de aj√≠ en polvo\n- 1 litro de agua\n- 3‚Äì5 ml de jab√≥n neutro (opcional) como adherente",
          preparacion: "Tritura el ajo y el aj√≠ en un poco de agua, deja reposar 12‚Äì24 h, cuela y completa hasta 1 litro. A√±ade el jab√≥n si quieres que se adhiera mejor.",
          aplicacion: "Pulverizar sobre hojas y tallos al atardecer, 1‚Äì2 veces por semana como prevenci√≥n o cuando veas inicio de plaga.",
          advertencias: "Prueba primero en pocas hojas. Evita contacto con ojos y piel; l√°vate bien las manos despu√©s."
        },
        {
          nombre: "Bicarbonato para hongos de hoja",
          paraQue: "Apoyo preventivo contra o√≠dio y algunos hongos de superficie.",
          ingredientes: "- 5 g (1 cucharadita) de bicarbonato de sodio\n- 1 litro de agua\n- 5 ml de jab√≥n neutro (opcional)",
          preparacion: "Disuelve el bicarbonato en el agua, a√±ade el jab√≥n y mezcla bien.",
          aplicacion: "Pulverizar sobre hojas afectadas 1 vez por semana, siempre al atardecer y con clima seco.",
          advertencias: "No excedas la dosis; demasiado bicarbonato puede quemar hojas. Suspende si ves amarilleo o quemaduras."
        }
      ];

      listEl.innerHTML = "";
      data.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card";
        div.innerHTML = `
          <div class="media-item-title">üíß ${p.nombre}</div>
          <div class="media-item-body"><strong>¬øPara qu√© sirve?</strong> ${p.paraQue}</div>
          <div class="media-item-body"><strong>Ingredientes (por litro):</strong><br>${p.ingredientes.replace(/\n/g,"<br>")}</div>
          <div class="media-item-body"><strong>Preparaci√≥n:</strong> ${p.preparacion}</div>
          <div class="media-item-body"><strong>C√≥mo aplicar:</strong> ${p.aplicacion}</div>
          <div class="media-item-body"><strong>Advertencias:</strong> ${p.advertencias}</div>
        `;
        listEl.appendChild(div);
      });
    }

    /*********************
     * Cat√°logo: render + b√∫squeda
     *********************/
    function renderCatalogo(filtroTexto = "") {
      const listEl = document.getElementById("catalogoList");
      if (!listEl) return;

      const filtro = filtroTexto.trim().toLowerCase();
      const lista = CATALOGO_CULTIVOS.filter(c => {
        if (!filtro) return true;
        return (
          c.nombre.toLowerCase().includes(filtro) ||
          c.id.toLowerCase().includes(filtro)
        );
      });

      if (!lista.length) {
        listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${filtroTexto}".</p>`;
        return;
      }

      listEl.innerHTML = "";
      lista.forEach(c => {
        const imgSrc = c.imagen || "img/placeholder.jpg";

        const card = document.createElement("div");
        card.className = "cultivo-card";
        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <img
                src="${imgSrc}"
                alt="${c.nombre}"
                class="cultivo-thumb"
                onerror="this.onerror=null;this.src='img/placeholder.jpg';"
              />
              <span>üå± ${c.nombre}</span>
            </div>
            <span class="chip">${c.categoria}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>D√≠as a cosecha:</strong> ${c.dias}</div>
            <div><strong>Luz:</strong> ${c.luz}</div>
            <div><strong>Riego:</strong> ${c.riego}</div>
            <div><strong>Tiesto / suelo:</strong> ${c.tiesto}</div>
            <div><strong>Profundidad de siembra:</strong> ${c.profundidad}</div>
            <div><strong>Plagas frecuentes:</strong> ${c.plagas.join(", ")}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn-secondary btn"
                    data-id="${c.id}"
                    data-action="germinacion">
              üîÅ Ver germinaci√≥n / reproducci√≥n
            </button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function setupCatalogo() {
      const input = document.getElementById("catalogoBusqueda");
      const listEl = document.getElementById("catalogoList");

      if (input) {
        input.addEventListener("input", () => {
          renderCatalogo(input.value);
        });
      }

      if (listEl) {
        listEl.addEventListener("click", ev => {
          const btn = ev.target.closest("button[data-action='germinacion']");
          if (!btn) return;

          const id = btn.getAttribute("data-id");
          const info = getInfoGerminacion(id);
          if (!info) {
            alert("Todav√≠a no tengo la gu√≠a de germinaci√≥n para este cultivo.");
            return;
          }

          const textoPasos = info.pasos
            .map((p, i) => `${i + 1}. ${p}`)
            .join("\n");

          alert(
            `${info.titulo}\n\n` +
            `M√©todo principal: ${info.metodo}\n\n` +
            `Pasos:\n${textoPasos}\n\n` +
            `Tip: ${info.tip}`
          );
        });
      }
    }

    /*********************
     * Navegaci√≥n
     *********************/
    function setupNavigation() {
      const navButtons = document.querySelectorAll(".nav-btn");
      navButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.getAttribute("data-section");
          if (!section) return;

          navButtons.forEach(b =>
            b.classList.toggle("nav-btn--active", b === btn)
          );

          document.querySelectorAll(".section").forEach(sec => {
            sec.classList.toggle(
              "section--active",
              sec.id === `section-${section}`
            );
          });
        });
      });

      const btnHuerto = document.getElementById("btnIrMiHuerto");
      const btnDiario = document.getElementById("btnIrDiario");
      const btnClima = document.getElementById("btnIrClima");
      const btnVerCalendario = document.getElementById("btnVerCalendario");
      const btnRecordatorios = document.getElementById("btnVerRecordatorios");

      if (btnHuerto) {
        btnHuerto.addEventListener("click", () => {
          document.querySelector('.nav-btn[data-section="huerto"]').click();
        });
      }
      if (btnDiario) {
        btnDiario.addEventListener("click", () => {
          document.querySelector('.nav-btn[data-section="diario"]').click();
        });
      }
      if (btnClima) {
        btnClima.addEventListener("click", () => {
          document.querySelector('.nav-btn[data-section="opciones"]').click();
        });
      }
      if (btnVerCalendario) {
        btnVerCalendario.addEventListener("click", () => {
          document.querySelector('.nav-btn[data-section="calendario"]').click();
        });
      }

      if (btnRecordatorios) {
        btnRecordatorios.addEventListener("click", () => {
          const recordatoriosAbono = getRecordatoriosAbono();
          const pendientesRiego = getPendientesRiego();
          const cosechasHoy = getCosechasHoy();

          if (
            !recordatoriosAbono.length &&
            !pendientesRiego.length &&
            !cosechasHoy.length
          ) {
            alert(
              "Por ahora no hay recordatorios pendientes.\n\n" +
                "Cuando registres abonos y riegos, aqu√≠ ver√°s qu√© toca hoy."
            );
            return;
          }

          const lineas = [];

          if (recordatoriosAbono.length) {
            lineas.push("Abono:");
            recordatoriosAbono.forEach(r => {
              lineas.push(`‚Ä¢ ${r.nombre} ‚Äî ${r.estadoLabel}`);
            });
            lineas.push("");
          }

          if (pendientesRiego.length) {
            lineas.push("Riego:");
            const hoy = todayISO();
            pendientesRiego.forEach(c => {
              const base = c.ultimoRiego || c.fechaSiembra || c.creadoEl;
              const diasDesde = base ? daysBetween(base, hoy) : "?";
              const freq = c.frecuenciaRiegoDias || "?";
              lineas.push(
                `‚Ä¢ ${c.nombre} ‚Äî √∫ltimo riego hace ${diasDesde} d√≠a(s), frecuencia ${freq} d√≠a(s).`
              );
            });
            lineas.push("");
          }

          if (cosechasHoy.length) {
            lineas.push("Cosecha:");
            cosechasHoy.forEach(c => {
              lineas.push(
                `‚Ä¢ ${c.nombre} ‚Äî fecha estimada ${formatDate(
                  c.fechaCosechaEstimada
                )}.`
              );
            });
            lineas.push("");
          }

          alert("üîî Recordatorios del huerto:\n\n" + lineas.join("\n"));
        });
      }
    }

    function setupMesesPills() {
      const pills = document.querySelectorAll("#mesesPills .pill");
      pills.forEach(p => {
        p.addEventListener("click", () => {
          pills.forEach(other =>
            other.classList.toggle("pill--active", other === p)
          );
          const month = parseInt(p.getAttribute("data-mes"), 10);
          renderCalendario(month);
        });
      });

      const now = new Date();
      const currentMonth = now.getMonth();
      const target = Array.from(pills).find(
        p => parseInt(p.dataset.mes, 10) === currentMonth
      );
      if (target) target.click();
      else renderCalendario(5);
    }

    function setupMiHuertoForm() {
      const btn = document.getElementById("btnAgregarCultivo");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const nombre = document.getElementById("cultivoNombre").value.trim();
        const variedad = document.getElementById("cultivoVariedad").value.trim();
        const tipo = document.getElementById("cultivoTipo").value || "otro";
        const fechaSiembra =
          document.getElementById("cultivoFecha").value || todayISO();
        const notas = document.getElementById("cultivoNotas").value.trim();

        if (!nombre) {
          alert("Por favor escribe al menos el nombre del cultivo.");
          return;
        }

        const frecuenciaBase = getFrecuenciaAbonoParaNombre(nombre);
        const extra = getRiegoYCosechaParaNombre(nombre, fechaSiembra);

        const nuevo = {
          id: Date.now().toString(36),
          nombre,
          variedad,
          tipo,
          fechaSiembra,
          notas,
          creadoEl: todayISO(),
          frecuenciaAbonoDias: frecuenciaBase,
          ultimaFertilizacion: null,
          frecuenciaRiegoDias: extra.frecuenciaRiego,
          ultimoRiego: null,
          fechaCosechaEstimada: extra.fechaCosechaEstimada || null
        };

        stateCultivos.push(nuevo);
        saveCultivos(stateCultivos);

        document.getElementById("cultivoNombre").value = "";
        document.getElementById("cultivoVariedad").value = "";
        document.getElementById("cultivoFecha").value = "";
        document.getElementById("cultivoNotas").value = "";

        renderCultivos();
        renderInicio();
        alert("Cultivo guardado.");
      });

      const list = document.getElementById("cultivosList");
      if (!list) return;

      list.addEventListener("click", ev => {
        const btn = ev.target.closest("button[data-id]");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        const cultivo = stateCultivos.find(c => c.id === id);
        if (!cultivo) return;

        if (action === "borrar") {
          if (confirm(`¬øEliminar el cultivo "${cultivo.nombre}"?`)) {
            stateCultivos = stateCultivos.filter(c => c.id !== id);
            saveCultivos(stateCultivos);
            renderCultivos();
            renderInicio();
          }
        } else if (action === "nota") {
          const navBtn = document.querySelector('.nav-btn[data-section="diario"]');
          if (navBtn) navBtn.click();
          const campo = document.getElementById("diarioTexto");
          if (campo) {
            campo.value = `Cultivo: ${cultivo.nombre} (${cultivo.variedad || "sin variedad"}). `;
            campo.focus();
          }
        } else if (action === "abono") {
          cultivo.ultimaFertilizacion = todayISO();
          if (!cultivo.frecuenciaAbonoDias) {
            cultivo.frecuenciaAbonoDias = 30;
          }

          stateDiario.push({
            id: Date.now().toString(36),
            fecha: todayISO(),
            texto: `Abono registrado para ${cultivo.nombre}${
              cultivo.variedad ? ` (${cultivo.variedad})` : ""
            }.`,
            tipo: "Abono"
          });

          saveCultivos(stateCultivos);
          saveDiario(stateDiario);
          renderCultivos();
          renderDiario();
          renderInicio();
          alert(`Se registr√≥ que abonaste "${cultivo.nombre}" hoy.`);
        } else if (action === "riego") {
          cultivo.ultimoRiego = todayISO();
          if (!cultivo.frecuenciaRiegoDias) {
            const entrada = prompt(
              "¬øCada cu√°ntos d√≠as quieres regar este cultivo? (n√∫mero de d√≠as)",
              "2"
            );
            const n = parseInt(entrada, 10);
            if (Number.isFinite(n) && n > 0) {
              cultivo.frecuenciaRiegoDias = n;
            }
          }

          stateDiario.push({
            id: Date.now().toString(36),
            fecha: todayISO(),
            texto: `Riego registrado para ${cultivo.nombre}${
              cultivo.variedad ? ` (${cultivo.variedad})` : ""
            }.`,
            tipo: "Riego"
          });

          saveCultivos(stateCultivos);
          saveDiario(stateDiario);
          renderCultivos();
          renderDiario();
          renderInicio();
          alert(`Se registr√≥ que regaste "${cultivo.nombre}" hoy.`);
        } else if (action === "plaga") {
          const entrada = prompt(
            'Escribe la plaga que quieres consultar (ej. "minador", "pulgones", "ara√±a roja"):'
          );
          if (!entrada) return;

          const texto = entrada.trim().toLowerCase();
          const plaga = PLAGAS_DATA.find(p =>
            p.nombre.toLowerCase().includes(texto)
          );

          if (!plaga) {
            alert(
              "No encontr√© esa plaga en la lista. Prueba con nombres como: pulgones, mosca blanca, ara√±a roja, etc."
            );
            return;
          }

          cultivo.plagaId = plaga.id;
          saveCultivos(stateCultivos);

          const navPlagas = document.querySelector(
            '.nav-btn[data-section="plagas"]'
          );
          if (navPlagas) navPlagas.click();
          renderPlagas(plaga.id);
          alert(`Mostrando informaci√≥n para: ${plaga.nombre}.`);
        }
      });
    }

    function setupDiario() {
      const btn = document.getElementById("btnGuardarDiario");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const campo = document.getElementById("diarioTexto");
        const texto = campo.value.trim();
        if (!texto) {
          alert("Escribe algo antes de guardar.");
          return;
        }

        const entrada = {
          id: Date.now().toString(36),
          fecha: todayISO(),
          texto,
          tipo: "General"
        };

        stateDiario.push(entrada);
        saveDiario(stateDiario);
        campo.value = "";
        renderDiario();
        renderInicio();
        alert("Entrada guardada en el diario.");
      });

      const filtros = document.querySelectorAll("#diarioFiltros .pill");

      filtros.forEach(filtro => {
        filtro.addEventListener("click", () => {
          filtros.forEach(b => b.classList.remove("pill--active"));
          filtro.classList.add("pill--active");

          diarioFiltroActual = filtro.dataset.filtro || "todos";
          renderDiario();
        });
      });
    }

    function exportarDatosPDF() {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("No se pudo cargar la librer√≠a para PDF. Verifica tu conexi√≥n.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4"
        });

        const marginLeft = 10;
        const maxWidth = 190 - marginLeft * 2;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Diario", marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        const fechaGen = new Date().toLocaleString();
        doc.text(`Generado: ${fechaGen}`, marginLeft, y);
        y += 8;

        if (!stateDiario.length) {
          doc.text("No tienes entradas guardadas en el diario.", marginLeft, y);
          doc.save("mi-siembra-inteligente-diario.pdf");
          return;
        }

        // Ordenar por fecha (de m√°s vieja a m√°s nueva)
        const entradas = [...stateDiario].sort((a, b) =>
          a.fecha.localeCompare(b.fecha)
        );

        entradas.forEach(e => {
          if (y > 280) {
            doc.addPage();
            y = 10;
          }

          doc.setFontSize(11);
          const cabecera = `${formatDate(e.fecha)} ¬∑ ${e.tipo || "General"}`;
          doc.text(cabecera, marginLeft, y);
          y += 5;

          doc.setFontSize(10);
          const lineas = doc.splitTextToSize(e.texto, maxWidth);
          lineas.forEach(line => {
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            doc.text(line, marginLeft + 2, y);
            y += 4;
          });

          y += 2; // peque√±o espacio entre entradas
        });

        doc.save("mi-siembra-inteligente-diario.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al crear el PDF del diario.");
      }
    }

function setupOpciones() {
  const nombreInput = document.getElementById("nombreHuerto");
  const climaSelect = document.getElementById("climaSelect");
  const hemisSelect = document.getElementById("hemisferioSelect");

  if (nombreInput) nombreInput.value = stateSettings.nombreHuerto || "";
  if (climaSelect) climaSelect.value = stateSettings.clima || "tropical";
  if (hemisSelect) hemisSelect.value = stateSettings.hemisferio || "norte";

  const btnGuardar = document.getElementById("btnGuardarConfig");
  if (btnGuardar) {
    btnGuardar.addEventListener("click", () => {
      const nuevoNombre = (nombreInput.value || "").trim() || "Mi huerto";
      const nuevoClima = climaSelect.value || "tropical";
      const nuevoHemis = hemisSelect.value || "norte";

      stateSettings = {
        ...stateSettings,
        nombreHuerto: nuevoNombre,
        clima: nuevoClima,
        hemisferio: nuevoHemis
      };
      saveSettings(stateSettings);
      updateHeader();
      updateSettingsContexts();
      renderInicio();
      renderCalendario(new Date().getMonth());
      alert("Configuraci√≥n guardada.");
    });
  }

  const btnExportar = document.getElementById("btnExportar");
  if (btnExportar) {
    btnExportar.addEventListener("click", () => {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("No se pudo cargar la librer√≠a para PDF. Verifica tu conexi√≥n a internet.");
          return;
        }

        const exportObj = {
          settings: stateSettings,
          cultivos: stateCultivos,
          diario: stateDiario
        };
        const jsonText = JSON.stringify(exportObj, null, 2);

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4"
        });

        const marginLeft = 10;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Respaldo", marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        const fecha = new Date().toLocaleString();
        doc.text(`Generado: ${fecha}`, marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        const lineas = doc.splitTextToSize(jsonText, 190 - marginLeft * 2);

        lineas.forEach(line => {
          if (y > 280) {
            doc.addPage();
            y = 10;
          }
          doc.text(line, marginLeft, y);
          y += 4;
        });

        doc.save("mi-siembra-inteligente-respaldo.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al crear el PDF. Intenta de nuevo.");
      }
    });
  }

  const btnImportar = document.getElementById("btnImportar");
  if (btnImportar) {
    btnImportar.addEventListener("click", () => {
      const texto = prompt("Pega aqu√≠ un backup exportado previamente (JSON):");
      if (!texto) return;
      try {
        const data = JSON.parse(texto);
        if (data.settings) {
          stateSettings = { ...DEFAULT_SETTINGS, ...data.settings };
          saveSettings(stateSettings);
        }
        if (Array.isArray(data.cultivos)) {
          stateCultivos = data.cultivos;
          saveCultivos(stateCultivos);
        }
        if (Array.isArray(data.diario)) {
          stateDiario = data.diario;
          saveDiario(stateDiario);
        }

        if (nombreInput) nombreInput.value = stateSettings.nombreHuerto || "";
        if (climaSelect) climaSelect.value = stateSettings.clima || "tropical";
        if (hemisSelect) hemisSelect.value = stateSettings.hemisferio || "norte";
        updateHeader();
        updateSettingsContexts();
        renderCultivos();
        renderDiario();
        renderInicio();
        renderCalendario(new Date().getMonth());
        alert("Datos importados correctamente.");
      } catch (e) {
        alert("El texto no parece un backup v√°lido.");
      }
    });
  }

  const btnBorrarTodo = document.getElementById("btnBorrarTodo");
  if (btnBorrarTodo) {
    btnBorrarTodo.addEventListener("click", () => {
      if (!confirm("Esto borrar√° todos los datos del huerto en este dispositivo. ¬øContinuar?")) {
        return;
      }
      localStorage.removeItem(STORAGE_KEYS.settings);
      localStorage.removeItem(STORAGE_KEYS.cultivos);
      localStorage.removeItem(STORAGE_KEYS.diario);
      stateSettings = { ...DEFAULT_SETTINGS };
      stateCultivos = [];
      stateDiario = [];

      if (nombreInput) nombreInput.value = stateSettings.nombreHuerto;
      if (climaSelect) climaSelect.value = stateSettings.clima;
      if (hemisSelect) hemisSelect.value = stateSettings.hemisferio;
      updateHeader();
      updateSettingsContexts();
      renderCultivos();
      renderDiario();
      renderInicio();
      renderCalendario(new Date().getMonth());
      alert("Datos borrados. Empezar√°s de cero.");
    });
  }
}

    /*********************
     * PWA: service worker + instalar
     *********************/
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch(err => console.error("Error registrando SW:", err));
      });
    }

    let deferredPrompt = null;
    const installBanner = document.getElementById("installBanner");
    const installBtn = document.getElementById("btnInstalarPwa");

    window.addEventListener("beforeinstallprompt", e => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBanner) {
        installBanner.classList.remove("hidden");
      }
    });

    if (installBtn) {
      installBtn.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        if (installBanner) {
          installBanner.classList.add("hidden");
        }
      });
    }

    /*********************
     * Inicio de la app
     *********************/
    document.addEventListener("DOMContentLoaded", () => {
      updateHeader();
      updateSettingsContexts();
      renderCultivos();
      renderDiario();
      renderInicio();
      renderCalendario(new Date().getMonth());
      renderPlagas();
      renderPesticidas();
      renderCatalogo();

      setupNavigation();
      setupMesesPills();
      setupMiHuertoForm();
      setupDiario();
      setupOpciones();
      setupCatalogo();
    });
  </script>
</body>
  </html>
