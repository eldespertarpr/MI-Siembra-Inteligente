<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v17)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />

  <!-- jsPDF para exportar a PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #02081f;
      --card: #02081f;
      --card-soft: #030919;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.15);
      --accent-strong: rgba(34,197,94,0.45);
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148,163,184,0.3);
      --danger: #f97373;
      --chip-bg: rgba(15,23,42,0.9);
      --chip-border: rgba(148,163,184,0.4);
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.7);
      --radius-xl: 22px;
      --radius-lg: 18px;
      --radius-full: 999px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #022c22 0, #020617 55%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 28px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 20px 16px 40px;
      }
    }

    /* HEADER */

    .app-header {
      background: radial-gradient(circle at 0 0, #4ade80 0, #16a34a 28%, #052e16 85%);
      border-radius: 28px;
      padding: 18px 18px 16px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      margin-bottom: 14px;
    }

    .app-header::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 120% -10%, rgba(34,197,94,0.35) 0, transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .app-header-icon {
      position: relative;
      z-index: 1;
      width: 52px;
      height: 52px;
      border-radius: 18px;
      background: radial-gradient(circle at 30% 10%, #bbf7d0 0, #16a34a 35%, #052e16 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 14px 35px rgba(0,0,0,0.45);
      flex-shrink: 0;
    }

    .app-header-icon span { font-size: 42px; }

    .app-header-text {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .app-title {
      font-size: 1.35rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .app-tag {
      font-size: 0.72rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.45);
      border: 1px solid rgba(15,23,42,0.8);
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #e5e7eb;
    }

    .app-subtitle {
      font-size: 0.80rem;
      color: #e5e7eb;
      opacity: 0.95;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .app-subtitle span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .app-subtitle-dot {
      width: 3px;
      height: 3px;
      border-radius: 50%;
      background: rgba(226,232,240,0.7);
    }

    /* NAV */

    .nav {
      margin-top: 8px;
      background: linear-gradient(135deg, var(--bg-elevated), #020617);
      border-radius: 26px;
      padding: 10px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.85);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 40;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(15,23,42,0.85);
    }

    @media (min-width: 660px) {
      .nav { grid-template-columns: repeat(8, minmax(0,1fr)); }
    }

    .nav-btn {
      border: none;
      border-radius: 999px;
      padding: 7px 6px 6px;
      font-size: 0.70rem;
      color: var(--text-soft);
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s, transform 0.12s;
      position: relative;
      min-height: 52px;
    }

    .nav-btn span.nav-icon { font-size: 1.40rem; }

    .nav-btn.nav-btn--active {
      background: radial-gradient(circle at top, var(--accent) 0, var(--accent-soft) 45%, transparent 100%);
      color: #ecfdf5;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.4), 0 14px 30px rgba(22,163,74,0.55);
      transform: translateY(-1px);
    }

    .nav-btn.nav-btn--active::after {
      content: "";
      position: absolute;
      inset: auto auto -3px 50%;
      width: 32%;
      max-width: 42px;
      height: 3px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(34,197,94,0.1), rgba(34,197,94,0.6), rgba(34,197,94,0.1));
      transform: translateX(-50%);
    }

    /* SECTIONS */

    main { margin-top: 14px; }

    .section {
      display: none;
      animation: fadeIn 0.18s ease-out;
    }

    .section--active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section > .section-title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 14px 2px 8px;
    }

    .section-icon-pill {
      width: 26px;
      height: 26px;
      border-radius: 13px;
      background: radial-gradient(circle at 30% 15%, #fefce8 0, #fef9c3 25%, #0f172a 90%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.3rem;
    }

    .section-title-row h2 {
      font-size: 1.05rem;
      margin: 0;
    }

    .section-subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin: 2px 2px 10px;
    }

    .app-card {
      background: radial-gradient(circle at top left, #020617 0, #020617 40%, #02081f 100%);
      border-radius: var(--radius-xl);
      padding: 14px 16px 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }

    .app-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .app-card-title {
      font-size: 0.96rem;
      font-weight: 600;
    }

    .chip {
      border-radius: var(--radius-full);
      padding: 4px 10px;
      font-size: 0.74rem;
      border: 1px solid var(--chip-border);
      background: var(--chip-bg);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .chip.badge {
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.6);
      color: #bbf7d0;
    }

    .chip-danger {
      border-color: rgba(239,68,68,0.7);
      color: #fecaca;
      background: rgba(127,29,29,0.5);
    }

    .context-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0 10px;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .divider-soft {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,184,0.4), transparent);
      margin: 8px -2px 10px;
    }

    .muted {
      color: var(--text-soft);
      font-size: 0.80rem;
    }

    .pill-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px -1px 4px;
    }

    .pill {
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 0.78rem;
      border: 1px solid rgba(148,163,184,0.55);
      background: rgba(15,23,42,0.9);
      cursor: pointer;
    }

    .pill--active {
      background: var(--accent-soft);
      border-color: rgba(34,197,94,0.85);
      color: #bbf7d0;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 14px;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #16a34a, #22c55e);
      color: #022c22;
      box-shadow: 0 12px 30px rgba(22,163,74,0.55);
      transition: transform 0.12s, box-shadow 0.12s, filter 0.12s;
    }

    .btn span { font-size: 1rem; }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 7px 18px rgba(22,163,74,0.55);
      filter: brightness(0.96);
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
      box-shadow: none;
    }

    .btn-full {
      width: 100%;
      justify-content: center;
    }

    .btn-danger {
      background: linear-gradient(135deg, #b91c1c, #ef4444);
      color: #fee2e2;
      box-shadow: 0 10px 26px rgba(248,113,113,0.45);
    }

    .grid-two {
      display: grid;
      grid-template-columns: repeat(2,minmax(0,1fr));
      gap: 8px;
    }

    .small-label {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .big-number {
      font-size: 1.3rem;
      font-weight: 600;
    }

    /* FORMS */

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin: 8px 0 4px;
    }

    @media (min-width: 660px) {
      .form-grid--2 {
        grid-template-columns: repeat(2, minmax(0,1fr));
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      background: rgba(15,23,42,0.95);
      border-radius: 14px;
      border: 1px solid rgba(51,65,85,0.9);
      padding: 8px 10px;
      color: var(--text-main);
      font-size: 0.83rem;
      font-family: inherit;
      width: 100%;
      max-width: 100%;
      outline: none;
      transition: border 0.12s, box-shadow 0.12s, background 0.12s;
    }

    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 26px;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
                        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position: calc(100% - 15px) 10px, calc(100% - 11px) 10px;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    textarea {
      min-height: 72px;
      resize: vertical;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.5);
      background: rgba(15,23,42,0.98);
    }

    /* Cat√°logo */

    .cultivos-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 4px;
    }

    .cultivo-card {
      border-radius: var(--radius-lg);
      padding: 10px 11px;
      background: radial-gradient(circle at top left, var(--card-soft) 0, #020617 60%);
      border: 1px solid rgba(75,85,99,0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cultivo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .cultivo-title {
      font-size: 0.9rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cultivo-thumb {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      object-fit: cover;
      flex-shrink: 0;
    }

    .cultivo-body {
      font-size: 0.78rem;
      color: var(--text-soft);
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 4px 10px;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .cultivo-body { grid-template-columns: 1fr; }
    }

    .cultivo-actions {
      margin-top: 6px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      flex-wrap: wrap;
    }

    .cultivo-notas {
      margin-top: 4px;
      font-size: 0.78rem;
      color: #e5e7eb;
    }

    /* Calendario */

    .calendar-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .calendar-item {
      border-radius: 16px;
      padding: 9px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 0.8rem;
    }

    .calendar-item-title {
      font-weight: 600;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .calendar-empty {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 8px;
    }

    /* Diario */

    .diario-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 6px;
      font-size: 0.8rem;
    }

    .diario-item {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
    }

    .diario-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 2px;
    }

    /* Plagas / pesticidas */

    .plaga-card {
      border-radius: 14px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 6px;
    }

    .plaga-card--highlight {
      border-color: rgba(34,197,94,0.9);
      box-shadow: 0 0 0 1px rgba(34,197,94,0.6);
    }

    .media-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .media-item-title {
      font-size: 0.86rem;
      font-weight: 600;
    }

    .media-item-body {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .germinacion-panel {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(148,163,184,0.5);
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    ul {
      margin: 4px 0 4px 18px;
      padding: 0;
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    footer {
      margin-top: 6px;
      font-size: 0.76rem;
      color: var(--text-soft);
      text-align: center;
      padding-bottom: 6px;
    }

    footer span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    #installBanner {
      position: fixed;
      left: 50%;
      bottom: 16px;
      transform: translateX(-50%);
      background: rgba(15,23,42,0.97);
      border-radius: 999px;
      padding: 7px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(148,163,184,0.75);
      box-shadow: 0 16px 40px rgba(15,23,42,0.85);
      font-size: 0.78rem;
      z-index: 80;
    }

    #installBanner.hidden { display: none; }

    #installBanner button {
      font-size: 0.78rem;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- HEADER -->
    <header class="app-header">
      <div class="app-header-icon">
        <span>üå±</span>
      </div>
      <div class="app-header-text">
        <div class="app-title-row">
          <div class="app-title">Mi Siembra Inteligente</div>
          <div class="app-tag">v17 ¬∑ PWA</div>
        </div>
        <div class="app-subtitle" id="appSubtitle"></div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <button class="nav-btn nav-btn--active" data-section="inicio">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Inicio</span>
      </button>
      <button class="nav-btn" data-section="calendario">
        <span class="nav-icon">üìÖ</span>
        <span class="nav-label">Calendario</span>
      </button>
      <button class="nav-btn" data-section="catalogo">
        <span class="nav-icon">üå±</span>
        <span class="nav-label">Cat√°logo</span>
      </button>
      <button class="nav-btn" data-section="huerto">
        <span class="nav-icon">üåø</span>
        <span class="nav-label">Mi huerto</span>
      </button>
      <button class="nav-btn" data-section="diario">
        <span class="nav-icon">üìì</span>
        <span class="nav-label">Diario</span>
      </button>
      <button class="nav-btn" data-section="plagas">
        <span class="nav-icon">üêõ</span>
        <span class="nav-label">Plagas</span>
      </button>
      <button class="nav-btn" data-section="pesticidas">
        <span class="nav-icon">üíß</span>
        <span class="nav-label">Pesticidas</span>
      </button>
      <button class="nav-btn" data-section="opciones">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Opciones</span>
      </button>
      <button class="nav-btn" data-section="guias">
        <span class="nav-icon">üìö</span>
        <span class="nav-label">Gu√≠as</span>
      </button>
    </nav>

    <main>
      <!-- INICIO -->
      <section id="section-inicio" class="section section--active">
        <div class="section-title-row">
          <div class="section-icon-pill">üè†</div>
          <h2>Inicio</h2>
        </div>
        <p class="section-subtitle">
          Resumen r√°pido de tu huerto y acceso a las funciones principales.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Estado r√°pido</div>
            <div class="chip badge" id="estadoClimaChip">Clima tropical</div>
          </div>
          <div class="grid-two">
            <div>
              <div class="small-label">Cultivos registrados</div>
              <div class="big-number" id="estadoCultivosCount">0</div>
            </div>
            <div>
              <div class="small-label">Entradas hoy en el diario</div>
              <div class="big-number" id="estadoEntradasCount">0</div>
            </div>
          </div>
          <div class="divider-soft"></div>
          <p class="muted" id="estadoResumen">
            A√∫n no has registrado cultivos. Usa "Mi huerto" para a√±adir tu primera siembra.
          </p>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="section-calendario" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìÖ</div>
          <h2>Calendario de siembra</h2>
        </div>
        <p class="section-subtitle">
          Selecciona un mes para ver sugerencias de cultivos seg√∫n tu clima y hemisferio.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Meses del a√±o</div>
            <div class="chip" id="calendarioClimaChip2">Clima tropical</div>
          </div>

          <div class="pill-group" id="mesesPills">
            <button class="pill" data-mes="0">Ene</button>
            <button class="pill" data-mes="1">Feb</button>
            <button class="pill" data-mes="2">Mar</button>
            <button class="pill" data-mes="3">Abr</button>
            <button class="pill" data-mes="4">May</button>
            <button class="pill pill--active" data-mes="5">Jun</button>
            <button class="pill" data-mes="6">Jul</button>
            <button class="pill" data-mes="7">Ago</button>
            <button class="pill" data-mes="8">Sep</button>
            <button class="pill" data-mes="9">Oct</button>
            <button class="pill" data-mes="10">Nov</button>
            <button class="pill" data-mes="11">Dic</button>
          </div>

          <div class="calendar-list" id="calendarList"></div>
          <div class="calendar-empty" id="calendarEmpty" style="display:none;">
            Por ahora no hay recomendaciones espec√≠ficas para este mes y clima.
          </div>
        </div>
      </section>

      <!-- CATALOGO -->
      <section id="section-catalogo" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üå±</div>
          <h2>Cat√°logo de cultivos</h2>
        </div>
        <p class="section-subtitle">
          Lista de cultivos con informaci√≥n r√°pida y gu√≠a de germinaci√≥n / reproducci√≥n.
        </p>

        <div class="app-card">
          <div class="field">
            <label for="catalogoBusqueda">Buscar cultivo</label>
            <input
              type="text"
              id="catalogoBusqueda"
              placeholder="Ej. tomate, lechuga, pl√°tano..."
            />
          </div>
          <div class="cultivos-list" id="catalogoList"></div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="section-huerto" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üåø</div>
          <h2>Mi huerto</h2>
        </div>
        <p class="section-subtitle">
          Registra tus cultivos y consulta los detalles de cada planta.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nuevo cultivo</div>
            <div class="chip badge">Registro r√°pido</div>
          </div>
          <div class="context-chips settings-context"></div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoNombre">Nombre del cultivo *</label>
              <input type="text" id="cultivoNombre" placeholder="Ej. Tomate, lechuga, pl√°tano" />
            </div>
            <div class="field">
              <label for="cultivoVariedad">Variedad (opcional)</label>
              <input type="text" id="cultivoVariedad" placeholder="Ej. Cherry, romana, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="cultivoTipo">Tipo</label>
              <select id="cultivoTipo">
                <option value="hoja">Hoja</option>
                <option value="fruto">Fruto</option>
                <option value="raiz">Ra√≠z</option>
                <option value="tuberculo">Tub√©rculo</option>
                <option value="aromaticas">Arom√°ticas</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="field">
              <label for="cultivoFecha">Fecha de siembra</label>
              <input type="date" id="cultivoFecha" />
            </div>
          </div>

          <div class="field">
            <label for="cultivoNotas">Notas (lugar, cama, maceta, etc.)</label>
            <textarea id="cultivoNotas" placeholder="Ej. Cama 1, fila 2. Semilla directa en suelo."></textarea>
          </div>

          <button class="btn btn-full" id="btnAgregarCultivo">
            <span>‚ûï</span> Guardar cultivo
          </button>
          <p class="muted" style="margin-top:6px;">
            * Solo el nombre es obligatorio. Puedes editar o eliminar los cultivos luego.
          </p>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cultivos registrados</div>
            <div class="chip" id="cultivosCountChip">0 cultivos</div>
          </div>
          <div class="cultivos-list" id="cultivosList"></div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="section-diario" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìì</div>
          <h2>Diario de huerto</h2>
        </div>
        <p class="section-subtitle">
          Anota riegos, abonados, podas o cualquier evento importante.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Nueva entrada</div>
            <div class="chip badge">Hoy</div>
          </div>
          <div class="field">
            <label for="diarioTexto">¬øQu√© hiciste hoy?</label>
            <textarea id="diarioTexto" placeholder="Ej. Regu√© tomates y lechugas. Apliqu√© compost."></textarea>
          </div>
          <button class="btn btn-full" id="btnGuardarDiario">
            <span>üíæ</span> Guardar en el diario
          </button>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Entradas recientes</div>
            <div class="chip" id="diarioCountChip">0 entradas</div>
          </div>

          <div class="pill-group" id="diarioFiltros">
            <button class="pill pill--active" data-filtro="todos">Todo</button>
            <button class="pill" data-filtro="Riego">Riego</button>
            <button class="pill" data-filtro="Abono">Abono</button>
            <button class="pill" data-filtro="General">General</button>
          </div>

          <p class="muted" id="diarioResumenHoy"></p>

          <div class="diario-list" id="diarioList"></div>

          <button class="btn btn-secondary btn-full" onclick="exportarDiarioPDF()">
            <span>üì¶</span> Exportar diario (PDF)
          </button>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="section-plagas" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üêõ</div>
          <h2>Plagas comunes</h2>
        </div>
        <p class="section-subtitle">
          Referencia r√°pida de plagas frecuentes en huertos caseros y c√≥mo manejarlas.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Cat√°logo b√°sico de plagas</div>
            <div class="chip">Referencia</div>
          </div>
          <div class="media-list" id="plagasList"></div>
        </div>
      </section>

      <!-- PESTICIDAS -->
      <section id="section-pesticidas" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üíß</div>
          <h2>Pesticidas y preparados</h2>
        </div>
        <p class="section-subtitle">
          Opciones suaves y de bajo impacto para manejar plagas en un huerto casero.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Preparados sugeridos</div>
            <div class="chip">Uso responsable</div>
          </div>
          <div class="media-list" id="pesticidasList"></div>
        </div>
      </section>

      <!-- OPCIONES -->
      <section id="section-opciones" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">‚öôÔ∏è</div>
          <h2>Opciones</h2>
        </div>
        <p class="section-subtitle">
          Ajusta el nombre de tu huerto, el clima y el hemisferio.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Datos generales</div>
          </div>
          <div class="context-chips settings-context"></div>

          <div class="form-grid">
            <div class="field">
              <label for="nombreHuerto">Nombre de huerto</label>
              <input type="text" id="nombreHuerto" placeholder="Ej. Huerto RDG, Mi huerto, etc." />
            </div>
          </div>

          <div class="form-grid form-grid--2">
            <div class="field">
              <label for="climaSelect">Clima principal</label>
              <select id="climaSelect">
                <option value="tropical">Tropical (Caribe, PR, etc.)</option>
                <option value="subtropical">Subtropical / templado suave</option>
                <option value="templado">Templado / fr√≠o</option>
              </select>
            </div>
            <div class="field">
              <label for="hemisferioSelect">Hemisferio</label>
              <select id="hemisferioSelect">
                <option value="norte">Hemisferio norte</option>
                <option value="sur">Hemisferio sur</option>
              </select>
            </div>
          </div>

          <button class="btn btn-full" id="btnGuardarConfig">
            <span>üíæ</span> Guardar configuraci√≥n
          </button>

          <div class="divider-soft"></div>
          <p class="muted">
            Toda la informaci√≥n se guarda <strong>solo en tu dispositivo</strong> usando almacenamiento local.
          </p>

          <div class="pill-group" style="flex-direction:column;">
            <button class="btn btn-secondary btn-full" onclick="exportarDatosPDF()">
              <span>üìÑ</span> Exportar datos (PDF)
            </button>

            <button class="btn btn-secondary btn-full" onclick="exportarRespaldoJSON()">
              <span>üíæ</span> Exportar respaldo (.json)
            </button>

            <button class="btn btn-secondary btn-full" onclick="importarRespaldoJSON()">
              <span>üç∞</span> Restaurar respaldo
            </button>

            <button class="btn btn-danger btn-full" onclick="borrarTodo()">
              <span>üßπ</span> Borrar todo
            </button>
          </div>

          <input
            type="file"
            id="inputRespaldoJSON"
            accept="application/json"
            style="display:none" />
        </div>
      </section>

      <!-- GUIAS -->
      <section id="section-guias" class="section">
        <div class="section-title-row">
          <div class="section-icon-pill">üìö</div>
          <h2>Gu√≠as r√°pidas</h2>
        </div>
        <p class="section-subtitle">
          Consejos b√°sicos para sacar m√°s provecho a tu huerto.
        </p>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Antes de sembrar</div>
            <div class="chip">Paso 1</div>
          </div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Preparar el suelo</div>
              <div class="media-item-body">
                Retira piedras y ra√≠ces gruesas, agrega materia org√°nica (compost, esti√©rcol bien
                descompuesto) y afloja la tierra sin voltearla en exceso.
              </div>
            </div>
            <div>
              <div class="media-item-title">Elegir el lugar</div>
              <div class="media-item-body">
                La mayor√≠a de los cultivos necesitan al menos 4‚Äì6 horas de sol directo.
              </div>
            </div>
          </div>
        </div>

        <div class="app-card">
          <div class="app-card-header">
            <div class="app-card-title">Riego inteligente</div>
            <div class="chip">Paso 2</div>
          </div>
          <div class="media-list">
            <div>
              <div class="media-item-title">Revisar la humedad</div>
              <div class="media-item-body">
                Antes de regar, introduce un dedo en el sustrato hasta 2‚Äì3&nbsp;cm. Si est√° h√∫medo,
                espera. Si est√° seco, riega de forma lenta y profunda.
              </div>
            </div>
            <div>
              <div class="media-item-title">Horario recomendado</div>
              <div class="media-item-body">
                En climas c√°lidos suele ser mejor regar temprano en la ma√±ana o al final de la
                tarde para reducir evaporaci√≥n y estr√©s en las plantas.
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <span>Mi Siembra Inteligente ¬∑ Datos guardados localmente en tu dispositivo üåø</span>
    </footer>
  </div>

  <!-- Banner instalar PWA -->
  <div id="installBanner" class="hidden">
    <span>Instala <strong>Mi Siembra Inteligente</strong> en tu dispositivo</span>
    <button class="btn btn-secondary" id="btnInstalarPwa">
      <span>üì≤</span> Instalar
    </button>
  </div>

  <script>
    /*********************
     * Datos base y utilidades
     *********************/
    const STORAGE_KEYS = {
      settings: "msi-settings",
      cultivos: "msi-cultivos",
      diario: "msi-diario"
    };

    const DEFAULT_SETTINGS = {
      nombreHuerto: "Mi huerto",
      clima: "tropical",
      hemisferio: "norte"
    };

    const CLIMA_LABEL = {
      tropical: "tropical",
      subtropical: "subtropical/templado",
      templado: "templado/fr√≠o"
    };

    const HEMISFERIO_LABEL = {
      norte: "hemisferio norte",
      sur: "hemisferio sur"
    };

    function loadSettings() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.settings);
        if (!raw) return { ...DEFAULT_SETTINGS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_SETTINGS, ...parsed };
      } catch (e) {
        return { ...DEFAULT_SETTINGS };
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify(settings));
    }

    function loadCultivos() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.cultivos);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveCultivos(list) {
      localStorage.setItem(STORAGE_KEYS.cultivos, JSON.stringify(list));
    }

    function loadDiario() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.diario);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (e) {
        return [];
      }
    }

    function saveDiario(list) {
      localStorage.setItem(STORAGE_KEYS.diario, JSON.stringify(list));
    }

    function todayISO() {
      const d = new Date();
      return d.toISOString().slice(0, 10);
    }

    function addDays(dateISO, days) {
      if (!dateISO || !Number.isFinite(days)) return dateISO;
      const d = new Date(dateISO + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateISO;
      d.setDate(d.getDate() + days);
      return d.toISOString().slice(0, 10);
    }

    function formatDate(dateStr) {
      if (!dateStr) return "Sin fecha";
      const d = new Date(dateStr + "T00:00:00");
      if (Number.isNaN(d.getTime())) return dateStr;
      const meses = [
        "ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"
      ];
      const dia = d.getDate().toString().padStart(2, "0");
      return `${dia} ${meses[d.getMonth()]} ${d.getFullYear()}`;
    }

    /*********************
     * Calendario de siembra
     *********************/
    const CALENDARIO_SIEMBRA = {
      tropical: {
        5: [
          {
            titulo: "Re-siembra de lechugas",
            tipo: "Hoja",
            detalle: "Siembra escalonada cada 2‚Äì3 semanas para cosechas continuas."
          },
          {
            titulo: "R√°banos",
            tipo: "Ra√≠z",
            detalle: "Cosecha r√°pida (20‚Äì30 d√≠as). Perfectos para ocupar huecos libres."
          }
        ],
        6: [
          {
            titulo: "Berenjena",
            tipo: "Fruto",
            detalle: "Le gustan las noches c√°lidas. Ideal para verano tropical."
          },
          {
            titulo: "Aj√≠es y pimientos",
            tipo: "Fruto",
            detalle: "Sembrar en lugar soleado y con buen drenaje."
          }
        ]
      },
      subtropical: {
        5: [
          {
            titulo: "Tomates de media estaci√≥n",
            tipo: "Fruto",
            detalle: "Elige variedades adaptadas a tu regi√≥n."
          }
        ]
      },
      templado: {
        2: [
          {
            titulo: "Lechugas de primavera",
            tipo: "Hoja",
            detalle: "Siembra temprana bajo protecci√≥n ligera si hay riesgo de heladas."
          }
        ]
      }
    };

    function ajustarMesPorHemisferio(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      let mes = monthIndex;
      if (
        settings.hemisferio === "sur" &&
        (climaKey === "templado" || climaKey === "subtropical")
      ) {
        mes = (monthIndex + 6) % 12;
      }
      return mes;
    }

    function getCalendarData(settings, monthIndex) {
      const climaKey = settings.clima || "tropical";
      const mesAjustado = ajustarMesPorHemisferio(settings, monthIndex);
      const base = CALENDARIO_SIEMBRA[climaKey] || {};
      return base[mesAjustado] || [];
    }

    /*********************
     * Cat√°logo de cultivos (versi√≥n simplificada)
     *********************/
    const CATALOGO_CULTIVOS = [
      {
        id: "tomate",
        nombre: "Tomate",
        categoria: "Fruto",
        dias: "70‚Äì90 d√≠as",
        luz: "Sol directo (6‚Äì8 h)",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas profundas de 5+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones", "Mosca blanca", "Orugas"],
        meses: [0,1,2,3,4,5,6,7],
        imagen: "img/tomate.jpg"
      },
      {
        id: "lechuga",
        nombre: "Lechuga",
        categoria: "Hoja",
        dias: "45‚Äì60 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas anchas de 3+ galones",
        profundidad: "0.5 cm",
        plagas: ["Babosas", "Caracoles", "Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/lechuga.jpg"
      },
      {
        id: "pepinillo",
        nombre: "Pepinillo / Pepino",
        categoria: "Fruto",
        dias: "60‚Äì90 d√≠as",
        luz: "Sol directo",
        riego: "Abundante y constante",
        tiesto: "Macetas profundas de 5+ galones con tutor",
        profundidad: "1‚Äì2 cm",
        plagas: ["Mosca blanca", "√Åcaros", "Hongos"],
        meses: [3,4,5,6,7,8],
        imagen: "img/pepinillo.jpg"
      },
      {
        id: "platano",
        nombre: "Pl√°tano",
        categoria: "Fruto perenne",
        dias: "Cosecha a partir de 9‚Äì12 meses",
        luz: "Sol directo",
        riego: "Regular, le gusta la humedad",
        tiesto: "Suelo directo, espacio amplio",
        profundidad: "Cormo enterrado firmemente",
        plagas: ["Picudo del pl√°tano", "Sigatoka"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/platano.jpg"
      },
      {
        id: "pimiento_morron",
        nombre: "Pimiento morr√≥n",
        categoria: "Fruto",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo (6‚Äì8 h)",
        riego: "Regular, evitando encharcamientos",
        tiesto: "Macetas de 4‚Äì5 galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Trips", "Ara√±a roja"],
        meses: [2,3,4,5,6,7],
        imagen: "img/pimiento_morron.jpg"
      },
      {
        id: "berenjena",
        nombre: "Berenjena",
        categoria: "Fruto",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Constante, sin encharcar",
        tiesto: "Macetas de 5+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Escarabajos", "Pulgones", "Ara√±a roja"],
        meses: [3,4,5,6,7,8],
        imagen: "img/berenjena.jpg"
      },
      {
        id: "cebolla",
        nombre: "Cebolla",
        categoria: "Bulbo",
        dias: "100‚Äì150 d√≠as",
        luz: "Sol directo",
        riego: "Moderado, reducir antes de cosechar",
        tiesto: "Macetas profundas o suelo directo",
        profundidad: "1‚Äì2 cm",
        plagas: ["Trips", "Mosca de la cebolla"],
        meses: [0,1,2,6,7,8,9,10],
        imagen: "img/cebolla.jpg"
      },
      {
        id: "zanahoria",
        nombre: "Zanahoria",
        categoria: "Ra√≠z",
        dias: "70‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Suelo siempre ligeramente h√∫medo",
        tiesto: "Macetas profundas (30+ cm)",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Mosca de la zanahoria", "Hongos"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/zanahoria.jpg"
      },
      {
        id: "rabano",
        nombre: "R√°bano",
        categoria: "Ra√≠z",
        dias: "25‚Äì35 d√≠as",
        luz: "Sol directo o media sombra",
        riego: "Suelo constantemente h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "1 cm",
        plagas: ["Pulguillas", "Babosas"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/rabano.jpg"
      },
      {
        id: "papa",
        nombre: "Papa",
        categoria: "Tub√©rculo",
        dias: "90‚Äì120 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Sacos o macetas profundas de 10+ galones",
        profundidad: "Tub√©rculo cubierto con 5‚Äì10 cm de sustrato",
        plagas: ["Escarabajo de la papa", "Hongos"],
        meses: [0,1,2,7,8,9],
        imagen: "img/papa.jpg"
      },
      {
        id: "gandules",
        nombre: "Gandules",
        categoria: "Leguminosa perenne",
        dias: "4‚Äì6 meses para la primera cosecha",
        luz: "Sol directo",
        riego: "Moderado, resistente a sequ√≠a",
        tiesto: "Suelo directo o macetas muy grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Gusanos de vaina", "Pulgones"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/gandules.jpg"
      },
      {
        id: "calabaza",
        nombre: "Calabaza",
        categoria: "Fruto rastrero",
        dias: "90‚Äì130 d√≠as",
        luz: "Sol directo",
        riego: "Regular, le gusta suelo f√©rtil",
        tiesto: "Suelo directo o macetas muy grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Barrenador de tallo", "Mosca blanca"],
        meses: [2,3,4,5,6,7],
        imagen: "img/calabaza.jpg"
      },
      {
        id: "calabacin_zucchini",
        nombre: "Calabac√≠n / Zucchini",
        categoria: "Fruto",
        dias: "45‚Äì60 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 8+ galones",
        profundidad: "2‚Äì3 cm",
        plagas: ["O√≠dio", "Pulgones"],
        meses: [2,3,4,5,6,7],
        imagen: "img/calabacin_zucchini.jpg"
      },
      {
        id: "maiz",
        nombre: "Ma√≠z",
        categoria: "Grano",
        dias: "80‚Äì100 d√≠as",
        luz: "Sol directo",
        riego: "Regular, m√°s constante en floraci√≥n",
        tiesto: "Parterres o contenedores grandes",
        profundidad: "2‚Äì3 cm",
        plagas: ["Gusanos del ma√≠z", "Pulgones"],
        meses: [2,3,4,5,6,7],
        imagen: "img/maiz.jpg"
      },
      {
        id: "habichuelas",
        nombre: "Habichuelas",
        categoria: "Leguminosa",
        dias: "60‚Äì80 d√≠as",
        luz: "Sol directo",
        riego: "Regular, sin encharcar",
        tiesto: "Macetas de 5+ galones con tutor",
        profundidad: "2‚Äì3 cm",
        plagas: ["Pulgones", "Trips"],
        meses: [2,3,4,5,6,7],
        imagen: "img/habichuelas.jpg"
      },
      {
        id: "cilantro",
        nombre: "Cilantro",
        categoria: "Arom√°tica",
        dias: "30‚Äì50 d√≠as",
        luz: "Sol suave o sombra parcial",
        riego: "Suelo fresco y h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5‚Äì1 cm",
        plagas: ["Pulgones"],
        meses: [0,1,2,3,8,9,10,11],
        imagen: "img/cilantro.jpg"
      },
      {
        id: "albahaca",
        nombre: "Albahaca",
        categoria: "Arom√°tica",
        dias: "40‚Äì60 d√≠as",
        luz: "Sol directo suave",
        riego: "Suelo ligeramente h√∫medo",
        tiesto: "Macetas de 3+ galones",
        profundidad: "0.5 cm",
        plagas: ["Pulgones", "Mosca blanca"],
        meses: [2,3,4,5,6,7,8],
        imagen: "img/albahaca.jpg"
      },
      {
        id: "mango",
        nombre: "Mango",
        categoria: "Frutal perenne",
        dias: "Varios a√±os hasta producir",
        luz: "Sol directo fuerte",
        riego: "Poco una vez establecido",
        tiesto: "Suelo directo; macet√≥n solo en variedades enanas",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Mosca de la fruta", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/mango.jpg"
      },
      {
        id: "limon",
        nombre: "Lim√≥n",
        categoria: "Frutal c√≠trico",
        dias: "2‚Äì3 a√±os desde plant√≠n",
        luz: "Sol directo",
        riego: "Regular en sequ√≠a",
        tiesto: "Macet√≥n grande o suelo directo",
        profundidad: "Plant√≠n al nivel del cuello",
        plagas: ["Minador de hoja", "Cochinillas"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/limon.jpg"
      },
      {
        id: "chayote",
        nombre: "Chayote",
        categoria: "Fruto trepador",
        dias: "120‚Äì180 d√≠as (primera cosecha)",
        luz: "Sol directo o media sombra luminosa",
        riego: "Regular, suelos h√∫medos pero bien drenados",
        tiesto: "Mejor en suelo directo con enredadera",
        profundidad: "Fruto enterrado lateral, apenas cubierto",
        plagas: ["Babosas", "Caracoles", "Hongos"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/chayote.jpg"
      },
      {
        id: "pina",
        nombre: "Pi√±a",
        categoria: "Frutal perenne",
        dias: "15‚Äì18 meses hasta la primera cosecha",
        luz: "Sol directo fuerte",
        riego: "Moderado, evitando encharcamientos",
        tiesto: "Macetones profundos o suelo directo",
        profundidad: "Corona plantada superficialmente",
        plagas: ["Cochinillas", "Hongos", "Mosca de la fruta"],
        meses: [0,1,2,3,4,5,6,7,8,9,10,11],
        imagen: "img/pina.jpg"
      }
    ];

    /*********************
     * Germinaci√≥n / reproducci√≥n
     *********************/
    const GERMINACION_POR_CULTIVO = {
      tomate: {
        titulo: "Tomate ‚Äì germinaci√≥n",
        metodo: "Semilla en alm√°cigo y luego trasplante.",
        pasos: [
          "Llenar bandeja o alm√°cigo con sustrato suelto y bien drenado.",
          "Sembrar la semilla a 0.5‚Äì1 cm de profundidad.",
          "Mantener siempre ligeramente h√∫medo, sin encharcar.",
          "Trasplantar cuando tenga 3‚Äì4 hojas verdaderas."
        ],
        tip: "Las pl√°ntulas al inicio prefieren luz filtrada, no sol directo fuerte."
      },
      lechuga: {
        titulo: "Lechuga ‚Äì germinaci√≥n",
        metodo: "Semilla directa o en alm√°cigo.",
        pasos: [
          "Sembrar muy superficial, apenas cubierta de sustrato.",
          "Mantener el sustrato siempre h√∫medo.",
          "Siembra en alm√°cigo: trasplantar con 3‚Äì4 hojas.",
          "Siembra directa: ralear, dejando espacio entre plantas."
        ],
        tip: "Germina mejor con temperaturas moderadas y sol suave."
      },
      calabacin_zucchini: {
        titulo: "Calabac√≠n / Zucchini ‚Äì germinaci√≥n",
        metodo: "Semilla directa en el sitio definitivo o tiesto grande.",
        pasos: [
          "Hacer hoyos de 2‚Äì3 cm de profundidad.",
          "Sembrar 2‚Äì3 semillas por hoyo y luego dejar la planta m√°s fuerte.",
          "Mantener el suelo h√∫medo pero sin charcos.",
          "Dejar buen espacio entre plantas, se abren bastante."
        ],
        tip: "Evita mojar hojas todo el tiempo para no favorecer el o√≠dio."
      },
      platano: {
        titulo: "Pl√°tano ‚Äì reproducci√≥n",
        metodo: "Hijuelos / cormos, no semilla.",
        pasos: [
          "Elegir hijuelos sanos, sin pudriciones.",
          "Cortar el hijo y dejarlo orear unas horas.",
          "Plantar enterrando bien el cormo en suelo con buen drenaje.",
          "Regar para asentar la tierra y luego mantener humedad moderada."
        ],
        tip: "No lo pongas donde se empoce el agua."
      },
      gandules: {
        titulo: "Gandules ‚Äì germinaci√≥n",
        metodo: "Semilla directa.",
        pasos: [
          "Sembrar a 2‚Äì3 cm de profundidad.",
          "Colocar 2‚Äì3 semillas por punto de siembra.",
          "Mantener h√∫medo hasta que germinen.",
          "Dejar solo la planta m√°s vigorosa por punto."
        ],
        tip: "No abuses del nitr√≥geno: ya fijan nitr√≥geno en el suelo."
      },
      papa: {
        titulo: "Papa ‚Äì siembra",
        metodo: "Trozos de tub√©rculo con al menos 1‚Äì2 ojos.",
        pasos: [
          "Cortar la papa en trozos con ojos y dejarlos secar 1 d√≠a.",
          "Sembrar a 10 cm de profundidad.",
          "Cuando crece, ir aporcando (echando tierra al tallo).",
          "Mantener riego regular sin encharcar."
        ],
        tip: "Rota el lugar de siembra para evitar plagas y enfermedades."
      },
      chayote: {
        titulo: "Chayote ‚Äì germinaci√≥n",
        metodo: "El fruto entero se usa como semilla.",
        pasos: [
          "Elegir un chayote sano, sin golpes ni pudrici√≥n.",
          "Dejarlo brotar en un lugar ventilado y sombreado.",
          "Cuando el brote tenga buen tama√±o, plantar el fruto de lado en suelo suelto.",
          "Cubrir parcialmente con tierra y mantener el sustrato h√∫medo, sin encharcar."
        ],
        tip: "Dale una estructura para trepar; es muy vigoroso."
      }
    };

    const GERMINACION_GENERIC = {
      hoja: {
        titulo: "Cultivos de hoja ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla directa o en alm√°cigo, muy superficial.",
        pasos: [
          "Usar sustrato suelto y bien drenado.",
          "Sembrar la semilla casi en superficie, apenas cubierta.",
          "Mantener siempre ligeramente h√∫medo, sin charcos.",
          "Trasplantar (si es alm√°cigo) cuando tenga 3‚Äì4 hojas verdaderas."
        ],
        tip: "Prefieren sol suave o media sombra y riegos frecuentes."
      },
      fruto: {
        titulo: "Cultivos de fruto ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla en alm√°cigo o directa seg√∫n el espacio.",
        pasos: [
          "Sembrar a 1‚Äì2 cm de profundidad seg√∫n tama√±o de semilla.",
          "Mantener el sustrato h√∫medo, no encharcado.",
          "Dar buena luz desde peque√±os para que no se espiguen.",
          "Trasplantar a tiesto grande o suelo cuando est√©n fuertes."
        ],
        tip: "Necesitan mucho sol y macetas profundas o suelo suelto."
      },
      raiz: {
        titulo: "Ra√≠ces ‚Äì germinaci√≥n b√°sica",
        metodo: "Siempre semilla directa en el sitio definitivo.",
        pasos: [
          "Aflojar bien el suelo a buena profundidad.",
          "Sembrar muy superficial (0.5‚Äì1 cm).",
          "Mantener humedad constante hasta que germinen.",
          "Ralear dejando espacio entre plantas."
        ],
        tip: "No trasplantar: se deforman las ra√≠ces."
      },
      tuberculo: {
        titulo: "Tub√©rculos ‚Äì siembra b√°sica",
        metodo: "Trozos de tub√©rculo o estacas seg√∫n el cultivo.",
        pasos: [
          "Elegir material sano, sin pudriciones.",
          "Dejar orear si hace falta (como en papa).",
          "Enterrar a buena profundidad en suelo suelto.",
          "Mantener riego regular sin encharcar."
        ],
        tip: "Les va bien un suelo profundo y con materia org√°nica."
      },
      aromatica: {
        titulo: "Arom√°ticas ‚Äì germinaci√≥n b√°sica",
        metodo: "Semilla fina o esquejes, seg√∫n especie.",
        pasos: [
          "Semilla: sembrar muy superficial y mantener humedad fina.",
          "Esquejes: enterrar la parte baja en sustrato h√∫medo.",
          "Colocar en lugar luminoso, sin sol muy fuerte al inicio.",
          "Trasplantar cuando el cepell√≥n est√© firme."
        ],
        tip: "Muchas arom√°ticas prefieren maceta."
      },
      frutal: {
        titulo: "Frutales ‚Äì establecimiento b√°sico",
        metodo: "Plantines o injertos, m√°s que semilla.",
        pasos: [
          "Comprar plant√≠n sano o injertado si es posible.",
          "Hacer hoyo amplio, mejorar el suelo con materia org√°nica.",
          "Plantar al nivel del cuello de la planta.",
          "Regar bien al inicio y tutorar si hace falta."
        ],
        tip: "Los frutales necesitan sitio fijo, sol y paciencia."
      },
      generico: {
        titulo: "Germinaci√≥n b√°sica ‚Äì gu√≠a general",
        metodo: "Semilla directa o en bandeja seg√∫n tama√±o de planta.",
        pasos: [
          "Leer siempre las indicaciones del sobre de semilla.",
          "Usar sustrato suelto y limpio.",
          "Respetar profundidad aproximada de 2‚Äì3 veces el tama√±o de la semilla.",
          "Mantener humedad constante hasta que germinen."
        ],
        tip: "Si dudas, siembra algunas en alm√°cigo y otras directo y observa."
      }
    };

    function getInfoGerminacion(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      if (!cultivo) return null;

      if (GERMINACION_POR_CULTIVO[cultivoId]) {
        return GERMINACION_POR_CULTIVO[cultivoId];
      }

      const cat = (cultivo.categoria || "").toLowerCase();
      if (cat.includes("hoja")) return GERMINACION_GENERIC.hoja;
      if (cat.includes("ra√≠z") || cat.includes("raiz")) return GERMINACION_GENERIC.raiz;
      if (cat.includes("tub√©rc") || cat.includes("tuberc")) return GERMINACION_GENERIC.tuberculo;
      if (cat.includes("arom√°tica") || cat.includes("aromatica")) return GERMINACION_GENERIC.aromatica;
      if (cat.includes("frutal") || cat.includes("fruto")) return GERMINACION_GENERIC.frutal;

      return GERMINACION_GENERIC.generico;
    }

    /*********************
     * Plagas (datos base)
     *********************/
    const PLAGAS_DATA = [
      {
        id: "pulgones",
        nombre: "Pulgones",
        comoSeVe:
          "Peque√±os insectos verdes, negros o amarillos pegados en brotes tiernos. Hojas enrolladas o deformadas.",
        manejoSuave:
          "Lavar con agua a presi√≥n suave y revisar con frecuencia brotes tiernos.",
        preparadosCaseros:
          "Jab√≥n pot√°sico o mezcla suave de agua con un poco de jab√≥n neutro (bien diluido) al atardecer.",
        productosComerciales:
          "Insecticidas de contacto para pulgones autorizados para huerto casero."
      },
      {
        id: "mosca_blanca",
        nombre: "Mosca blanca",
        comoSeVe:
          "Al mover la hoja salen volantitos blancos. En el env√©s se ven peque√±os puntos blancos fijos.",
        manejoSuave:
          "Retirar hojas muy afectadas y mejorar ventilaci√≥n entre plantas.",
        preparadosCaseros:
          "Trampas amarillas adhesivas y jab√≥n pot√°sico suave.",
        productosComerciales:
          "Productos espec√≠ficos para mosca blanca de uso dom√©stico."
      },
      {
        id: "orugas",
        nombre: "Orugas",
        comoSeVe:
          "Hojas con mordidas grandes. Orugas visibles en env√©s o entre hojas.",
        manejoSuave:
          "Recolecci√≥n manual con guantes, muy efectiva en huertos peque√±os.",
        preparadosCaseros:
          "Infusiones de ajo y aj√≠ como repelente, junto con retiro manual.",
        productosComerciales:
          "Bacillus thuringiensis (BT) para orugas j√≥venes."
      },
      {
        id: "caracoles_babosas",
        nombre: "Caracoles y babosas",
        comoSeVe:
          "Mordidas irregulares en hojas y rastros de baba plateada.",
        manejoSuave:
          "Mantener el √°rea limpia y recogerlos a mano al atardecer.",
        preparadosCaseros:
          "Refugios-trampa y barreras de c√°scara de huevo triturada.",
        productosComerciales:
          "Cebos espec√≠ficos para babosas/caracoles aptos para huerto casero."
      },
      {
        id: "arana_roja",
        nombre: "Ara√±a roja",
        comoSeVe:
          "Puntos amarillos muy finos en hojas y, en ataques fuertes, telara√±as finas.",
        manejoSuave:
          "Aumentar humedad ambiental y duchas de agua en el env√©s.",
        preparadosCaseros:
          "Jab√≥n pot√°sico muy diluido o infusi√≥n de ajo.",
        productosComerciales:
          "Acaricidas espec√≠ficos para ara√±a roja."
      },
      {
        id: "trips",
        nombre: "Trips",
        comoSeVe:
          "Manchas plateadas o rayas en hojas y p√©talos. Insectos alargados y r√°pidos.",
        manejoSuave:
          "Eliminar flores y hojas muy da√±adas y mejorar ventilaci√≥n.",
        preparadosCaseros:
          "Trampas azules/amarillas adhesivas y jab√≥n pot√°sico.",
        productosComerciales:
          "Insecticidas para trips de uso dom√©stico."
      },
      {
        id: "cochinillas",
        nombre: "Cochinillas",
        comoSeVe:
          "Bultitos algodonosos o duros en tallos y hojas; melaza pegajosa.",
        manejoSuave:
          "Retirar a mano o con hisopo y alcohol. Podar partes muy infestadas.",
        preparadosCaseros:
          "Jab√≥n pot√°sico y aceites vegetales suaves (hort√≠colas).",
        productosComerciales:
          "Aceites hort√≠colas minerales o productos para cochinilla."
      },
      {
        id: "hongos_hoja",
        nombre: "Hongos de hoja (mildiu, o√≠dio, manchas)",
        comoSeVe:
          "Manchas amarillas o caf√©s, a veces polvillo blanco en hojas.",
        manejoSuave:
          "Mejorar ventilaci√≥n, evitar mojar follaje de noche y retirar hojas enfermas.",
        preparadosCaseros:
          "Soluciones suaves de bicarbonato o infusiones de cola de caballo.",
        productosComerciales:
          "Fungicidas autorizados para huerto casero."
      }
    ];

    /*********************
     * Estado global
     *********************/
    let stateSettings = loadSettings();
    let stateCultivos = loadCultivos();
    let stateDiario = loadDiario();
    let diarioFiltroActual = "todos";
    let diarioEnEdicionId = null; // üëà NUEVO

    /*********************
     * Render de UI
     *********************/
    function updateHeader() {
      const subtitleEl = document.getElementById("appSubtitle");
      if (!subtitleEl) return;

      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      subtitleEl.innerHTML = `
        <span>Huerto "<strong>${nombre}</strong>"</span>
        <span class="app-subtitle-dot"></span>
        <span>clima ${clima}</span>
        <span class="app-subtitle-dot"></span>
        <span>${hemis}</span>
      `;
    }

    function updateSettingsContexts() {
      const nombre = stateSettings.nombreHuerto || "Mi huerto";
      const clima = CLIMA_LABEL[stateSettings.clima] || CLIMA_LABEL.tropical;
      const hemis = HEMISFERIO_LABEL[stateSettings.hemisferio] || HEMISFERIO_LABEL.norte;

      document.querySelectorAll(".settings-context").forEach(el => {
        el.innerHTML = `
          <span class="chip"><span>üåø</span> Huerto: ${nombre}</span>
          <span class="chip"><span>‚òÅÔ∏è</span> Clima: ${clima}</span>
          <span class="chip"><span>üß≠</span> ${hemis}</span>
        `;
      });

      const climaText = `Clima ${clima}`;
      const estadoClimaChip = document.getElementById("estadoClimaChip");
      if (estadoClimaChip) estadoClimaChip.textContent = climaText;
      const calChip2 = document.getElementById("calendarioClimaChip2");
      if (calChip2) calChip2.textContent = climaText;
    }

    function renderInicio() {
      const cultivosCount = stateCultivos.length;
      const hoyISO = todayISO();
      const entradasHoy = stateDiario.filter(e => e.fecha === hoyISO).length;

      const cultivosEl = document.getElementById("estadoCultivosCount");
      const entradasEl = document.getElementById("estadoEntradasCount");
      if (cultivosEl) cultivosEl.textContent = String(cultivosCount);
      if (entradasEl) entradasEl.textContent = String(entradasHoy);

      const resumen = document.getElementById("estadoResumen");
      if (!resumen) return;

      const nombre = stateSettings.nombreHuerto || "tu huerto";
      let texto;

      if (!cultivosCount && !entradasHoy) {
        texto = 'Todav√≠a no has registrado cultivos ni entradas en el diario. Empieza a√±adiendo tu primer cultivo en "Mi huerto".';
      } else if (cultivosCount && !entradasHoy) {
        texto = `Tienes ${cultivosCount} cultivo(s) registrado(s) en ${nombre}. A√∫n no has escrito nada en el diario hoy.`;
      } else if (cultivosCount && entradasHoy) {
        texto = `Llevas ${cultivosCount} cultivo(s) activo(s) y ya registraste ${entradasHoy} nota(s) en el diario hoy. ¬°Buen trabajo!`;
      } else {
        texto = 'Tienes anotaciones en el diario pero a√∫n no has a√±adido cultivos. Usa "Mi huerto" para registrar lo que est√°s sembrando.';
      }

      resumen.textContent = texto;
    }

    function renderCalendario(monthIndex) {
      const listEl = document.getElementById("calendarList");
      const emptyEl = document.getElementById("calendarEmpty");
      if (!listEl || !emptyEl) return;

      listEl.innerHTML = "";
      const data = getCalendarData(stateSettings, monthIndex);

      if (data.length) {
        emptyEl.style.display = "none";
        data.forEach(item => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${item.titulo}</span>
              <span class="chip">${item.tipo}</span>
            </div>
            <div>${item.detalle}</div>
          `;
          listEl.appendChild(div);
        });
      } else {
        emptyEl.style.display = "block";
      }

      const mesCatalogo = ajustarMesPorHemisferio(stateSettings, monthIndex);
      const sugeridos = CATALOGO_CULTIVOS.filter(
        c => Array.isArray(c.meses) && c.meses.includes(mesCatalogo)
      );

      if (sugeridos.length) {
        const separador = document.createElement("div");
        separador.className = "divider-soft";
        listEl.appendChild(separador);

        const tituloExtra = document.createElement("p");
        tituloExtra.className = "muted";
        tituloExtra.textContent =
          "Desde el cat√°logo: cultivos recomendados para este mes.";
        listEl.appendChild(tituloExtra);

        sugeridos.forEach(c => {
          const div = document.createElement("div");
          div.className = "calendar-item";
          div.innerHTML = `
            <div class="calendar-item-title">
              <span>${c.nombre}</span>
              <span class="chip">${c.categoria}</span>
            </div>
            <div>D√≠as a cosecha: ${c.dias}. Luz: ${c.luz}.</div>
            <div style="margin-top:6px;">
              <button
                class="btn btn-secondary btn-full"
                data-action="ver-catalogo"
                data-id="${c.id}">
                üîç Ver en cat√°logo
              </button>
            </div>
          `;
          listEl.appendChild(div);
        });
      }
    }

    function irACultivoEnCatalogo(cultivoId) {
      const cultivo = CATALOGO_CULTIVOS.find(c => c.id === cultivoId);
      const textoBusqueda = cultivo ? cultivo.nombre : "";

      const navBtn = document.querySelector('.nav-btn[data-section="catalogo"]');
      if (navBtn) navBtn.click();

      const input = document.getElementById("catalogoBusqueda");
      if (input) input.value = textoBusqueda;

      renderCatalogo(textoBusqueda);

      const section = document.getElementById("section-catalogo");
      if (section && section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    function renderCatalogo(filtroTexto = "") {
      const listEl = document.getElementById("catalogoList");
      if (!listEl) return;

      const filtro = filtroTexto.trim().toLowerCase();
      const lista = CATALOGO_CULTIVOS.filter(c => {
        if (!filtro) return true;
        return (
          c.nombre.toLowerCase().includes(filtro) ||
          c.id.toLowerCase().includes(filtro)
        );
      });

      if (!lista.length) {
        listEl.innerHTML = `<p class="muted">No hay cultivos que coincidan con "${filtroTexto}".</p>`;
        return;
      }

      listEl.innerHTML = "";
      lista.forEach(c => {
        const imgSrc = c.imagen || "img/placeholder.jpg";

        const card = document.createElement("div");
        card.className = "cultivo-card";
        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <img
                src="${imgSrc}"
                alt="${c.nombre}"
                class="cultivo-thumb"
                onerror="this.onerror=null;this.src='img/placeholder.jpg';"
              />
              <span>üå± ${c.nombre}</span>
            </div>
            <span class="chip">${c.categoria}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>D√≠as a cosecha:</strong> ${c.dias}</div>
            <div><strong>Luz:</strong> ${c.luz}</div>
            <div><strong>Riego:</strong> ${c.riego}</div>
            <div><strong>Tiesto / suelo:</strong> ${c.tiesto}</div>
            <div><strong>Profundidad de siembra:</strong> ${c.profundidad}</div>
            <div><strong>Plagas frecuentes:</strong> ${c.plagas.join(", ")}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn-secondary btn"
                    data-id="${c.id}"
                    data-action="germinacion">
              üîÅ Ver germinaci√≥n / reproducci√≥n
            </button>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    function getRiegoYCosechaParaNombre(nombre, fechaSiembraISO) {
      let frecuenciaRiego = null;
      let fechaCosechaEstimada = null;

      if (!nombre) return { frecuenciaRiego, fechaCosechaEstimada };

      const nombreLower = nombre.trim().toLowerCase();
      const cultivoCatalogo = CATALOGO_CULTIVOS.find(
        c =>
          c.nombre.toLowerCase() === nombreLower ||
          c.id.toLowerCase() === nombreLower
      );

      if (cultivoCatalogo) {
        frecuenciaRiego = 3; // valor gen√©rico sencillo
        if (fechaSiembraISO && cultivoCatalogo.dias) {
          const match = cultivoCatalogo.dias.match(/(\d+)/);
          if (match) {
            const dias = parseInt(match[1], 10);
            if (Number.isFinite(dias) && dias > 0) {
              fechaCosechaEstimada = addDays(fechaSiembraISO, dias);
            }
          }
        }
      }

      return { frecuenciaRiego, fechaCosechaEstimada };
    }

    function renderCultivos() {
      const listEl = document.getElementById("cultivosList");
      const chip = document.getElementById("cultivosCountChip");
      if (!listEl) return;

      const count = stateCultivos.length;
      if (chip) chip.textContent = `${count} cultivo${count === 1 ? "" : "s"}`;

      if (!count) {
        listEl.innerHTML =
          '<p class="muted">Todav√≠a no has registrado cultivos. Usa el formulario de arriba para a√±adir tu primera siembra.</p>';
        return;
      }

      listEl.innerHTML = "";
      stateCultivos.forEach(c => {
        const card = document.createElement("div");
        card.className = "cultivo-card";

        const tipoLabelMap = {
          hoja: "Hoja",
          fruto: "Fruto",
          raiz: "Ra√≠z",
          tuberculo: "Tub√©rculo",
          aromaticas: "Arom√°ticas",
          otro: "Otro"
        };
        const tipoLabel = tipoLabelMap[c.tipo] || "Otro";

        const ultimaAbonoTexto = c.ultimaFertilizacion
          ? formatDate(c.ultimaFertilizacion)
          : "Sin registro";
        const frecuenciaAbonoTexto = c.frecuenciaAbonoDias
          ? c.frecuenciaAbonoDias + " d√≠as"
          : "No definida";

        const ultimoRiegoTexto = c.ultimoRiego
          ? formatDate(c.ultimoRiego)
          : "Sin registro";
        const frecuenciaRiegoTexto = c.frecuenciaRiegoDias
          ? c.frecuenciaRiegoDias + " d√≠as"
          : "No definida";

        const fechaCosechaTexto = c.fechaCosechaEstimada
          ? formatDate(c.fechaCosechaEstimada)
          : "No definida";

        card.innerHTML = `
          <div class="cultivo-header">
            <div class="cultivo-title">
              <span>üåø</span>
              <span>${c.nombre}</span>
            </div>
            <span class="chip">${tipoLabel}</span>
          </div>
          <div class="cultivo-body">
            <div><strong>Variedad:</strong> ${c.variedad || "Sin especificar"}</div>
            <div><strong>Fecha de siembra:</strong> ${formatDate(c.fechaSiembra)}</div>
            <div><strong>Ubicaci√≥n / notas cortas:</strong> ${
              c.notas ? c.notas.slice(0, 140) : "‚Äî"
            }</div>
            <div><strong>Registro creado:</strong> ${formatDate(c.creadoEl)}</div>
            <div><strong>√öltimo abono:</strong> ${ultimaAbonoTexto}</div>
            <div><strong>Frecuencia de abono:</strong> ${frecuenciaAbonoTexto}</div>
            <div><strong>√öltimo riego:</strong> ${ultimoRiegoTexto}</div>
            <div><strong>Frecuencia de riego:</strong> ${frecuenciaRiegoTexto}</div>
            <div><strong>Fecha est. cosecha:</strong> ${fechaCosechaTexto}</div>
          </div>
          <div class="cultivo-actions">
            <button class="btn-secondary btn" data-id="${c.id}" data-action="nota">‚úèÔ∏è A√±adir nota</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="riego">üí¶ Registrar riego hoy</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="abono">üíß Registrar abono hoy</button>
            <button class="btn-secondary btn" data-id="${c.id}" data-action="plaga">üêõ Plagas de este cultivo</button>
            <button class="btn-danger btn" data-id="${c.id}" data-action="borrar">üóë Eliminar</button>
          </div>
        `;

        listEl.appendChild(card);
      });
    }

    function renderDiario() {
  const listEl = document.getElementById("diarioList");
  const chip = document.getElementById("diarioCountChip");
  const resumenHoyEl = document.getElementById("diarioResumenHoy");
  if (!listEl) return;

  const arrOrdenada = [...stateDiario].sort((a, b) =>
    b.fecha.localeCompare(a.fecha)
  );
  const countTotal = arrOrdenada.length;

  if (chip) {
    chip.textContent = `${countTotal} entrada${countTotal === 1 ? "" : "s"}`;
  }

  if (resumenHoyEl) {
    const hoy = todayISO();
    const hoyEntries = arrOrdenada.filter(e => e.fecha === hoy);

    if (!hoyEntries.length) {
      resumenHoyEl.textContent =
        "Hoy a√∫n no has registrado nada en el diario.";
    } else {
      const riegos = hoyEntries.filter(e => e.tipo === "Riego").length;
      const abonos = hoyEntries.filter(e => e.tipo === "Abono").length;
      const otros = hoyEntries.length - riegos - abonos;

      const partes = [];
      if (riegos) partes.push(`${riegos} riego(s)`);
      if (abonos) partes.push(`${abonos} abono(s)`);
      if (otros) partes.push(`${otros} nota(s) general(es)`);

      resumenHoyEl.textContent = `Hoy registraste: ${partes.join(", ")}.`;
    }
  }

  const arrFiltrada = arrOrdenada.filter(e => {
    if (diarioFiltroActual === "todos") return true;
    return (e.tipo || "General") === diarioFiltroActual;
  });

  if (!arrFiltrada.length) {
    listEl.innerHTML =
      '<p class="muted">No hay entradas que coincidan con el filtro seleccionado.</p>';
    return;
  }

  listEl.innerHTML = "";
  arrFiltrada.forEach(e => {
    const div = document.createElement("div");
    div.className = "diario-item";
    div.innerHTML = `
      <div class="diario-item-header">
        <span><strong>${formatDate(e.fecha)}</strong></span>
        <div>
          <span class="chip">${e.tipo || "General"}</span>
          <button
            class="btn btn-secondary"
            data-action="editar-diario"
            data-id="${e.id}"
            style="padding:4px 8px;font-size:0.7rem;margin-left:6px;">
            ‚úèÔ∏è Editar
          </button>
        </div>
      </div>
      <div>${e.texto}</div>
    `;
    listEl.appendChild(div);
  });
}

    function renderPlagas(highlightId) {
      const listEl = document.getElementById("plagasList");
      if (!listEl) return;

      listEl.innerHTML = "";
      PLAGAS_DATA.forEach(p => {
        const div = document.createElement("div");
        div.className =
          "plaga-card" + (highlightId && highlightId === p.id ? " plaga-card--highlight" : "");
        div.innerHTML = `
          <div class="media-item-title">üêõ ${p.nombre}</div>
          <div class="media-item-body"><strong>C√≥mo se ve:</strong> ${p.comoSeVe}</div>
          <div class="media-item-body"><strong>Manejo suave:</strong> ${p.manejoSuave}</div>
          <div class="media-item-body"><strong>Preparados caseros:</strong> ${p.preparadosCaseros}</div>
          <div class="media-item-body"><strong>Productos comerciales:</strong> ${p.productosComerciales}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function renderPesticidas() {
      const listEl = document.getElementById("pesticidasList");
      if (!listEl) return;

      const data = [
        {
          nombre: "Jab√≥n pot√°sico / neutro suave",
          paraQue: "Ayuda a controlar pulgones, mosca blanca y cochinillas.",
          ingredientes: "- 10‚Äì15 ml de jab√≥n pot√°sico o jab√≥n neutro l√≠quido\n- 1 litro de agua",
          preparacion: "Mezcla el jab√≥n en el agua hasta que quede bien disuelto.",
          aplicacion: "Pulverizar sobre hojas (env√©s) al atardecer, cada 5‚Äì7 d√≠as seg√∫n necesidad.",
          advertencias: "No usar m√°s concentrado; puede quemar hojas delicadas. No aplicar a pleno sol."
        },
        {
          nombre: "Infusi√≥n de ajo y aj√≠ picante",
          paraQue: "Repelente general para pulgones y orugas peque√±as.",
          ingredientes: "- 3‚Äì4 dientes de ajo\n- 1 trocito de aj√≠ picante\n- 1 litro de agua\n- 3‚Äì5 ml de jab√≥n neutro (opcional)",
          preparacion: "Tritura ajo y aj√≠, deja reposar 12‚Äì24 h, cuela y completa hasta 1 litro. A√±ade jab√≥n si quieres mejor adherencia.",
          aplicacion: "Pulverizar sobre hojas y tallos al atardecer, 1‚Äì2 veces por semana.",
          advertencias: "Evita contacto con ojos y piel. Lava bien las manos luego."
        },
        {
          nombre: "Bicarbonato para hongos de hoja",
          paraQue: "Apoyo preventivo contra o√≠dio y algunos hongos de superficie.",
          ingredientes: "- 5 g (1 cdta) de bicarbonato de sodio\n- 1 litro de agua\n- 5 ml de jab√≥n neutro (opcional)",
          preparacion: "Disolver el bicarbonato en agua y a√±adir el jab√≥n.",
          aplicacion: "Pulverizar sobre hojas 1 vez por semana, siempre al atardecer.",
          advertencias: "No exceder la dosis; demasiado bicarbonato puede quemar hojas."
        }
      ];

      listEl.innerHTML = "";
      data.forEach(p => {
        const div = document.createElement("div");
        div.className = "plaga-card";
        div.innerHTML = `
          <div class="media-item-title">üíß ${p.nombre}</div>
          <div class="media-item-body"><strong>¬øPara qu√© sirve?</strong> ${p.paraQue}</div>
          <div class="media-item-body"><strong>Ingredientes:</strong><br>${p.ingredientes.replace(/\n/g,"<br>")}</div>
          <div class="media-item-body"><strong>Preparaci√≥n:</strong> ${p.preparacion}</div>
          <div class="media-item-body"><strong>C√≥mo aplicar:</strong> ${p.aplicacion}</div>
          <div class="media-item-body"><strong>Advertencias:</strong> ${p.advertencias}</div>
        `;
        listEl.appendChild(div);
      });
    }

    /*********************
     * Navegaci√≥n y setups
     *********************/
    function setupNavigation() {
      const navButtons = document.querySelectorAll(".nav-btn");
      navButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          const section = btn.getAttribute("data-section");
          if (!section) return;

          navButtons.forEach(b =>
            b.classList.toggle("nav-btn--active", b === btn)
          );

          document.querySelectorAll(".section").forEach(sec => {
            sec.classList.toggle(
              "section--active",
              sec.id === `section-${section}`
            );
          });
        });
      });
    }

    function setupMesesPills() {
      const pills = document.querySelectorAll("#mesesPills .pill");
      if (!pills.length) return;

      pills.forEach(p => {
        p.addEventListener("click", () => {
          pills.forEach(other =>
            other.classList.toggle("pill--active", other === p)
          );
          const month = parseInt(p.getAttribute("data-mes"), 10);
          renderCalendario(month);
        });
      });

      const now = new Date();
      const currentMonth = now.getMonth();
      let target = null;
      pills.forEach(p => {
        if (parseInt(p.dataset.mes, 10) === currentMonth) target = p;
      });
      if (target) target.click();
      else renderCalendario(5);
    }

    function setupCatalogo() {
      const input = document.getElementById("catalogoBusqueda");
      const listEl = document.getElementById("catalogoList");

      if (input) {
        input.addEventListener("input", () => {
          renderCatalogo(input.value);
        });
      }

      if (listEl) {
        listEl.addEventListener("click", ev => {
          const btn = ev.target.closest("button[data-action='germinacion']");
          if (!btn) return;

          const id = btn.getAttribute("data-id");
          const info = getInfoGerminacion(id);
          if (!info) {
            alert("Todav√≠a no tengo la gu√≠a de germinaci√≥n para este cultivo.");
            return;
          }

          const card = btn.closest(".cultivo-card");
          if (!card) return;

          let panel = card.querySelector(".germinacion-panel");
          if (!panel) {
            panel = document.createElement("div");
            panel.className = "germinacion-panel";
            card.appendChild(panel);
          }

          if (panel.style.display === "block") {
            panel.style.display = "none";
            return;
          }

          const pasosHtml = info.pasos
            .map((p, i) => `${i + 1}. ${p}`)
            .join("<br>");

          panel.innerHTML = `
            <div class="media-item-title">${info.titulo}</div>
            <div class="media-item-body"><strong>M√©todo principal:</strong> ${info.metodo}</div>
            <div class="media-item-body"><strong>Pasos:</strong><br>${pasosHtml}</div>
            <div class="media-item-body"><strong>Tip:</strong> ${info.tip}</div>
          `;
          panel.style.display = "block";
        });
      }
    }

    function setupCalendarioLinks() {
      const calendarList = document.getElementById("calendarList");
      if (!calendarList) return;

      calendarList.addEventListener("click", ev => {
        const btn = ev.target.closest("button[data-action='ver-catalogo']");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        if (id) {
          irACultivoEnCatalogo(id);
        }
      });
    }

    function setupMiHuertoForm() {
      const btn = document.getElementById("btnAgregarCultivo");
      if (!btn) return;

      btn.addEventListener("click", () => {
        const nombre = (document.getElementById("cultivoNombre").value || "").trim();
        const variedad = (document.getElementById("cultivoVariedad").value || "").trim();
        const tipo = document.getElementById("cultivoTipo").value || "otro";
        const fechaSiembra =
          document.getElementById("cultivoFecha").value || todayISO();
        const notas = (document.getElementById("cultivoNotas").value || "").trim();

        if (!nombre) {
          alert("Por favor escribe al menos el nombre del cultivo.");
          return;
        }

        const extra = getRiegoYCosechaParaNombre(nombre, fechaSiembra);

        const nuevo = {
          id: Date.now().toString(36),
          nombre,
          variedad,
          tipo,
          fechaSiembra,
          notas,
          creadoEl: todayISO(),
          ultimaFertilizacion: null,
          frecuenciaAbonoDias: 30,
          ultimoRiego: null,
          frecuenciaRiegoDias: extra.frecuenciaRiego,
          fechaCosechaEstimada: extra.fechaCosechaEstimada || null
        };

        stateCultivos.push(nuevo);
        saveCultivos(stateCultivos);

        document.getElementById("cultivoNombre").value = "";
        document.getElementById("cultivoVariedad").value = "";
        document.getElementById("cultivoFecha").value = "";
        document.getElementById("cultivoNotas").value = "";

        renderCultivos();
        renderInicio();
        alert("Cultivo guardado ‚úÖ");
      });

      const list = document.getElementById("cultivosList");
      if (!list) return;

      list.addEventListener("click", ev => {
        const btn = ev.target.closest("button[data-id]");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        const cultivo = stateCultivos.find(c => c.id === id);
        if (!cultivo) return;

        if (action === "borrar") {
          if (confirm(`¬øEliminar el cultivo "${cultivo.nombre}"?`)) {
            stateCultivos = stateCultivos.filter(c => c.id !== id);
            saveCultivos(stateCultivos);
            renderCultivos();
            renderInicio();
          }
        } else if (action === "nota") {
          const navBtn = document.querySelector('.nav-btn[data-section="diario"]');
          if (navBtn) navBtn.click();
          const campo = document.getElementById("diarioTexto");
          if (campo) {
            campo.value = `Cultivo: ${cultivo.nombre}${
              cultivo.variedad ? ` (${cultivo.variedad})` : ""
            }. `;
            campo.focus();
          }
        } else if (action === "riego") {
          cultivo.ultimoRiego = todayISO();
          if (!cultivo.frecuenciaRiegoDias) {
            const entrada = prompt(
              "¬øCada cu√°ntos d√≠as quieres regar este cultivo? (n√∫mero de d√≠as)",
              "3"
            );
            const n = parseInt(entrada, 10);
            if (Number.isFinite(n) && n > 0) {
              cultivo.frecuenciaRiegoDias = n;
            }
          }

          stateDiario.push({
            id: Date.now().toString(36),
            fecha: todayISO(),
            texto: `Riego registrado para ${cultivo.nombre}${
              cultivo.variedad ? ` (${cultivo.variedad})` : ""
            }.`,
            tipo: "Riego"
          });

          saveCultivos(stateCultivos);
          saveDiario(stateDiario);
          renderCultivos();
          renderDiario();
          renderInicio();
          alert("Riego registrado ‚úÖ");
        } else if (action === "abono") {
          cultivo.ultimaFertilizacion = todayISO();
          if (!cultivo.frecuenciaAbonoDias) {
            const entrada = prompt(
              "¬øCada cu√°ntos d√≠as quieres abonar este cultivo? (n√∫mero de d√≠as)",
              "30"
            );
            const n = parseInt(entrada, 10);
            if (Number.isFinite(n) && n > 0) {
              cultivo.frecuenciaAbonoDias = n;
            }
          }

          stateDiario.push({
            id: Date.now().toString(36),
            fecha: todayISO(),
            texto: `Abono registrado para ${cultivo.nombre}${
              cultivo.variedad ? ` (${cultivo.variedad})` : ""
            }.`,
            tipo: "Abono"
          });

          saveCultivos(stateCultivos);
          saveDiario(stateDiario);
          renderCultivos();
          renderDiario();
          renderInicio();
          alert("Abono registrado ‚úÖ");
        } else if (action === "plaga") {
          const entrada = prompt(
            'Escribe la plaga que quieres consultar (ej. "pulgones", "mosca blanca", "ara√±a roja"):'
          );
          if (!entrada) return;

          const texto = entrada.trim().toLowerCase();
          const plaga = PLAGAS_DATA.find(p =>
            p.nombre.toLowerCase().includes(texto)
          );

          if (!plaga) {
            alert(
              "No encontr√© esa plaga en la lista. Prueba con nombres como: pulgones, mosca blanca, ara√±a roja, etc."
            );
            return;
          }

          const navPlagas = document.querySelector(
            '.nav-btn[data-section="plagas"]'
          );
          if (navPlagas) navPlagas.click();
          renderPlagas(plaga.id);
          alert(`Mostrando informaci√≥n para: ${plaga.nombre}.`);
        }
      });
    }

    function setupDiario() {
  const btn = document.getElementById("btnGuardarDiario");
  const campo = document.getElementById("diarioTexto");
  const filtros = document.querySelectorAll("#diarioFiltros .pill");
  const listEl = document.getElementById("diarioList");

  if (!btn || !campo) return;

  // Guardar / actualizar entrada
  btn.addEventListener("click", () => {
    const texto = campo.value.trim();
    if (!texto) {
      alert("Escribe algo antes de guardar.");
      return;
    }

    const tituloCard = document.querySelector(
      '#section-diario .app-card .app-card-title'
    );

    // MODO EDICI√ìN
    if (diarioEnEdicionId) {
      const idx = stateDiario.findIndex(e => e.id === diarioEnEdicionId);
      if (idx !== -1) {
        stateDiario[idx].texto = texto;
        saveDiario(stateDiario);
      }

      diarioEnEdicionId = null;
      campo.value = "";
      if (tituloCard) tituloCard.textContent = "Nueva entrada";
      btn.innerHTML = '<span>üíæ</span> Guardar en el diario';

      renderDiario();
      renderInicio();
      alert("Entrada actualizada.");
      return;
    }

    // MODO NUEVA ENTRADA
    const entrada = {
      id: Date.now().toString(36),
      fecha: todayISO(),
      texto,
      tipo: "General"
    };

    stateDiario.push(entrada);
    saveDiario(stateDiario);
    campo.value = "";
    renderDiario();
    renderInicio();
    alert("Entrada guardada en el diario.");
  });

  // Filtros (igual que antes)
  if (filtros && filtros.length) {
    filtros.forEach(filtro => {
      filtro.addEventListener("click", () => {
        filtros.forEach(b => b.classList.remove("pill--active"));
        filtro.classList.add("pill--active");

        diarioFiltroActual = filtro.dataset.filtro || "todos";
        renderDiario();
      });
    });
  }

  // Click en "‚úèÔ∏è Editar" dentro de la lista
  if (listEl) {
    listEl.addEventListener("click", ev => {
      const btnEditar = ev.target.closest("button[data-action='editar-diario']");
      if (!btnEditar) return;

      const id = btnEditar.getAttribute("data-id");
      const entrada = stateDiario.find(e => e.id === id);
      if (!entrada) return;

      diarioEnEdicionId = id;

      campo.value = entrada.texto || "";
      campo.focus();

      const tituloCard = document.querySelector(
        '#section-diario .app-card .app-card-title'
      );
      if (tituloCard) tituloCard.textContent = "Editar entrada";

      btn.innerHTML = '<span>üíæ</span> Actualizar entrada';

      // Opcional: subir hasta el formulario
      const section = document.getElementById("section-diario");
      if (section && section.scrollIntoView) {
        section.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });
  }
}

    function setupOpciones() {
      const nombreInput = document.getElementById("nombreHuerto");
      const climaSelect = document.getElementById("climaSelect");
      const hemisSelect = document.getElementById("hemisferioSelect");

      if (nombreInput) nombreInput.value = stateSettings.nombreHuerto || "";
      if (climaSelect) climaSelect.value = stateSettings.clima || "tropical";
      if (hemisSelect) hemisSelect.value = stateSettings.hemisferio || "norte";

      const btnGuardar = document.getElementById("btnGuardarConfig");
      if (btnGuardar) {
        btnGuardar.addEventListener("click", () => {
          const nuevoNombre = (nombreInput.value || "").trim() || "Mi huerto";
          const nuevoClima = climaSelect.value || "tropical";
          const nuevoHemis = hemisSelect.value || "norte";

          stateSettings = {
            ...stateSettings,
            nombreHuerto: nuevoNombre,
            clima: nuevoClima,
            hemisferio: nuevoHemis
          };
          saveSettings(stateSettings);
          updateHeader();
          updateSettingsContexts();
          renderInicio();
          renderCalendario(new Date().getMonth());
          alert("Configuraci√≥n guardada ‚úÖ");
        });
      }
    }

    /*********************
     * PDF y respaldo
     *********************/
    function exportarDatosPDF() {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("No se pudo cargar la librer√≠a para PDF.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4"
        });

        const marginLeft = 10;
        const maxWidth = 190 - marginLeft * 2;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Resumen de datos", marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleString()}`, marginLeft, y);
        y += 8;

        doc.setFontSize(11);
        doc.text("Ajustes del huerto", marginLeft, y);
        y += 6;

        doc.setFontSize(10);
        const textoSettings = `Nombre: ${stateSettings.nombreHuerto || ""}\nClima: ${stateSettings.clima}\nHemisferio: ${stateSettings.hemisferio}`;
        const lineasSettings = doc.splitTextToSize(textoSettings, maxWidth);
        lineasSettings.forEach(line => {
          if (y > 280) {
            doc.addPage();
            y = 10;
          }
          doc.text(line, marginLeft, y);
          y += 4;
        });

        y += 4;
        doc.setFontSize(11);
        doc.text("Cultivos registrados", marginLeft, y);
        y += 6;
        doc.setFontSize(10);

        if (!stateCultivos.length) {
          doc.text("No hay cultivos guardados.", marginLeft, y);
          y += 6;
        } else {
          stateCultivos.forEach(c => {
            const textoCultivo = `‚Ä¢ ${c.nombre}${
              c.variedad ? ` (${c.variedad})` : ""
            } ‚Äì siembra: ${formatDate(c.fechaSiembra)} ‚Äì notas: ${c.notas || "-"}`;
            const lineas = doc.splitTextToSize(textoCultivo, maxWidth);
            lineas.forEach(line => {
              if (y > 280) {
                doc.addPage();
                y = 10;
              }
              doc.text(line, marginLeft, y);
              y += 4;
            });
          });
          y += 4;
        }

        doc.setFontSize(11);
        doc.text("Resumen del diario", marginLeft, y);
        y += 6;
        doc.setFontSize(10);
        if (!stateDiario.length) {
          doc.text("No hay entradas en el diario.", marginLeft, y);
        } else {
          doc.text(`Total de entradas: ${stateDiario.length}`, marginLeft, y);
        }

        doc.save("mi-siembra-datos.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al crear el PDF.");
      }
    }

    function exportarDiarioPDF() {
      try {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          alert("No se pudo cargar la librer√≠a para PDF.");
          return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
          orientation: "p",
          unit: "mm",
          format: "a4"
        });

        const marginLeft = 10;
        const maxWidth = 190 - marginLeft * 2;
        let y = 10;

        doc.setFontSize(14);
        doc.text("Mi Siembra Inteligente ‚Äì Diario de huerto", marginLeft, y);
        y += 8;

        doc.setFontSize(10);
        doc.text(`Generado: ${new Date().toLocaleString()}`, marginLeft, y);
        y += 8;

        if (!stateDiario.length) {
          doc.text("No hay entradas en el diario.", marginLeft, y);
          doc.save("mi-siembra-diario.pdf");
          return;
        }

        const entradasOrdenadas = [...stateDiario].sort((a, b) =>
          a.fecha.localeCompare(b.fecha)
        );

        entradasOrdenadas.forEach(e => {
          const encabezado = `${formatDate(e.fecha)} ‚Äì ${e.tipo || "General"}`;
          const texto = e.texto || "";
          const lineas = doc.splitTextToSize(
            encabezado + "\n" + texto,
            maxWidth
          );

          lineas.forEach(line => {
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            doc.text(line, marginLeft, y);
            y += 4;
          });

          y += 2;
        });

        doc.save("mi-siembra-diario.pdf");
      } catch (e) {
        console.error(e);
        alert("Ocurri√≥ un problema al exportar el diario.");
      }
    }

    function exportarRespaldoJSON() {
      const respaldo = {
        settings: stateSettings,
        cultivos: stateCultivos,
        diario: stateDiario
      };

      const contenido = JSON.stringify(respaldo, null, 2);
      const blob = new Blob([contenido], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const enlace = document.createElement("a");
      const fecha = new Date().toISOString().slice(0, 10);

      enlace.href = url;
      enlace.download = `mi-siembra-respaldo-${fecha}.json`;
      document.body.appendChild(enlace);
      enlace.click();
      document.body.removeChild(enlace);
      URL.revokeObjectURL(url);

      alert("Respaldo (.json) exportado correctamente ‚úÖ");
    }

    function importarRespaldoJSON() {
      const input = document.getElementById("inputRespaldoJSON");
      if (!input) {
        alert("No se encontr√≥ el campo de archivo para restaurar el respaldo.");
        return;
      }

      input.value = "";
      input.onchange = event => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            if (!data || typeof data !== "object") {
              throw new Error("Formato de respaldo no v√°lido");
            }

            const confirmar = confirm(
              "Esto reemplazar√° los datos actuales de tu huerto por los del respaldo seleccionado. ¬øQuieres continuar?"
            );
            if (!confirmar) return;

            if (data.settings) {
              stateSettings = { ...DEFAULT_SETTINGS, ...data.settings };
              saveSettings(stateSettings);
            }

            if (Array.isArray(data.cultivos)) {
              stateCultivos = data.cultivos;
              saveCultivos(stateCultivos);
            } else {
              stateCultivos = [];
              saveCultivos(stateCultivos);
            }

            if (Array.isArray(data.diario)) {
              stateDiario = data.diario;
              saveDiario(stateDiario);
            } else {
              stateDiario = [];
              saveDiario(stateDiario);
            }

            updateHeader();
            updateSettingsContexts();
            renderCultivos();
            renderDiario();
            renderInicio();
            renderCalendario(new Date().getMonth());

            alert("Respaldo restaurado correctamente ‚úÖ");
          } catch (err) {
            console.error(err);
            alert(
              "No se pudo leer el archivo de respaldo. Usa un .json generado por Mi Siembra Inteligente."
            );
          }
        };

        reader.readAsText(file);
      };

      input.click();
    }

    function borrarTodo() {
      if (
        !confirm(
          "Esto borrar√° ajustes, cultivos y diario en este dispositivo. ¬øSeguro que quieres continuar?"
        )
      ) {
        return;
      }

      localStorage.removeItem(STORAGE_KEYS.settings);
      localStorage.removeItem(STORAGE_KEYS.cultivos);
      localStorage.removeItem(STORAGE_KEYS.diario);

      stateSettings = { ...DEFAULT_SETTINGS };
      stateCultivos = [];
      stateDiario = [];

      const nombreInput = document.getElementById("nombreHuerto");
      const climaSelect = document.getElementById("climaSelect");
      const hemisSelect = document.getElementById("hemisferioSelect");

      if (nombreInput) nombreInput.value = stateSettings.nombreHuerto;
      if (climaSelect) climaSelect.value = stateSettings.clima;
      if (hemisSelect) hemisSelect.value = stateSettings.hemisferio;

      updateHeader();
      updateSettingsContexts();
      renderCultivos();
      renderDiario();
      renderInicio();
      renderCalendario(new Date().getMonth());

      alert("Se borraron todos los datos. Empezar√°s de cero üå±");
    }

    /*********************
     * PWA: service worker + instalar
     *********************/
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("sw.js")
          .catch(err => console.error("Error registrando SW:", err));
      });
    }

    let deferredPrompt = null;
    const installBanner = document.getElementById("installBanner");
    const installBtn = document.getElementById("btnInstalarPwa");

    window.addEventListener("beforeinstallprompt", e => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBanner) {
        installBanner.classList.remove("hidden");
      }
    });

    if (installBtn) {
      installBtn.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        if (installBanner) {
          installBanner.classList.add("hidden");
        }
      });
    }

    /*********************
     * Inicio de la app
     *********************/
    document.addEventListener("DOMContentLoaded", () => {
      updateHeader();
      updateSettingsContexts();
      renderInicio();
      renderCalendario(new Date().getMonth());
      renderCatalogo();
      renderCultivos();
      renderDiario();
      renderPlagas();
      renderPesticidas();

      setupNavigation();
      setupMesesPills();
      setupMiHuertoForm();
      setupDiario();
      setupOpciones();
      setupCatalogo();
      setupCalendarioLinks();
    });
  </script>
</body>
              </html>
