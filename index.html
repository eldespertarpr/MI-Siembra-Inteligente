<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi Siembra Inteligente (v15)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#22c55e" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #020617;
      --bg-elevated: #02081f;
      --card: #02081f;
      --card-soft: #030919;
      --accent: #22c55e;
      --accent-soft: rgba(34,197,94,0.12);
      --accent-strong: rgba(34,197,94,0.4);
      --text-main: #f9fafb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148,163,184,0.4);
      --shadow-soft: 0 18px 45px rgba(15,23,42,0.85);
      --radius-xl: 20px;
      --radius-2xl: 26px;
      --transition-fast: 0.18s ease-out;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      font-size: 16px;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 50%, #000 100%);
      color: var(--text-main);
      min-height: 100%;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }

    .app-shell {
      min-height: 100vh;
      max-width: 960px;
      margin: 0 auto;
      padding: 16px 12px 24px;
    }

    /* HEADER */

    header.app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      padding: 4px 4px 10px;
      backdrop-filter: blur(26px);
      -webkit-backdrop-filter: blur(26px);
    }

    .header-inner {
      border-radius: 999px;
      padding: 10px 16px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.15) 0, rgba(15,23,42,0.9) 45%, rgba(15,23,42,0.96) 100%);
      box-shadow: 0 20px 60px rgba(15,23,42,0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 0, #bbf7d0 0, #22c55e 30%, #15803d 70%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.9), 0 12px 30px rgba(34,197,94,0.55);
    }

    .brand-icon span { font-size: 18px; }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .brand-title {
      font-weight: 650;
      letter-spacing: 0.01em;
      font-size: 17px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-soft);
    }

    .pill-nav {
      display: flex;
      gap: 6px;
      padding: 2px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      border: 1px solid rgba(148,163,184,0.55);
    }

    .pill-nav button {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .pill-nav button span.emoji { font-size: 13px; }

    .pill-nav button.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(34,197,94,0.6);
      transform: translateY(-0.5px);
    }

    main { padding: 8px 2px 24px; }

    section.view {
      display: none;
      animation: fadeIn 0.2s ease-out;
    }

    section.view.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* CARDS Y LISTAS */

    .section-card {
      background: radial-gradient(circle at top left, rgba(148,163,184,0.14) 0, var(--card-soft) 42%, #020617 100%);
      border-radius: var(--radius-2xl);
      padding: 18px 18px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(51,65,85,0.9);
      margin-bottom: 18px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .section-title {
      font-size: 21px;
      font-weight: 650;
    }

    .section-subtitle {
      font-size: 13px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .badge {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(34,197,94,0.18);
      border: 1px solid rgba(34,197,94,0.6);
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .badge span.emoji { font-size: 12px; }

    .grid-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .home-card {
      background: radial-gradient(circle at 0 0, rgba(34,197,94,0.38) 0, rgba(15,23,42,0.98) 45%, rgba(15,23,42,1) 100%);
      border-radius: 20px;
      padding: 12px 12px 13px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(34,197,94,0.62);
      box-shadow: 0 12px 32px rgba(22,163,74,0.7);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 5px;
      min-height: 90px;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }

    .home-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(22,163,74,0.85);
      border-color: rgba(190,242,100,0.95);
    }

    .home-card-title {
      font-size: 15px;
      font-weight: 650;
    }

    .home-card-desc {
      font-size: 12px;
      color: #d1fae5;
      max-width: 85%;
    }

    .home-card-icon {
      position: absolute;
      right: -6px;
      bottom: -4px;
      font-size: 46px;
      opacity: 0.18;
      transform: rotate(-8deg);
    }

    .chips-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .chip {
      font-size: 11px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .chip span.emoji { font-size: 12px; }

    .month-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .month-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: var(--text-soft);
      font-size: 12px;
      padding: 6px 4px;
      text-align: center;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast);
    }

    .month-btn.active {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      border-color: rgba(190,242,100,0.95);
      box-shadow: 0 10px 28px rgba(34,197,94,0.85);
      transform: translateY(-1px);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .list-item {
      border-radius: 18px;
      padding: 10px 11px;
      background: linear-gradient(135deg, rgba(15,23,42,0.96), rgba(15,23,42,1));
      border: 1px solid rgba(51,65,85,0.95);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .list-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .list-title {
      font-size: 14px;
      font-weight: 600;
    }

    .list-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      font-size: 11px;
    }

    .meta-pill {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
    }

    .small-btn {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 5px 8px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .small-btn span.emoji { font-size: 13px; }

    .catalog-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .crop-card {
      border-radius: 22px;
      overflow: hidden;
      background: radial-gradient(circle at top, rgba(22,163,74,0.3) 0, #020617 55%);
      border: 1px solid rgba(51,65,85,0.95);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      min-height: 190px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), border-color var(--transition-fast);
    }

    .crop-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 18px 40px rgba(22,163,74,0.85);
      border-color: rgba(190,242,100,0.95);
    }

    .crop-photo {
      height: 90px;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at 20% 0, #bbf7d0 0, #22c55e 35%, #15803d 70%, #166534 100%);
    }

    .crop-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      opacity: 0.88;
    }

    .crop-photo::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(2,6,23,0.82));
    }

    .crop-body {
      padding: 9px 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .crop-name {
      font-size: 14px;
      font-weight: 600;
    }

    .crop-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 4px;
    }

    .crop-tag {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
    }

    .empty-state {
      padding: 26px 18px;
      border-radius: var(--radius-2xl);
      border: 1px dashed rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.8);
      text-align: center;
      font-size: 13px;
      color: var(--text-soft);
    }

    .empty-state span.emoji {
      display: block;
      font-size: 28px;
      margin-bottom: 6px;
    }

    .garden-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-top: 10px;
    }

    .garden-cell {
      border-radius: 14px;
      border: 1px solid rgba(51,65,85,0.9);
      background: radial-gradient(circle at top, rgba(34,197,94,0.25) 0, rgba(15,23,42,1) 60%);
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      text-align: center;
      padding: 4px;
    }

    .garden-cell span { display: block; }

    .garden-cell-label {
      font-weight: 600;
      color: var(--text-main);
      font-size: 11px;
    }

    .garden-cell-plant {
      font-size: 10px;
      margin-top: 2px;
    }

    .dialog-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .dialog-backdrop.active { display: flex; }

    .dialog {
      width: min(380px, 100% - 32px);
      border-radius: 22px;
      padding: 16px 16px 14px;
      background: radial-gradient(circle at top left, rgba(34,197,94,0.2) 0, #020617 50%);
      border: 1px solid rgba(148,163,184,0.9);
      box-shadow: 0 24px 70px rgba(0,0,0,0.95);
    }

    .dialog h3 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .dialog label {
      font-size: 12px;
      color: var(--text-soft);
      display: block;
      margin-bottom: 5px;
    }

    .dialog select,
    .dialog input,
    .dialog textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      font-size: 13px;
      padding: 7px 9px;
      margin-bottom: 10px;
      font-family: inherit;
      resize: vertical;
    }

    .dialog textarea { min-height: 60px; }

    .dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(148,163,184,0.9);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border-color: rgba(190,242,100,0.95);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 12px 32px rgba(34,197,94,0.8);
    }

    .btn-ghost { background: transparent; }

    .diary-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .diary-entry {
      border-radius: 16px;
      padding: 8px 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(51,65,85,0.95);
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .diary-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .diary-type { font-weight: 600; }

    .diary-date {
      font-size: 11px;
      color: var(--text-soft);
    }

    .diary-notes {
      color: var(--text-soft);
      font-size: 12px;
    }

    /* DIALOGO CULTIVO */

    .dialog.dialog-crop {
      width: min(430px, 100% - 24px);
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      padding-bottom: 10px;
    }

    .crop-dialog-img-wrap {
      border-radius: 18px;
      overflow: hidden;
      margin-bottom: 10px;
      background: radial-gradient(circle at 20% 0, #bbf7d0 0, #22c55e 35%, #15803d 70%, #166534 100%);
      max-height: 260px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .crop-dialog-img-wrap img {
      width: 100%;
      height: auto;
      object-fit: contain;
      display: block;
    }

    .crop-dialog-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .crop-dialog-name {
      font-size: 17px;
      font-weight: 650;
    }

    .crop-dialog-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .crop-dialog-tag {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.7);
      color: var(--text-soft);
    }

    .crop-dialog-body {
      font-size: 13px;
      color: var(--text-soft);
      overflow-y: auto;
      padding-right: 2px;
      margin-bottom: 6px;
    }

    .crop-dialog-body p {
      margin: 4px 0 6px;
    }

    .crop-dialog-body strong {
      color: var(--text-main);
      font-weight: 600;
    }

    footer {
      margin-top: 8px;
      padding: 6px 4px 2px;
      font-size: 10px;
      color: var(--text-soft);
      text-align: center;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    @media (min-width: 768px) {
      .app-shell { padding: 18px 8px 28px; }
      .section-card { padding: 20px 20px 20px; }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-inner">
        <div class="brand">
          <div class="brand-icon"><span>üå±</span></div>
          <div class="brand-text">
            <div class="brand-title">Mi Siembra Inteligente</div>
            <div class="brand-sub">Planifica, registra y cuida tu huerto paso a paso.</div>
          </div>
        </div>
        <nav class="pill-nav" aria-label="Secciones principales">
          <button class="nav-btn active" data-view="homeView"><span class="emoji">üè†</span><span>Inicio</span></button>
          <button class="nav-btn" data-view="calendarView"><span class="emoji">üìÖ</span><span>Calendario</span></button>
          <button class="nav-btn" data-view="catalogView"><span class="emoji">üåø</span><span>Cat√°logo</span></button>
          <button class="nav-btn" data-view="moreView"><span class="emoji">‚ãØ</span><span>M√°s</span></button>
        </nav>
      </div>
    </header>

    <main>
      <!-- INICIO -->
      <section id="homeView" class="view active">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Inicio</div>
              <div class="section-subtitle">Elige qu√© quieres hacer hoy en tu siembra.</div>
            </div>
            <div class="badge"><span class="emoji">‚ö°</span><span>Modo r√°pido</span></div>
          </div>
          <div class="grid-cards">
            <article class="home-card" data-view-target="calendarView">
              <div class="home-card-title">Qu√© sembrar este mes</div>
              <div class="home-card-desc">Calendario sencillo por mes para saber qu√© cultivos van mejor ahora mismo.</div>
              <div class="home-card-icon">üìÖ</div>
            </article>
            <article class="home-card" data-view-target="catalogView">
              <div class="home-card-title">Cat√°logo de cultivos</div>
              <div class="home-card-desc">Explora fichas visuales con tiempo de cosecha y sol recomendado.</div>
              <div class="home-card-icon">üåø</div>
            </article>
            <article class="home-card" data-view-target="gardenView">
              <div class="home-card-title">Mi huerto</div>
              <div class="home-card-desc">Dise√±a un peque√±o plano de 4√ó4 y marca qu√© hay sembrado en cada cuadro.</div>
              <div class="home-card-icon">üß©</div>
            </article>
            <article class="home-card" data-view-target="diaryView">
              <div class="home-card-title">Diario de siembra</div>
              <div class="home-card-desc">Registra siembras, riegos, abonos y cosechas.</div>
              <div class="home-card-icon">üìì</div>
            </article>
            <article class="home-card" data-view-target="pestsView">
              <div class="home-card-title">Plagas y cuidados</div>
              <div class="home-card-desc">Problemas comunes y qu√© hacer de forma sencilla.</div>
              <div class="home-card-icon">ü™≤</div>
            </article>
            <article class="home-card" data-view-target="fertView">
              <div class="home-card-title">Abonos y fertilizantes</div>
              <div class="home-card-desc">Ideas de compost, abonos caseros y cu√°ndo aplicarlos.</div>
              <div class="home-card-icon">üß™</div>
            </article>
          </div>
          <div class="chips-row">
            <span class="chip"><span class="emoji">üì±</span><span>PWA offline</span></span>
            <span class="chip"><span class="emoji">‚òï</span><span>Hecho para planificar tranquilo</span></span>
            <span class="chip"><span class="emoji">üáµüá∑</span><span>Clima tropical adaptable</span></span>
          </div>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section id="calendarView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">¬øQu√© puedo sembrar este mes?</div>
              <div class="section-subtitle">Toca un mes para ver cultivos recomendados y tiempo aproximado de cosecha.</div>
            </div>
            <button class="small-btn" data-view-target="homeView"><span class="emoji">‚¨ÖÔ∏è</span><span>Inicio</span></button>
          </div>
          <div class="month-grid" id="monthButtons"></div>
          <div class="list" id="monthResults"></div>
        </div>
      </section>

      <!-- CAT√ÅLOGO -->
      <section id="catalogView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Cat√°logo visual de cultivos</div>
              <div class="section-subtitle">Primeros cultivos con fotos representativas y datos r√°pidos.</div>
            </div>
            <button class="small-btn" data-view-target="homeView"><span class="emoji">‚¨ÖÔ∏è</span><span>Inicio</span></button>
          </div>
          <div class="chips-row" id="catalogFilters"></div>
          <div class="catalog-grid" id="catalogGrid"></div>
        </div>
      </section>

      <!-- MI HUERTO -->
      <section id="gardenView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Mi huerto</div>
              <div class="section-subtitle">Toca un cuadro para asignar qu√© est√°s sembrando en esa √°rea.</div>
            </div>
            <button class="small-btn" id="resetGarden"><span class="emoji">üßπ</span><span>Limpiar</span></button>
          </div>
          <div class="garden-grid" id="gardenGrid"></div>
          <div class="section-subtitle" style="margin-top:10px;">
            Sugerencia: puedes usar el plano como referencia de tu cama de siembra real o de tiestos.
          </div>
        </div>
      </section>

      <!-- DIARIO -->
      <section id="diaryView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Diario de siembra</div>
              <div class="section-subtitle">Registra actividades importantes para no perder el hilo de tu huerto.</div>
            </div>
            <button class="small-btn" id="addDiaryEntry"><span class="emoji">‚ûï</span><span>Nuevo</span></button>
          </div>
          <div class="diary-list" id="diaryList"></div>
          <div class="empty-state" id="diaryEmpty">
            <span class="emoji">üìù</span>
            A√∫n no has registrado actividades. Empieza a√±adiendo tu pr√≥xima siembra, riego, abono o cosecha.
          </div>
        </div>
      </section>

      <!-- PLAGAS -->
      <section id="pestsView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Plagas y cuidados b√°sicos</div>
              <div class="section-subtitle">Gu√≠a r√°pida para problemas frecuentes y acciones sencillas.</div>
            </div>
            <button class="small-btn" data-view-target="homeView"><span class="emoji">‚¨ÖÔ∏è</span><span>Inicio</span></button>
          </div>
          <div class="list">
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">Pulgones</div>
                <div class="list-meta">
                  <span class="meta-pill">ü™≤ Chupan savia</span>
                  <span class="meta-pill">üåø Brotes tiernos</span>
                </div>
                <div class="section-subtitle">
                  Soluci√≥n simple: rociar con agua jabonosa suave (jab√≥n pot√°sico o de fregar bien diluido) cada 2‚Äì3 d√≠as.
                </div>
              </div>
            </div>
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">Hongos en hojas</div>
                <div class="list-meta">
                  <span class="meta-pill">üçÉ Manchas</span>
                  <span class="meta-pill">üíß Exceso de humedad</span>
                </div>
                <div class="section-subtitle">
                  Mejora la ventilaci√≥n, evita mojar las hojas al regar y retira hojas muy afectadas.
                </div>
              </div>
            </div>
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">Orugas y gusanos</div>
                <div class="list-meta">
                  <span class="meta-pill">ü™± Hojas comidas</span>
                  <span class="meta-pill">üå± Pl√°ntulas</span>
                </div>
                <div class="section-subtitle">
                  Rev√≠salas a mano, especialmente por la tarde, y ret√≠ralas. Puedes proteger brotes con mallas ligeras.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ABONOS -->
      <section id="fertView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">Abonos y fertilizantes</div>
              <div class="section-subtitle">Ideas pr√°cticas de abonos caseros y cu√°ndo aplicarlos.</div>
            </div>
            <button class="small-btn" data-view-target="homeView"><span class="emoji">‚¨ÖÔ∏è</span><span>Inicio</span></button>
          </div>
          <div class="list">
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">Compost maduro</div>
                <div class="list-meta">
                  <span class="meta-pill">üóëÔ∏è Restos de cocina</span>
                  <span class="meta-pill">üå± Aporta de todo un poco</span>
                </div>
                <div class="section-subtitle">
                  Ideal para mezclar con la tierra antes de sembrar o para mejorar camas ya usadas.
                </div>
              </div>
            </div>
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">T√© de compost o de humus</div>
                <div class="list-meta">
                  <span class="meta-pill">üíß L√≠quido</span>
                  <span class="meta-pill">üöø Se aplica al riego</span>
                </div>
                <div class="section-subtitle">
                  √ötil para dar un empuj√≥n extra a plantas en crecimiento sin exagerar la dosis.
                </div>
              </div>
            </div>
            <div class="list-item">
              <div class="list-main">
                <div class="list-title">Abonos qu√≠micos l√≠quidos</div>
                <div class="list-meta">
                  <span class="meta-pill">‚ö†Ô∏è Leer etiqueta</span>
                </div>
                <div class="section-subtitle">
                  Siempre respeta las dosis indicadas. Es mejor menos cantidad y m√°s frecuente que pasarse.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- M√ÅS -->
      <section id="moreView" class="view">
        <div class="section-card">
          <div class="section-header">
            <div>
              <div class="section-title">M√°s opciones</div>
              <div class="section-subtitle">Atajos a secciones clave de la app.</div>
            </div>
          </div>
          <div class="grid-cards">
            <article class="home-card" data-view-target="gardenView">
              <div class="home-card-title">Mi huerto</div>
              <div class="home-card-desc">Plano r√°pido 4√ó4 para visualizar tu siembra.</div>
              <div class="home-card-icon">üß©</div>
            </article>
            <article class="home-card" data-view-target="diaryView">
              <div class="home-card-title">Diario</div>
              <div class="home-card-desc">Historial de tareas y cosechas.</div>
              <div class="home-card-icon">üìì</div>
            </article>
            <article class="home-card" data-view-target="pestsView">
              <div class="home-card-title">Plagas</div>
              <div class="home-card-desc">Problemas frecuentes y soluciones b√°sicas.</div>
              <div class="home-card-icon">ü™≤</div>
            </article>
            <article class="home-card" data-view-target="fertView">
              <div class="home-card-title">Abonos</div>
              <div class="home-card-desc">Cu√°ndo y c√≥mo abonar sin excesos.</div>
              <div class="home-card-icon">üß™</div>
            </article>
          </div>
        </div>
      </section>
    </main>

    <footer>
      Mi Siembra Inteligente (v15) ¬∑ Guarda datos solo en este dispositivo ¬∑ Puedes instalarla como app desde el navegador.
    </footer>
  </div>

  <!-- DI√ÅLOGO HUERTO -->
  <div class="dialog-backdrop" id="gardenDialog">
    <div class="dialog">
      <h3>Asignar cultivo</h3>
      <div id="gardenDialogPosition" class="section-subtitle" style="margin-bottom:8px;"></div>
      <label for="gardenCropSelect">Cultivo</label>
      <select id="gardenCropSelect"></select>
      <div class="dialog-footer">
        <button class="btn btn-ghost" type="button" data-dialog-close>Cancelar</button>
        <button class="btn btn-primary" type="button" id="gardenSave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- DI√ÅLOGO DIARIO -->
  <div class="dialog-backdrop" id="diaryDialog">
    <div class="dialog">
      <h3>Nueva entrada</h3>
      <label for="diaryType">Tipo de actividad</label>
      <select id="diaryType">
        <option value="Siembra">Siembra</option>
        <option value="Riego">Riego</option>
        <option value="Abono">Abono</option>
        <option value="Cosecha">Cosecha</option>
        <option value="Otro">Otro</option>
      </select>
      <label for="diaryDate">Fecha</label>
      <input id="diaryDate" type="date" />
      <label for="diaryNotes">Notas</label>
      <textarea id="diaryNotes" placeholder="Ej. Sembr√© 4 plantas de tomate en tiestos de 5 galones."></textarea>
      <div class="dialog-footer">
        <button class="btn btn-ghost" type="button" data-dialog-close>Cancelar</button>
        <button class="btn btn-primary" type="button" id="diarySave">Guardar</button>
      </div>
    </div>
  </div>

  <!-- DI√ÅLOGO FICHA DEL CULTIVO -->
  <div class="dialog-backdrop" id="cropDialog">
    <div class="dialog dialog-crop">
      <div class="crop-dialog-img-wrap">
        <img id="cropDialogImg" src="" alt="Cultivo" />
      </div>
      <div class="crop-dialog-header-line">
        <div class="crop-dialog-name" id="cropDialogName">Cultivo</div>
        <button class="btn btn-ghost" type="button" data-dialog-close>‚úï</button>
      </div>
      <div class="crop-dialog-tags">
        <span class="crop-dialog-tag" id="cropDialogTipo"></span>
        <span class="crop-dialog-tag" id="cropDialogDias"></span>
        <span class="crop-dialog-tag" id="cropDialogSol"></span>
      </div>
      <div class="crop-dialog-body">
        <p><strong>Siembra:</strong> <span id="cropDialogSiembra"></span></p>
        <p><strong>Distancia entre plantas:</strong> <span id="cropDialogDistancia"></span></p>
        <p><strong>Profundidad de siembra:</strong> <span id="cropDialogProfundidad"></span></p>
        <p><strong>Tiesto recomendado:</strong> <span id="cropDialogTiesto"></span></p>
      </div>
    </div>
  </div>

  <script>
    // --- Datos de cultivos (usa las im√°genes de tu carpeta img/) ---
    const cultivos = [
      {
        id: 'tomate',
        nombre: 'Tomate',
        tipo: 'Hortaliza',
        imagen: 'img/tomate.jpg',
        meses: [1,2,3,8,9,10,11,12],
        diasCosecha: '70‚Äì90 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Semilleros o pl√°ntulas',
        distancia: '40‚Äì60 cm entre plantas',
        profundidad: '0.5‚Äì1 cm',
        tiesto: '10‚Äì20 L'
      },
      {
        id: 'lechuga',
        nombre: 'Lechuga',
        tipo: 'Hortaliza',
        imagen: 'img/lechuga.jpg',
        meses: [1,2,3,4,8,9,10,11,12],
        diasCosecha: '45‚Äì60 d√≠as',
        sol: 'Sol suave o media sombra',
        siembra: 'Semilleros o directo',
        distancia: '25‚Äì30 cm',
        profundidad: '0.5 cm',
        tiesto: '5‚Äì10 L'
      },
      {
        id: 'cilantro',
        nombre: 'Cilantro',
        tipo: 'Arom√°tica',
        imagen: 'img/cilantro.jpg',
        meses: [1,2,3,4,5,8,9,10,11,12],
        diasCosecha: '30‚Äì45 d√≠as',
        sol: 'Sol suave / media sombra',
        siembra: 'Siembra directa',
        distancia: '15‚Äì20 cm',
        profundidad: '0.5 cm',
        tiesto: '3‚Äì5 L'
      },
      {
        id: 'recao',
        nombre: 'Recao',
        tipo: 'Arom√°tica',
        imagen: 'img/recao.jpg',
        meses: [1,2,3,4,5,6,7,8,9,10,11,12],
        diasCosecha: '60‚Äì90 d√≠as',
        sol: 'Media sombra',
        siembra: 'Pl√°ntulas o divisi√≥n',
        distancia: '20‚Äì25 cm',
        profundidad: 'Cubrir apenas la ra√≠z',
        tiesto: '5‚Äì10 L'
      },
      {
        id: 'pimiento',
        nombre: 'Pimiento',
        tipo: 'Hortaliza',
        imagen: 'img/pimiento.jpg',
        meses: [1,2,3,8,9,10,11,12],
        diasCosecha: '80‚Äì100 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Semilleros o pl√°ntulas',
        distancia: '40‚Äì60 cm',
        profundidad: '0.5‚Äì1 cm',
        tiesto: '15‚Äì20 L'
      },
      {
        id: 'cebolla',
        nombre: 'Cebolla',
        tipo: 'Hortaliza',
        imagen: 'img/cebolla.jpg',
        meses: [1,2,3,9,10,11,12],
        diasCosecha: '100‚Äì120 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Semilla o bulbos',
        distancia: '10‚Äì15 cm',
        profundidad: '1‚Äì2 cm',
        tiesto: '8‚Äì10 L (profundo)'
      },
      {
        id: 'zanahoria',
        nombre: 'Zanahoria',
        tipo: 'Ra√≠z y tub√©rculo',
        imagen: 'img/zanahoria.jpg',
        meses: [1,2,3,4,9,10,11,12],
        diasCosecha: '70‚Äì90 d√≠as',
        sol: 'Sol suave',
        siembra: 'Siembra directa',
        distancia: '5‚Äì8 cm',
        profundidad: '0.5‚Äì1 cm',
        tiesto: '15‚Äì20 L (profundo)'
      },
      {
        id: 'habichuelas',
        nombre: 'Habichuelas',
        tipo: 'Leguminosa',
        imagen: 'img/habichuelas.jpg',
        meses: [2,3,4,5,8,9,10],
        diasCosecha: '60‚Äì80 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Siembra directa',
        distancia: '20‚Äì30 cm',
        profundidad: '2‚Äì3 cm',
        tiesto: '10‚Äì20 L (con tutor si son trepadoras)'
      },
      {
        id: 'calabaza',
        nombre: 'Calabaza',
        tipo: 'Hortaliza de fruto',
        imagen: 'img/calabaza.jpg',
        meses: [2,3,4,5,8,9],
        diasCosecha: '90‚Äì120 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Siembra directa',
        distancia: '80‚Äì100 cm',
        profundidad: '2‚Äì3 cm',
        tiesto: '30 L o m√°s'
      },
      {
        id: 'platano',
        nombre: 'Pl√°tano',
        tipo: 'Frutal',
        imagen: 'img/platano.jpg',
        meses: [1,2,3,4,5,6,7,8,9,10,11,12],
        diasCosecha: '9‚Äì14 meses',
        sol: 'Pleno sol',
        siembra: 'Hijos / reto√±os',
        distancia: '2‚Äì3 m',
        profundidad: 'Cubrir bien el cormo',
        tiesto: 'Suelo directo (recomendado)'
      },
      {
        id: 'yautia',
        nombre: 'Yaut√≠a',
        tipo: 'Ra√≠z y tub√©rculo',
        imagen: 'img/yautia.jpg',
        meses: [1,2,3,4,5,6,7,8,9,10,11,12],
        diasCosecha: '8‚Äì10 meses',
        sol: 'Sol suave / media sombra',
        siembra: 'Trozos de cormo',
        distancia: '60‚Äì80 cm',
        profundidad: '10‚Äì15 cm',
        tiesto: 'Suelo directo o tiesto muy grande'
      },
      {
        id: 'papa',
        nombre: 'Papa',
        tipo: 'Ra√≠z y tub√©rculo',
        imagen: 'img/papa.jpg',
        meses: [1,2,3,9,10,11,12],
        diasCosecha: '90‚Äì120 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Tub√©rculos (semilla de papa)',
        distancia: '25‚Äì30 cm',
        profundidad: '8‚Äì10 cm',
        tiesto: '20‚Äì30 L'
      },
      {
        id: 'maiz',
        nombre: 'Ma√≠z',
        tipo: 'Cereal',
        imagen: 'img/maiz.jpg',
        meses: [2,3,4,5,6,8,9],
        diasCosecha: '90‚Äì110 d√≠as',
        sol: 'Pleno sol',
        siembra: 'Siembra directa',
        distancia: '25‚Äì30 cm (en bloques)',
        profundidad: '3‚Äì4 cm',
        tiesto: 'Suelo directo o bancales grandes'
      },
      {
        id: 'gandules',
        nombre: 'Gandules',
        tipo: 'Leguminosa',
        imagen: 'img/gandules.jpg',
        meses: [2,3,4,5,8,9,10],
        diasCosecha: '5‚Äì7 meses',
        sol: 'Pleno sol',
        siembra: 'Semilla directa',
        distancia: '80‚Äì100 cm',
        profundidad: '2‚Äì3 cm',
        tiesto: 'Suelo directo o tiesto muy grande'
      },
      {
        id: 'papaya',
        nombre: 'Papaya',
        tipo: 'Frutal',
        imagen: 'img/papaya.jpg',
        meses: [1,2,3,4,5,6,7,8,9,10,11,12],
        diasCosecha: '9‚Äì12 meses',
        sol: 'Pleno sol',
        siembra: 'Semilla o pl√°ntulas',
        distancia: '2‚Äì3 m',
        profundidad: 'Cubrir ra√≠ces sin enterrarla demasiado',
        tiesto: 'Suelo directo o tiesto muy grande'
      }
    ];

    const mesesInfo = [
      { id: 1, nombre: 'Ene' },
      { id: 2, nombre: 'Feb' },
      { id: 3, nombre: 'Mar' },
      { id: 4, nombre: 'Abr' },
      { id: 5, nombre: 'May' },
      { id: 6, nombre: 'Jun' },
      { id: 7, nombre: 'Jul' },
      { id: 8, nombre: 'Ago' },
      { id: 9, nombre: 'Sep' },
      { id: 10, nombre: 'Oct' },
      { id: 11, nombre: 'Nov' },
      { id: 12, nombre: 'Dic' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
      setupNavigation();
      setupHomeCards();
      setupCalendar();
      setupCatalog();
      setupGarden();
      setupDiary();
      setupDialogs();
      registerServiceWorker();
    });

    // --- Navegaci√≥n principal ---
    function showView(id) {
      document.querySelectorAll('section.view').forEach(sec => {
        sec.classList.toggle('active', sec.id === id);
      });
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === id);
      });
    }

    function setupNavigation() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const viewId = btn.dataset.view;
          showView(viewId);
        });
      });
    }

    function setupHomeCards() {
      document.querySelectorAll('[data-view-target]').forEach(card => {
        card.addEventListener('click', () => {
          const target = card.dataset.viewTarget;
          if (!target) return;
          showView(target);
        });
      });
    }

    // --- Calendario ---
    function setupCalendar() {
      const monthButtons = document.getElementById('monthButtons');
      const monthResults = document.getElementById('monthResults');
      if (!monthButtons || !monthResults) return;

      mesesInfo.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'month-btn';
        btn.textContent = m.nombre;
        btn.dataset.month = String(m.id);
        btn.addEventListener('click', () => {
          document.querySelectorAll('.month-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderMonth(m.id, monthResults);
        });
        monthButtons.appendChild(btn);
      });

      const currentMonth = new Date().getMonth() + 1;
      const defaultButton = monthButtons.querySelector('[data-month="' + currentMonth + '"]') || monthButtons.querySelector('.month-btn');
      if (defaultButton) {
        defaultButton.classList.add('active');
        renderMonth(parseInt(defaultButton.dataset.month, 10), monthResults);
      }
    }

    function renderMonth(monthId, container) {
      container.innerHTML = '';
      const lista = cultivos.filter(c => c.meses.indexOf(monthId) !== -1);

      if (!lista.length) {
        const div = document.createElement('div');
        div.className = 'empty-state';
        div.innerHTML = '<span class="emoji">üå±</span>No hemos a√±adido cultivos espec√≠ficos para este mes a√∫n.';
        container.appendChild(div);
        return;
      }

      lista.forEach(c => {
        const item = document.createElement('div');
        item.className = 'list-item';
        item.innerHTML =
          '<div class="list-main">' +
            '<div class="list-title">' + c.nombre + '</div>' +
            '<div class="list-meta">' +
              '<span class="meta-pill">üïí ' + c.diasCosecha + '</span>' +
              '<span class="meta-pill">‚òÄÔ∏è ' + c.sol + '</span>' +
            '</div>' +
          '</div>' +
          '<button class="small-btn" type="button" data-crop-id="' + c.id + '">' +
            '<span class="emoji">üîç</span><span>Ver ficha</span>' +
          '</button>';
        container.appendChild(item);
      });

      container.querySelectorAll('[data-crop-id]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const cropId = btn.getAttribute('data-crop-id');
          const crop = cultivos.find(function(c) { return c.id === cropId; });
          if (crop) openCropDialog(crop);
        });
      });
    }

    // --- Cat√°logo ---
    function setupCatalog() {
      const filtersWrap = document.getElementById('catalogFilters');
      const grid = document.getElementById('catalogGrid');
      if (!filtersWrap || !grid) return;

      const tiposSet = {};
      cultivos.forEach(function(c) { tiposSet[c.tipo] = true; });
      const tipos = ['Todos'].concat(Object.keys(tiposSet));

      tipos.forEach(function(tipo) {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'chip';
        chip.dataset.tipo = tipo;
        chip.innerHTML = '<span class="emoji">üåø</span><span>' + tipo + '</span>';
        chip.addEventListener('click', function() {
          filtersWrap.querySelectorAll('.chip').forEach(function(ch) { ch.classList.remove('active'); });
          chip.classList.add('active');
          renderCatalog(grid, tipo === 'Todos' ? null : tipo);
        });
        filtersWrap.appendChild(chip);
      });

      const firstChip = filtersWrap.querySelector('.chip');
      if (firstChip) firstChip.classList.add('active');
      renderCatalog(grid, null);
    }

    function renderCatalog(grid, tipoFiltro) {
      grid.innerHTML = '';
      const lista = tipoFiltro ? cultivos.filter(function(c) { return c.tipo === tipoFiltro; }) : cultivos;

      lista.forEach(function(c) {
        const card = document.createElement('article');
        card.className = 'crop-card';
        card.dataset.cropId = c.id;
        card.innerHTML =
          '<div class="crop-photo">' +
            '<img src="' + c.imagen + '" alt="' + c.nombre + '" loading="lazy">' +
          '</div>' +
          '<div class="crop-body">' +
            '<div class="crop-name">' + c.nombre + '</div>' +
            '<div class="crop-tags">' +
              '<span class="crop-tag">' + c.tipo + '</span>' +
              '<span class="crop-tag">üïí ' + c.diasCosecha + '</span>' +
              '<span class="crop-tag">‚òÄÔ∏è ' + c.sol + '</span>' +
            '</div>' +
          '</div>';
        grid.appendChild(card);
      });

      grid.querySelectorAll('.crop-card').forEach(function(card) {
        card.addEventListener('click', function() {
          const cropId = card.dataset.cropId;
          const crop = cultivos.find(function(c) { return c.id === cropId; });
          if (crop) openCropDialog(crop);
        });
      });
    }

    // --- Mi huerto (4x4) ---
    const GARDEN_KEY = 'miSiembraGardenV1';

    function setupGarden() {
      const grid = document.getElementById('gardenGrid');
      const resetBtn = document.getElementById('resetGarden');
      if (!grid) return;

      let state = loadGardenState();

      function renderGarden() {
        grid.innerHTML = '';
        for (let i = 0; i < 16; i++) {
          const cell = document.createElement('button');
          cell.type = 'button';
          cell.className = 'garden-cell';
          cell.dataset.index = String(i);

          const fila = Math.floor(i / 4) + 1;
          const col = (i % 4) + 1;
          const info = state[i];

          cell.innerHTML =
            '<span class="garden-cell-label">F' + fila + '-C' + col + '</span>' +
            '<span class="garden-cell-plant">' + (info && info.nombre ? info.nombre : 'Vac√≠o') + '</span>';

          cell.addEventListener('click', function() {
            openGardenDialog(i, state, function(newState) {
              state = newState;
              saveGardenState(state);
              renderGarden();
            });
          });

          grid.appendChild(cell);
        }
      }

      renderGarden();

      if (resetBtn) {
        resetBtn.addEventListener('click', function() {
          if (!window.confirm('¬øSeguro que quieres limpiar el plano del huerto?')) return;
          state = new Array(16).fill(null);
          saveGardenState(state);
          renderGarden();
        });
      }
    }

    function loadGardenState() {
      try {
        const raw = window.localStorage.getItem(GARDEN_KEY);
        if (!raw) return new Array(16).fill(null);
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed) || parsed.length !== 16) return new Array(16).fill(null);
        return parsed;
      } catch (e) {
        console.warn('No se pudo leer el huerto:', e);
        return new Array(16).fill(null);
      }
    }

    function saveGardenState(state) {
      try {
        window.localStorage.setItem(GARDEN_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('No se pudo guardar el huerto:', e);
      }
    }

    function openGardenDialog(index, state, onSave) {
      const backdrop = document.getElementById('gardenDialog');
      const positionEl = document.getElementById('gardenDialogPosition');
      const select = document.getElementById('gardenCropSelect');
      const saveBtn = document.getElementById('gardenSave');
      if (!backdrop || !positionEl || !select || !saveBtn) return;

      select.innerHTML = '<option value="">(Vac√≠o)</option>';
      cultivos.forEach(function(c) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nombre;
        select.appendChild(opt);
      });

      const fila = Math.floor(index / 4) + 1;
      const col = (index % 4) + 1;
      positionEl.textContent = 'Fila ' + fila + ', columna ' + col + '.';

      const current = state[index];
      select.value = current && current.id ? current.id : '';

      function handleSave() {
        const val = select.value;
        const newState = state.slice();
        if (!val) {
          newState[index] = null;
        } else {
          const crop = cultivos.find(function(c) { return c.id === val; });
          if (crop) {
            newState[index] = { id: crop.id, nombre: crop.nombre };
          }
        }
        closeDialog(backdrop);
        saveBtn.removeEventListener('click', handleSave);
        onSave(newState);
      }

      saveBtn.addEventListener('click', handleSave);
      openDialog(backdrop);
    }

    // --- Diario ---
    const DIARY_KEY = 'miSiembraDiaryV1';

    function setupDiary() {
      const list = document.getElementById('diaryList');
      const empty = document.getElementById('diaryEmpty');
      const addBtn = document.getElementById('addDiaryEntry');
      if (!list || !empty || !addBtn) return;

      let entries = loadDiary();

      function renderDiary() {
        list.innerHTML = '';
        if (!entries.length) {
          empty.style.display = 'block';
          return;
        }
        empty.style.display = 'none';

        const sorted = entries.slice().sort(function(a, b) {
          return (b.date || '').localeCompare(a.date || '');
        });

        sorted.forEach(function(entry) {
          const div = document.createElement('div');
          div.className = 'diary-entry';
          div.innerHTML =
            '<div class="diary-meta">' +
              '<span class="diary-type">' + (entry.type || 'Actividad') + '</span>' +
              '<span class="diary-date">' + (entry.date || '') + '</span>' +
            '</div>' +
            '<div class="diary-notes">' + (entry.notes || '') + '</div>';
          list.appendChild(div);
        });
      }

      renderDiary();

      addBtn.addEventListener('click', function() {
        openDiaryDialog(entries, function(newEntries) {
          entries = newEntries;
          saveDiary(entries);
          renderDiary();
        });
      });
    }

    function loadDiary() {
      try {
        const raw = window.localStorage.getItem(DIARY_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed;
      } catch (e) {
        console.warn('No se pudo leer el diario:', e);
        return [];
      }
    }

    function saveDiary(entries) {
      try {
        window.localStorage.setItem(DIARY_KEY, JSON.stringify(entries));
      } catch (e) {
        console.warn('No se pudo guardar diario:', e);
      }
    }

    function openDiaryDialog(entries, onSave) {
      const backdrop = document.getElementById('diaryDialog');
      const typeEl = document.getElementById('diaryType');
      const dateEl = document.getElementById('diaryDate');
      const notesEl = document.getElementById('diaryNotes');
      const saveBtn = document.getElementById('diarySave');
      if (!backdrop || !typeEl || !dateEl || !notesEl || !saveBtn) return;

      const hoy = new Date().toISOString().slice(0, 10);
      if (!dateEl.value) dateEl.value = hoy;
      notesEl.value = '';

      function handleSave() {
        const newEntry = {
          type: typeEl.value || 'Actividad',
          date: dateEl.value || '',
          notes: notesEl.value.trim()
        };
        const newEntries = entries.slice();
        newEntries.push(newEntry);
        closeDialog(backdrop);
        saveBtn.removeEventListener('click', handleSave);
        onSave(newEntries);
      }

      saveBtn.addEventListener('click', handleSave);
      openDialog(backdrop);
    }

    // --- Di√°logo ficha cultivo ---
    function openCropDialog(crop) {
      const backdrop = document.getElementById('cropDialog');
      if (!backdrop) return;

      const img = document.getElementById('cropDialogImg');
      const nameEl = document.getElementById('cropDialogName');
      const tipoEl = document.getElementById('cropDialogTipo');
      const diasEl = document.getElementById('cropDialogDias');
      const solEl = document.getElementById('cropDialogSol');
      const siembraEl = document.getElementById('cropDialogSiembra');
      const distanciaEl = document.getElementById('cropDialogDistancia');
      const profundidadEl = document.getElementById('cropDialogProfundidad');
      const tiestoEl = document.getElementById('cropDialogTiesto');

      if (img) {
        img.src = crop.imagen;
        img.alt = crop.nombre;
      }
      if (nameEl) nameEl.textContent = crop.nombre;
      if (tipoEl) tipoEl.textContent = crop.tipo;
      if (diasEl) diasEl.textContent = crop.diasCosecha;
      if (solEl) solEl.textContent = crop.sol;
      if (siembraEl) siembraEl.textContent = crop.siembra;
      if (distanciaEl) distanciaEl.textContent = crop.distancia;
      if (profundidadEl) profundidadEl.textContent = crop.profundidad;
      if (tiestoEl) tiestoEl.textContent = crop.tiesto;

      openDialog(backdrop);
    }

    // --- Sistema gen√©rico de di√°logos ---
    function setupDialogs() {
      document.querySelectorAll('.dialog-backdrop').forEach(function(backdrop) {
        backdrop.addEventListener('click', function(e) {
          if (e.target === backdrop) closeDialog(backdrop);
        });
      });

      document.querySelectorAll('[data-dialog-close]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const backdrop = btn.closest('.dialog-backdrop');
          if (backdrop) closeDialog(backdrop);
        });
      });
    }

    function openDialog(backdrop) {
      backdrop.classList.add('active');
    }

    function closeDialog(backdrop) {
      backdrop.classList.remove('active');
    }

    // --- Service worker ---
    function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(function(err) {
          console.log('SW error', err);
        });
      }
    }
  </script>
</body>
</html>
